[{"title":"Javaå¹¶å‘å­¦ä¹ ä¹‹çº¿ç¨‹æ± ThreadPoolExecutorçš„å°ç»“","slug":"Javaå¹¶å‘å­¦ä¹ ä¹‹çº¿ç¨‹æ± ThreadPoolExecutorçš„å°ç»“","date":"2018-03-06T09:33:54.000Z","updated":"2018-03-06T09:44:19.566Z","comments":true,"path":"2018/03/06/Javaå¹¶å‘å­¦ä¹ ä¹‹çº¿ç¨‹æ± ThreadPoolExecutorçš„å°ç»“/","link":"","permalink":"https://zbang.online/hexblog/2018/03/06/Javaå¹¶å‘å­¦ä¹ ä¹‹çº¿ç¨‹æ± ThreadPoolExecutorçš„å°ç»“/","excerpt":"Javaå¹¶å‘å­¦ä¹ ä¹‹çº¿ç¨‹æ± ThreadPoolExecutorçš„å°ç»“æœ¬ç¯‡åšæ–‡å°†å¸¦ç€é—®é¢˜æ¥å›é¡¾å°ç»“å¤šçº¿ç¨‹æ± ç›¸å…³çš„çŸ¥è¯†ç‚¹ çº¿ç¨‹æ± çš„å‡ ç§åˆ›å»ºæ–¹å¼ çº¿ç¨‹æ± çš„ä¼˜ç‚¹æ˜¯ä»€ä¹ˆ åº”ç”¨åœºæ™¯ å¦‚ä½•ä½¿ç”¨ å®ç°åŸç† å¼‚å¸¸çŠ¶å†µæ€ä¹ˆå¤„ç† çº¿ç¨‹æ± ä¸­ä»»åŠ¡çš„æäº¤æ‰§è¡Œåï¼Œåˆ°çº¿ç¨‹æ‰§è¡Œï¼Œæ‰§è¡Œå®Œæˆçš„æ•´ä¸ªæµç¨‹é€»è¾‘ çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å›æ”¶æœºåˆ¶","text":"Javaå¹¶å‘å­¦ä¹ ä¹‹çº¿ç¨‹æ± ThreadPoolExecutorçš„å°ç»“æœ¬ç¯‡åšæ–‡å°†å¸¦ç€é—®é¢˜æ¥å›é¡¾å°ç»“å¤šçº¿ç¨‹æ± ç›¸å…³çš„çŸ¥è¯†ç‚¹ çº¿ç¨‹æ± çš„å‡ ç§åˆ›å»ºæ–¹å¼ çº¿ç¨‹æ± çš„ä¼˜ç‚¹æ˜¯ä»€ä¹ˆ åº”ç”¨åœºæ™¯ å¦‚ä½•ä½¿ç”¨ å®ç°åŸç† å¼‚å¸¸çŠ¶å†µæ€ä¹ˆå¤„ç† çº¿ç¨‹æ± ä¸­ä»»åŠ¡çš„æäº¤æ‰§è¡Œåï¼Œåˆ°çº¿ç¨‹æ‰§è¡Œï¼Œæ‰§è¡Œå®Œæˆçš„æ•´ä¸ªæµç¨‹é€»è¾‘ çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å›æ”¶æœºåˆ¶ I. ä»€ä¹ˆæ˜¯çº¿ç¨‹æ± 1. é€šä¿—è®²è§£æˆ‘ä»¬å…ˆä¸¾ä¸€ä¸ªå°ä¾‹å­æ¥è¯´ä¸€ä¸‹ä»€ä¹ˆæ˜¯çº¿ç¨‹æ± ï¼Œä»¥åŠçº¿ç¨‹æ± çš„å·¥ä½œæ–¹å¼ é¦–å…ˆåœ¨çœ‹ä¸€ä¸‹çº¿ç¨‹æ± ä¸­æäº¤ä¸€ä¸ªä»»åŠ¡çš„æµç¨‹å›¾ ä¸‹é¢å°±æ˜¯å®é™…çš„caseï¼šåŸºæœ¬ä¸Šå¤§å®¶éƒ½å»è¿‡é“¶è¡Œï¼Œæˆ‘ä»¬å°±ä»¥åˆ°é“¶è¡Œçš„æŸœå°ä¸ŠåŠç†ä¸šåŠ¡çš„æµç¨‹æ¥è¯´æ˜çº¿ç¨‹æ± ï¼Œæˆ‘ä»¬å…ˆå‡è®¾è¿™é‡Œæœ‰ä¸€ä¸ªxxé“¶è¡Œï¼ˆè¿™é‡Œæ˜¯å¹¿å‘Šä½ï¼Œå¾…ç§ŸğŸ˜‰ï¼‰ï¼Œæ€»å…±æœ‰8ä¸ªæŸœå°ï¼Œå¹³æ—¶åªå¼€æ”¾4ä¸ªæŸœå°ï¼Œå¤§å…å†…æ€»å…±æœ‰20ä¸ªåº§ä½ã€‚ é‚£ä¹ˆæ¥ä¸€ä¸ªåŠç†ä¸šåŠ¡çš„ï¼Œå¦‚æœå¼€æ”¾çš„å››ä¸ªæŸœå°ä¸Šï¼Œæœ‰ç©ºçš„ï¼Œç›´æ¥ä¸Šå»åŠç†ä¸šåŠ¡å³å¯ å¦‚æœå››ä¸ªæŸœå°éƒ½åœ¨å¤„ç†ä¸šåŠ¡äº†ï¼Œé‚£ä¹ˆåŠç†ä¸šåŠ¡åˆ™éœ€è¦å–ä¸€ä¸ªå·ï¼Œåˆ°å¤§å…çš„åº§ä½ä¸Šç­‰ç€å«å· å¦‚æœå¤§å…åæ»¡äº†ï¼Œé“¶è¡Œç»ç†å†³å®šå¼€æ”¾æ‰€æœ‰çš„æŸœå°ï¼Œé‚£ä¹ˆæ–°æ¥åŠç†çš„äººç›´æ¥åˆ°æ–°çš„æŸœå°ä¸Šå¤„ç† å¦‚æœæ‰€æœ‰æŸœå°éƒ½åœ¨å¤„ç†ï¼Œä¸”å¤§å…ä¹Ÿæ»¡äº†ï¼Œè¿™ä¸ªæ—¶å€™å°±å‘Šè¯‰æ–°æ¥åŠç†ä¸šåŠ¡çš„ç°åœ¨å·²ç»æ»¡è½½äº†ï¼Œä½ ä»¬åˆ°xxxåœ°çš„é“¶è¡Œå»åŠç†å§ï¼ˆæˆ–è€…å›å®¶ç­‰ä¸‹åˆå†æ¥å¥½äº†ï¼‰ ä»æµç¨‹ä¸Šçš„å¯¹æ¯”æ¥çœ‹ï¼Œå°±å¾ˆç›¸ä¼¼äº†ï¼Œè™½ç„¶å®é™…ä¸Šé“¶è¡Œå¯ä¸ä¼šå› ä¸ºäººçš„å¤ªå¤šæ¥æ–°å¢å¼€æ”¾æŸœå°çš„æ•°é‡ï¼Œä¸‹é¢ç®€å•çš„å°†ä¸Šé¢çš„caseæ˜ å°„åˆ°çº¿ç¨‹æ± çš„æˆå‘˜ä¸Š 4ä¸ªå¼€æ”¾æŸœå° ï¼š å¯¹åº”çº¿ç¨‹æ± çš„corePoolSize(æ ¸å¿ƒå·¥ä½œçº¿ç¨‹æ•°) 8ä¸ªæ€»æŸœå°ï¼šå¯¹åº”çº¿ç¨‹æ± çš„maximumPoolSize(æœ€å¤§å·¥ä½œçº¿ç¨‹æ•°) 20ä¸ªåº§ä½ï¼šå¯¹åº”çº¿ç¨‹æ± çš„workQueue(ä»»åŠ¡é˜Ÿåˆ—) æ‰€ä»¥çº¿ç¨‹æ± ä¸­æäº¤ä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œä¼˜å…ˆçœ‹æ ¸å¿ƒå·¥ä½œçº¿ç¨‹æ•°æ˜¯å¦å·²æ»¡ï¼Œæœªæ»¡æ—¶ï¼Œç›´æ¥åˆ›å»ºçº¿ç¨‹æ‰§è¡Œï¼›å·²æ»¡ï¼Œåˆ™ä¸¢å…¥é˜Ÿåˆ—ï¼›å¦‚æœé˜Ÿåˆ—ä¹Ÿæ»¡äº†ï¼Œåˆ™åˆ¤æ–­å·¥ä½œçº¿ç¨‹æ•°æ˜¯å¦è¶…è¿‡æœ€å¤§æ•°ï¼Œæ²¡æœ‰åˆ™ç›´æ¥åˆ›å»ºçº¿ç¨‹æ‰§è¡Œï¼›å¦åˆ™ç›´æ¥â€œä¸¢å¼ƒâ€è¿™ä¸ªä»»åŠ¡äº† ï¼ˆæ³¨æ„è¿™ä¸ªä¸¢å¼ƒä¸æ˜¯çœŸçš„ä¸¢å¼ƒï¼Œå…¶å¤„ç†ç­–ç•¥å¯ä»¥ç”±ä½ è‡ªå·±å®šä¹‰ï¼‰ ä¸Šé¢æ˜¯åŸºæœ¬æµç¨‹ï¼Œå¹¶æ²¡æœ‰æ¶‰åŠåˆ°å·¥ä½œçº¿ç¨‹çš„å›æ”¶ï¼Œçº¿ç¨‹æ± çš„çŠ¶æ€ï¼ˆæ¯”å¦‚é“¶è¡Œæ˜¯å¦æ‰“çƒŠäº†ï¼‰ï¼Œä»»åŠ¡çš„æ‰§è¡Œç­–ç•¥ç­‰ 2. çº¿ç¨‹æ± è¯´æ˜çº¿ç¨‹æ± æ˜¯ä¸€ç§å¤šçº¿ç¨‹çš„å¤„ç†æœºåˆ¶ï¼Œä¸»è¦æ˜¯ä¸ºäº†å‡å°‘çº¿ç¨‹çš„é¢‘ç¹åˆ›å»ºå’Œé”€æ¯ï¼Œä»è€Œæå‡ç³»ç»Ÿæ•ˆç‡ ä½¿ç”¨çº¿ç¨‹æ± ä¼˜ç‚¹ å‡å°‘äº†åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹çš„æ¬¡æ•°ï¼Œæ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½å¯ä»¥è¢«é‡å¤åˆ©ç”¨ï¼Œå¯æ‰§è¡Œå¤šä¸ªä»»åŠ¡ å¯ä»¥æ ¹æ®ç³»ç»Ÿçš„æ‰¿å—èƒ½åŠ›ï¼Œè°ƒæ•´çº¿ç¨‹æ± ä¸­å·¥ä½œçº¿çº¿ç¨‹çš„æ•°é‡ ä½¿ç”¨çº¿ç¨‹æ± åœºæ™¯ æˆ‘ä»¬å°†çº¿ç¨‹è¿›è¡Œæ‹†åˆ†ï¼Œåˆ›å»ºçº¿ç¨‹è€—æ—¶T1, çº¿ç¨‹æ‰§è¡Œè€—æ—¶T2, é”€æ¯çº¿ç¨‹è€—æ—¶T3 å¦‚æœä½ çš„åœºæ™¯ä¸­ï¼Œæäº¤çº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡éå¸¸é¢‘ç¹ï¼Œä¸”å…·ä½“çš„æ‰§è¡Œè€—æ—¶è¾ƒçŸ­ï¼Œå³ T1 + T3 &gt; T2, è¿™ç§åœºæ™¯ä¸‹ä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥å¸¦æ¥æ˜æ˜¾çš„æ€§èƒ½æå‡ ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœä¸æ˜¯ä½ çš„ä»»åŠ¡åªå¶å°”çš„è¿è¡Œå‡ æ¬¡ï¼Œé‚£ä¹ˆç»å¤§éƒ¨åˆ†åœºæ™¯éƒ½é€‚åˆç”¨çº¿ç¨‹æ± æ¥å¤„ç† 3. çº¿ç¨‹æ± ç»„æˆç±»å®šä¹‰ï¼š java.util.concurrent.ThreadPoolExecutor æ„é€  1234567891011121314151617181920212223// çº¿ç¨‹æ± æ„é€ æ–¹æ³•public ThreadPoolExecutor(int corePoolSize, // æ ¸å¿ƒçº¿ç¨‹æ•° int maximumPoolSize, // æœ€å¤§çº¿ç¨‹æ•° long keepAliveTime, // å­˜æ´»æ—¶é—´ TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, // æ’é˜Ÿé˜Ÿåˆ— ThreadFactory threadFactory, // åˆ›å»ºçº¿ç¨‹çš„å·¥ä½œç±» RejectedExecutionHandler handler) // çº¿ç¨‹æ•°æ»¡ï¼Œé˜Ÿåˆ—æ»¡æ—¶å…·ä½“ä»»åŠ¡ç­–ç•¥&#123; if (corePoolSize &lt; 0 || maximumPoolSize &lt;= 0 || maximumPoolSize &lt; corePoolSize || keepAliveTime &lt; 0) throw new IllegalArgumentException(); if (workQueue == null || threadFactory == null || handler == null) throw new NullPointerException(); this.corePoolSize = corePoolSize; this.maximumPoolSize = maximumPoolSize; this.workQueue = workQueue; this.keepAliveTime = unit.toNanos(keepAliveTime); this.threadFactory = threadFactory; this.handler = handler;&#125; II. çº¿ç¨‹æ± ä½¿ç”¨1. æ„é€ å‚æ•°è¯¦è§£æ„é€ å‚æ•°è¾ƒå¤šï¼Œåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå½“ç„¶é¦–å…ˆå¾—ææ¸…æ¥šè¿™äº›å‚æ•°æ˜¯å¹²å˜›ç”¨çš„ å‚æ•° å«ä¹‰ è¯´æ˜ corePoolSize æ ¸å¿ƒå·¥ä½œçº¿ç¨‹æ•° æ²¡æœ‰ä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹æ± ä¸­å…è®¸å­˜åœ¨çš„æœ€å°ç©ºé—²çº¿ç¨‹æ•° å·¥ä½œçº¿ç¨‹æ•° &lt; corePoolSizeæ—¶ï¼Œæäº¤ä»»åŠ¡åˆ›å»ºå·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ maximumPoolSize æœ€å¤§å·¥ä½œçº¿ç¨‹æ•° çº¿ç¨‹æ± ä¸­å…è®¸å‡ºç°çš„æœ€å¤§å·¥ä½œçº¿ç¨‹æ•°é‡ å½“é˜Ÿåˆ—æ»¡ &amp;&amp; å·¥ä½œçº¿ç¨‹æ•° &lt; maximumPoolSizeæ—¶ï¼Œæ–°çš„é˜Ÿåˆ—å°†åˆ›å»ºçº¿ç¨‹æ¥æ‰§è¡Œï¼› å¦‚æœé˜Ÿåˆ—æ²¡æœ‰è¾¹ç•Œï¼Œé‚£ä¹ˆè¿™ä¸ªå‚æ•°æ²¡æœ‰æ„ä¹‰ workQueue ä»»åŠ¡é˜Ÿåˆ— ä¿å­˜å¾…æ‰§è¡Œä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—ï¼› å½“ (å·¥ä½œçº¿ç¨‹æ•° &gt;= corePoolSize) &amp;&amp; (ä»»åŠ¡æ•° &lt; ä»»åŠ¡é˜Ÿåˆ—é•¿åº¦)æ—¶ï¼Œä»»åŠ¡ä¼šoffer()å…¥é˜Ÿç­‰å¾… keepAliveTime å·¥ä½œçº¿ç¨‹æœ€å¤§ç©ºé—²æ—¶é—´ å½“çº¿ç¨‹æ•° &gt; corePoolSizeæ—¶ï¼Œè¿™ä¸ªå‚æ•°è¡¨ç¤ºç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ï¼› è¶…æ—¶çš„ç©ºé—²çº¿ç¨‹ï¼Œä¼šè¢«å›æ”¶æ‰ï¼Œç›´åˆ°çº¿ç¨‹æ•°==corePoolSzie; å½“allowCoreThreadTimeOut=trueæ—¶ï¼Œåˆ™è¶…æ—¶çš„æ ¸å¿ƒå·¥ä½œçº¿ç¨‹ä¹Ÿä¼šè¢«å›æ”¶ unit æ—¶é—´å•ä½ keepAliveTimeçš„æ—¶é—´å•ä½ threadFactory çº¿ç¨‹åˆ›å»ºå·¥å‚ åˆ›å»ºçº¿ç¨‹çš„å·¥å‚ç±»ï¼Œå¯ä»¥åœ¨è¿™é‡ŒæŒ‡å®šåˆ›å»ºçº¿ç¨‹çš„nameï¼Œè®¾ç½®å®ˆæŠ¤çº¿ç¨‹ï¼Œå¼‚å¸¸caseå¤„ç†ç­‰ handler é¥±å’Œç­–ç•¥æ‰§è¡Œå™¨ çº¿ç¨‹æ± å’Œé˜Ÿåˆ—éƒ½å·²æ»¡æ—¶ï¼Œæ–°æäº¤ä»»åŠ¡çš„å¤„ç†ç­–ç•¥ é»˜è®¤æ˜¯Abort(ç›´æŠ›Rejectå¼‚å¸¸)ï¼ŒåŒ…æ‹¬Discard(LIFOè§„åˆ™ä¸¢å¼ƒ)ã€DiscardOldest(LRUè§„åˆ™ä¸¢å¼ƒ) ä»¥åŠ CallerRuns(è°ƒç”¨è€…çº¿ç¨‹æ‰§è¡Œ)ï¼Œå…è®¸è‡ªå®šä¹‰æ‰§è¡Œå™¨ 2. çº¿ç¨‹æ± çš„åˆ›å»ºç›´æ¥è°ƒç”¨æ„é€ æ–¹æ³•åˆ›å»ºæœ€ç›´è§‚çš„æ–¹å¼ï¼Œç›´æ¥æ„é€ æ–¹æ³•newä¸€ä¸ª 1234567891011121314151617181920212223242526272829303132333435// æŠ¥è­¦çº¿ç¨‹æ± ExecutorService executorService = new ThreadPoolExecutor(3, 5, 60, TimeUnit.SECONDS, new LinkedBlockingDeque&lt;Runnable&gt;(10), new DefaultThreadFactory(\"test-thread\"), new ThreadPoolExecutor.CallerRunsPolicy()); // çº¿ç¨‹åˆ›å»ºå·¥å‚ï¼Œä¸»è¦è®¾ç½®ä¸ºéå®ˆæŠ¤çº¿ç¨‹ï¼ŒæŒ‡å®šçº¿ç¨‹åï¼Œè®¾ç½®ä¼˜å…ˆçº§// å…³äºè¿™ä¸ªå·¥å‚ç±»ï¼Œæ¨èçœ‹nettyçš„å®ç°public class DefaultThreadFactory implements ThreadFactory &#123; private static final AtomicInteger poolNumber = new AtomicInteger(1); private final ThreadGroup group; private final AtomicInteger threadNumber = new AtomicInteger(1); private final String namePrefix; public DefaultThreadFactory(String poolName) &#123; if (null == poolName) &#123; poolName = \"pool\"; &#125; SecurityManager s = System.getSecurityManager(); group = (s != null) ? s.getThreadGroup() : Thread.currentThread().getThreadGroup(); namePrefix = poolName + poolNumber.getAndIncrement() + \"-thread-\"; &#125; @Override public Thread newThread(Runnable r) &#123; Thread t = new Thread(group, r, namePrefix + threadNumber.getAndIncrement(), 0); if (t.isDaemon()) t.setDaemon(false); if (t.getPriority() != Thread.NORM_PRIORITY) t.setPriority(Thread.NORM_PRIORITY); return t; &#125;&#125; åˆ©ç”¨ Executorsåˆ›å»ºjdk1.5+ ä¸­æä¾›äº† java.util.concurrent.Executors æ¥åˆ›å»ºå¸¸è§çš„é›†ä¸­çº¿ç¨‹æ± æ–¹å¼ å…³äºå„ç§çº¿ç¨‹æ± çš„è¯´æ˜å¯ä»¥å‚è€ƒ: Javaå¹¶å‘å­¦ä¹ ä¹‹ç©è½¬çº¿ç¨‹æ±  å›ºå®šå¤§å°çº¿ç¨‹æ±  123456// åˆ›å»ºä¸€ä¸ªå›ºå®šå¤§å°çš„çº¿ç¨‹æ± public static ExecutorService newFixedThreadPool(int nThreads) &#123; return new ThreadPoolExecutor(nThreads, nThreads, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;Runnable&gt;());&#125; å·¥ä½œçªƒå–çº¿ç¨‹æ±  123456public static ExecutorService newWorkStealingPool(int parallelism) &#123; return new ForkJoinPool (parallelism, ForkJoinPool.defaultForkJoinWorkerThreadFactory, null, true);&#125; åˆ›å»ºå•çº¿ç¨‹æ±  123456public static ExecutorService newSingleThreadExecutor() &#123; return new FinalizableDelegatedExecutorService (new ThreadPoolExecutor(1, 1, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;Runnable&gt;()));&#125; ç¼“å­˜çº¿ç¨‹æ±  12345public static ExecutorService newCachedThreadPool() &#123; return new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60L, TimeUnit.SECONDS, new SynchronousQueue&lt;Runnable&gt;());&#125; å®šæ—¶ä»»åŠ¡çº¿ç¨‹æ±  123public static ScheduledExecutorService newScheduledThreadPool(int corePoolSize) &#123; return new ScheduledThreadPoolExecutor(corePoolSize);&#125; ä¸å¯é…ç½®çº¿ç¨‹æ±  12345public static ExecutorService unconfigurableExecutorService(ExecutorService executor) &#123; if (executor == null) throw new NullPointerException(); return new DelegatedExecutorService(executor);&#125; 3. æäº¤ä»»åŠ¡execute: æäº¤æ— é¡»è¿”å›å€¼çš„ä»»åŠ¡ submit(Runnable): é€‚ç”¨äºæäº¤éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡ ç›¸æ¯”è¾ƒäºä¸Šé¢çš„ï¼ŒåŒºåˆ«æ˜¯è¿™ä¸ªä¼šè¿”å›ä¸€ä¸ª Future å¯¹è±¡ï¼Œé€šè¿‡è°ƒç”¨future.get()å¯ä»¥è·å–çº¿ç¨‹çš„è¿”å›å€¼ï¼Œ å…¶ä¸­è¿™ä¸ªæ–¹ç¨‹æ˜¯çº¿ç¨‹é˜»å¡çš„ï¼Œç›´åˆ°è¿”å›äº†ç»“æœä¹‹åï¼Œæ‰ä¼šç»§ç»­æ‰§è¡Œä¸‹å» 4. å…³é—­çº¿ç¨‹æ± shutdown(): æœ‰åºåœ°å…³é—­çº¿ç¨‹æ± ï¼Œå·²æäº¤çš„ä»»åŠ¡ä¼šè¢«æ‰§è¡Œ(åŒ…å«æ­£åœ¨æ‰§è¡Œå’Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„)ï¼Œä½†ä¼šæ‹’ç»æ–°ä»»åŠ¡ shutdownNow(): ç«‹å³(å°è¯•)åœæ­¢æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡(åŒ…å«æ­£åœ¨æ‰§è¡Œå’Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„)ï¼Œå¹¶è¿”å›å¾…æ‰§è¡Œä»»åŠ¡åˆ—è¡¨ III. çº¿ç¨‹æ± å®ç°åŸç†1. çº¿ç¨‹æ± çŠ¶æ€çº¿ç¨‹æ± çŠ¶æ€æµç¨‹å¦‚ä¸‹ï¼š RUNNING -&gt; SHUTDOWN -&gt; STOP -&gt; TIDYING -&gt; TERMINATED æ¯ä¸ªçŠ¶æ€å«ä¹‰ 1234567891011121314//é«˜3ä½111ï¼Œä½29ä½ä¸º0 è¯¥çŠ¶æ€ä¸‹çº¿ç¨‹æ± ä¼šæ¥æ”¶æ–°æäº¤ä»»åŠ¡å’Œæ‰§è¡Œé˜Ÿåˆ—ä»»åŠ¡private static final int RUNNING = -1 &lt;&lt; COUNT_BITS;//é«˜3ä½000ï¼Œä½29ä½ä¸º0 è¯¥çŠ¶æ€ä¸‹çº¿ç¨‹æ± ä¸å†æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†è¿˜ä¼šç»§ç»­æ‰§è¡Œé˜Ÿåˆ—ä»»åŠ¡private static final int SHUTDOWN = 0 &lt;&lt; COUNT_BITS;//é«˜3ä½001ï¼Œä½29ä½ä¸º0 è¯¥çŠ¶æ€ä¸‹çº¿ç¨‹æ± ä¸å†æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä¸ä¼šå†æ‰§è¡Œé˜Ÿåˆ—ä»»åŠ¡ï¼Œå¹¶ä¼šä¸­æ–­æ­£åœ¨æ‰§è¡Œä¸­çš„ä»»åŠ¡private static final int STOP = 1 &lt;&lt; COUNT_BITS;//é«˜3ä½010ï¼Œä½29ä½ä¸º0 è¯¥çŠ¶æ€ä¸‹çº¿ç¨‹æ± çš„æ‰€æœ‰ä»»åŠ¡éƒ½è¢«ç»ˆæ­¢ï¼Œå·¥ä½œçº¿ç¨‹æ•°ä¸º0ï¼ŒæœŸé—´ä¼šè°ƒç”¨é’©å­æ–¹æ³•terminated()private static final int TIDYING = 2 &lt;&lt; COUNT_BITS;//é«˜3ä½011ï¼Œä½29ä½ä¸º0 è¯¥çŠ¶æ€ä¸‹è¡¨æ˜çº¿ç¨‹æ± terminated()æ–¹æ³•å·²ç»è°ƒç”¨å®Œæˆprivate static final int TERMINATED = 3 &lt;&lt; COUNT_BITS; 2. ä»»åŠ¡æäº¤é€»è¾‘æœ€å¼€å§‹çš„æµå›¾å°±è¯´æ˜äº†ä»»åŠ¡æäº¤åçš„æµç¨‹ï¼Œé’ˆå¯¹æµç¨‹å—ä¹Ÿå°±ä¸ç»§ç»­ç»†è¯´ï¼Œåªæä¸€ä¸ªæ³¨æ„ç‚¹ è‹¥å®é™…å·¥ä½œçº¿ç¨‹æ•°workers&lt;æ ¸å¿ƒå·¥ä½œçº¿ç¨‹æ•°corePoolSizeï¼Œåˆ™åˆ›å»ºæ–°å·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œæ–°ä»»åŠ¡execute(Runable) è‹¥å®é™…å·¥ä½œçº¿ç¨‹æ•°workers&gt;=æ ¸å¿ƒå·¥ä½œçº¿ç¨‹æ•°corePoolSize(æ ¸å¿ƒå·¥ä½œçº¿ç¨‹ä»¬éƒ½åœ¨æ‰§è¡Œä»»åŠ¡)ä¸”ä»»åŠ¡é˜Ÿåˆ—workQueueæœªæ»¡ï¼Œåˆ™å°†ä»»åŠ¡åŠ å…¥åˆ°ä»»åŠ¡é˜Ÿåˆ—workQueueä¸­ è‹¥ä»»åŠ¡é˜Ÿåˆ—workQueueå·²æ»¡ï¼Œåˆ™åˆ›å»ºæ–°å·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡execute() è‹¥å®é™…å·¥ä½œçº¿ç¨‹æ•°workers&gt;=æœ€å¤§å·¥ä½œçº¿ç¨‹æ•°maximumPoolSize(æ‰€æœ‰çº¿ç¨‹éƒ½åœ¨æ‰§è¡Œä»»åŠ¡)ï¼Œæ­¤æ—¶ä»»åŠ¡æ•°å·²é¥±å’Œï¼Œéœ€è¦æ ¹æ®é¥±å’Œæ‹’ç»ç­–ç•¥rejectedExecutionHandleræ‰§è¡Œç›¸å¯¹åº”çš„é¥±å’Œæ‹’ç»æ“ä½œ çº¿ç¨‹æ± çš„æ€»ä½“è®¾è®¡æ˜¯åŸºäºæ€§èƒ½è€ƒè™‘ï¼Œå°½å¯èƒ½é¿å…è·å–å…¨å±€é”ï¼š ç”±äºåˆ›å»ºæ–°çº¿ç¨‹æ—¶éƒ½éœ€è¦è·å–å…¨å±€é”ï¼Œå› æ­¤æ­¥éª¤1å’Œæ­¥éª¤3å¿…é¡»åŠ é” ä¸ºäº†é¿å…å¤šæ¬¡è·å–å…¨å±€é”(æ€§èƒ½ä¼¸ç¼©ç“¶é¢ˆ)ï¼Œå½“å®é™…å·¥ä½œçº¿ç¨‹æ•°&gt;=æ ¸å¿ƒå·¥ä½œçº¿ç¨‹æ•°æ—¶ï¼Œä¹‹åä¼šæ‰§è¡Œæ­¥éª¤2(å…¥é˜Ÿæ—¶æ— é¡»è·å–å…¨å±€é”) çº¿ç¨‹æ± å†…çº¿ç¨‹å›æ”¶ç­–ç•¥ è‹¥å®é™…å·¥ä½œçº¿ç¨‹æ•°workers&gt;æ ¸å¿ƒå·¥ä½œçº¿ç¨‹æ•°corePoolSizeï¼Œå›æ”¶ç©ºé—²æ—¶é—´è¶…è¿‡keepAliveTimeçš„ç©ºé—²çš„éæ ¸å¿ƒçº¿ç¨‹(å‡å°‘å·¥ä½œçº¿ç¨‹æ•°ç›´åˆ°&lt;=æ ¸å¿ƒå·¥ä½œçº¿ç¨‹æ•°å³å¯) è‹¥è®¾ç½®allowCoreThreadTimeOutä¸ºtrueæ—¶ï¼Œåˆ™è¶…è¿‡keepAliveTimeçš„ç©ºé—²çš„æ ¸å¿ƒå·¥ä½œçº¿ç¨‹ä¹Ÿä¼šè¢«å›æ”¶ 3. ä»»åŠ¡æ‰§è¡Œè¯´æ˜ï¼Œä¸‹é¢ä¸¤æ®µä»£ç è§£ææ¥è‡ªè½¬è½½ï¼š å¹¶å‘ç•ª@ThreadPoolExecutor execute() - æäº¤ä»»åŠ¡123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899/** * 1.è‹¥å®é™…å·¥ä½œçº¿ç¨‹æ•° &lt; æ ¸å¿ƒå·¥ä½œçº¿ç¨‹æ•°ï¼Œä¼šå°è¯•åˆ›å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹å»æ‰§è¡Œè¯¥ * ä»»åŠ¡ï¼Œå³è¯¥commandä¼šä½œä¸ºè¯¥çº¿ç¨‹çš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œå³ç¬¬ä¸€ä¸ªfirstTask * * 2.è‹¥ä»»åŠ¡å…¥é˜ŸæˆåŠŸï¼Œä»éœ€è¦æ‰§è¡ŒåŒé‡æ ¡éªŒï¼ŒåŸå› æœ‰ä¸¤ç‚¹ï¼š * - ç¬¬ä¸€ä¸ªæ˜¯å»ç¡®è®¤æ˜¯å¦éœ€è¦æ–°å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œå› ä¸ºå¯èƒ½å­˜åœ¨ * åœ¨ä¸Šæ¬¡æ£€æŸ¥åå·²ç»æ­»äº¡diedçš„å·¥ä½œçº¿ç¨‹ * - ç¬¬äºŒä¸ªæ˜¯å¯èƒ½åœ¨è¿›å…¥è¯¥æ–¹æ³•åçº¿ç¨‹æ± è¢«å…³é—­äº†ï¼Œ * æ¯”å¦‚æ‰§è¡Œshutdown() * å› æ­¤éœ€è¦å†æ¬¡æ£€æŸ¥stateçŠ¶æ€ï¼Œå¹¶åˆ†åˆ«å¤„ç†ä»¥ä¸Šä¸¤ç§æƒ…å†µï¼š * - è‹¥çº¿ç¨‹æ± ä¸­å·²æ— å¯ç”¨å·¥ä½œçº¿ç¨‹äº†ï¼Œåˆ™éœ€è¦æ–°å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹ * - è‹¥çº¿ç¨‹æ± å·²è¢«å…³é—­ï¼Œåˆ™éœ€è¦å›æ»šå…¥é˜Ÿåˆ—(è‹¥æœ‰å¿…è¦) * * 3.è‹¥ä»»åŠ¡å…¥é˜Ÿå¤±è´¥(æ¯”å¦‚é˜Ÿåˆ—å·²æ»¡)ï¼Œåˆ™éœ€è¦æ–°å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼› * - è‹¥æ–°å»ºçº¿ç¨‹å¤±è´¥ï¼Œè¯´æ˜çº¿ç¨‹æ± å·²åœæ­¢æˆ–è€…å·²é¥±å’Œï¼Œå¿…é¡»æ‰§è¡Œæ‹’ç»ç­–ç•¥ */public void execute(Runnable command) &#123; //æ–°ä»»åŠ¡ä¸å…è®¸ä¸ºç©ºï¼Œç©ºåˆ™æŠ›å‡ºNPE if (command == null) throw new NullPointerException(); // ctl ä¸ºçº¿ç¨‹æ± çŠ¶æ€æ§åˆ¶å™¨ï¼Œç”¨äºä¿è¯çº¿ç¨‹æ± çŠ¶æ€å’Œå·¥ä½œçº¿ç¨‹æ•° // ä½29ä½ä¸ºå·¥ä½œçº¿ç¨‹æ•°é‡ï¼Œé«˜3ä½ä¸ºçº¿ç¨‹æ± çŠ¶æ€ int c = ctl.get(); /** * case1ï¼šå½“å®é™…å·¥ä½œçº¿ç¨‹æ•° &lt; æ ¸å¿ƒå·¥ä½œçº¿ç¨‹æ•°æ—¶ * æ‰§è¡Œæ–¹æ¡ˆï¼šä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å·¥ä½œçº¿ç¨‹å»æ‰§è¡Œè¯¥ä»»åŠ¡ * æ³¨æ„ï¼šæ­¤æ—¶å³ä½¿æœ‰å…¶ä»–ç©ºé—²çš„å·¥ä½œçº¿ç¨‹ä¹Ÿè¿˜æ˜¯ä¼šæ–°å¢å·¥ä½œçº¿ç¨‹ï¼Œ * ç›´åˆ°è¾¾åˆ°æ ¸å¿ƒå·¥ä½œçº¿ç¨‹æ•°ä¸ºæ­¢ */ if (workerCountOf(c) &lt; corePoolSize) &#123; /** * æ–°å¢å·¥ä½œçº¿ç¨‹ï¼Œtrueè¡¨ç¤ºè¦å¯¹æ¯”çš„æ˜¯æ ¸å¿ƒå·¥ä½œçº¿ç¨‹æ•° * ä¸€æ—¦æ–°å¢æˆåŠŸå°±å¼€å§‹æ‰§è¡Œå½“å‰ä»»åŠ¡ * æœŸé—´ä¹Ÿä¼šé€šè¿‡è‡ªæ—‹è·å–é˜Ÿåˆ—ä»»åŠ¡è¿›è¡Œæ‰§è¡Œ */ if (addWorker(command, true)) return; /** * éœ€è¦é‡æ–°è·å–æ§åˆ¶å™¨çŠ¶æ€ï¼Œè¯´æ˜æ–°å¢çº¿ç¨‹å¤±è´¥ * çº¿ç¨‹å¤±è´¥çš„åŸå› å¯èƒ½æœ‰ä¸¤ç§ï¼š * - 1.çº¿ç¨‹æ± å·²è¢«å…³é—­ï¼ŒéRUNNINGçŠ¶æ€çš„çº¿ç¨‹æ± æ˜¯ä¸å…è®¸æ¥æ”¶æ–°ä»»åŠ¡çš„ * - 2.å¹¶å‘æ—¶ï¼Œå‡å¦‚éƒ½é€šè¿‡äº†workerCountOf(c) &lt; corePoolSizeæ ¡éªŒï¼Œä½†å…¶ä»–çº¿ç¨‹ * å¯èƒ½ä¼šåœ¨addWorkerå‰å…ˆåˆ›å»ºå‡ºçº¿ç¨‹ï¼Œå¯¼è‡´workerCountOf(c) &gt;= corePoolSizeï¼Œ * å³å®é™…å·¥ä½œçº¿ç¨‹æ•° &gt;= æ ¸å¿ƒå·¥ä½œçº¿ç¨‹æ•°ï¼Œæ­¤æ—¶éœ€è¦è¿›å…¥case2 */ c = ctl.get(); &#125; /** * case2ï¼šå½“å®é™…å·¥ä½œçº¿ç¨‹æ•°&gt;=æ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œæ–°æäº¤ä»»åŠ¡éœ€è¦å…¥é˜Ÿ * æ‰§è¡Œæ–¹æ¡ˆï¼šä¸€æ—¦å…¥é˜ŸæˆåŠŸï¼Œä»éœ€è¦å¤„ç†çº¿ç¨‹æ± çŠ¶æ€çªå˜å’Œå·¥ä½œçº¿ç¨‹æ­»äº¡çš„æƒ…å†µ */ if (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123; //åŒé‡æ ¡éªŒ int recheck = ctl.get(); /** * recheckçš„ç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢çº¿ç¨‹æ± çŠ¶æ€çš„çªå˜ - å³è¢«å…³é—­ * ä¸€æ—¦çº¿ç¨‹æ± éRUNNINGçŠ¶æ€æ—¶ï¼Œé™¤äº†ä»é˜Ÿåˆ—ä¸­ç§»é™¤è¯¥ä»»åŠ¡(å›æ»š)å¤– * è¿˜éœ€è¦æ‰§è¡Œä»»åŠ¡æ‹’ç»ç­–ç•¥å¤„ç†æ–°æäº¤çš„ä»»åŠ¡ */ if (!isRunning(recheck) &amp;&amp; remove(command)) //æ‰§è¡Œä»»åŠ¡æ‹’ç»ç­–ç•¥ reject(command); /** * è‹¥çº¿ç¨‹æ± è¿˜æ˜¯RUNNINGçŠ¶æ€ æˆ– * é˜Ÿåˆ—ç§»é™¤å¤±è´¥(å¯èƒ½æ­£å¥½è¢«ä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ‹¿åˆ°å¤„ç†äº†) * æ­¤æ—¶éœ€è¦ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªå·¥ä½œçº¿ç¨‹è¿˜å¯ä»¥å¹²æ´» * è¡¥å……ä¸€å¥ï¼šä¹‹æ‰€æœ‰æ— é¡»ä¸æ ¸å¿ƒå·¥ä½œçº¿ç¨‹æ•°æˆ–æœ€å¤§çº¿ç¨‹æ•°ç›¸æ¯”ï¼Œè€Œåªæ˜¯æ¯”è¾ƒ0çš„åŸå› æ˜¯ * åªè¦ä¿è¯æœ‰ä¸€ä¸ªå·¥ä½œçº¿ç¨‹å¯ä»¥å¹²æ´»å°±è¡Œï¼Œå®ƒä¼šè‡ªåŠ¨å»è·å–ä»»åŠ¡ */ else if (workerCountOf(recheck) == 0) /** * è‹¥å·¥ä½œçº¿ç¨‹éƒ½å·²æ­»äº¡ï¼Œéœ€è¦æ–°å¢ä¸€ä¸ªå·¥ä½œçº¿ç¨‹å»å¹²æ´» * æ­»äº¡åŸå› å¯èƒ½æ˜¯çº¿ç¨‹è¶…æ—¶æˆ–è€…å¼‚å¸¸ç­‰ç­‰å¤æ‚æƒ…å†µ * * ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºnullæŒ‡çš„æ˜¯ä¼ å…¥ä¸€ä¸ªç©ºä»»åŠ¡ï¼Œ * ç›®çš„æ˜¯åˆ›å»ºä¸€ä¸ªæ–°å·¥ä½œçº¿ç¨‹å»å¤„ç†é˜Ÿåˆ—ä¸­çš„å‰©ä½™ä»»åŠ¡ * ç¬¬äºŒä¸ªå‚æ•°ä¸ºfalseç›®çš„æ˜¯æç¤ºå¯ä»¥æ‰©å®¹åˆ°æœ€å¤§å·¥ä½œçº¿ç¨‹æ•° */ addWorker(null, false); &#125; /** * case3ï¼šä¸€æ—¦çº¿ç¨‹æ± è¢«å…³é—­ æˆ–è€… æ–°ä»»åŠ¡å…¥é˜Ÿå¤±è´¥(é˜Ÿåˆ—å·²æ»¡) * æ‰§è¡Œæ–¹æ¡ˆï¼šä¼šå°è¯•åˆ›å»ºä¸€ä¸ªæ–°çš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶å…è®¸æ‰©å®¹åˆ°æœ€å¤§å·¥ä½œçº¿ç¨‹æ•° * æ³¨æ„ï¼šä¸€æ—¦åˆ›å»ºå¤±è´¥ï¼Œæ¯”å¦‚è¶…è¿‡æœ€å¤§å·¥ä½œçº¿ç¨‹æ•°ï¼Œéœ€è¦æ‰§è¡Œä»»åŠ¡æ‹’ç»ç­–ç•¥ */ else if (!addWorker(command, false)) //æ‰§è¡Œä»»åŠ¡æ‹’ç»ç­–ç•¥ reject(command);&#125; ä¸Šé¢çš„ä»£ç è™½ç„¶éå¸¸å°‘ï¼Œä½†æ˜¯é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œåˆ›å»ºçº¿ç¨‹æ˜¯æ ¹æ® addWorkeræ–¹æ³•æ¥å®ç°çš„ï¼Œå…¶ä¸»è¦é€»è¾‘ä¸º 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204/** * æ–°å¢å·¥ä½œçº¿ç¨‹éœ€è¦éµå®ˆçº¿ç¨‹æ± æ§åˆ¶çŠ¶æ€è§„å®šå’Œè¾¹ç•Œé™åˆ¶ * * @param core coreä¸ºtrueæ—¶å…è®¸æ‰©å®¹åˆ°æ ¸å¿ƒå·¥ä½œçº¿ç¨‹æ•°ï¼Œå¦åˆ™ä¸ºæœ€å¤§å·¥ä½œçº¿ç¨‹æ•° * @return æ–°å¢æˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›false */private boolean addWorker(Runnable firstTask, boolean core) &#123; //é‡è¯•æ ‡ç­¾ retry: /*** * å¤–éƒ¨è‡ªæ—‹ -&gt; ç›®çš„æ˜¯ç¡®è®¤æ˜¯å¦èƒ½å¤Ÿæ–°å¢å·¥ä½œçº¿ç¨‹ * å…è®¸æ–°å¢çº¿ç¨‹çš„æ¡ä»¶æœ‰ä¸¤ä¸ªï¼š * 1.æ»¡è¶³çº¿ç¨‹æ± çŠ¶æ€æ¡ä»¶ -&gt; æ¡ä»¶ä¸€ * 2.å®é™…å·¥ä½œçº¿ç¨‹æ»¡è¶³æ•°é‡è¾¹ç•Œæ¡ä»¶ -&gt; æ¡ä»¶äºŒ * ä¸æ»¡è¶³æ¡ä»¶æ—¶ä¼šç›´æ¥è¿”å›falseï¼Œè¡¨ç¤ºæ–°å¢å·¥ä½œçº¿ç¨‹å¤±è´¥ */ for (;;) &#123; //è¯»å–åŸå­æ§åˆ¶é‡ - åŒ…å«workerCount(å®é™…å·¥ä½œçº¿ç¨‹æ•°)å’ŒrunState(çº¿ç¨‹æ± çŠ¶æ€) int c = ctl.get(); //è¯»å–çº¿ç¨‹æ± çŠ¶æ€ int rs = runStateOf(c); /** * æ¡ä»¶ä¸€.åˆ¤æ–­æ˜¯å¦æ»¡è¶³çº¿ç¨‹æ± çŠ¶æ€æ¡ä»¶ * 1.åªæœ‰ä¸¤ç§æƒ…å†µå…è®¸æ–°å¢çº¿ç¨‹ï¼š * 1.1 çº¿ç¨‹æ± çŠ¶æ€==RUNNING * 1.2 çº¿ç¨‹æ± çŠ¶æ€==SHUTDOWNä¸”firstTaskä¸ºnullåŒæ—¶é˜Ÿåˆ—éç©º * * 2.çº¿ç¨‹æ± çŠ¶æ€&gt;=SHUTDOWNæ—¶ä¸å…è®¸æ¥æ”¶æ–°ä»»åŠ¡ï¼Œå…·ä½“å¦‚ä¸‹ï¼š * 2.1 çº¿ç¨‹æ± çŠ¶æ€&gt;SHUTDOWNï¼Œå³ä¸ºSTOPã€TIDYINGã€TERMINATED * 2.2 çº¿ç¨‹æ± çŠ¶æ€==SHUTDOWNï¼Œä½†firstTaskéç©º * 2.3 çº¿ç¨‹æ± çŠ¶æ€==SHUTDOWNä¸”firstTaskä¸ºç©ºï¼Œä½†é˜Ÿåˆ—ä¸ºç©º * è¡¥å……ï¼šé’ˆå¯¹1.2ã€2.2ã€2.3çš„æƒ…å†µå…·ä½“è¯·å‚åŠ åé¢çš„\"å°é—®ç­”\"ç¯èŠ‚ */ if (rs &gt;= SHUTDOWN &amp;&amp; !(rs == SHUTDOWN &amp;&amp; firstTask == null &amp;&amp; ! workQueue.isEmpty())) return false; /*** * å†…éƒ¨è‡ªæ—‹ -&gt; æ¡ä»¶äºŒ.åˆ¤æ–­å®é™…å·¥ä½œçº¿ç¨‹æ•°æ˜¯å¦æ»¡è¶³æ•°é‡è¾¹ç•Œæ¡ä»¶ * -æ•°é‡è¾¹ç•Œæ¡ä»¶æ»¡è¶³ä¼šå¯¹å°è¯•workerCountå®ç°CASè‡ªå¢ï¼Œå¦åˆ™æ–°å¢å¤±è´¥ * -å½“CASå¤±è´¥æ—¶ä¼šå†æ¬¡é‡æ–°åˆ¤æ–­æ˜¯å¦æ»¡è¶³æ–°å¢æ¡ä»¶ï¼š * 1.è‹¥æ­¤æœŸé—´çº¿ç¨‹æ± çŠ¶æ€çªå˜(è¢«å…³é—­)ï¼Œé‡æ–°åˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€æ¡ä»¶å’Œæ•°é‡è¾¹ç•Œæ¡ä»¶ * 2.è‹¥æ­¤æœŸé—´çº¿ç¨‹æ± çŠ¶æ€ä¸€è‡´ï¼Œåˆ™åªéœ€é‡æ–°åˆ¤æ–­æ•°é‡è¾¹ç•Œæ¡ä»¶ */ for (;;) &#123; //è¯»å–å®é™…å·¥ä½œçº¿ç¨‹æ•° int wc = workerCountOf(c); /** * æ–°å¢å·¥ä½œçº¿ç¨‹ä¼šå› ä¸¤ç§å®é™…å·¥ä½œçº¿ç¨‹æ•°è¶…æ ‡æƒ…å†µè€Œå¤±è´¥ï¼š * 1.å®é™…å·¥ä½œçº¿ç¨‹æ•° &gt;= æœ€å¤§å®¹é‡ * 2.å®é™…å·¥ä½œçº¿ç¨‹æ•° &gt; å·¥ä½œçº¿ç¨‹æ¯”è¾ƒè¾¹ç•Œæ•°(å½“å‰æœ€å¤§æ‰©å®¹æ•°) * -è‹¥core = trueï¼Œæ¯”è¾ƒè¾¹ç•Œæ•° = æ ¸å¿ƒå·¥ä½œçº¿ç¨‹æ•° * -è‹¥core = falseï¼Œæ¯”è¾ƒè¾¹ç•Œæ•° = æœ€å¤§å·¥ä½œçº¿ç¨‹æ•° */ if (wc &gt;= CAPACITY || wc &gt;= (core ? corePoolSize : maximumPoolSize)) return false; /** * å®é™…å·¥ä½œçº¿ç¨‹è®¡æ•°CASè‡ªå¢: * 1.ä¸€æ—¦æˆåŠŸç›´æ¥é€€å‡ºæ•´ä¸ªretryå¾ªç¯ï¼Œè¡¨æ˜æ–°å¢æ¡ä»¶éƒ½æ»¡è¶³ * 2.å› å¹¶å‘ç«äº‰å¯¼è‡´CASæ›´æ–°å¤±è´¥çš„åŸå› æœ‰ä¸‰ç§: * 2.1 çº¿ç¨‹æ± åˆšå¥½å·²æ–°å¢ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ * -&gt; è®¡æ•°å¢åŠ ï¼Œåªéœ€é‡æ–°åˆ¤æ–­æ•°é‡è¾¹ç•Œæ¡ä»¶ * 2.2 åˆšå¥½å…¶ä»–å·¥ä½œçº¿ç¨‹è¿è¡ŒæœŸå‘ç”Ÿé”™è¯¯æˆ–å› è¶…æ—¶è¢«å›æ”¶ * -&gt; è®¡æ•°å‡å°‘ï¼Œåªéœ€é‡æ–°åˆ¤æ–­æ•°é‡è¾¹ç•Œæ¡ä»¶ * 2.3 åˆšå¥½çº¿ç¨‹æ± è¢«å…³é—­ * -&gt; è®¡æ•°å‡å°‘ï¼Œå·¥ä½œçº¿ç¨‹è¢«å›æ”¶ï¼Œ * éœ€é‡æ–°åˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€æ¡ä»¶å’Œæ•°é‡è¾¹ç•Œæ¡ä»¶ */ if (compareAndIncrementWorkerCount(c)) break retry; //é‡æ–°è¯»å–åŸå­æ§åˆ¶é‡ -&gt; åŸå› æ˜¯åœ¨æ­¤æœŸé—´å¯èƒ½çº¿ç¨‹æ± è¢«å…³é—­äº† c = ctl.get(); /** * å¿«é€Ÿæ£€æµ‹æ˜¯å¦å‘ç”Ÿçº¿ç¨‹æ± çŠ¶æ€çªå˜ * 1.è‹¥çŠ¶æ€çªå˜ï¼Œé‡æ–°åˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€æ¡ä»¶å’Œæ•°é‡è¾¹ç•Œæ¡ä»¶ * 2.è‹¥çŠ¶æ€ä¸€è‡´ï¼Œåˆ™åªéœ€é‡æ–°åˆ¤æ–­æ•°é‡è¾¹ç•Œæ¡ä»¶ */ if (runStateOf(c) != rs) continue retry; &#125; &#125; /** * è¿™é‡Œæ˜¯addWorkeræ–¹æ³•çš„ä¸€ä¸ªåˆ†å‰²çº¿ * å‰é¢çš„ä»£ç çš„ä½œç”¨æ˜¯å†³å®šäº†çº¿ç¨‹æ± æ¥å—è¿˜æ˜¯æ‹’ç»æ–°å¢å·¥ä½œçº¿ç¨‹ * åé¢çš„ä»£ç çš„ä½œç”¨æ˜¯çœŸæ­£å¼€å§‹æ–°å¢å·¥ä½œçº¿ç¨‹å¹¶å°è£…æˆWorkeræ¥ç€æ‰§è¡Œåç»­æ“ä½œ * PS:è™½ç„¶ç¬”è€…è§‰å¾—è¿™ä¸ªæ–¹æ³•å…¶å®å¯ä»¥æ‹†åˆ†æˆä¸¤ä¸ªæ–¹æ³•çš„(åœ¨break retryçš„ä½ç½®) */ //è®°å½•æ–°å¢çš„å·¥ä½œçº¿ç¨‹æ˜¯å¦å¼€å§‹å·¥ä½œ boolean workerStarted = false; //è®°å½•æ–°å¢çš„workeræ˜¯å¦æˆåŠŸæ·»åŠ åˆ°workersé›†åˆä¸­ boolean workerAdded = false; Worker w = null; try &#123; //å°†æ–°æäº¤çš„ä»»åŠ¡å’Œå½“å‰çº¿ç¨‹å°è£…æˆä¸€ä¸ªWorker w = new Worker(firstTask); //è·å–æ–°åˆ›å»ºçš„å®é™…å·¥ä½œçº¿ç¨‹ final Thread t = w.thread; /** * æ£€æµ‹æ˜¯å¦æœ‰å¯æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼Œå³æ˜¯å¦æˆåŠŸåˆ›å»ºäº†æ–°çš„å·¥ä½œçº¿ç¨‹ * 1.è‹¥å­˜åœ¨ï¼Œåˆ™é€‰æ‹©æ‰§è¡Œä»»åŠ¡ * 2.è‹¥ä¸å­˜åœ¨ï¼Œåˆ™éœ€è¦æ‰§è¡ŒaddWorkerFailed()æ–¹æ³• */ if (t != null) &#123; /** * æ–°å¢å·¥ä½œçº¿ç¨‹éœ€è¦åŠ å…¨å±€é” * ç›®çš„æ˜¯ä¸ºäº†ç¡®ä¿å®‰å…¨æ›´æ–°workersé›†åˆå’ŒlargestPoolSize */ final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; /** * è·å¾—å…¨å±€é”åï¼Œéœ€å†æ¬¡æ£€æµ‹å½“å‰çº¿ç¨‹æ± çŠ¶æ€ * åŸå› åœ¨äºé¢„é˜²ä¸¤ç§éæ³•æƒ…å†µï¼š * 1.çº¿ç¨‹å·¥å‚åˆ›å»ºçº¿ç¨‹å¤±è´¥ * 2.åœ¨é”è¢«è·å–ä¹‹å‰ï¼Œçº¿ç¨‹æ± å°±è¢«å…³é—­äº† */ int rs = runStateOf(ctl.get()); /** * åªæœ‰ä¸¤ç§æƒ…å†µæ˜¯å…è®¸æ·»åŠ workè¿›å…¥worksé›†åˆçš„ * ä¹Ÿåªæœ‰è¿›å…¥workersé›†åˆåæ‰æ˜¯çœŸæ­£çš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶å¼€å§‹æ‰§è¡Œä»»åŠ¡ * 1.çº¿ç¨‹æ± çŠ¶æ€ä¸ºRUNNING(å³rs&lt;SHUTDOWN) * 2.çº¿ç¨‹æ± çŠ¶æ€ä¸ºSHUTDOWNä¸”ä¼ å…¥ä¸€ä¸ªç©ºä»»åŠ¡ * (ç†ç”±å‚è§ï¼šå°é—®ç­”ä¹‹å¿«é€Ÿæ£€æµ‹çº¿ç¨‹æ± çŠ¶æ€?) */ if (rs &lt; SHUTDOWN || (rs == SHUTDOWN &amp;&amp; firstTask == null)) &#123; /** * è‹¥çº¿ç¨‹å¤„äºæ´»åŠ¨çŠ¶æ€æ—¶ï¼Œè¯´æ˜çº¿ç¨‹å·²å¯åŠ¨ï¼Œéœ€è¦ç«‹å³æŠ›å‡º\"çº¿ç¨‹çŠ¶æ€éæ³•å¼‚å¸¸\" * åŸå› æ˜¯çº¿ç¨‹æ˜¯åœ¨åé¢æ‰è¢«startçš„ï¼Œå·²è¢«startçš„ä¸å…è®¸å†è¢«æ·»åŠ åˆ°workersé›†åˆä¸­ * æ¢å¥è¯è¯´è¯¥æ–¹æ³•æ–°å¢çº¿ç¨‹æ—¶ï¼Œè€Œçº¿ç¨‹æ˜¯æ–°çš„ï¼Œæœ¬èº«åº”è¯¥æ˜¯åˆå§‹çŠ¶æ€(new) * å¯èƒ½å‡ºç°çš„åœºæ™¯ï¼šè‡ªå®šä¹‰çº¿ç¨‹å·¥å‚newThreadæœ‰å¯èƒ½ä¼šæå‰å¯åŠ¨çº¿ç¨‹ */ if (t.isAlive()) throw new IllegalThreadStateException(); //ç”±äºåŠ é”ï¼Œæ‰€ä»¥å¯ä»¥æ”¾å¿ƒçš„åŠ å…¥é›†åˆ workers.add(w); int s = workers.size(); //æ›´æ–°æœ€å¤§å·¥ä½œçº¿ç¨‹æ•°ï¼Œç”±äºæŒæœ‰é”ï¼Œæ‰€ä»¥æ— éœ€CAS if (s &gt; largestPoolSize) largestPoolSize = s; //ç¡®è®¤æ–°å»ºçš„workerå·²è¢«æ·»åŠ åˆ°workersé›†åˆä¸­ workerAdded = true; &#125; &#125; finally &#123; //åƒä¸‡ä¸è¦å¿˜è®°ä¸»åŠ¨è§£é” mainLock.unlock(); &#125; /** * ä¸€æ—¦æ–°å»ºå·¥ä½œçº¿ç¨‹è¢«åŠ å…¥å·¥ä½œçº¿ç¨‹é›†åˆä¸­ï¼Œå°±æ„å‘³ç€å…¶å¯ä»¥å¼€å§‹å¹²æ´»äº† * æœ‰å¿ƒçš„æ‚¨è‚¯å®šå‘ç°åœ¨çº¿ç¨‹startä¹‹å‰å·²ç»é‡Šæ”¾é”äº† * åŸå› åœ¨äºä¸€æ—¦workerAddedä¸ºtrueæ—¶ï¼Œè¯´æ˜é”çš„ç›®çš„å·²ç»è¾¾åˆ° * æ ¹æ®æœ€å°åŒ–é”ä½œç”¨åŸŸçš„åŸåˆ™ï¼Œçº¿ç¨‹æ‰§è¡Œä»»åŠ¡æ— é¡»åŠ é”ï¼Œè¿™æ˜¯ç§ä¼˜åŒ– * ä¹Ÿå¸Œæœ›æ‚¨åœ¨ä½¿ç”¨é”æ—¶å°½é‡ä¿è¯é”çš„ä½œç”¨åŸŸæœ€å°åŒ– */ if (workerAdded) &#123; /** * å¯åŠ¨çº¿ç¨‹ï¼Œå¼€å§‹å¹²æ´»å•¦ * è‹¥æ‚¨çœ‹è¿‡ç¬”è€…çš„\"å¹¶å‘ç•ª@Threadä¸€æ–‡é€š\"è‚¯å®šçŸ¥é“start()åï¼Œ * ä¸€æ—¦çº¿ç¨‹åˆå§‹åŒ–å®Œæˆä¾¿ä¼šç«‹å³è°ƒç”¨run()æ–¹æ³• */ t.start(); //ç¡®è®¤è¯¥å·¥ä½œçº¿ç¨‹å¼€å§‹å¹²æ´»äº† workerStarted = true; &#125; &#125; &#125; finally &#123; //è‹¥æ–°å»ºå·¥ä½œçº¿ç¨‹å¤±è´¥æˆ–æ–°å»ºå·¥ä½œçº¿ç¨‹åæ²¡æœ‰æˆåŠŸæ‰§è¡Œï¼Œéœ€è¦åšæ–°å¢å¤±è´¥å¤„ç† if (!workerStarted) addWorkerFailed(w); &#125; //è¿”å›ç»“æœè¡¨æ˜æ–°å»ºçš„å·¥ä½œçº¿ç¨‹æ˜¯å¦å·²å¯åŠ¨æ‰§è¡Œ return workerStarted;&#125; å°é—®ï¼šå¿«é€Ÿæ£€æµ‹çº¿ç¨‹çŠ¶æ€æ—¶ï¼Œæƒ…å†µ1.2ã€2.1ã€2.3çš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ å°ç­”ï¼šåœ¨é˜æ˜è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ˜ç¡®ä¸¤ä¸ªçŸ¥è¯†ç‚¹ï¼š æ–°å¢Workerçš„ç›®çš„æ˜¯å¤„ç†ä»»åŠ¡ï¼Œä»»åŠ¡æ¥æºåˆ†åˆå§‹ä»»åŠ¡å’Œé˜Ÿåˆ—ä»»åŠ¡(å³å‰©ä½™çš„å¾…å¤„ç†ä»»åŠ¡) çº¿ç¨‹æ± åœ¨éRUNNINGçŠ¶æ€ä¸‹æ˜¯ä¸å…è®¸æ¥æ”¶æ–°ä»»åŠ¡çš„ï¼Œæ¢å¥è¯è¯´æ‚¨éƒ½è¦ä¸‹ç­äº†ï¼Œéš¾é“è¿˜æƒ³æ¥æ–°éœ€æ±‚ï¼Ÿ é’ˆå¯¹2.1 - &gt; çº¿ç¨‹æ± çŠ¶æ€==SHUTDOWNï¼Œä½†firstTaskï¼= nullï¼Œä¸å…è®¸æ–°å¢Workerå½“çº¿ç¨‹æ± çŠ¶æ€ä¸ºSHUTDOWNæ—¶ï¼Œç”±äºä¸å…è®¸æ¥æ”¶æ–°ä»»åŠ¡ï¼Œå› æ­¤ä¸€æ—¦firstTaskï¼= nulléœ€è¦ç›´æ¥æ‹’ç» é’ˆå¯¹2.2 - &gt; çº¿ç¨‹æ± çŠ¶æ€==SHUTDOWNï¼Œä¸”firstTask == nullï¼Œ ä½†é˜Ÿåˆ—ä¸ºç©ºï¼Œ ä¸å…è®¸æ–°å¢Workerå½“firstTaskä¸ºnullæ—¶ï¼Œè¯´æ˜è°ƒç”¨addWorker()ç›®çš„ä¸æ˜¯ä¸ºäº†å¤„ç†æ–°å¢ä»»åŠ¡é‚£ä¹ˆå…¶ç›®çš„åº”è¯¥æ˜¯ä¸ºäº†å¤„ç†å‰©ä½™ä»»åŠ¡ï¼Œå³é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œè€Œä¸€æ—¦é˜Ÿåˆ—ä¸ºç©ºï¼Œé‚£ä¹Ÿæ²¡å¿…è¦æ–°å¢Workeräº† é’ˆå¯¹1.2 - &gt; è‹¥çº¿ç¨‹æ± çŠ¶æ€==SHUTDOWNï¼Œå¿…é¡»æ»¡è¶³firstTaskä¸ºnullä¸”é˜Ÿåˆ—éç©ºï¼Œæ‰å…è®¸æ–°å¢Workerå½“çº¿ç¨‹æ± çŠ¶æ€ä¸ºSHUTDOWNæ—¶(è°ƒç”¨shutdown())ï¼Œæ­¤æ—¶ä¸å…è®¸æ¥æ”¶æ–°ä»»åŠ¡ï¼Œå› æ­¤firstTaskå¿…é¡»ä¸ºnullä½†éœ€è¦å¤„ç†å‰©ä½™ä»»åŠ¡ï¼Œå› æ­¤é˜Ÿåˆ—å¿…é¡»éç©ºï¼Œå¦åˆ™æ–°å¢çš„å·¥ä½œçº¿ç¨‹å°±æ— ä»»åŠ¡å¯åšï¼Œé‚£å°±æ²¡æ„ä¹‰äº†ç»“è®ºï¼šä¼ å…¥ä¸€ä¸ªç©ºä»»åŠ¡çš„ç›®çš„æ˜¯ä¸ºäº†æ–°å¢å·¥ä½œçº¿ç¨‹å»å¤„ç†ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„å‰©ä½™ä»»åŠ¡ 3. Workerç±»è¯¦è§£workeråŒ…è£…äº†ä»»åŠ¡çš„è°ƒåº¦ï¼Œç”¨äºå°è£…å·¥ä½œçº¿ç¨‹å’Œä»»åŠ¡å¹¶ç®¡ç†å·¥ä½œçº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ç­‰åŠŸèƒ½ ç”±äºå·¥ä½œçº¿ç¨‹å’Œworkerå®ä¾‹æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œå› ä¸ºå¯ä»¥ç®€å•çš„ç†è§£å·¥ä½œçº¿ç¨‹ç­‰ä»·äºworkerï¼Œå°¤å…¶æ˜¯è°ˆåŠæ•°é‡æ—¶ï¼Œæ¯”å¦‚åˆ›å»ºå·¥ä½œçº¿ç¨‹å®é™…ä¸Šå°±æ˜¯åˆ›å»ºä¸€ä¸ªworker çº¿ç¨‹åœ¨çº¿ç¨‹æ± æ‰§è¡Œä»»åŠ¡çš„å·¥ä½œæµç¨‹ï¼š å·¥ä½œçº¿ç¨‹å¼€å§‹æ‰§è¡Œå‰ï¼Œéœ€å…ˆå¯¹workeråŠ é”ï¼Œä»»åŠ¡å®Œæˆè§£é” ä»»åŠ¡æ‰§è¡Œå‰ååˆ†åˆ«æ‰§è¡ŒbeforeExecute()å’ŒafterExecute()æ–¹æ³• æ‰§è¡Œä¸­é‡åˆ°å¼‚å¸¸ä¼šå‘å¤–æŠ›å‡ºï¼Œçº¿ç¨‹æ˜¯å¦æ­»äº¡å–å†³äºæ‚¨å¯¹äºå¼‚å¸¸çš„å¤„ç† æ¯ä¸ªä»»åŠ¡æ‰§è¡Œå®Œåï¼Œå½“å‰å·¥ä½œçº¿ç¨‹ä»»åŠ¡å®Œæˆæ•°è‡ªå¢ï¼ŒåŒæ—¶ä¼šå¾ªç¯è°ƒç”¨getTask()ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­åå¤è·å–ä»»åŠ¡å¹¶æ‰§è¡Œï¼Œæ— ä»»åŠ¡å¯æ‰§è¡Œæ—¶çº¿ç¨‹ä¼šé˜»å¡åœ¨è¯¥æ–¹æ³•ä¸Š å½“å·¥ä½œçº¿ç¨‹å› å„ç§ç†ç”±é€€å‡ºæ—¶ï¼Œä¼šæ‰§è¡ŒprocessWorkerExit()å›æ”¶çº¿ç¨‹(æ ¸å¿ƒæ˜¯å°†è¯¥workerä»workersé›†åˆä¸­ç§»é™¤ï¼Œæ³¨æ„ä¹‹å‰workerå·²ç»é€€å‡ºä»»åŠ¡å¾ªç¯ï¼Œå› æ­¤å·²ç»ä¸å†åšå·¥äº†ï¼Œä»é›†åˆç§»é™¤åå°±æ–¹ä¾¿gcäº†) é—®ï¼šworkerä¸­æ–­å¦‚ä½•æ§åˆ¶çš„ å½“å·¥ä½œçº¿ç¨‹çœŸæ­£å¼€å§‹æ‰§è¡Œä¹‹å‰ï¼Œä¸å…è®¸è¢«ä¸­æ–­ å½“å·¥ä½œçº¿ç¨‹æ­£åœ¨æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œä¸å…è®¸è¢«ä¸­æ–­ å½“å·¥ä½œçº¿ç¨‹æ­£ç­‰å¾…ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡getTask()æ—¶æ‰èƒ½è¢«ä¸­æ–­ è°ƒç”¨interruptIdleWorkers()ä¸­æ–­ç©ºé—²çº¿ç¨‹æ—¶å¿…é¡»å…ˆè·å¾—workeré” é—®ï¼šä¸ºä»€ä¹ˆWorkerä¸è¢«è®¾è®¡æˆå¯é‡å…¥é”ï¼Ÿ ç”±äºåœ¨åŠ¨æ€æ§åˆ¶æ–¹æ³•ä¸­å¯èƒ½ä¼šä¸­æ–­çº¿ç¨‹ï¼Œæ¯”å¦‚è°ƒç”¨interruptIdleWorkers()ï¼Œç”±æ­¤è¯¥æ–¹æ³•åœ¨æ‰§è¡Œinterrupt()ä¹‹å‰ä¼šè°ƒç”¨worker.tryLock()ï¼Œè‹¥æ­¤æ—¶å…è®¸é‡å…¥ï¼Œå°±ä¼šå¯¼è‡´çº¿ç¨‹è¢«æ„å¤–ä¸­æ–­ï¼Œè¿™è·Ÿå½“å·¥ä½œçº¿ç¨‹æ­£åœ¨æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œä¸å…è®¸è¢«ä¸­æ–­å‡†åˆ™æ˜¯ç›¸è¿èƒŒçš„ IV. é—®é¢˜è§£ç­”1. å¦‚ä½•åˆ›å»ºçº¿ç¨‹æ± ç›´æ¥æ ¹æ®æ„é€ æ–¹æ³•åˆ›å»º 12345java.util.concurrent.ThreadPoolExecutor#ThreadPoolExecutor(int, int, long, java.util.concurrent.TimeUnit, java.util.concurrent.BlockingQueue&lt;java.lang.Runnable&gt;, java.util.concurrent.ThreadFactory, java.util.concurrent.RejectedExecutionHandler) åˆ©ç”¨ Executors åˆ›å»ºçº¿ç¨‹æ±  12345678910111213java.util.concurrent.Executors#newFixedThreadPool(int)java.util.concurrent.Executors#newWorkStealingPool(int)java.util.concurrent.Executors#newSingleThreadExecutor()java.util.concurrent.Executors#newCachedThreadPool()java.util.concurrent.Executors#newSingleThreadScheduledExecutor()java.util.concurrent.Executors#newScheduledThreadPool(int)java.util.concurrent.Executors#unconfigurableExecutorService 2. çº¿ç¨‹æ± çš„é€‚ç”¨åœºæ™¯ä¼˜ç‚¹ å‡å°‘äº†åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹çš„æ¬¡æ•°ï¼Œæ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½å¯ä»¥è¢«é‡å¤åˆ©ç”¨ï¼Œå¯æ‰§è¡Œå¤šä¸ªä»»åŠ¡å¯ä»¥æ ¹æ®ç³»ç»Ÿçš„æ‰¿å—èƒ½åŠ›ï¼Œè°ƒæ•´çº¿ç¨‹æ± ä¸­å·¥ä½œçº¿çº¿ç¨‹çš„æ•°é‡ ä½¿ç”¨çº¿ç¨‹æ± åœºæ™¯ æˆ‘ä»¬å°†çº¿ç¨‹è¿›è¡Œæ‹†åˆ†ï¼Œåˆ›å»ºçº¿ç¨‹è€—æ—¶T1, çº¿ç¨‹æ‰§è¡Œè€—æ—¶T2, é”€æ¯çº¿ç¨‹è€—æ—¶T3 å¦‚æœä½ çš„åœºæ™¯ä¸­ï¼Œæäº¤çº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡éå¸¸é¢‘ç¹ï¼Œä¸”å…·ä½“çš„æ‰§è¡Œè€—æ—¶è¾ƒçŸ­ï¼Œå³ T1 + T3 &gt; T2, è¿™ç§åœºæ™¯ä¸‹ä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥å¸¦æ¥æ˜æ˜¾çš„æ€§èƒ½æå‡ ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœä¸æ˜¯ä½ çš„ä»»åŠ¡åªå¶å°”çš„è¿è¡Œå‡ æ¬¡ï¼Œé‚£ä¹ˆç»å¤§éƒ¨åˆ†åœºæ™¯éƒ½é€‚åˆç”¨çº¿ç¨‹æ± æ¥å¤„ç† 3. å¦‚ä½•ä½¿ç”¨çº¿ç¨‹æ± åˆ›å»ºçº¿ç¨‹æ± ï¼Œæäº¤ä»»åŠ¡ execute é€‚ç”¨äºæäº¤æ²¡æœ‰è¿”å›ç»“æœçš„ä»»åŠ¡ submit é€‚ç”¨äºæäº¤æœ‰è¿”å›ç»“æœçš„ä»»åŠ¡ï¼Œ è¿”å›ä¸€ä¸ªFutrureçš„åŒ…è£…ç±» 4. çº¿ç¨‹æ± å®ç°åŸç† &amp; ä»»åŠ¡æäº¤åçš„æµç¨‹åœ¨å®ç°åŸç†ä¸­ä¼šç©¿æ’ä¸Šä»»åŠ¡æäº¤åçš„æµç¨‹ï¼Œæ‰€ä»¥å°±æ”¾åœ¨ä¸€èµ·äº† é¦–å…ˆä»æäº¤ä¸€ä¸ªä»»åŠ¡å¼€å§‹ï¼š é¦–å…ˆåˆ¤æ–­å·¥ä½œçº¿ç¨‹æ•°æ˜¯å¦å°äºæ ¸å¿ƒå·¥ä½œçº¿ç¨‹æ•°ï¼Œæ˜¯åˆ™ç›´æ¥åˆ›å»ºå·¥ä½œçº¿ç¨‹æ‰§è¡Œ å¦ï¼Œåˆ™å°†ä»»åŠ¡ä¸¢å…¥ä»»åŠ¡é˜Ÿåˆ—ä¸­ è‹¥ä»»åŠ¡é˜Ÿåˆ—å·²æ»¡ï¼Œä¸”å·¥ä½œçº¿ç¨‹æ•° &lt; æœ€å¤§å·¥ä½œçº¿ç¨‹æ•°ï¼Œåˆ™ç›´æ¥åˆ›å»ºå·¥ä½œçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ è‹¥é˜Ÿåˆ—æ»¡ï¼Œä¸”å·¥ä½œçº¿ç¨‹æ•°è¾¾åˆ°æœ€å¤§å€¼ï¼Œåˆ™é‡‡ç”¨æ‹’ç»ä»»åŠ¡ç­–ç•¥ å…¶ä¸­ä¸Šé¢çš„ä»»åŠ¡è¿›é˜Ÿoråˆ›å»ºçº¿ç¨‹æ‰§è¡Œï¼Œéƒ½éœ€è¦å…³æ³¨çº¿ç¨‹æ± çš„çŠ¶æ€ï¼Œæ¯ä¸ªçŠ¶æ€å¯¹åº”çš„åŸåˆ™ çŠ¶æ€ è¯´æ˜ é™åˆ¶ RUNNING è¿è¡ŒçŠ¶æ€ çº¿ç¨‹æ± ä¼šæ¥æ”¶æ–°æäº¤ä»»åŠ¡å’Œæ‰§è¡Œé˜Ÿåˆ—ä»»åŠ¡ SHUTDOWN å…³é—­çŠ¶æ€ çº¿ç¨‹æ± ä¸å†æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†è¿˜ä¼šç»§ç»­æ‰§è¡Œé˜Ÿåˆ—ä»»åŠ¡ STOP åœæ­¢çŠ¶æ€ ä¸å†æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä¸ä¼šå†æ‰§è¡Œé˜Ÿåˆ—ä»»åŠ¡ï¼Œå¹¶ä¼šä¸­æ–­æ­£åœ¨æ‰§è¡Œä¸­çš„ä»»åŠ¡ TIDYING æ•´ç†çŠ¶æ€ æ‰€æœ‰ä»»åŠ¡éƒ½è¢«ç»ˆæ­¢ï¼Œå·¥ä½œçº¿ç¨‹æ•°ä¸º0ï¼ŒæœŸé—´ä¼šè°ƒç”¨é’©å­æ–¹æ³•terminated() TERMINATED ç»ˆæ­¢çŠ¶æ€ çº¿ç¨‹æ± terminated()æ–¹æ³•å·²ç»è°ƒç”¨å®Œæˆ æ¥ç€ä¸Šé¢ï¼Œå·¥ä½œçº¿ç¨‹æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œä¼šå°è¯•ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡æ¥æ‰§è¡Œï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™é˜»å¡ï¼›æ­¤æ—¶å·¥ä½œçº¿ç¨‹ç©ºé—² æ ¹æ®å·¥ä½œçº¿ç¨‹çš„å›æ”¶æœºåˆ¶ å…è®¸å›æ”¶æ ¸å¿ƒå·¥ä½œçº¿ç¨‹æ—¶ï¼Œå°†æ‰€æœ‰ç©ºé—²æ—¶é—´å¤§äºkeepAliveTimeçš„çº¿ç¨‹å›æ”¶æ‰ ä¸å…è®¸å›æ”¶æ ¸å¿ƒå·¥ä½œçº¿ç¨‹ï¼Œå›æ”¶ç©ºé—²æ—¶é—´å¤§äºkeepAliveTimeçš„çº¿ç¨‹ï¼ŒçŸ¥é“å·¥ä½œçº¿ç¨‹æ•°é‡ä¸ºæ ¸å¿ƒå·¥ä½œçº¿ç¨‹æ•° 5. å¼‚å¸¸çŠ¶å†µå¤„ç†submit()å¼‚å¸¸å¤„ç† å¼‚å¸¸ä¼šä¿å­˜åœ¨Futureå¯¹è±¡çš„ExecutionExceptionä¸­ï¼Œå¯ä»¥åœ¨è°ƒç”¨get()ä½¿ç”¨try-catchæ–¹å¼æ•è·ï¼Œæœ‰Nä¸ªä»»åŠ¡æœ‰å¼‚å¸¸å°±ä¼šæŠ›å‡ºæ¥Nä¸ªå¼‚å¸¸ï¼Œä½†ä¸ä¼šç»ˆæ­¢å½“å‰å·¥ä½œçº¿ç¨‹ å•ç‹¬è®¾ç½®UncaughtExceptionHandleræ²¡åµç”¨ï¼Œä½†ç»“åˆ(3)ä½¿ç”¨å°±æœ‰æ•ˆ å…è®¸åœ¨submit()æ–¹æ³•å†…éƒ¨ç”¨try-catchæ•è·è¯¥å¼‚å¸¸ï¼ŒåŒæ ·ä¸ä¼šç»ˆæ­¢å½“å‰çº¿ç¨‹ è‹¥æƒ³åœ¨å†…éƒ¨å¤„ç†å¼‚å¸¸ï¼Œè¿˜å¯ä»¥é‡å†™afterExecute()æ–¹æ³•ï¼Œ execute()å¼‚å¸¸å¤„ç† é»˜è®¤ä¼šåœ¨execute()æ–¹æ³•å†…éƒ¨ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œæ³¨æ„è¿™ä¸ä¼šä¸­æ–­çº¿ç¨‹æ± è¿è¡Œï¼Œä½†ä¼šç»ˆæ­¢å½“å‰å·¥ä½œçº¿ç¨‹ï¼Œå¹¶é‡æ–°åˆ›å»ºæ–°çš„å·¥ä½œçº¿ç¨‹æ‰§è¡Œè¯¥ä»»åŠ¡ å…è®¸åœ¨execute()æ–¹æ³•å†…éƒ¨ç”¨try-catchæ•è·è¯¥å¼‚å¸¸ï¼Œå¥½å¤„æ˜¯ä¸ä¼šç»ˆæ­¢å½“å‰çº¿ç¨‹å¹¶é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹äº† é‡å†™afterExecute()æ–¹æ³• è¿˜å¯ä»¥è®¾ç½®UncaughtExceptionHandler ä¸€ä¸ªå®ä¾‹å¦‚ä¸‹: 1234567891011ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor(1, 2, 3, TimeUnit.SECONDS, new LinkedBlockingQueue(), //æˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªçº¿ç¨‹å·¥å‚å’Œé‡å†™çº¿ç¨‹çš„setUncaughtExceptionHandleræ–¹æ³• new ThreadFactory() &#123; final AtomicInteger threadNumber = new AtomicInteger(1); public Thread newThread(Runnable r) &#123; Thread thread = new Thread(Thread.currentThread().getThreadGroup(), r, \"thread-\" + (threadNumber.getAndIncrement())); thread.setUncaughtExceptionHandler((t,e) -&gt; System.out.println(e)); return thread; &#125;&#125;); 6. çº¿ç¨‹æ± å…³é—­å…³é—­çº¿ç¨‹æ± ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸¤è€…çš„åŒºåˆ«æ˜¯ï¼š shutdown() : é˜Ÿåˆ—å‰©ä½™ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæ¯•å†ç»ˆæ­¢ shutdownNow() : æ”¾å¼ƒæ‰§è¡Œé˜Ÿåˆ—å‰©ä½™ä»»åŠ¡ï¼Œä½†ä¼šå°†å®ƒä»¬è¿”å› ä¸¤è€…çš„å…±æ€§åœ¨äºï¼š æ­£åœ¨æ‰§è¡Œä¸­çš„ä»»åŠ¡ä¼šç»§ç»­æ‰§è¡Œï¼Œä¸ä¼šè¢«ç»ˆæ­¢æˆ–æ”¾å¼ƒ æ–°æäº¤çš„ä»»åŠ¡ä¼šè¢«ç›´æ¥æ‹’ç» V. å…¶ä»–å‚è€ƒ Java-çº¿ç¨‹æ± ä¸“é¢˜ï¼ˆä»€ä¹ˆæ˜¯çº¿ç¨‹æ± ï¼Œå¦‚ä½•ä½¿ç”¨ï¼Œä¸ºä»€ä¹ˆè¦ç”¨ï¼‰ å¹¶å‘ç•ª@ThreadPoolExecutor ä¸ªäººåšå®¢ï¼š Z+|blogåŸºäºhexo + github pagesæ­å»ºçš„ä¸ªäººåšå®¢ï¼Œè®°å½•æ‰€æœ‰å­¦ä¹ å’Œå·¥ä½œä¸­çš„åšæ–‡ï¼Œæ¬¢è¿å¤§å®¶å‰å»é€›é€› å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è¯†æœ‰é™ï¼Œå¦‚å‘ç°bugæˆ–è€…æœ‰æ›´å¥½çš„å»ºè®®ï¼Œéšæ—¶æ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼Œæˆ‘çš„å¾®åšåœ°å€: å°ç°ç°Blog æ‰«æå…³æ³¨","categories":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"Concurrency","slug":"Java/Concurrency","permalink":"https://zbang.online/hexblog/categories/Java/Concurrency/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"å¹¶å‘","slug":"å¹¶å‘","permalink":"https://zbang.online/hexblog/tags/å¹¶å‘/"},{"name":"ThreadPoolExecutor","slug":"ThreadPoolExecutor","permalink":"https://zbang.online/hexblog/tags/ThreadPoolExecutor/"}],"keywords":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"Concurrency","slug":"Java/Concurrency","permalink":"https://zbang.online/hexblog/categories/Java/Concurrency/"}]},{"title":"7. æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹é»˜è®¤æŠ¥è­¦è§„åˆ™æ‰©å±•","slug":"æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹é»˜è®¤æŠ¥è­¦è§„åˆ™æ‰©å±•","date":"2018-03-05T04:25:00.000Z","updated":"2018-03-05T12:31:01.015Z","comments":true,"path":"2018/03/05/æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹é»˜è®¤æŠ¥è­¦è§„åˆ™æ‰©å±•/","link":"","permalink":"https://zbang.online/hexblog/2018/03/05/æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹é»˜è®¤æŠ¥è­¦è§„åˆ™æ‰©å±•/","excerpt":"æœ¬ç¯‡ä¸»è¦æ˜¯æ‰©å±•é»˜è®¤çš„æŠ¥è­¦è§„åˆ™ï¼Œä½¿å…¶èƒ½æ›´åŠ å‹å¥½çš„æ”¯æŒåŒæ—¶é€‰æ‹©å¤šç§æŠ¥è­¦æ–¹å¼ æ‰©å±•éµå¾ªä¸¤ä¸ªåŸåˆ™ ä¸å½±å“åŸæœ‰çš„é…ç½®æ–‡ä»¶æ ¼å¼ ç®€åŒ–è§„åˆ™è§£æå¤æ‚åº¦","text":"æœ¬ç¯‡ä¸»è¦æ˜¯æ‰©å±•é»˜è®¤çš„æŠ¥è­¦è§„åˆ™ï¼Œä½¿å…¶èƒ½æ›´åŠ å‹å¥½çš„æ”¯æŒåŒæ—¶é€‰æ‹©å¤šç§æŠ¥è­¦æ–¹å¼ æ‰©å±•éµå¾ªä¸¤ä¸ªåŸåˆ™ ä¸å½±å“åŸæœ‰çš„é…ç½®æ–‡ä»¶æ ¼å¼ ç®€åŒ–è§„åˆ™è§£æå¤æ‚åº¦ I. é…ç½®æ–‡ä»¶çš„æ‰©å±•å…ˆçœ‹ä¸€ä¸‹åŸæœ‰çš„é…ç½®æ–‡ä»¶ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748&#123; \"default\": &#123; \"level\": \"NONE\", \"autoIncEmergency\": true, \"max\": 30, \"min\": 3, \"threshold\": [ &#123; \"level\": \"LOG\", \"threshold\": 5, \"users\": [ \"yihui\", \"erhui\" ] &#125; ], \"users\": [ \"yihui\" ] &#125;, \"NPE,SELFDEFINE\": &#123; \"level\": \"LOG\", \"autoIncEmergency\": false, \"max\": 30, \"min\": 0, \"threshold\": [ &#123; \"level\": \"SMS\", \"threshold\": 20, \"users\": [ \"345345345345\", \"123123123123\" ] &#125;, &#123; \"level\": \"WEIXIN\", \"threshold\": 10, \"users\": [ \"å°ç°ç°Blog\", \"greyBlog\" ] &#125; ], \"users\": [ \"yihui\" ] &#125;&#125; æˆ‘ä»¬å¸Œæœ›æ˜¯èƒ½å¤Ÿæ”¯æŒå¤šé‡æŠ¥è­¦æ–¹å¼åŒæ—¶é€‰ä¸­ï¼Œé‚£ä¹ˆä¸Šé¢çš„é…ç½®ä¸­ï¼Œ thresholdä¸­åªå®šä¹‰äº†ä¸€ä¸ªé˜€å€¼å‚æ•°æ˜¾ç„¶æ˜¯ä¸åˆé€‚çš„ï¼Œä¸»è¦é—®é¢˜åœ¨äº å•ä¸€é˜€å€¼ï¼Œä¸å…è®¸ä¸åŒæŠ¥è­¦æ–¹å¼å­˜åœ¨äº¤å‰ ä¸¤ä¸ªæŠ¥è­¦æ–¹å¼çš„thresholdå€¼ç›¸ç­‰æ—¶ï¼Œé€‰ä¸­çš„å…·ä½“æ˜¯å“ªä¸ªä¸å¯é¢„æœŸ æ‰€ä»¥æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å°†ä¸Šé¢çš„å‚æ•°ä¸­ï¼Œæ–°å¢ä¸€ä¸ªæŒ‡å®šä¸Šé™çš„å€¼max 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485&#123; \"default\": &#123; \"level\": \"NONE\", \"autoIncEmergency\": true, \"max\": 30, \"min\": 3, \"threshold\": [ &#123; \"level\": \"LOG\", \"threshold\": 5, \"users\": [ \"yihui\", \"erhui\" ] &#125; ], \"users\": [ \"yihui\" ] &#125;, \"NPE,SELFDEFINE\": &#123; \"level\": \"LOG\", \"autoIncEmergency\": false, \"max\": 30, \"min\": 0, \"threshold\": [ &#123; \"level\": \"SMS\", \"threshold\": 20, \"users\": [ \"345345345345\", \"123123123123\" ] &#125;, &#123; \"level\": \"WEIXIN\", \"threshold\": 10, \"users\": [ \"å°ç°ç°Blog\", \"greyBlog\" ] &#125; ], \"users\": [ \"yihui\" ] &#125;, \"ZZZ\": &#123; \"level\": \"LOG\", \"autoIncEmergency\": true, \"max\": 30, \"min\": 3, \"threshold\": [ &#123; \"level\": \"SMS\", \"threshold\": 20, \"max\": 27, \"users\": [ \"345345345345\", \"123123123123\" ] &#125;, &#123; \"level\": \"WEIXIN\", \"threshold\": 10, \"users\": [ \"yihui\", \"erhui\" ] &#125;, &#123; \"level\": \"EMAIL\", \"threshold\": 9, \"max\": 14, \"users\": [ \"yihui@xxx.com\", \"erhui@xxx.com\" ] &#125; ], \"users\": [ \"yihui@xxx.com\" ] &#125;&#125; å‘ä¸Šé¢è¿™èˆ¬æ”¹åŠ¨ä¹‹åï¼Œç›¸å½“äºæ¯ä¸ªæŠ¥è­¦æ–¹å¼éƒ½å¯ä»¥å®šä¹‰è‡ªå·±çš„åŒºé—´ï¼Œå› æ­¤å…è®¸å¤šé‡æŠ¥è­¦æ–¹å¼å­˜åœ¨åŒºé—´çš„äº¤å‰ï¼Œè®¡æ•°åœ¨äº¤å‰åŒºé—´å³è¡¨ç¤ºé€‰ä¸­è¿™å¤šé‡æ–¹å¼ II. æ‰©å±•çš„å®ç°æ”¯æŒä»é…ç½®æ–‡ä»¶çš„å˜åŠ¨æ¥çœ‹ï¼Œæ”¹åŠ¨å¾ˆå°ï¼Œåªæ˜¯æ–°å¢ä¸€ä¸ªå‚æ•°è€Œå·²ï¼Œä¸”è¿™ä¸ªå‚æ•°ä¸æ˜¯å¿…å¡«çš„ï¼Œé‚£ä¹ˆå¯¹åº”çš„doåº”è¯¥ä¸º 123456789101112131415161718192021222324public class BasicAlarmThreshold &#123; private String level; /** * å¯ç”¨å®šä¹‰çš„æŠ¥è­¦æ–¹å¼çš„é˜€å€¼ä¸‹é™ï¼Œ * * å½“æŠ¥è­¦è®¡æ•° count &gt;= min * - max énull, count &lt; max åˆ™é€‰æ‹©æœ¬æŠ¥è­¦æ–¹å¼; * count &gt;= max åˆ™ä¸é€‰æ‹©æœ¬æŠ¥è­¦æ–¹å¼ * - max ä¸ºnullï¼ˆå³è¡¨ç¤ºä¸ºå®šä¹‰æ—¶ï¼‰ï¼Œ * åˆ™maxèµ‹å€¼ä¸º:æ°å¥½å¤§äº min çš„ &#123;@link BasicAlarmThreshold#threshold&#125;å€¼ * */ private int threshold; /** * æŠ¥è­¦ä¸Šé™å€¼ï¼Œæ³¨æ„è¿™æ˜¯åŒ…è£…ç±»å‹ï¼Œå…è®¸ä¸ºnull */ private Integer max; private List&lt;String&gt; users;&#125; ç„¶åé¡ºå¸¦ç€ï¼Œä¼˜åŒ–ä¸€æŠŠæˆ‘ä»¬çš„æ˜ å°„è§„åˆ™ï¼Œå°†é…ç½®è§„åˆ™çš„DOå¯¹è±¡ï¼Œæ˜ å°„ä¸ºä¸šåŠ¡å¯¹è±¡ ä¸»è¦çš„æ˜ å°„è§„åˆ™å¦‚ä¸‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990/** * å°†é…ç½®é¡¹è½¬æ¢ä¸ºä¸šåŠ¡DOå¯¹è±¡, ä¼šåšä¸€äº›å…¼å®¹, ä¿è¯ level. min, max, users, thresholds éƒ½ä¸ä¼šä¸ºnull * * @param basicAlarmConfig * @return */private static AlarmConfig parse2BizConfig(BasicAlarmConfig basicAlarmConfig) &#123; if (basicAlarmConfig.getUsers() == null || basicAlarmConfig.getUsers().isEmpty()) &#123; // å¦‚æœæ²¡æœ‰å¡«å†™ç”¨æˆ·, åˆ™ç›´æ¥æŠ›å¼ƒ return null; &#125; AlarmConfig alarmConfig = new AlarmConfig(); // å¦‚æœé…ç½®çš„æŠ¥è­¦ç±»å‹æ˜¯å¼‚å¸¸çš„, åˆ™ä¸‹é¢ä¼šå…¼å®¹ä¸€æŠŠï¼Œè®¾ç½®ä¸º NONE, é¿å…å› ä¸ºé…ç½®çš„åŸå› å¯¼è‡´ç³»ç»Ÿå¼‚å¸¸ alarmConfig.setExecutor(SimpleExecuteFactory.getExecute(basicAlarmConfig.getLevel())); alarmConfig.setAutoIncEmergency(basicAlarmConfig.isAutoIncEmergency()); // æŠ¥è­¦ç”¨æˆ·, è¦æ±‚ç”¨æˆ·å¿…é¡»å­˜åœ¨ alarmConfig.setUsers(basicAlarmConfig.getUsers()); // æŠ¥è­¦ä¸Šé™, å¦‚æœç”¨æˆ·æ²¡æœ‰å¡«å†™ï¼Œé‡‡ç”¨é»˜è®¤çš„ï¼ˆå› ä¸ºçŸ­ä¿¡æŠ¥è­¦æŒ‰æ¡æ•°è¦é’±, æ²¡å¿…è¦ä¸€ç›´æ— ä¸Šé™çš„æŠ¥ï¼‰ alarmConfig.setMaxLimit(basicAlarmConfig.getMax() == null ? AlarmConfig.DEFAULT_MAX_NUM : basicAlarmConfig.getMax()); // æŠ¥è­¦ä¸‹é™, å¦‚æœç”¨æˆ·æ²¡æœ‰å¡«å†™, é‡‡ç”¨é»˜è®¤çš„æœ€å°å€¼0 alarmConfig.setMinLimit(basicAlarmConfig.getMin() == null ? AlarmConfig.DEFAULT_MIN_NUM : basicAlarmConfig.getMin()); // è·å–é…ç½®ä¸­çš„é˜€å€¼åˆ—è¡¨ï¼Œå¹¶æ’åº List&lt;BasicAlarmThreshold&gt; basicAlarmThresholdList = basicAlarmConfig.getThreshold(); if(basicAlarmThresholdList == null) &#123; basicAlarmThresholdList = Collections.emptyList(); &#125; basicAlarmThresholdList.sort(Comparator.comparingInt(BasicAlarmThreshold::getThreshold)); List&lt;AlarmThreshold&gt; alarmThresholdList = new ArrayList&lt;&gt;(basicAlarmThresholdList.size() + 2); AlarmThreshold tmpAlarmThreshold; BasicAlarmThreshold tmpBasicAlarmThreshold; boolean containDefaultExecute = false; for (int i = 0; i &lt; basicAlarmThresholdList.size(); i++) &#123; tmpBasicAlarmThreshold = basicAlarmThresholdList.get(i); tmpAlarmThreshold = new AlarmThreshold(); tmpAlarmThreshold.setExecutor(SimpleExecuteFactory.getExecute(tmpBasicAlarmThreshold.getLevel())); tmpAlarmThreshold.setUsers(tmpBasicAlarmThreshold.getUsers()); tmpAlarmThreshold.setMin(tmpBasicAlarmThreshold.getThreshold()); if (tmpBasicAlarmThreshold.getMax() == null || tmpBasicAlarmThreshold.getMax() &lt;= tmpBasicAlarmThreshold.getThreshold()) &#123; if (i == basicAlarmThresholdList.size() - 1) &#123; // æœ€åä¸€ä¸ªï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„ä¸Šé™é˜€å€¼ tmpAlarmThreshold.setMax(alarmConfig.getMaxLimit()); &#125; else &#123; tmpAlarmThreshold.setMax(basicAlarmThresholdList.get(i + 1).getThreshold()); &#125; &#125; else &#123; tmpAlarmThreshold.setMax(tmpBasicAlarmThreshold.getMax()); &#125; if (!containDefaultExecute) &#123; containDefaultExecute = tmpBasicAlarmThreshold.getLevel().equals(basicAlarmConfig.getLevel()); &#125; alarmThresholdList.add(tmpAlarmThreshold); &#125; int thresholdSize = alarmThresholdList.size(); if (thresholdSize == 0) &#123; // æ²¡æœ‰é…ç½®é˜€å€¼åˆ—è¡¨ï¼Œç›´æ¥ä½¿ç”¨é»˜è®¤ tmpAlarmThreshold = new AlarmThreshold(); tmpAlarmThreshold.setExecutor(alarmConfig.getExecutor()); tmpAlarmThreshold.setUsers(alarmConfig.getUsers()); tmpAlarmThreshold.setMin(alarmConfig.getMinLimit()); tmpAlarmThreshold.setMax(alarmConfig.getMaxLimit()); alarmThresholdList.add(tmpAlarmThreshold); &#125; else if (!containDefaultExecute) &#123; // ä¸åŒ…å«æ—¶é»˜è®¤æ—¶ï¼Œè¡¥å…¨ tmpAlarmThreshold = new AlarmThreshold(); tmpAlarmThreshold.setExecutor(alarmConfig.getExecutor()); tmpAlarmThreshold.setUsers(alarmConfig.getUsers()); tmpAlarmThreshold.setMin(alarmConfig.getMinLimit()); tmpAlarmThreshold.setMax(alarmThresholdList.get(0).getMin()); alarmThresholdList.add(0, tmpAlarmThreshold); if (alarmThresholdList.get(thresholdSize).getMax() &lt; alarmConfig.getMaxLimit()) &#123; tmpAlarmThreshold = new AlarmThreshold(); tmpAlarmThreshold.setExecutor(alarmConfig.getExecutor()); tmpAlarmThreshold.setUsers(alarmConfig.getUsers()); tmpAlarmThreshold.setMin(alarmThresholdList.get(thresholdSize).getMax()); tmpAlarmThreshold.setMax(alarmConfig.getMaxLimit()); alarmThresholdList.add(tmpAlarmThreshold); &#125; &#125; alarmConfig.setAlarmThreshold(alarmThresholdList); return alarmConfig;&#125; åœ¨æ˜ å°„ä¸ºä¸šåŠ¡å¯¹è±¡çš„é€»è¾‘ä¸­ï¼Œç›´æ¥ä¿éšœäº†AlarmThresholdåˆ—è¡¨ä¸­çš„é¡ºåºä¸ºæœ€ç»ˆçš„éœ€æ±‚é¡ºåºï¼Œæ˜ å°„è§„åˆ™ä¸º 123456789101112131415161718192021222324252627/** * å¦‚æœé…ç½®çš„basicAlarmThresholdListåˆ—è¡¨ä¸­åŒ…å«é»˜è®¤çš„æŠ¥è­¦æ–¹å¼ * - åˆ™æŠ¥è­¦æ–¹å¼å®Œå…¨æŒ‰ç…§basicAlarmThresholdListçš„å®šä¹‰æ¥ * - eg: é»˜è®¤æŠ¥è­¦ä¸º Log, min=5, max=30 * - basicAlarmThresholdList ä¸­å®šä¹‰ä¸º : &#123; Log, min=6 &#125;, &#123; Email, min=8 &#125;, &#123; WeiXin, min=10, max=16 &#125;, &#123; SMS, min=14, max=26 &#125; * - åˆ™è½¬æ¢åçš„ alarmThresholdListä¸º: * - &#123; Log, min=6, max=8 &#125;, &#123; Email, min=8, max=10 &#125;, &#123; WeiXin, min=10, max=16 &#125;, &#123; SMS, min=14, max=26 &#125; * - count : [6, 8) Log * - count : [8, 10) Email * - count : [10, 16) WeiXin * - count : [14, 26) SMS * * å¦‚æœä¸åŒ…å«é»˜è®¤æŠ¥è­¦æ–¹å¼ * - åˆ™éœ€è¦è¡¥å…¨æœ€å¤–å±‚å®šä¹‰çš„Min-MaxåŒºé—´ä¸­çš„ç©ºä½™ä½ * - eg: é»˜è®¤æŠ¥è­¦ä¸º Log, min=5, max=30 * - basicAlarmThresholdList ä¸­å®šä¹‰ä¸º : &#123; Email, min=8 &#125;, &#123; WeiXin, min=10, max=16 &#125;, &#123; SMS, min=14, max=26 &#125; * - åˆ™è½¬æ¢åçš„ alarmThresholdListä¸º: * - &#123; Log, min=5, max=8 &#125;, &#123; Email, min=8, max=10 &#125;, &#123; WeiXin, min=10, max=16 &#125;, &#123; SMS, min=14, max=26 &#125;, &#123; Log, min=26, max=30 &#125; * - count : [5, 8) Log * - count : [8, 10) Email * - count : [10, 16) WeiXin * - count : [14, 26) SMS * - count : [26, 30) Log * * * ä¸Šé¢æ”¹é€ åï¼Œå¾ˆå®¹æ˜“å¾—çŸ¥ï¼Œæ”¯æŒå¤šé‡æŠ¥è­¦æ–¹å¼åŒæ—¶å·¥ä½œï¼Œå³å½“æŠ€æœ¯ä¸º14ï¼Œ15 æ—¶ï¼ŒåŒæ—¶å‘èµ·WeiXinå’ŒSMSæŠ¥è­¦ */ ç›¸åº”çš„å°±å¯ä»¥å¹²æ‰åŸæ¥ä¸å¤ªå¥½æ‡‚çš„Executoré€‰æ‹©é€»è¾‘ï¼Œå¯¹åº”çš„ä»£ç ä¸º 123456789101112131415161718192021222324252627282930// com.hust.hui.alarm.core.execut.AlarmExecuteSelector#getExecutepublic static List&lt;ExecuteHelper&gt; getExecute(final AlarmConfig alarmConfig, int count) &#123; // æœªè¾¾åˆ°æŠ¥è­¦çš„ä¸‹é™ or è¶…è¿‡æŠ¥è­¦çš„ä¸Šé™æ—¶ if (count &lt; alarmConfig.getMinLimit() || count &gt; alarmConfig.getMaxLimit()) &#123; return Collections.singletonList(new ExecuteHelper(SimpleExecuteFactory.getExecute(NoneExecute.NAME), alarmConfig.getUsers())); &#125; // æœªå¼€å¯æŠ¥è­¦å‡çº§, ç›´æ¥è¿”å› if (!alarmConfig.isAutoIncEmergency()) &#123; return Collections.singletonList(new ExecuteHelper(alarmConfig.getExecutor(), alarmConfig.getUsers())); &#125; if (count &lt; alarmConfig.getAlarmThreshold().get(0).getMin()) &#123; // æœªè¾¾åˆ°æŠ¥è­¦çš„ä¸‹é™ return Collections.singletonList(new ExecuteHelper(SimpleExecuteFactory.getExecute(NoneExecute.NAME), alarmConfig.getUsers())); &#125; List&lt;ExecuteHelper&gt; list = new ArrayList&lt;&gt;(); for(AlarmThreshold alarmThreshold: alarmConfig.getAlarmThreshold()) &#123; if (alarmThreshold.getMin() &lt;= count &amp;&amp; count &lt; alarmThreshold.getMax()) &#123; list.add(new ExecuteHelper(alarmThreshold.getExecutor(), alarmThreshold.getUsers())); &#125; if(alarmThreshold.getMin() &gt; count) &#123; break; &#125; &#125; return list;&#125; III. å…¶ä»–ç›¸å…³åšæ–‡ æŠ¥è­¦ç³»ç»ŸQuickAlarmæ€»çº² æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦æ‰§è¡Œå™¨çš„è®¾è®¡ä¸å®ç° æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦è§„åˆ™çš„è®¾å®šä¸åŠ è½½ æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦è§„åˆ™è§£æ æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹é¢‘ç‡ç»Ÿè®¡åŠæ¥å£å°è£… æŠ¥è­¦ç³»ç»ŸQuickAlarmä½¿ç”¨æ‰‹å†Œ æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹é»˜è®¤æŠ¥è­¦è§„åˆ™æ‰©å±• é¡¹ç›®: QuickAlarm é¡¹ç›®åœ°å€ï¼š Quick-Alarm åšå®¢åœ°å€ï¼š å°ç°ç°Blog ä¸ªäººåšå®¢ï¼š Z+|blogåŸºäºhexo + github pagesæ­å»ºçš„ä¸ªäººåšå®¢ï¼Œè®°å½•æ‰€æœ‰å­¦ä¹ å’Œå·¥ä½œä¸­çš„åšæ–‡ï¼Œæ¬¢è¿å¤§å®¶å‰å»é€›é€› å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è¯†æœ‰é™ï¼Œå¦‚å‘ç°bugæˆ–è€…æœ‰æ›´å¥½çš„å»ºè®®ï¼Œéšæ—¶æ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼Œæˆ‘çš„å¾®åšåœ°å€: å°ç°ç°Blog æ‰«æå…³æ³¨","categories":[{"name":"Quickç³»åˆ—é¡¹ç›®","slug":"Quickç³»åˆ—é¡¹ç›®","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/"},{"name":"QuickAlarm","slug":"Quickç³»åˆ—é¡¹ç›®/QuickAlarm","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/QuickAlarm/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"SPI","slug":"SPI","permalink":"https://zbang.online/hexblog/tags/SPI/"},{"name":"QuickAlarm","slug":"QuickAlarm","permalink":"https://zbang.online/hexblog/tags/QuickAlarm/"}],"keywords":[{"name":"Quickç³»åˆ—é¡¹ç›®","slug":"Quickç³»åˆ—é¡¹ç›®","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/"},{"name":"QuickAlarm","slug":"Quickç³»åˆ—é¡¹ç›®/QuickAlarm","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/QuickAlarm/"}]},{"title":"å€ŸåŠ©GitHubæ­å»ºå±äºè‡ªå·±çš„mavenä»“åº“æ•™ç¨‹","slug":"å€ŸåŠ©GitHubæ­å»ºå±äºè‡ªå·±çš„mavenä»“åº“æ•™ç¨‹","date":"2018-02-12T06:01:13.000Z","updated":"2018-02-13T03:21:17.019Z","comments":true,"path":"2018/02/12/å€ŸåŠ©GitHubæ­å»ºå±äºè‡ªå·±çš„mavenä»“åº“æ•™ç¨‹/","link":"","permalink":"https://zbang.online/hexblog/2018/02/12/å€ŸåŠ©GitHubæ­å»ºå±äºè‡ªå·±çš„mavenä»“åº“æ•™ç¨‹/","excerpt":"","text":"I. èƒŒæ™¯åœ¨Githubä¸Šä¹Ÿå†™äº†ä¸å°‘çš„é¡¹ç›®äº†ï¼Œç„¶åç»å¸¸é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œå¾ˆå¤šè‡ªå·±å†™çš„é¡¹ç›®ï¼Œå¸Œæœ›åœ¨å¦å¤–ä¸€ä¸ªé¡¹ç›®ä¸­ä½¿ç”¨æ—¶ï¼Œåªèƒ½æŠŠè¿™ä¸ªé¡¹ç›®ä¸‹è½½ä¸‹æ¥ï¼Œç›¸å½“ä¹‹ä¸æ–¹ä¾¿ å› ä¸ºå¤§å¤šæ•°çš„javaåç«¯é¡¹ç›®éƒ½æ˜¯åŸºäºmavenç®¡ç†ä¾èµ–çš„ï¼Œæ‰€ä»¥å°±å¸Œæœ›èƒ½æœ‰ä¸€ä¸ªå…¬å…±çš„mavenä»“åº“ï¼Œå¯ä»¥æŠŠè‡ªå·±çš„é¡¹ç›®æ‰”è¿›å»ï¼Œç„¶åå†åº”ç”¨å°±æ–¹ä¾¿å¾ˆå¤šäº† åŸºäºæ­¤ï¼Œå°±æœ‰äº†æœ¬æ–‡è¿™ä¸ªæ•™ç¨‹äº† II. å®ç°æ­¥éª¤1. githubä»“åº“å»ºç«‹æ–°å»ºä¸€ä¸ªrepositoryçš„å‰ææ˜¯æœ‰githubå¸å·ï¼Œé»˜è®¤çœ‹åˆ°æœ¬æ–‡çš„æ˜¯æœ‰å¸å·çš„ é¦–å…ˆæ˜¯åœ¨githubä¸Šæ–°å»ºä¸€ä¸ªä»“åº“ï¼Œå‘½ä»¤éšæ„ï¼Œå¦‚æˆ‘æ–°å»ºé¡¹ç›®ä¸º https://github.com/liuyueyi/maven-repository 2. é…ç½®æœ¬åœ°ä»“åº“æœ¬åœ°æŒ‡å®šä¸€ä¸ªç›®å½•ï¼Œæ–°å»ºæ–‡ä»¶å¤¹ maven-repository, å¦‚æˆ‘çš„æœ¬åœ°é…ç½®å¦‚ä¸‹ 1234567891011121314## è¿›å…¥ç›®å½•cd /Users/yihui/GitHub## æ–°å»ºç›®å½•mkdir maven-repository; cd maven-repository## æ–°å»ºrepositoryç›®å½•# è¿™ä¸ªç›®å½•ä¸‹é¢å°±æ˜¯å­˜æ”¾æˆ‘ä»¬deployçš„é¡¹ç›®ç›¸å…³ä¿¡æ¯# ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬é¡¹ç›®deployæŒ‡å®šçš„ç›®å½•ï¼Œå°±æ˜¯è¿™é‡Œmkdir repository## æ–°å¢ä¸€ä¸ªreadmeæ–‡æ¡£# ä¿æŒè‰¯å¥½çš„ä¹ æƒ¯ï¼Œæ¯ä¸ªé¡¹ç›®éƒ½æœ‰ä¸€ä¸ªè¯´æ˜æ–‡æ¡£touch README.md è¿™ä¸ªç›®å½•ç»“æ„ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·çš„ï¼Ÿ æˆ‘ä»¬ç›´æ¥çœ‹mavené…ç½®ä¸­é»˜è®¤çš„ç›®å½•ç»“æ„ï¼ŒåŒæ ·æ‹·è´ä¸€ä»½å‡ºæ¥è€Œå·² 3. ä»“åº“å…³è”å°†æœ¬åœ°çš„ä»“åº“å’Œè¿œç¨‹çš„githubä»“åº“å…³è”èµ·æ¥ï¼Œæ‰§è¡Œçš„å‘½ä»¤ä¹Ÿæ¯”è¾ƒç®€å•äº† 1234git add .git commit -m 'first comit'git remote add origin https://github.com/liuyueyi/maven-repository.gitgit push -u origin master æ¥ç€å°±æ˜¯è¿›è¡Œåˆ†æ”¯ç®¡ç†äº† çº¦å®šå°†é¡¹ç›®ä¸­çš„snapshotç‰ˆï¼Œdeployåˆ°ä»“åº“çš„ snapshotåˆ†æ”¯ä¸Š çº¦å®šå°†é¡¹ç›®ä¸­çš„releaseç‰ˆï¼Œdeployåˆ°ä»“åº“çš„ releaseåˆ†æ”¯ä¸Š masteråˆ†æ”¯ç®¡ç†æ‰€æœ‰çš„ç‰ˆæœ¬ æ‰€ä»¥éœ€è¦æ–°åˆ›å»ºä¸¤ä¸ªåˆ†æ”¯ 12345678## åˆ›å»ºsnapshotåˆ†æ”¯git checkout -b snapshot git push origin snapshot# ä¹Ÿå¯ä»¥ä½¿ç”¨ git branch snapshot , æˆ‘é€šå¸¸ç”¨ä¸Šé¢å“ªä¸ªï¼Œåˆ›å»ºå¹¶åˆ‡æ¢åˆ†æ”¯## åˆ›å»ºreleaseåˆ†æ”¯git checkout -b releasegit push origin release 4. é¡¹ç›®deployé¡¹ç›®çš„deployï¼Œå°±éœ€è¦ä¸»åŠ¨çš„æŒ‡å®šä¸€ä¸‹deployçš„åœ°å€äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„deployå‘½ä»¤å¦‚ä¸‹ 12## deployé¡¹ç›®åˆ°æœ¬åœ°ä»“åº“mvn clean deploy -Dmaven.test.skip -DaltDeploymentRepository=self-mvn-repo::default::file:/Users/yihui/GitHub/maven-repository/repository ä¸Šé¢çš„å‘½ä»¤å°±æ¯”è¾ƒå¸¸è§äº†ï¼Œä¸»è¦éœ€è¦æ³¨æ„çš„æ˜¯fileåé¢çš„å‚æ•°ï¼Œæ ¹æ®è‡ªå·±å‰é¢è®¾ç½®çš„æœ¬åœ°ä»“åº“ç›®å½•æ¥è¿›è¡Œæ›¿æ¢ 5. deployè„šæœ¬æ¯æ¬¡è¿›è¡Œä¸Šé¢ä¸€å¤§ä¸²çš„å‘½ä»¤ï¼Œä¸å¤ªå¥½è®°ï¼Œç‰¹åˆ«æ˜¯ä¸åŒçš„ç‰ˆæœ¬deployåˆ°ä¸åŒçš„åˆ†æ”¯ä¸Šï¼Œä¸»åŠ¨å»åˆ‡æ¢åˆ†æ”¯å¹¶ä¸Šä¼ ï¼Œä¹ŸæŒºéº»çƒ¦ï¼Œæ‰€ä»¥å°±æœ‰å¿…è¦å†™ä¸€ä¸ªdeployçš„è„šæœ¬äº† ç”±äºshellå®åœ¨æ˜¯ä¸å¤ªä¼šå†™ï¼Œæ‰€ä»¥ä¸‹é¢çš„è„šæœ¬åªèƒ½ä»¥å‡‘åˆèƒ½ç”¨æ¥è¯´äº† 123456789101112131415161718192021222324252627282930313233343536373839404142434445#!/bin/bashif [ $# != 1 ];then echo 'deploy argument [snapshot(s for short) | release(r for short) ] needed!' exit 0fi## deployå‚æ•°ï¼Œsnapshot è¡¨ç¤ºå¿«ç…§åŒ…ï¼Œç®€å†™ä¸ºsï¼Œ releaseè¡¨ç¤ºæ­£å¼åŒ…ï¼Œç®€å†™ä¸ºrarg=$1DEPLOY_PATH=/Users/yihui/GitHub/maven-repository/CURRENT_PATH=`pwd`deployFunc()&#123; br=$1 ## å¿«ç…§åŒ…å‘å¸ƒ cd $DEPLOY_PATH ## åˆ‡æ¢å¯¹åº”åˆ†æ”¯ git checkout $br cd $CURRENT_PATH # å¼€å§‹deploy mvn clean deploy -Dmaven.test.skip -DaltDeploymentRepository=self-mvn-repo::default::file:/Users/yihui/GitHub/maven-repository/repository # deploy å®Œæˆ,æäº¤ cd $DEPLOY_PATH git add -am 'deploy' git push origin $br # åˆå¹¶masteråˆ†æ”¯ git checkout master git merge $br git commit -am 'merge' git push origin master cd $CURRENT_PATH&#125;if [ $arg = 'snapshot' ] || [ $arg = 's' ];then ## å¿«ç…§åŒ…å‘å¸ƒ deployFunc snapshotelif [ $arg = 'release' ] || [ $arg = 'r' ];then ## æ­£å¼åŒ…å‘å¸ƒ deployFunc releaseelse echo 'argument should be snapshot(s for short) or release(r for short). like: `sh deploy.sh snapshot` or `sh deploy.sh s`'fi å°†ä¸Šé¢çš„è„šæœ¬ï¼Œè€ƒæœ¬åˆ°é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹ï¼Œç„¶åæ‰§è¡Œ 12345678chmod +x deploy.sh## å‘å¸ƒå¿«ç…§åŒ…./deploy.sh s# sh deploy.sh snapshot ä¹Ÿå¯ä»¥## å‘å¸ƒæ­£å¼åŒ…./deploy.sh r åŸºäºæ­¤ï¼Œæ•´ä¸ªæ­¥éª¤å®Œæˆ III. ä½¿ç”¨ä¸Šé¢ä»“åº“çš„åŸºæœ¬æ­å»ºç®—æ˜¯okäº†ï¼Œç„¶åå°±æ˜¯ä½¿ç”¨äº†ï¼Œmavençš„pomæ–‡ä»¶åº”è¯¥æ€ä¹ˆé…ç½®å‘¢ï¼Ÿ é¦–å…ˆæ˜¯æ·»åŠ ä»“åº“åœ°å€ æ·»åŠ ä»“åº“ å¦‚æœè¦åŒºåˆ†snapshotå’Œreleaseçš„è¯ï¼Œå¦‚ä¸‹é…ç½® 12345678910&lt;repositories&gt; &lt;repository&gt; &lt;id&gt;yihui-maven-repo-snap&lt;/id&gt; &lt;url&gt;https://raw.githubusercontent.com/liuyueyi/maven-repository/snapshot/repository&lt;/url&gt; &lt;/repository&gt; &lt;repository&gt; &lt;id&gt;yihui-maven-repo-release&lt;/id&gt; &lt;url&gt;https://raw.githubusercontent.com/liuyueyi/maven-repository/release/repository&lt;/url&gt; &lt;/repository&gt;&lt;/repositories&gt; å¦‚æœä¸careçš„è¯ï¼Œç›´æ¥æ·»åŠ ä¸‹é¢çš„å³å¯ 123456&lt;repositories&gt; &lt;repository&gt; &lt;id&gt;yihui-maven-repo&lt;/id&gt; &lt;url&gt;https://raw.githubusercontent.com/liuyueyi/maven-repository/master/repository&lt;/url&gt; &lt;/repository&gt;&lt;/repositories&gt; ä»“åº“é…ç½®å®Œæ¯•ä¹‹åï¼Œç›´æ¥å¼•å…¥ä¾èµ–å³å¯ï¼Œå¦‚ä¾èµ–æˆ‘çš„Quick-AlarmåŒ…ï¼Œå°±å¯ä»¥æ·»åŠ ä¸‹é¢çš„ä¾èµ–é…ç½® 12345&lt;dependency&gt; &lt;groupId&gt;com.hust.hui.alarm&lt;/groupId&gt; &lt;artifactId&gt;core&lt;/artifactId&gt; &lt;version&gt;0.1&lt;/version&gt;&lt;/dependency&gt; IV. å…¶ä»–ä¸ªäººåšå®¢ï¼š Z+|blogåŸºäºhexo + github pagesæ­å»ºçš„ä¸ªäººåšå®¢ï¼Œè®°å½•æ‰€æœ‰å­¦ä¹ å’Œå·¥ä½œä¸­çš„åšæ–‡ï¼Œæ¬¢è¿å¤§å®¶å‰å»é€›é€› å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è¯†æœ‰é™ï¼Œå¦‚å‘ç°bugæˆ–è€…æœ‰æ›´å¥½çš„å»ºè®®ï¼Œéšæ—¶æ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼Œæˆ‘çš„å¾®åšåœ°å€: å°ç°ç°Blog æ‰«æå…³æ³¨","categories":[{"name":"Shell","slug":"Shell","permalink":"https://zbang.online/hexblog/categories/Shell/"},{"name":"Git","slug":"Shell/Git","permalink":"https://zbang.online/hexblog/categories/Shell/Git/"},{"name":"Maven","slug":"Shell/Git/Maven","permalink":"https://zbang.online/hexblog/categories/Shell/Git/Maven/"}],"tags":[{"name":"Github","slug":"Github","permalink":"https://zbang.online/hexblog/tags/Github/"},{"name":"Maven","slug":"Maven","permalink":"https://zbang.online/hexblog/tags/Maven/"},{"name":"æ•™ç¨‹","slug":"æ•™ç¨‹","permalink":"https://zbang.online/hexblog/tags/æ•™ç¨‹/"}],"keywords":[{"name":"Shell","slug":"Shell","permalink":"https://zbang.online/hexblog/categories/Shell/"},{"name":"Git","slug":"Shell/Git","permalink":"https://zbang.online/hexblog/categories/Shell/Git/"},{"name":"Maven","slug":"Shell/Git/Maven","permalink":"https://zbang.online/hexblog/categories/Shell/Git/Maven/"}]},{"title":"6. æŠ¥è­¦ç³»ç»ŸQuickAlarmä½¿ç”¨æ‰‹å†Œ","slug":"æŠ¥è­¦ç³»ç»ŸQuickAlarmä½¿ç”¨æ‰‹å†Œ","date":"2018-02-11T10:53:33.000Z","updated":"2018-03-05T12:31:01.015Z","comments":true,"path":"2018/02/11/æŠ¥è­¦ç³»ç»ŸQuickAlarmä½¿ç”¨æ‰‹å†Œ/","link":"","permalink":"https://zbang.online/hexblog/2018/02/11/æŠ¥è­¦ç³»ç»ŸQuickAlarmä½¿ç”¨æ‰‹å†Œ/","excerpt":"","text":"æœ¬æ–‡å°†ä¸»è¦è¯´æ˜QuickAlarmè¯¥å¦‚ä½•ä½¿ç”¨ï¼Œä»¥åŠä½¿ç”¨æ—¶éœ€è¦æ³¨æ„äº‹é¡¹ 1. åŸºæœ¬ä½¿ç”¨å§¿åŠ¿é¦–å…ˆæˆ‘ä»¬ä¸åšä»»ä½•çš„è‡ªå®šä¹‰æ“ä½œï¼Œå…¨éƒ¨ä¾é ç³»ç»Ÿé»˜è®¤çš„å®ç°ï¼Œæˆ‘ä»¬çš„ä½¿ç”¨æ­¥éª¤å¦‚ä¸‹ 1. æ·»åŠ æ³¨å†Œæ–‡ä»¶é¦–å…ˆåœ¨é¡¹ç›®çš„èµ„æºç›®å½•ä¸‹ï¼Œæ·»åŠ æ³¨å†Œæ–‡ä»¶ alarm.propertiesï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ 12345678910111213## åº”ç”¨åï¼Œå¿…å¡«appName=test## æŠ¥è­¦è§„åˆ™æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„ï¼Œå¦‚æœé‡‡ç”¨ç³»ç»Ÿé»˜è®¤åŠ è½½æ–¹å¼ï¼Œå¿…å¡«## / å¼€å¤´ï¼Œè¡¨ç¤ºå­˜çš„æ˜¯ç»å¯¹è·¯å¾„## é/å¼€å¤´ï¼Œè¡¨ç¤ºå­˜çš„æ˜¯ç³»ç»Ÿç›¸å¯¹è·¯å¾„ï¼Œä¸€èˆ¬æ˜¯æ”¾åœ¨èµ„æºç›®å½•ä¸‹alarmConfPath=/tmp/alarmConfig## æœ€å¤§çš„æŠ¥è­¦ç±»å‹ï¼Œéå¿…å¡«maxAlarmType=1000## é»˜è®¤æŠ¥è­¦ç”¨æˆ·ï¼Œå¿…å¡«defaultAlarmUsers=yihui å…·ä½“å­˜æ”¾çš„ä½ç½®ï¼Œå¯ä»¥å‚è€ƒä¸‹å›¾ï¼Œæ”¾åœ¨resourcesç›®å½•ä¸‹ï¼ˆæºç ä¸­ï¼Œæ˜¯æ”¾åœ¨æµ‹è¯•èµ„æºç›®å½•ä¸‹çš„ï¼‰ 2. æ·»åŠ æŠ¥è­¦è§„åˆ™æ ¹æ®æ³¨å†Œæ–‡ä»¶ä¸­æŒ‡å®šçš„è·¯å¾„ï¼Œè®¾ç½®æŠ¥è­¦è§„åˆ™æ–‡ä»¶ï¼Œå¦‚æˆ‘ä»¬çš„æŠ¥è­¦è§„åˆ™æ–‡ä»¶ å†…å®¹ä¸ºjsonä¸²æ ¼å¼ï¼Œæ”¯æŒæ ¼å¼åŒ–çš„jsonä¸²è§£æï¼Œä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œä¸‹é¢å‹ç¼©æˆä¸€è¡Œï¼Œç‚¹å‡»è·å–jsonæ ¼å¼åŒ–å°å·¥å…· /tmp/alarmConig: 1&#123;\"default\":&#123;\"level\":\"LOG\",\"autoIncEmergency\":true,\"max\":30,\"min\":3,\"threshold\":[&#123;\"level\":\"SMS\",\"threshold\":20,\"users\":[\"345345345345\",\"123123123123\"]&#125;,&#123;\"level\":\"WEIXIN\",\"threshold\":10,\"users\":[\"yihui\",\"erhui\"]&#125;,&#123;\"level\":\"LOG\",\"threshold\":5,\"users\":[\"yihui\",\"erhui\"]&#125;],\"users\":[\"yihui\"]&#125;,\"NPE\":&#123;\"level\":\"WEIXIN\",\"autoIncEmergency\":false,\"max\":30,\"min\":0,\"threshold\":[&#123;\"level\":\"SMS\",\"threshold\":20,\"users\":[\"345345345345\",\"123123123123\"]&#125;,&#123;\"level\":\"WEIXIN\",\"threshold\":10,\"users\":[\"3h ui\",\"4hui\"]&#125;],\"users\":[\"yihui\"]&#125;,\"XXX,YYY\":&#123;\"level\":\"EMAIL\",\"autoIncEmergency\":true,\"max\":30,\"min\":3,\"threshold\":[&#123;\"level\":\"SMS\",\"threshold\":20,\"users\":[\"345345345345\",\"123123123123\"]&#125;,&#123;\"level\":\"WEIXIN\",\"threshold\":10,\"users\":[\"yihui\",\"erhui\"]&#125;,&#123;\"level\":\"EMAIL\",\"threshold\":5,\"users\":[\"yihui@xxx.com\",\"erhui@xxx.com\"]&#125;],\"users\":[\"yihui@xxx.com\"]&#125;&#125; 3. æµ‹è¯•ç±»ä¸€ä¸ªç®€å•çš„ä½¿ç”¨æµ‹è¯• 123456789101112@Testpublic void sendMsg() throws InterruptedException &#123; String key = \"NPE\"; String title = \"NPEå¼‚å¸¸\"; String msg = \"å‡ºç°NPEå¼‚å¸¸äº†!!!\"; AlarmWrapper.getInstance().sendMsg(key, title, msg); // å¾®ä¿¡æŠ¥è­¦ // ä¸å­˜åœ¨å¼‚å¸¸é…ç½®ç±»å‹, é‡‡ç”¨é»˜è®¤æŠ¥è­¦, æ¬¡æ•°è¾ƒå°, åˆ™ç›´æ¥éƒ¨ç½²å‡º AlarmWrapper.getInstance().sendMsg(\"zzz\", \"ä¸å­˜åœ¨xxxå¼‚å¸¸é…ç½®\", \"æŠ¥è­¦å—’å—’å—’å—’\"); Thread.sleep(1000);&#125; II. æŠ¥è­¦æ‰§è¡Œæœºå™¨æ‰©å±•å‰é¢çš„æŠ¥è­¦è§„åˆ™é…ç½®ä¸­ï¼Œæœ‰WEIXIN, SMS, EMAILçš„æŠ¥è­¦ï¼Œä½†æ˜¯ç³»ç»Ÿåªæä¾›äº†ä¸¤ä¸ªNONEå’ŒLOGï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹ä¸‹å¦‚ä½•è‡ªå®šä¹‰å®ç°ä¸Šé¢çš„ä¸‰ä¸ª 1. å®ç°IExecuteæ¥å£é‚®ä»¶æŠ¥è­¦ 123456public class EmailExecute extends LogExecute &#123; @Override public void sendMsg(List&lt;String&gt; users, String title, String msg) &#123; super.sendMsg(users, title, msg); &#125;&#125; çŸ­ä¿¡æŠ¥è­¦ 12345678910/** * Created by yihui on 2018/2/7. */public class SmsExecute extends LogExecute &#123; @Override public void sendMsg(List&lt;String&gt; users, String title, String msg) &#123; super.sendMsg(users, title, msg); &#125;&#125; å¾®ä¿¡æŠ¥è­¦ 123456789/** * Created by yihui on 2018/2/7. */public class WeiXinExecute extends LogExecute &#123; @Override public void sendMsg(List&lt;String&gt; users, String title, String msg) &#123; super.sendMsg(users, title, msg); &#125;&#125; è¯´æ˜ï¼Œå› ä¸ºæ²¡æœ‰å…·ä½“çš„å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥ç”¨æ—¥å¿—è¾“å‡ºæ¥æ¨¡æ‹Ÿï¼Œæ‰€ä»¥å°±éƒ½ç»§æ‰¿äº†LogExecute, å®é™…ä½¿ç”¨ä¸­ï¼Œå¯ä»¥åœ¨ä¸Šé¢è¡¥ä¸Šç›¸åº”çš„å®ç°ä»£ç  2. æ·»åŠ SPIå®šä¹‰åœ¨ resources ç›®å½•ä¸‹ï¼Œæ–°å¢ ç›®å½•ï¼šMETA-INF/services/ æ–‡ä»¶ï¼šcom.hust.hui.alarm.core.execut.api.IExecute æ–‡ä»¶å†…å®¹ä¸ºä¸Šé¢å‡ ä¸ªå®ç°ç±»çš„å…¨è·¯å¾„ 123com.hust.hui.alarm.core.test.execute.EmailExecutecom.hust.hui.alarm.core.test.execute.SmsExecutecom.hust.hui.alarm.core.test.execute.WeiXinExecute ç›®å½•ç»“æ„å¦‚ï¼š 3. æµ‹è¯•1234567891011121314151617181920public static void main(String[] args) throws InterruptedException &#123; // æµ‹è¯•å¼‚å¸¸å‡çº§çš„case // è®¡æ•° [1 - 2] é»˜è®¤æŠ¥è­¦ï¼ˆå³æ— æ—¥å¿—ï¼‰ ï¼ˆå…¶ä¸­ &lt; 3 çš„æ˜¯å› ä¸ºæœªè¾¾åˆ°ä¸‹é™, é‡‡ç”¨çš„é»˜è®¤æŠ¥è­¦ï¼‰ // è®¡æ•° [3 - 4] é»˜è®¤é‚®ä»¶æŠ¥è­¦ï¼ˆå…¶ä¸­ &lt; 5 é‡‡ç”¨çš„é»˜è®¤æŠ¥è­¦, ä¸ä¸‹é¢çš„åŒºåˆ«æ˜¯æŠ¥è­¦ç”¨æˆ·ï¼‰ // è®¡æ•° [5 - 9] é‚®ä»¶æŠ¥è­¦ ï¼ˆå¤§äº5å°äº10æ ¹æ®ä¸Šå‡è§„åˆ™,è¿˜æ˜¯é€‰æ‹©é‚®ä»¶æŠ¥è­¦ï¼‰ // è®¡æ•° [10 - 19] å¾®ä¿¡æŠ¥è­¦ // è®¡æ•° [20 - 30] çŸ­ä¿¡æŠ¥è­¦ // è®¡æ•° [31 -] é»˜è®¤æŠ¥è­¦ ï¼ˆè¶…è¿‡ä¸Šé™, ä¸æŠ¥è­¦ï¼‰ for (int i = 0; i &lt; 40; i++) &#123; new Thread(new Runnable() &#123; @Override public void run() &#123; AlarmWrapper.getInstance().sendMsg(\"YYY\", \"å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•\"); &#125; &#125;).start(); &#125; Thread.sleep(1000 * 600);&#125; å®æµ‹è¾“å‡ºç»“æœå¦‚ä¸‹: 1234567891011121314151617181920212223242526272818:36:28.997 [Thread-12] INFO alarm - Do send msg by SMS to user:[345345345345, 123123123123], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 26 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:28.998 [Thread-24] INFO alarm - Do send msg by WEIXIN to user:[yihui, erhui], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 16 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:28.998 [Thread-33] INFO alarm - Do send msg by EMAIL to user:[yihui@xxx.com, erhui@xxx.com], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 6 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:28.998 [Thread-22] INFO alarm - Do send msg by WEIXIN to user:[yihui, erhui], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 18 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:28.998 [Thread-26] INFO alarm - Do send msg by WEIXIN to user:[yihui, erhui], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 14 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:28.998 [Thread-23] INFO alarm - Do send msg by WEIXIN to user:[yihui, erhui], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 17 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:28.998 [Thread-35] INFO alarm - Do send msg by EMAIL to user:[yihui@xxx.com], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 4 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:28.997 [sms-sender1-thread-4] INFO alarm - Do send msg by WEIXIN to user:[yihui, erhui], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 10 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:28.997 [sms-sender1-thread-3] INFO alarm - Do send msg by EMAIL to user:[yihui@xxx.com, erhui@xxx.com], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 5 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:28.997 [Thread-18] INFO alarm - Do send msg by SMS to user:[345345345345, 123123123123], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 27 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:28.997 [Thread-11] INFO alarm - Do send msg by SMS to user:[345345345345, 123123123123], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 28 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:28.998 [Thread-21] INFO alarm - Do send msg by WEIXIN to user:[yihui, erhui], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 19 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:28.997 [sms-sender1-thread-2] INFO alarm - Do send msg by EMAIL to user:[yihui@xxx.com, erhui@xxx.com], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 9 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:28.998 [Thread-14] INFO alarm - Do send msg by SMS to user:[345345345345, 123123123123], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 24 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:28.997 [Thread-10] INFO alarm - Do send msg by SMS to user:[345345345345, 123123123123], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 29 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:28.998 [Thread-15] INFO alarm - Do send msg by SMS to user:[345345345345, 123123123123], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 22 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:28.998 [Thread-16] INFO alarm - Do send msg by SMS to user:[345345345345, 123123123123], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 23 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:28.998 [sms-sender1-thread-5] INFO alarm - Do send msg by WEIXIN to user:[yihui, erhui], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 15 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:28.998 [Thread-9] INFO alarm - Do send msg by SMS to user:[345345345345, 123123123123], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 30 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:28.998 [sms-sender1-thread-1] INFO alarm - Do send msg by WEIXIN to user:[yihui, erhui], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 11 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:28.998 [Thread-13] INFO alarm - Do send msg by SMS to user:[345345345345, 123123123123], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 25 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:28.998 [Thread-19] INFO alarm - Do send msg by SMS to user:[345345345345, 123123123123], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 21 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:28.998 [Thread-34] INFO alarm - Do send msg by EMAIL to user:[yihui@xxx.com], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 3 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:29.010 [sms-sender1-thread-4] INFO alarm - Do send msg by EMAIL to user:[yihui@xxx.com, erhui@xxx.com], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 7 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:29.010 [sms-sender1-thread-3] INFO alarm - Do send msg by WEIXIN to user:[yihui, erhui], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 12 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:29.011 [sms-sender1-thread-2] INFO alarm - Do send msg by WEIXIN to user:[yihui, erhui], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 13 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:29.014 [sms-sender1-thread-5] INFO alarm - Do send msg by EMAIL to user:[yihui@xxx.com, erhui@xxx.com], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 8 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:36:29.014 [sms-sender1-thread-1] INFO alarm - Do send msg by SMS to user:[345345345345, 123123123123], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 20 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯• III. æŠ¥è­¦è§„åˆ™åŠ è½½è‡ªå®šä¹‰1. å®ç°IConfLoaderæ¥å£è‡ªå®šä¹‰åŠ è½½å™¨ï¼Œç»™äº†ä¸€ä¸ªæœ€åŸºæœ¬çš„ 12345678910111213141516171819202122232425262728293031323334public class SelfAlarmConfLoader implements IConfLoader &#123; @Override public RegisterInfo getRegisterInfo() &#123; RegisterInfo registerInfo = new RegisterInfo(); registerInfo.setMaxAlarmType(100); registerInfo.setDefaultAlarmUsers(\"yihui\"); registerInfo.setAppName(\"test\"); return registerInfo; &#125; @Override public boolean alarmEnable() &#123; return true; &#125; @Override public int order() &#123; return 0; &#125; @Override public AlarmConfig getAlarmConfig(String alarmKey) &#123; //db æŸ¥è¯¢ï¼Œè·å–å¯¹åº”çš„é…ç½®ä¿¡æ¯ // ä¸‹é¢æ˜¯æ¨¡æ‹Ÿï¼Œè¿”å›ä¸€ä¸ªå›ºå®šçš„é…ç½® AlarmConfig alarmConfig = new AlarmConfig(); alarmConfig.setAlarmLevel(\"WEIXIN\"); alarmConfig.setAutoIncEmergency(false); alarmConfig.setMinLimit(10); alarmConfig.setMaxLimit(14); alarmConfig.setUsers(Arrays.asList(\"yihui\")); alarmConfig.setAlarmThreshold(Collections.emptyList()); return alarmConfig; &#125;&#125; 2. æ·»åŠ SPIé…ç½®åœ¨resourcesç›®å½•ä¸‹æ–°å¢ ç›®å½•ï¼š META-INF/services æ–‡ä»¶ï¼š com.hust.hui.alarm.core.loader.api.IConfLoader æ–‡ä»¶å†…å®¹ 1com.hust.hui.alarm.core.test.loader.SelfAlarmConfLoader 3. æµ‹è¯•åŒæ ·æ˜¯ä¸Šé¢çš„ä»£ç ï¼Œè¾“å‡ºç»“æœ 1234518:43:04.275 [sms-sender1-thread-2] INFO alarm - Do send msg by WEIXIN to user:[yihui], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 10 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:43:04.275 [sms-sender1-thread-4] INFO alarm - Do send msg by WEIXIN to user:[yihui], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 12 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:43:04.276 [sms-sender1-thread-1] INFO alarm - Do send msg by WEIXIN to user:[yihui], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 11 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:43:04.275 [sms-sender1-thread-5] INFO alarm - Do send msg by WEIXIN to user:[yihui], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 14 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯•18:43:04.275 [sms-sender1-thread-3] INFO alarm - Do send msg by WEIXIN to user:[yihui], title: [test], msg: ip:172.17.13.18 &gt;&gt;&gt; key:YYY &gt;&gt;&gt; å¼‚å¸¸æ•°: 13 &gt;&gt;&gt; å¼‚å¸¸æŠ¥è­¦å‡çº§æµ‹è¯• 4. è¯´æ˜ç³»ç»Ÿé»˜è®¤çš„orderæ˜¯10ï¼Œæ‰€ä»¥å¦‚æœåœ¨æµ‹è¯•ä¸Šé¢çš„ç¬¬äºŒæ­¥æ—¶ï¼Œä¸å¦¨æŠŠcom.hust.hui.alarm.core.test.loader.SelfAlarmConfLoader#orderè¿”å›å€¼ï¼Œæ”¹æˆå¤§äº10ï¼Œè¿™æ ·å°±ä¼šèµ°åˆ°é»˜è®¤çš„é…ç½®åŠ è½½ç±» é‡‡ç”¨ SelfAlarmConfLoader æ—¶ï¼Œå‰é¢è¯´çš„ä¸¤ä¸ªåŸºç¡€é…ç½®æ–‡ä»¶ï¼Œæ˜¯å¯ä»¥æ²¡æœ‰çš„ï¼Œå®Œå…¨ä¸ä¼šæœ‰ä»»ä½•å½±å“ï¼Œå› ä¸ºå¯¹åº”çš„æ³¨å†Œç±»å’ŒæŠ¥è­¦è§„åˆ™ï¼Œéƒ½æ˜¯å³è¿™ä¸ªç±»å†…éƒ¨æä¾›äº† IV. å°ç»“æ‰€æœ‰æµ‹è¯•ç›¸å…³æ•°æ®ï¼Œå‡å¯ä»¥åœ¨æµ‹è¯•å·¥ç¨‹ä¸­è·å–ï¼Œè¯·ä¸»è¦å…³æ³¨: æµ‹è¯•case æ³¨å†Œæ–‡ä»¶ï¼šalarmConfig æŠ¥è­¦è§„åˆ™é…ç½®æ–‡ä»¶ï¼šalarm.properties V. å…¶ä»–ç›¸å…³åšæ–‡ æŠ¥è­¦ç³»ç»ŸQuickAlarmæ€»çº² æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦æ‰§è¡Œå™¨çš„è®¾è®¡ä¸å®ç° æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦è§„åˆ™çš„è®¾å®šä¸åŠ è½½ æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦è§„åˆ™è§£æ æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹é¢‘ç‡ç»Ÿè®¡åŠæ¥å£å°è£… æŠ¥è­¦ç³»ç»ŸQuickAlarmä½¿ç”¨æ‰‹å†Œ æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹é»˜è®¤æŠ¥è­¦è§„åˆ™æ‰©å±• é¡¹ç›®: QuickAlarm é¡¹ç›®åœ°å€ï¼š Quick-Alarm åšå®¢åœ°å€ï¼š å°ç°ç°Blog ä¸ªäººåšå®¢ï¼š Z+|blogåŸºäºhexo + github pagesæ­å»ºçš„ä¸ªäººåšå®¢ï¼Œè®°å½•æ‰€æœ‰å­¦ä¹ å’Œå·¥ä½œä¸­çš„åšæ–‡ï¼Œæ¬¢è¿å¤§å®¶å‰å»é€›é€› å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è¯†æœ‰é™ï¼Œå¦‚å‘ç°bugæˆ–è€…æœ‰æ›´å¥½çš„å»ºè®®ï¼Œéšæ—¶æ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼Œæˆ‘çš„å¾®åšåœ°å€: å°ç°ç°Blog æ‰«æå…³æ³¨","categories":[{"name":"Quickç³»åˆ—é¡¹ç›®","slug":"Quickç³»åˆ—é¡¹ç›®","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/"},{"name":"QuickAlarm","slug":"Quickç³»åˆ—é¡¹ç›®/QuickAlarm","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/QuickAlarm/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"SPI","slug":"SPI","permalink":"https://zbang.online/hexblog/tags/SPI/"},{"name":"QuickAlarm","slug":"QuickAlarm","permalink":"https://zbang.online/hexblog/tags/QuickAlarm/"},{"name":"ä½¿ç”¨æ‰‹å†Œ","slug":"ä½¿ç”¨æ‰‹å†Œ","permalink":"https://zbang.online/hexblog/tags/ä½¿ç”¨æ‰‹å†Œ/"}],"keywords":[{"name":"Quickç³»åˆ—é¡¹ç›®","slug":"Quickç³»åˆ—é¡¹ç›®","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/"},{"name":"QuickAlarm","slug":"Quickç³»åˆ—é¡¹ç›®/QuickAlarm","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/QuickAlarm/"}]},{"title":"5. æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹é¢‘ç‡ç»Ÿè®¡åŠæ¥å£å°è£…","slug":"æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹é¢‘ç‡ç»Ÿè®¡åŠæ¥å£å°è£…","date":"2018-02-11T08:59:47.000Z","updated":"2018-03-05T12:31:01.015Z","comments":true,"path":"2018/02/11/æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹é¢‘ç‡ç»Ÿè®¡åŠæ¥å£å°è£…/","link":"","permalink":"https://zbang.online/hexblog/2018/02/11/æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹é¢‘ç‡ç»Ÿè®¡åŠæ¥å£å°è£…/","excerpt":"å‰é¢å°†æŠ¥è­¦è§„åˆ™çš„åˆ¶å®šåŠ è½½è§£æï¼Œä»¥åŠæŠ¥è­¦æ‰§è¡Œå™¨çš„å®šä¹‰åŠ è½½å’Œæ‰©å±•è¿›è¡Œäº†è®²è§£ï¼ŒåŸºæœ¬ä¸Šæ ¸å¿ƒçš„å†…å®¹å·²ç»å®Œç»“ï¼Œæ¥ä¸‹æ¥å‰©ä¸‹å†…å®¹å°±æ¯”è¾ƒç®€å•äº† æŠ¥è­¦é¢‘ç‡çš„ç»Ÿè®¡ æŠ¥è­¦çº¿ç¨‹æ±  å¯¹å¤–å°è£…ç»Ÿä¸€å¯ç”¨çš„è§£è€¦","text":"å‰é¢å°†æŠ¥è­¦è§„åˆ™çš„åˆ¶å®šåŠ è½½è§£æï¼Œä»¥åŠæŠ¥è­¦æ‰§è¡Œå™¨çš„å®šä¹‰åŠ è½½å’Œæ‰©å±•è¿›è¡Œäº†è®²è§£ï¼ŒåŸºæœ¬ä¸Šæ ¸å¿ƒçš„å†…å®¹å·²ç»å®Œç»“ï¼Œæ¥ä¸‹æ¥å‰©ä¸‹å†…å®¹å°±æ¯”è¾ƒç®€å•äº† æŠ¥è­¦é¢‘ç‡çš„ç»Ÿè®¡ æŠ¥è­¦çº¿ç¨‹æ±  å¯¹å¤–å°è£…ç»Ÿä¸€å¯ç”¨çš„è§£è€¦ I. æŠ¥è­¦é¢‘ç‡ç»Ÿè®¡1. è®¾è®¡å‰é¢åœ¨è§£ææŠ¥è­¦è§„åˆ™æ—¶ï¼Œå°±æœ‰ä¸€ä¸ªcountå‚æ•°ï¼Œç”¨æ¥ç¡®å®šå…·ä½“é€‰æ‹©ä»€ä¹ˆæŠ¥è­¦æ‰§è¡Œå™¨çš„æ ¸å¿ƒå‚æ•°ï¼Œæˆ‘ä»¬ç»´æŠ¤çš„æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼š é’ˆå¯¹æŠ¥è­¦ç±»å‹ï¼Œè¿›è¡Œè®¡æ•°ç»Ÿè®¡ï¼Œæ²¡è°ƒç”¨ä¸€æ¬¡ï¼Œåˆ™è®¡æ•°+1 æ¯åˆ†é’Ÿæ¸…é›¶ä¸€æ¬¡ 2. å®ç°å› ä¸ºæ¯ç§æŠ¥è­¦ç±»å‹ï¼Œéƒ½ç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„è®¡æ•°å™¨ å®šä¹‰ä¸€ä¸ªmapæ¥å­˜å‚¨å¯¹åº”å…³ç³» 1private ConcurrentHashMap&lt;String, AtomicInteger&gt; alarmCountMap; æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡æ¸…é›¶ 1234567// æ¯åˆ†é’Ÿæ¸…é›¶ä¸€æŠŠæŠ¥è­¦è®¡æ•°ScheduledExecutorService scheduleExecutorService = Executors.newScheduledThreadPool(1);scheduleExecutorService.scheduleAtFixedRate(() -&gt; &#123; for (Map.Entry&lt;String, AtomicInteger&gt; entry : alarmCountMap.entrySet()) &#123; entry.getValue().set(0); &#125;&#125;, 0, 1, TimeUnit.MINUTES); æ³¨æ„ä¸Šé¢çš„å®ç°ï¼Œå°±æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ æœ‰æ²¡æœ‰å¯èƒ½å› ä¸ºmapä¸­çš„æ•°æ®è¿‡å¤§ï¼ˆæˆ–è€…gcä»€ä¹ˆåŸå› ï¼‰ï¼Œå¯¼è‡´æ¯æ¬¡æ¸…é›¶èŠ±ä¸å°‘çš„æ—¶é—´ï¼Œè€Œå¯¼è‡´è®¡æ•°ä¸å‡†å‘¢ï¼Ÿ ï¼ˆå…ˆä¸ç»™å‡ºå›ç­”ï¼‰ è®¡æ•°åŠ 1æ“ä½œ 1234567891011121314151617/** * çº¿ç¨‹å®‰å…¨çš„è·å–æŠ¥è­¦æ€»æ•° å¹¶è‡ªåŠ¨åŠ 1 * * @param key * @return */private int getAlarmCount(String key) &#123; if (!alarmCountMap.containsKey(key)) &#123; synchronized (this) &#123; if (!alarmCountMap.containsKey(key)) &#123; alarmCountMap.put(key, new AtomicInteger(0)); &#125; &#125; &#125; return alarmCountMap.get(key).addAndGet(1);&#125; II. æŠ¥è­¦çº¿ç¨‹æ± ç›®å‰ä¹Ÿåªæ˜¯æä¾›äº†ä¸€ä¸ªéå¸¸ç®€å•çš„çº¿ç¨‹æ± å®ç°ï¼Œåé¢çš„è€ƒè™‘æ˜¯æŠ½è±¡ä¸€ä¸ªåŸºäºforkjoinçš„å¹¶å‘æ¡†æ¶æ¥å¤„ç†ï¼ˆä¸»è¦æ˜¯æœ€è¿‘æ¥è§¦åˆ°ä¸€ä¸ªå¤§ç¥åŸºäºforkjoinå†™çš„å¹¶å‘å™¨ç»„ä»¶æŒºå‰å®³çš„ï¼Œæ‰€ä»¥ç­‰æˆ‘ç ”ç©¶é€äº†ï¼Œå±±å¯¨ä¸€ä¸ªï¼‰ 123456// æŠ¥è­¦çº¿ç¨‹æ± private ExecutorService alarmExecutorService = new ThreadPoolExecutor(3, 5, 60, TimeUnit.SECONDS, new LinkedBlockingDeque&lt;&gt;(10), new DefaultThreadFactory(\"sms-sender\"), new ThreadPoolExecutor.CallerRunsPolicy()); ä»»åŠ¡æäº¤æ‰§è¡Œ 12345678private void doSend(final ExecuteHelper executeHelper, final AlarmContent alarmContent) &#123; alarmExecutorService.execute(() -&gt; executeHelper.getIExecute().sendMsg( executeHelper.getUsers(), alarmContent.getTitle(), alarmContent.getContent()));&#125; III. æ¥å£å°è£…è¿™ä¸ªå°±æ²¡ä»€ä¹ˆå¥½è¯´çš„äº† 123456789101112131415161718192021222324252627282930313233343536373839404142public void sendMsg(String key, String content) &#123; sendMsg(new AlarmContent(key, null, content));&#125;public void sendMsg(String key, String title, String content) &#123; sendMsg(new AlarmContent(key, title, content));&#125;/** * 1. è·å–æŠ¥è­¦çš„é…ç½®é¡¹ * 2. è·å–å½“å‰æŠ¥è­¦çš„æ¬¡æ•° * 3. é€‰æ‹©é€‚å½“çš„æŠ¥è­¦ç±»å‹ * 4. æ‰§è¡ŒæŠ¥è­¦ * 5. æŠ¥è­¦æ¬¡æ•°+1 * * @param alarmContent */private void sendMsg(AlarmContent alarmContent) &#123; try &#123; // get alarm config AlarmConfig alarmConfig = confLoader.getAlarmConfig(alarmContent.key); // get alarm count int count = getAlarmCount(alarmContent.key); alarmContent.setCount(count); ExecuteHelper executeHelper; if (confLoader.alarmEnable()) &#123; // get alarm execute executeHelper = AlarmExecuteSelector.getExecute(alarmConfig, count); &#125; else &#123; // æŠ¥è­¦å…³é—­, åˆ™èµ°ç©ºæŠ¥è­¦æµç¨‹, å°†æŠ¥è­¦ä¿¡æ¯å†™å…¥æ—¥å¿—æ–‡ä»¶ executeHelper = AlarmExecuteSelector.getDefaultExecute(); &#125; // do send msg doSend(executeHelper, alarmContent); &#125; catch (Exception e) &#123; logger.error(\"AlarmWrapper.sendMsg error! content:&#123;&#125;, e:&#123;&#125;\", alarmContent, e); &#125;&#125; æ¥å£å°è£…å®Œæ¯•ä¹‹åå¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿ æˆ‘ä»¬ä½¿ç”¨å•ä¾‹æ¨¡å¼å°è£…äº†å”¯ä¸€å¯¹å¤–ä½¿ç”¨çš„ç±»AlarmWrapperï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œä¸‹é¢å°±æ˜¯ä¸€ä¸ªæµ‹è¯•case 12345678910111213@Testpublic void sendMsg() throws InterruptedException &#123; String key = \"NPE\"; String title = \"NPEå¼‚å¸¸\"; String msg = \"å‡ºç°NPEå¼‚å¸¸äº†!!!\"; AlarmWrapper.getInstance().sendMsg(key, title, msg); // å¾®ä¿¡æŠ¥è­¦ // ä¸å­˜åœ¨å¼‚å¸¸é…ç½®ç±»å‹, é‡‡ç”¨é»˜è®¤æŠ¥è­¦, æ¬¡æ•°è¾ƒå°, åˆ™ç›´æ¥éƒ¨ç½²å‡º AlarmWrapper.getInstance().sendMsg(\"zzz\", \"ä¸å­˜åœ¨xxxå¼‚å¸¸é…ç½®\", \"æŠ¥è­¦å—’å—’å—’å—’\"); Thread.sleep(1000);&#125; ä½¿ç”¨èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œå°±é‚£ä¹ˆä¸€è¡Œå³å¯ï¼Œä»è¿™ä¸ªä½¿ç”¨ä¹Ÿå¯ä»¥çŸ¥é“ï¼Œæ•´ä¸ªåˆå§‹åŒ–ï¼Œå°±æ˜¯åœ¨è¿™ä¸ªå¯¹è±¡é¦–æ¬¡è¢«è®¿é—®æ—¶è¿›è¡Œ æ„é€ å‡½æ•°å†…å®¹å¦‚ä¸‹: 12345678910private AlarmWrapper() &#123; // è®°å½•æ¯ç§å¼‚å¸¸çš„æŠ¥è­¦æ•° alarmCountMap = new ConcurrentHashMap&lt;&gt;(); // åŠ è½½æŠ¥è­¦é…ç½®ä¿¡æ¯ confLoader = ConfLoaderFactory.loader(); // åˆå§‹åŒ–çº¿ç¨‹æ±  initExecutorService();&#125; æ‰€æœ‰å¦‚æœä½ å¸Œæœ›åœ¨è‡ªå·±çš„åº”ç”¨ä½¿ç”¨ä¹‹å‰å°±åŠ è½½å¥½æ‰€æœ‰çš„é…ç½®ï¼Œä¸å¦¨æå‰æ‰§è¡Œä¸€ä¸‹ AlarmWrapper.getInstance() IV. å°ç»“åŸºäºæ­¤ï¼Œæ•´ä¸ªç³»ç»Ÿè®¾è®¡åŸºæœ¬ä¸Šå®Œæˆï¼Œå½“ç„¶ä»£ç å±‚é¢ä¹Ÿokäº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯ä½¿ç”¨æ‰‹å†Œäº† å†çœ‹ä¸€ä¸‹æˆ‘ä»¬çš„æ•´ä¸ªé€»è¾‘ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯ä¸‹é¢è¿™ä¸ªæµç¨‹äº† æäº¤æŠ¥è­¦ å°è£…æŠ¥è­¦å†…å®¹ï¼ˆæŠ¥è­¦ç±»å‹ï¼ŒæŠ¥è­¦ä¸»é¢˜ï¼ŒæŠ¥è­¦å†…å®¹ï¼‰ ç»´æŠ¤æŠ¥è­¦è®¡æ•°ï¼ˆæ¯åˆ†é’Ÿè®¡æ•°æ¸…é›¶ï¼Œæ¯ä¸ªæŠ¥è­¦ç±»å‹å¯¹åº”ä¸€ä¸ªæŠ¥è­¦è®¡æ•°ï¼‰ é€‰æ‹©æŠ¥è­¦ æ ¹æ®æŠ¥è­¦ç±»å‹é€‰æ‹©æŠ¥è­¦è§„åˆ™ æ ¹æ®æŠ¥è­¦è§„åˆ™ï¼Œå’Œå½“å‰æŠ¥è­¦é¢‘ç‡é€‰æ‹©æŠ¥è­¦æ‰§è¡Œå™¨ è‹¥ä¸å¼€å¯åŒºé—´æ˜ å°„ï¼Œåˆ™è¿”å›é»˜è®¤æ‰§è¡Œå™¨ å¦åˆ™éå†æ‰€æœ‰æ‰§è¡Œå™¨çš„æŠ¥è­¦é¢‘ç‡åŒºé—´ï¼Œé€‰æ‹©åŒ¹é…çš„æŠ¥è­¦è§„åˆ™ æ‰§è¡ŒæŠ¥è­¦ å°è£…æŠ¥è­¦ä»»åŠ¡ï¼Œæäº¤çº¿ç¨‹æ±  æŠ¥è­¦æ‰§è¡Œå™¨å†…éƒ¨å®ç°å…·ä½“æŠ¥è­¦é€»è¾‘ V. å…¶ä»–ç›¸å…³åšæ–‡ æŠ¥è­¦ç³»ç»ŸQuickAlarmæ€»çº² æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦æ‰§è¡Œå™¨çš„è®¾è®¡ä¸å®ç° æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦è§„åˆ™çš„è®¾å®šä¸åŠ è½½ æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦è§„åˆ™è§£æ æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹é¢‘ç‡ç»Ÿè®¡åŠæ¥å£å°è£… æŠ¥è­¦ç³»ç»ŸQuickAlarmä½¿ç”¨æ‰‹å†Œ æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹é»˜è®¤æŠ¥è­¦è§„åˆ™æ‰©å±• é¡¹ç›®: QuickAlarm é¡¹ç›®åœ°å€ï¼š Quick-Alarm åšå®¢åœ°å€ï¼š å°ç°ç°Blog ä¸ªäººåšå®¢ï¼š Z+|blogåŸºäºhexo + github pagesæ­å»ºçš„ä¸ªäººåšå®¢ï¼Œè®°å½•æ‰€æœ‰å­¦ä¹ å’Œå·¥ä½œä¸­çš„åšæ–‡ï¼Œæ¬¢è¿å¤§å®¶å‰å»é€›é€› å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è¯†æœ‰é™ï¼Œå¦‚å‘ç°bugæˆ–è€…æœ‰æ›´å¥½çš„å»ºè®®ï¼Œéšæ—¶æ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼Œæˆ‘çš„å¾®åšåœ°å€: å°ç°ç°Blog æ‰«æå…³æ³¨","categories":[{"name":"Quickç³»åˆ—é¡¹ç›®","slug":"Quickç³»åˆ—é¡¹ç›®","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/"},{"name":"QuickAlarm","slug":"Quickç³»åˆ—é¡¹ç›®/QuickAlarm","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/QuickAlarm/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"SPI","slug":"SPI","permalink":"https://zbang.online/hexblog/tags/SPI/"},{"name":"QuickAlarm","slug":"QuickAlarm","permalink":"https://zbang.online/hexblog/tags/QuickAlarm/"}],"keywords":[{"name":"Quickç³»åˆ—é¡¹ç›®","slug":"Quickç³»åˆ—é¡¹ç›®","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/"},{"name":"QuickAlarm","slug":"Quickç³»åˆ—é¡¹ç›®/QuickAlarm","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/QuickAlarm/"}]},{"title":"4. æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦è§„åˆ™è§£æ","slug":"æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦è§„åˆ™è§£æ","date":"2018-02-11T08:08:04.000Z","updated":"2018-03-05T12:31:01.015Z","comments":true,"path":"2018/02/11/æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦è§„åˆ™è§£æ/","link":"","permalink":"https://zbang.online/hexblog/2018/02/11/æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦è§„åˆ™è§£æ/","excerpt":"å‰é¢ä¸¤ç¯‡åˆ†åˆ«è¯´äº†æŠ¥è­¦æ‰§è¡Œå™¨å’ŒæŠ¥è­¦è§„åˆ™çš„å®šä¹‰åŠç”¨æˆ·æ‰©å±•åŠ è½½ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ¯”è¾ƒæ ¸å¿ƒçš„ä¸€å—äº†ï¼Œå¦‚ä½•å°†æŠ¥è­¦è§„åˆ™å’ŒæŠ¥è­¦æ‰§è¡Œå™¨å…³è”èµ·æ¥ï¼Œå³å½“å‘ç”ŸæŠ¥è­¦æ—¶ï¼Œåº”è¯¥callå“ªä¸€ä¸ªæŠ¥è­¦æ‰§è¡Œå™¨","text":"å‰é¢ä¸¤ç¯‡åˆ†åˆ«è¯´äº†æŠ¥è­¦æ‰§è¡Œå™¨å’ŒæŠ¥è­¦è§„åˆ™çš„å®šä¹‰åŠç”¨æˆ·æ‰©å±•åŠ è½½ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ¯”è¾ƒæ ¸å¿ƒçš„ä¸€å—äº†ï¼Œå¦‚ä½•å°†æŠ¥è­¦è§„åˆ™å’ŒæŠ¥è­¦æ‰§è¡Œå™¨å…³è”èµ·æ¥ï¼Œå³å½“å‘ç”ŸæŠ¥è­¦æ—¶ï¼Œåº”è¯¥callå“ªä¸€ä¸ªæŠ¥è­¦æ‰§è¡Œå™¨ I. èƒŒæ™¯çŸ¥è¯†ç‚¹0. å£°æ˜åœ¨æ­£å¼è¿›å…¥ä¹‹å‰ï¼Œæœ‰å¿…è¦é¢å¤–å£°æ˜ä¸€ä¸‹ï¼Œå› ä¸ºç›®å‰çš„v1ç‰ˆæœ¬ï¼Œæ²¡æœ‰å¼€æ”¾æŠ¥è­¦è§„åˆ™çš„è‡ªå®šä¹‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç›®å‰åªæ”¯æŒé»˜è®¤çš„æŠ¥è­¦è§„åˆ™ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥çš„ä¸»è¦å†…å®¹å°†é›†ä¸­åœ¨ ç³»ç»Ÿé»˜è®¤çš„æŠ¥è­¦è§„åˆ™çš„è§£æ å³åŸºäºæŠ¥è­¦é¢‘ç‡é˜€å€¼ï¼Œè‡ªåŠ¨é€‰æ‹©æŠ¥è­¦æ‰§è¡Œå™¨çš„è§„åˆ™è§£æ 1. æŠ¥è­¦è§„åˆ™å¦‚æœå¯¹äºæŠ¥è­¦è§„åˆ™ï¼Œä¾ç„¶ä¸æ˜¯å¾ˆæ¸…æ™°çš„ï¼Œå¯ä»¥é˜…è¯»ä¸€ä¸‹ã€ŠæŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦è§„åˆ™çš„è®¾å®šä¸åŠ è½½ã€‹ è¿™é‡Œç®€å•çš„è¿›è¡Œè¯´æ˜ï¼Œç³»ç»Ÿä¸­é»˜è®¤çš„æŠ¥è­¦è§„åˆ™ç»“æ„ä¸ºï¼š keyä¸ºæŠ¥è­¦ç±»å‹ï¼ˆå³ç”¨æˆ·æ‰§è¡ŒæŠ¥è­¦æ—¶ï¼Œä¼ è¿›æ¥çš„æŠ¥è­¦ç±»å‹å‚æ•°ï¼‰ valueä¸ºå…·ä½“æŠ¥è­¦è§„åˆ™ æ¯ä¸ªæŠ¥è­¦æ‰§è¡Œå™¨æ‹¥æœ‰ä¸€ä¸ªæŠ¥è­¦é¢‘ç‡åŒºé—´ï¼Œé€šè¿‡æŠ¥è­¦é¢‘ç‡æ˜ å°„åˆ°æŠ¥è­¦æ‰§è¡Œå™¨çš„åŒºé—´æ¥é€‰æ‹©å¯¹åº”çš„AlarmExecutorï¼Œè¿™å°±æ˜¯ç³»ç»Ÿå®šä¹‰çš„æŠ¥è­¦è§„åˆ™ II. æŠ¥è­¦è§„åˆ™è§£æé€šè¿‡å‰é¢çš„æŠ¥è­¦è§„åˆ™çš„ç®€å•è¯´æ˜ï¼ŒåŸºæœ¬ä¸Šä¹Ÿå¯ä»¥æå‡ºæŠ¥è­¦è§„åˆ™çš„è§£æåŸåˆ™äº† æ¯ç§æŠ¥è­¦ç±»å‹ï¼Œå¯¹åº”ä¸€ä¸ªæŠ¥è­¦è§„åˆ™ æ¯ä¸ªæŠ¥è­¦è§„åˆ™ä¸­ï¼Œå¯ä»¥æœ‰å¤šä¸ªæŠ¥è­¦æ‰§è¡Œå™¨ æ¯ä¸ªæŠ¥è­¦æ‰§è¡Œå™¨éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„æŠ¥è­¦é¢‘ç‡çš„é˜€å€¼ æ ¹æ®é˜€å€¼å¯¹æ‰€æœ‰çš„æŠ¥è­¦æ‰§è¡Œå™¨æ’åº è®¡ç®—æŠ¥è­¦é¢‘ç‡ï¼Œæ˜ å°„åˆ°å“ªä¸ªåŒºé—´ï¼Œåˆ™é€‰æ‹©å“ªä¸ªæŠ¥è­¦æ‰§è¡Œå™¨ ä¸Šé¢æ˜¯ä¸€ä¸ªç®€å•çš„è§£æè§„åˆ™ï¼Œå½“ç„¶å®é™…ä¸Šå’Œè¿™ä¸ªå·®ä¸å¤šï¼Œä½†æœ‰ä¸€äº›é—®é¢˜éœ€è¦é¢å¤–æ³¨æ„ åªæƒ³é€‰æ‹©ä¸€ç§æŠ¥è­¦æ–¹å¼ï¼Œæ˜¯å¦å¯ä»¥æ”¯æŒï¼Ÿ å¤šé‡æŠ¥è­¦æ–¹å¼åŒæ—¶è°ƒç”¨æ€ä¹ˆå¤„ç†ï¼Ÿï¼ˆå¦‚æˆ‘å¸Œæœ›ç”¨çŸ­ä¿¡æç¤ºè¯´æœ‰é—®é¢˜ï¼ŒåŒæ—¶ç”¨é‚®ä»¶åŒ…å«è¯¦ç»†çš„å¼‚å¸¸å †æ ˆï¼‰ é¢‘ç‡é™åˆ¶ æŠ¥è­¦ç±»å‹æ²¡æœ‰è®¾ç½®æŠ¥è­¦è§„åˆ™å¦‚ä½•å¤„ç†ï¼Ÿ æŠ¥è­¦è§„åˆ™ä¸­ä½¿ç”¨äº†ä¸€ä¸ªæœªæ³¨å†Œçš„æŠ¥è­¦æ‰§è¡Œå™¨ä¼šæ€æ ·ï¼Ÿ 1. å®ç°æ–¹æ¡ˆè¯´æ˜å†æ¬¡å°†æŠ¥è­¦è§„åˆ™ç±»æ‹¿å‡ºæ¥çœ‹ä¸€ä¸‹ 12345678910111213141516171819202122232425262728293031323334/** * æŠ¥è­¦ç”¨æˆ· */private List&lt;String&gt; users;/** * æŠ¥è­¦çš„é˜€å€¼ */private List&lt;AlarmThreshold&gt; alarmThreshold;/** * æœ€å°çš„æŠ¥è­¦æ•° */private int minLimit;/** * æœ€å¤§çš„æŠ¥è­¦æ•° */private int maxLimit;/** * æŠ¥è­¦ç±»å‹ &#123;@link IExecute#getName()&#125; */private String alarmLevel;/** * true è¡¨ç¤ºå½“æŠ¥è­¦è¶…è¿‡å½“å‰çš„é˜€å€¼ä¹‹å, å°†æå‡æŠ¥è­¦çš„ç¨‹åº¦ */private boolean autoIncEmergency; é’ˆå¯¹ä¸Šé¢çš„é—®é¢˜ï¼Œé€ä¸€è¯´æ˜ é¦–å…ˆæ˜¯ autoIncEmergency è¿™ä¸ªå‚æ•°ï¼Œå¦‚æœä¸ºtrueï¼Œåˆ™è¡¨ç¤ºå¯ä»¥èµ°ä¸Šé¢çš„å“ªä¸ªåŒºé—´æ˜ å°„çš„è§„åˆ™ï¼›å¦åˆ™å°±å…¨éƒ¨èµ°AlarmConfigä¸­é»˜è®¤çš„æŠ¥è­¦ç±»å‹äº† minLimit : è¡¨ç¤ºå‘ç”ŸæŠ¥è­¦çš„é¢‘ç‡ä¸‹é™å€¼ï¼Œå°äºè¿™ä¸ªå€¼å°±ä¸ä¼šæ‰§è¡Œå…·ä½“çš„æŠ¥è­¦é€»è¾‘ maxLimit : æœ€å¤§çš„æŠ¥è­¦é¢‘ç‡ï¼Œè¶…è¿‡äº†ä¹Ÿä¸æŠ¥è­¦ï¼ˆç®€å•çš„é¢‘ç‡æ§åˆ¶ï¼‰ alarmLevel: å¯¹åº”çš„å°±æ˜¯å…·ä½“çš„æŠ¥è­¦ç±»å‹ alarmThreshold: è¿™ä¸ªåªæœ‰åœ¨autoIncEmergency=trueæ—¶ï¼Œæ‰æœ‰å°ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰é¢è¯´çš„ä¸åŒçš„æŠ¥è­¦æ‰§è¡Œå™¨ï¼Œæ ¹æ®é˜€å€¼åŒºé—´è¿›è¡Œæ’åºï¼Œå¼€å¯ä¹‹åï¼Œéå†ï¼Œåˆ¤æ–­é¢‘ç‡æ˜¯å¦åœ¨è¿™ä¸ªåŒºé—´å†…ï¼Œè‹¥åœ¨ï¼Œåˆ™è¡¨ç¤ºå¯ä»¥é€‰æ‹©å®ƒäº† å¦‚æœä¸å­˜åœ¨æŠ¥è­¦è§„åˆ™ï¼Œåˆ™é‡‡ç”¨é»˜è®¤çš„å…œåº•è§„åˆ™ è‹¥æŠ¥è­¦æ‰§è¡Œå™¨ä¹Ÿä¸å­˜åœ¨ï¼Œå°±ç›´æ¥é‡‡ç”¨ç³»ç»Ÿå®šä¹‰çš„æ—¥å¿—æŠ¥è­¦æ‰§è¡Œå™¨ 2. å®ç°åŸºæœ¬ä¸Šå‰é¢å·²ç»å°†æ•´ä¸ªé€»è¾‘éƒ½è¯´äº†ï¼Œæ‰€ä»¥å®é™…çš„ç¼–ç åè€Œæ¯”è¾ƒæ¸…æ™°äº† 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071/** * è·å–å…·ä½“çš„æŠ¥è­¦æ‰§è¡Œå™¨ * &lt;p&gt; * 1. æœªå¼€å¯ä¸¥é‡ç­‰çº§ä¸Šå‡æ—¶, ç›´æ¥è¿”å› * 2. å¼€å¯ä¹‹å, åˆ¤æ–­å½“å‰çš„è®¡æ•° èŒƒå›´ * * @param alarmConfig æŠ¥è­¦é…ç½®é¡¹, å†…éƒ¨æ‰€æœ‰çš„å‚æ•°éƒ½ä¸å¯èƒ½ä¸ºnull */public static ExecuteHelper getExecute(final AlarmConfig alarmConfig, int count) &#123; // æœªè¾¾åˆ°æŠ¥è­¦çš„ä¸‹é™ or è¶…è¿‡æŠ¥è­¦çš„ä¸Šé™æ—¶ if (count &lt; alarmConfig.getMinLimit() || count &gt; alarmConfig.getMaxLimit()) &#123; return new ExecuteHelper(SimpleExecuteFactory.getExecute(NoneExecute.NAME), alarmConfig.getUsers()); &#125; // æœªå¼€å¯æŠ¥è­¦å‡çº§, ç›´æ¥è¿”å› if (!alarmConfig.isAutoIncEmergency()) &#123; return new ExecuteHelper(SimpleExecuteFactory. getExecute(alarmConfig.getAlarmLevel()), alarmConfig.getUsers()); &#125; // æŠ¥è­¦ç­‰çº§å¼€å¯ä¸Šå‡ä¹‹è¶‹åŠ¿ // 1. è·å–è®¾ç½®çš„é»˜è®¤ç­‰çº§ // 2. åˆ¤æ–­å½“å‰çš„æŠ¥è­¦æ¬¡æ•°, é€‰æ‹©å¯¹åº”çš„æŠ¥è­¦ç±»å‹ // 3. é€‰æ‹©å…·ä½“çš„æŠ¥è­¦ç±»å‹ String defaultLevel = alarmConfig.getAlarmLevel(); String selectLevel = null; List&lt;String&gt; selectUser = alarmConfig.getUsers(); List&lt;AlarmThreshold&gt; list = alarmConfig.getAlarmThreshold(); boolean useNew = false; boolean containDefaultLevel = false; for (AlarmThreshold alarmThreshold : list) &#123; if (Objects.equals(alarmThreshold.getAlarmLevel(), defaultLevel)) &#123; containDefaultLevel = true; &#125; &#125; for (AlarmThreshold alarmThreshold : list) &#123; // è¡¨ç¤ºå½“å‰çš„æŠ¥è­¦ç­‰çº§å·²ç»èµ¶ä¸Šé»˜è®¤çš„æŠ¥è­¦ç­‰çº§äº†, æ‰€ä»¥è¦é€‰æ‹©æ–°çš„æŠ¥è­¦ç±»å‹ if (Objects.equals(alarmThreshold.getAlarmLevel(), defaultLevel)) &#123; useNew = true; &#125; if (count &lt; alarmThreshold.getThreshold()) &#123; break; &#125; selectLevel = alarmThreshold.getAlarmLevel(); // é€‰æ‹©æ–°çš„æŠ¥è­¦ç±»å‹æ—¶, éœ€è¦æ›´æ–°æŠ¥è­¦ç”¨æˆ· selectUser = alarmThreshold.getUsers(); &#125; // é˜€å€¼åˆ—è¡¨ä¸­ä¸åŒ…å«é»˜è®¤æŠ¥è­¦ç±»å‹ï¼Œåˆ™æ ¹æ®æ–°çš„æ¥ if (!containDefaultLevel &amp;&amp; selectLevel != null) &#123; return new ExecuteHelper(SimpleExecuteFactory.getExecute(selectLevel), selectUser); &#125; // å¦‚æœé˜€å€¼åˆ—è¡¨ä¸­åŒ…å«äº†é»˜è®¤æŠ¥è­¦ç±»å‹, ä¸”å·²ç»è¶…è¿‡é»˜è®¤é˜€å€¼ if (useNew &amp;&amp; selectLevel != null) &#123; return new ExecuteHelper(SimpleExecuteFactory.getExecute(selectLevel), selectUser); &#125; else &#123; return new ExecuteHelper(SimpleExecuteFactory.getExecute(defaultLevel), alarmConfig.getUsers()); &#125;&#125; å…·ä½“çš„å®ç°åŸºæœ¬å’Œæˆ‘ä»¬å‰é¢åˆ†æçš„ä¸€æ ·ï¼Œä½†æœ‰ä¸€ä¸ªåœ°æ–¹éœ€è¦é¢å¤–æ³¨æ„ é»˜è®¤æŠ¥è­¦é˜€å€¼ï¼Œå¯ä»¥ç›´æ¥å†³å®šæ˜¯å¦éœ€è¦æŠ¥è­¦ å› æ­¤å®šä¹‰çš„å…¶ä»–æŠ¥è­¦æ–¹å¼çš„é˜€å€¼ï¼Œåº”è¯¥åœ¨é»˜è®¤çš„é˜€å€¼åŒºé—´å†… å½“ç„¶AlarmThresholdä¸­ä¸åŒ…å«é»˜è®¤æŠ¥è­¦æ–¹å¼æ—¶ï¼Œä¼˜å…ˆé€‰æ‹©é˜€å€¼åŒºé—´çš„æŠ¥è­¦æ–¹å¼ å½“ç„¶AlarmThresholdä¸­åŒ…å«é»˜è®¤æŠ¥è­¦æ–¹å¼æ—¶ï¼Œæ ¹æ®æ–°çš„è§„åˆ™åšå¤„ç† ï¼ˆåæ§½ï¼šä¸Šé¢è¿™ä¸ªå®ç°æœ‰ç‚¹ç»•ï¼Œåé¢æƒ³åŠæ³•è§„é¿ä¸‹ï¼Œæå¾—ä¸å¤ªå¥½ç†è§£äº†ï¼‰ å¦å¤–ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œä¸Šé¢çš„å®ç°æ²¡æœ‰æ”¯æŒå¯ä»¥åŒæ—¶é€‰æ‹©å¤šä¸ªæŠ¥è­¦æ‰§è¡Œå™¨çš„æƒ…å†µ å› ä¸ºè€ƒè™‘åˆ°åé¢è‚¯å®šä¼šå¯¹æŠ¥è­¦è§„åˆ™çš„å®šä¹‰å’Œè§£ææ”¾å¼€ï¼Œæ‰€ä»¥å…ˆå®ç°äº†ä¸€ä¸ªç®€å•çš„åœºæ™¯ï¼Œå…·ä½“çš„æ”¾åœ¨åé¢å¤„ç† III. å°ç»“åˆ°è¿™é‡ŒæŠ¥è­¦è§„åˆ™å’ŒæŠ¥è­¦æ‰§è¡Œå™¨ä¹‹é—´çš„è§£æå…³ç³»å·²ç¡®å®šï¼Œå‰©ä¸‹çš„ä¸œè¥¿å°±ç®€å•äº†ï¼Œä¸€ä¸ªç»´æŒæŠ¥è­¦é¢‘ç‡è®¡æ•°ï¼Œä¸€ä¸ªæŠ¥è­¦çº¿ç¨‹æ± ï¼Œå†åŠ ä¸Šä¸€ä¸ªå¯¹å¤–æ¥å£çš„å°è£…è€Œè¨€ åŸºæœ¬ä¸Šï¼Œåˆ°è¿™é‡Œä¸»è¦çš„æ ¸å¿ƒé€»è¾‘å·²ç»å®Œæˆï¼Œå°ç»“ä¸€ä¸‹æœ¬ç³»ç»Ÿä¸­çš„æ ¸å¿ƒè®¾è®¡ç†å¿µ â€“ ä¸€åˆ‡å¯è‡ªå®šä¹‰ï¼ˆå½“ç„¶ç›®å‰å·®å¾—æœ‰ç‚¹è¿œï¼‰ 1. æŠ¥è­¦æ‰§è¡Œå™¨ é€šè¿‡SPIæœºåˆ¶æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰æ‰©å±• è¦æ±‚ Executor æ‹¥æœ‰å”¯ä¸€æ ‡è¯† å› ä¸ºæŠ¥è­¦æ‰§è¡Œå™¨æ”¯æŒæ‰©å±•ï¼Œæ‰€ä»¥Executorçš„å†…éƒ¨å®ç°ï¼Œå®Œå…¨å¯ä»¥ç”±ç”¨æˆ·å†³å®š 2. æŠ¥è­¦è§„åˆ™ ç›®å‰æŠ¥è­¦è§„åˆ™åªæä¾›é»˜è®¤çš„åŸºäºé¢‘ç‡åŒºé—´çš„é€‰æ‹©æ–¹æ¡ˆ æŠ¥è­¦è§„åˆ™é€šè¿‡æŠ¥è­¦æ‰§è¡Œå™¨çš„nameä¸ä¹‹å”¯ä¸€å¯¹åº”ï¼Œè‹¥å¯¹åº”ä¸ä¸Šï¼Œåˆ™é€‰æ‹©é»˜è®¤æ‰§è¡Œå™¨ æŠ¥è­¦è§„åˆ™çš„åŠ è½½åŒæ ·åŸºäºSPIï¼Œæ”¯æŒè‡ªå®šä¹‰ï¼Œå› æ­¤æŠ¥è­¦è§„åˆ™å¯ä»¥å­˜åœ¨ä»»ä½•åœ°æ–¹ æŠ¥è­¦è§„åˆ™åŠ è½½å™¨ï¼Œæä¾›ä¸€ä¸ªæŠ¥è­¦è§„åˆ™å˜åŠ¨çš„é’©å­(load()),è‹¥é‡‡ç”¨è‡ªå®šä¹‰çš„åŠ è½½ç±»ï¼Œåˆ™ç¡®ä¿è§„åˆ™å˜åŠ¨æ—¶ï¼Œä¸»åŠ¨å›è°ƒè¿™ä¸ªæ–¹æ³• é»˜è®¤çš„æŠ¥è­¦è§„åˆ™åŠ è½½ç±»ï¼Œæ˜¯åŸºäºç³»ç»Ÿçš„é…ç½®æ–‡ä»¶å®ç°ï¼Œå†…éƒ¨æ‰˜ç®¡äº†æ–‡ä»¶çš„å˜åŠ¨æ›´æ–°äº‹ä»¶ï¼ˆä½¿ç”¨commons-ioå®ç°ï¼‰ IV. å…¶ä»–ç›¸å…³åšæ–‡ æŠ¥è­¦ç³»ç»ŸQuickAlarmæ€»çº² æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦æ‰§è¡Œå™¨çš„è®¾è®¡ä¸å®ç° æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦è§„åˆ™çš„è®¾å®šä¸åŠ è½½ æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦è§„åˆ™è§£æ æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹é¢‘ç‡ç»Ÿè®¡åŠæ¥å£å°è£… æŠ¥è­¦ç³»ç»ŸQuickAlarmä½¿ç”¨æ‰‹å†Œ æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹é»˜è®¤æŠ¥è­¦è§„åˆ™æ‰©å±• é¡¹ç›®: QuickAlarm é¡¹ç›®åœ°å€ï¼š Quick-Alarm åšå®¢åœ°å€ï¼š å°ç°ç°Blog ä¸ªäººåšå®¢ï¼š Z+|blogåŸºäºhexo + github pagesæ­å»ºçš„ä¸ªäººåšå®¢ï¼Œè®°å½•æ‰€æœ‰å­¦ä¹ å’Œå·¥ä½œä¸­çš„åšæ–‡ï¼Œæ¬¢è¿å¤§å®¶å‰å»é€›é€› å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è¯†æœ‰é™ï¼Œå¦‚å‘ç°bugæˆ–è€…æœ‰æ›´å¥½çš„å»ºè®®ï¼Œéšæ—¶æ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼Œæˆ‘çš„å¾®åšåœ°å€: å°ç°ç°Blog æ‰«æå…³æ³¨","categories":[{"name":"Quickç³»åˆ—é¡¹ç›®","slug":"Quickç³»åˆ—é¡¹ç›®","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/"},{"name":"QuickAlarm","slug":"Quickç³»åˆ—é¡¹ç›®/QuickAlarm","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/QuickAlarm/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"SPI","slug":"SPI","permalink":"https://zbang.online/hexblog/tags/SPI/"},{"name":"QuickAlarm","slug":"QuickAlarm","permalink":"https://zbang.online/hexblog/tags/QuickAlarm/"}],"keywords":[{"name":"Quickç³»åˆ—é¡¹ç›®","slug":"Quickç³»åˆ—é¡¹ç›®","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/"},{"name":"QuickAlarm","slug":"Quickç³»åˆ—é¡¹ç›®/QuickAlarm","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/QuickAlarm/"}]},{"title":"3. æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦è§„åˆ™çš„è®¾å®šä¸åŠ è½½","slug":"æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦è§„åˆ™çš„è®¾å®šä¸åŠ è½½","date":"2018-02-09T11:39:43.000Z","updated":"2018-03-05T12:31:01.015Z","comments":true,"path":"2018/02/09/æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦è§„åˆ™çš„è®¾å®šä¸åŠ è½½/","link":"","permalink":"https://zbang.online/hexblog/2018/02/09/æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦è§„åˆ™çš„è®¾å®šä¸åŠ è½½/","excerpt":"å‰é¢ä¸€ç¯‡æ˜¯æŠ¥è­¦æ‰§è¡Œå™¨çš„å®šä¹‰ä¸åŠ è½½å·²ç»å®Œæˆï¼Œä½†ä¸ä¹‹å¯¹åº”çš„æŠ¥è­¦è§„åˆ™æœ‰æ˜¯å¦‚ä½•å®šä¹‰å’ŒåŠ è½½çš„å‘¢ï¼Ÿ æ­¤å¤–ï¼Œæ—¢ç„¶å‘½åä¸ºè§„åˆ™ï¼Œé‚£ä¹ˆå°±éœ€è¦æœ‰å¯¹åº”çš„è§£æå™¨ï¼Œä»¥æ ¹æ®æŠ¥è­¦è§„åˆ™å’ŒæŠ¥è­¦ç±»å‹ç­‰ç›¸å…³è¾“å…¥æ¡ä»¶ï¼Œæ¥é€‰æ‹©å¯¹åº”çš„æŠ¥è­¦æ‰§è¡Œå™¨ï¼Œå› æ­¤æœ¬æ–‡ä¸»è¦åŒ…æ‹¬çš„å†…å®¹å°±æ¯”è¾ƒæ¸…æ™°äº† æŠ¥è­¦è§„åˆ™çš„å®šä¹‰ æŠ¥è­¦è§„åˆ™çš„åŠ è½½ æŠ¥è­¦è§„åˆ™çš„è§£æä»¥åŠæŠ¥è­¦æ‰§è¡Œå™¨é€‰æ‹©","text":"å‰é¢ä¸€ç¯‡æ˜¯æŠ¥è­¦æ‰§è¡Œå™¨çš„å®šä¹‰ä¸åŠ è½½å·²ç»å®Œæˆï¼Œä½†ä¸ä¹‹å¯¹åº”çš„æŠ¥è­¦è§„åˆ™æœ‰æ˜¯å¦‚ä½•å®šä¹‰å’ŒåŠ è½½çš„å‘¢ï¼Ÿ æ­¤å¤–ï¼Œæ—¢ç„¶å‘½åä¸ºè§„åˆ™ï¼Œé‚£ä¹ˆå°±éœ€è¦æœ‰å¯¹åº”çš„è§£æå™¨ï¼Œä»¥æ ¹æ®æŠ¥è­¦è§„åˆ™å’ŒæŠ¥è­¦ç±»å‹ç­‰ç›¸å…³è¾“å…¥æ¡ä»¶ï¼Œæ¥é€‰æ‹©å¯¹åº”çš„æŠ¥è­¦æ‰§è¡Œå™¨ï¼Œå› æ­¤æœ¬æ–‡ä¸»è¦åŒ…æ‹¬çš„å†…å®¹å°±æ¯”è¾ƒæ¸…æ™°äº† æŠ¥è­¦è§„åˆ™çš„å®šä¹‰ æŠ¥è­¦è§„åˆ™çš„åŠ è½½ æŠ¥è­¦è§„åˆ™çš„è§£æä»¥åŠæŠ¥è­¦æ‰§è¡Œå™¨é€‰æ‹© I. æŠ¥è­¦è§„åˆ™å®šä¹‰ ç›®å‰é’ˆå¯¹æŠ¥è­¦è§„åˆ™æ²¡æœ‰ç»™å‡ºè‡ªå®šä¹‰é…ç½®çš„å…¥å£ï¼Œå³å®Œå…¨é‡‡ç”¨äº†é»˜è®¤çš„æ–¹æ¡ˆï¼Œåç»­å¯ä»¥è€ƒè™‘æ”¯æŒé€‚ç”¨æ–¹æ¥è‡ªå®šä¹‰æŠ¥è­¦è§„åˆ™ä»¥åŠè§£æå™¨ï¼Œè¿™æ ·æ‰©å±•æ€§å°±æ›´å¼ºäº† é¦–å…ˆè¯´æ˜ä¸‹æˆ‘ä»¬çš„è®¾è®¡è§„åˆ™ï¼Œæˆ‘ä»¬é’ˆå¯¹ä¸åŒçš„AlarmExecuteå®šä¹‰äº†ä¸€ä¸ªä¼˜å…ˆçº§ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯ é’ˆå¯¹æŠ¥è­¦é¢‘ç‡è®¾ç½®ä¸åŒåŒºé—´ï¼Œæ¯ä¸ªåŒºé—´å¯¹åº”ä¸€ç§æŠ¥è­¦ç±»å‹ å½“å®é™…è°ƒç”¨çš„æŠ¥è­¦é¢‘ç‡è¾¾åˆ°è¿™ä¸ªåŒºé—´ï¼Œå°±é€‰æ‹©è¿™ç§æŠ¥è­¦ç±»å‹ åŒæ—¶ä¹Ÿå…è®¸å…³é—­æ ¹æ®é¢‘ç‡é€‰æ‹©æŠ¥è­¦å™¨çš„åŠŸèƒ½ï¼Œå…¨ç¨‹ç”¨ä¸€ä¸ªé»˜è®¤ æ¯ç§æŠ¥è­¦ç±»å‹çš„ç”¨æˆ·éƒ½å¯ä»¥è‡ªå®šä¹‰ é’ˆå¯¹ä¸Šé¢çš„ç›®æ ‡ï¼Œæˆ‘ä»¬è®¾è®¡çš„ç±»å°±æ¯”è¾ƒæ˜ç¡®äº† é˜€å€¼ç±»ï¼š 1234567891011121314151617181920212223242526272829303132@Getter@Setter@ToStringpublic class AlarmThreshold implements Comparable&lt;AlarmThreshold&gt; &#123; /** * æŠ¥è­¦ç±»å‹ï¼Œå¯¹åº” &#123;@link IExecute#getName()&#125; */ private String alarmLevel; /** * æ™‹å‡æ­¤æŠ¥è­¦çš„é˜€å€¼ */ private int threshold; /** * å¯¹åº”çš„æŠ¥è­¦ç”¨æˆ· */ private List&lt;String&gt; users; @Override public int compareTo(AlarmThreshold o) &#123; if (o == null) &#123; return -1; &#125; return threshold - o.getThreshold(); &#125;&#125; é…ç½®ç±»ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243@Getter@Setter@ToStringpublic class AlarmConfig &#123; public static final int DEFAULT_MIN_NUM = 0; public static final int DEFAULT_MAX_NUM = 30; /** * æŠ¥è­¦ç”¨æˆ· */ private List&lt;String&gt; users; /** * æŠ¥è­¦çš„é˜€å€¼ */ private List&lt;AlarmThreshold&gt; alarmThreshold; /** * æœ€å°çš„æŠ¥è­¦æ•° */ private int minLimit; /** * æœ€å¤§çš„æŠ¥è­¦æ•° */ private int maxLimit; /** * æŠ¥è­¦ç±»å‹ &#123;@link IExecute#getName()&#125; */ private String alarmLevel; /** * true è¡¨ç¤ºå½“æŠ¥è­¦è¶…è¿‡å½“å‰çš„é˜€å€¼ä¹‹å, å°†æå‡æŠ¥è­¦çš„ç¨‹åº¦ */ private boolean autoIncEmergency;&#125; ä¸€ä¸ªæŠ¥è­¦ç±»å‹å¯¹åº”ä¸€ä¸ªAlarmConfigï¼Œè¿™æ ·å½“æ‰§è¡ŒæŠ¥è­¦æ—¶ï¼Œå°±å¯ä»¥å¾ˆå®¹æ˜“çš„è·å–å¯¹åº”çš„è§„åˆ™ åŒæ ·æ ¹æ®å®šä¹‰ï¼Œä¹Ÿå¯ä»¥çœ‹å‡ºæŠ¥è­¦è§„åˆ™æ¯”è¾ƒç®€å•ï¼Œç›´æ¥æ ¹æ®é˜€å€¼åŒºé—´æ¥é€‰æ‹© II. æŠ¥è­¦è§„åˆ™åŠ è½½å…³äºå¦‚ä½•åŠ è½½æŠ¥è­¦è§„åˆ™ï¼Œæƒ³äº†å¾ˆä¹…ï¼Œé€‰æ‹©æŠŠè¿™å—æ”¾å¼€ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•ç¡®å®šï¼Œä½¿ç”¨æ–¹çš„é…ç½®æ˜¯å­˜åœ¨ä»€ä¹ˆåœ°æ–¹çš„ï¼Œè€Œä¸”ä½¿ç”¨çš„é…ç½®æ˜¯å¦èƒ½å’Œæˆ‘ä»¬çš„è®¾è®¡çš„DOå…¼å®¹ä¹Ÿæ˜¯ä¸ªé—®é¢˜ï¼Œå› æ­¤å¹²è„†æ”¾æ‰‹ï¼ŒåŒæ ·æ˜¯é€šè¿‡SPIçš„æ–¹å¼æ¥åšçš„ æˆ‘ä»¬å®šä¹‰è§„åˆ™åŠ è½½æ¥å£ï¼š IConfLoader 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748public interface IConfLoader &#123; /** * åŠ è½½é…ç½®åˆ°å†…å­˜çš„æ“ä½œï¼Œå¯åŠ¨æ—¶ï¼Œè¢«è°ƒç”¨ * * @return true è¡¨ç¤ºåŠ è½½æˆåŠŸ; false è¡¨ç¤ºåŠ è½½å¤±è´¥ */ default boolean load() &#123; return true; &#125; /** * æ’åºï¼Œè¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ * &lt;p&gt; * è¯´æ˜ï¼š å½“ç³»ç»Ÿä¸­å¤šä¸ªLoaderå­˜åœ¨æ—¶ï¼Œä¼šæ ¹æ®ä¼˜å…ˆçº§æ¥é€‰æ‹©orderæœ€å°çš„ä¸€ä¸ªä½œä¸ºé»˜è®¤çš„Loader * * @return */ default int order() &#123; return 10; &#125; /** * è·å–æ³¨å†Œä¿¡æ¯ * * @return */ RegisterInfo getRegisterInfo(); /** * æ˜¯å¦å¼€å¯æŠ¥è­¦ * * @return */ boolean alarmEnable(); /** * æ ¹æ®æŠ¥è­¦ç±»å‹ï¼Œè·å–å¯¹åº”çš„æŠ¥è­¦è§„åˆ™ * * @param alarmKey * @return */ AlarmConfig getAlarmConfig(String alarmKey);&#125; ä¸Šé¢çš„æ–¹æ³•ï¼Œå¯ä»¥åˆ’åˆ†ä¸ºä¸¤ç±»: åŠ è½½æ—¶ä½¿ç”¨ load ä¸ºå…·ä½“çš„æ‰§è¡ŒåŠ è½½é…ç½®åˆ°å†…å­˜çš„æ–¹æ³•ï¼Œè¿”å›trueè¡¨ç¤ºåŠ è½½æˆåŠŸ order æ’åº getRegisterInfo è·å–åŸºç¡€çš„é…ç½®ä¿¡æ¯ï¼ˆåŒ…æ‹¬åº”ç”¨åç­‰ç›¸å…³é…ç½®ï¼‰ ä¸šåŠ¡è¿è¡Œæ—¶ä½¿ç”¨ alarmEnable ï¼š æ˜¯å¦å¼€å¯æŠ¥è­¦ ï¼ˆå½“å¤§é‡æŠ¥è­¦æ—¶ï¼Œå¯ä»¥å…ˆå…³é—­æŠ¥è­¦ï¼Œç„¶åå†æŸ¥é—®é¢˜ï¼‰ getAlarmConfigï¼šæ ¸å¿ƒæ–¹æ³•ï¼Œæ ¹æ®æŠ¥è­¦ç±»å‹ï¼Œè¿”å›å¯¹åº”çš„æŠ¥è­¦è§„åˆ™ ç³»ç»Ÿé»˜è®¤æä¾›ä¸€ä¸ªä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½æŠ¥è­¦è§„åˆ™çš„æ–¹æ¡ˆï¼Œä¸»è¦ä¼šä¾èµ–ä¸¤ä¸ªé…ç½®æ–‡ä»¶ alarm.properties : åˆå§‹åŒ–æ³¨å†Œä¿¡æ¯ï¼Œå†…éƒ¨ä¿å­˜ RegisterInfo æ‰€éœ€è¦çš„å±æ€§ alarmConfig : ä¿å­˜å…·ä½“çš„æŠ¥è­¦è§„åˆ™ï¼Œjsonæ ¼å¼ 1. é…ç½®åŠ è½½é…ç½®åŠ è½½çš„å®ç°é€»è¾‘ï¼Œå¦‚ä¸‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071public class PropertiesConfLoader implements IConfLoader &#123; private RegisterInfo registerInfo; private Map&lt;String, AlarmConfig&gt; cacheMap; public boolean load() &#123; // è·å–æ³¨å†Œä¿¡æ¯ registerInfo = RegisterInfoLoaderHelper.load(); if (registerInfo == null) &#123; return false; &#125; // è·å–æŠ¥è­¦çš„é…ç½®ç±» File file; String path = registerInfo.getAlarmConfPath(); if (path.startsWith(\"/\")) &#123; file = new File(path); &#125; else &#123; URL url = this.getClass().getClassLoader().getResource(path); file = new File(url.getFile()); &#125; // åŠ è½½æˆåŠŸï¼Œæ‰æ›¿æ¢ cacheMapçš„å†…å®¹ï¼› ä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢ä¿®æ”¹é…ç½®å‡ºç°é—®é¢˜ Map&lt;String, AlarmConfig&gt; tmp = init(file); boolean ans = tmp != null; // æ³¨å†Œé…ç½®æ–‡ä»¶çš„å˜åŠ¨ ans = ans &amp;&amp; PropertiesConfListenerHelper.registerConfChangeListener(file, this::init); if (ans) &#123; cacheMap = tmp; &#125; return ans; &#125; private Map&lt;String, AlarmConfig&gt; init(File file) &#123; try &#123; // æ­£å¸¸æ¥è®²ï¼Œæ˜¯ä¸€ä¸ªå®Œæ•´çš„jsonä¸² List&lt;String&gt; list = IOUtils.readLines(new FileInputStream(file), \"utf-8\"); String config = Joiner.on(\"\").join(list); return AlarmConfParse.parseConfig(config, Splitter.on(\",\").splitToList(registerInfo.getDefaultAlarmUsers())); &#125; catch (IOException e) &#123; log.error(\"load config into cacheMap error! e: &#123;&#125;\", e); return null; &#125; &#125; @Override public RegisterInfo getRegisterInfo() &#123; return registerInfo; &#125; @Override public boolean alarmEnable() &#123; return true; &#125; @Override public AlarmConfig getAlarmConfig(String alarmKey) &#123; AlarmConfig config = cacheMap.get(alarmKey); if (config == null) &#123; return cacheMap.get(AlarmConfParse.DEFAULT_ALARM_KEY); &#125; else &#123; return config; &#125; &#125;&#125; ä¸»è¦æŸ¥çœ‹é»˜è®¤çš„loadæ–¹æ³•å³å¯, alarmEnable å’Œ getAlarmConfigè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œçœ‹ä¸€ä¸‹å°±çŸ¥é“æ€ä¹ˆç©çš„ 2. RegisterInfo åŠ è½½ä¸Šé¢çš„å®ç°ä¸­ï¼Œç¬¬ä¸€æ­¥å°±æ˜¯ä» alarm.properteis æ–‡ä»¶ä¸­è¯»å–å¯¹åº”çš„é…ç½®ï¼Œç„¶ååˆå§‹åŒ– RegisterInfoå¯¹è±¡ 1234567891011@Datapublic class RegisterInfo implements Serializable &#123; // æŠ¥è­¦è§„åˆ™æ–‡ä»¶çš„è·¯å¾„ï¼Œç³»ç»Ÿé»˜è®¤åŠ è½½æ—¶ï¼Œå¿…å¡«ï¼›å¦åˆ™é€‰å¡« private String alarmConfPath; // æœ€å¤§æŠ¥è­¦ç±»å‹æ•°ï¼Œéå¿…å¡«ï¼Œé»˜è®¤1000 private Integer maxAlarmType; // é»˜è®¤æŠ¥è­¦ç”¨æˆ·ï¼Œ å¿…é¡» private String defaultAlarmUsers; // åº”ç”¨åï¼Œ å¿…é¡» private String appName;&#125; ä¸€ä¸ªé…ç½®æ–‡ä»¶å®ä¾‹ 1234appName=testalarmConfPath=/tmp/alarmConfigmaxAlarmType=1000defaultAlarmUsers=yihui ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–ä¿¡æ¯ï¼Œç„¶ååˆå§‹åŒ–å¯¹è±¡çš„è¿‡ç¨‹å°±æ¯”è¾ƒç®€å•äº†ï¼Œæˆ‘è¿™é‡Œåšäº†ä¸€ä¸ªå°ç®€åŒ–ï¼Œä½¿ç”¨åå°„çš„æ–¹å¼å®ç°å¯¹è±¡æ‹·è´ 123456789101112131415161718public static void copy(Properties source, Object dest) throws IllegalAccessException &#123; Field[] fields = dest.getClass().getDeclaredFields(); for (Field f : fields) &#123; // ä¸ä¿®æ”¹é™æ€å˜é‡ if (Modifier.isStatic(f.getModifiers())) &#123; continue; &#125; f.setAccessible(true); // å€¼æ‹·è´ï¼Œå› ä¸ºä¸åŒæ•°æ®ç±»å‹çš„é—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦å¯¹propertiesä¸­è·å–çš„Stringç±»å‹è½¬æ¢ä¸€æŠŠ f.set(dest, parseObj(source.getProperty(f.getName()), f.getType())); &#125;&#125;// å¼ºåˆ¶ç±»å‹è½¬æ¢private static &lt;T&gt; T parseObj(String obj, Class&lt;T&gt; clz) &#123; return ParseFuncEnum.getFunc(clz).apply(obj);&#125; ä¸Šé¢çš„å®ç°ç›®å‰æ¯”è¾ƒç®€å•ï¼Œæ²¡æœ‰è€ƒè™‘çˆ¶ç±»çš„æƒ…å†µï¼Œæ²¡æœ‰è€ƒè™‘å¤æ‚çš„æ•°æ®ç±»å‹è½¬æ¢ï¼Œç›®å‰åªæ”¯æŒäº†åŸºæœ¬ç±»å‹çš„è½¬æ¢ï¼Œåç»­å¯è€ƒè™‘æŠ½è±¡ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677public enum ParseFuncEnum &#123; INT_PARSE(Arrays.asList(int.class, Integer.class)) &#123; @Override public Function&lt;String, Integer&gt; getFunc() &#123; return Integer::valueOf; &#125; &#125;, LONG_PARSE(Arrays.asList(long.class, Long.class)) &#123; @Override public Function&lt;String, Long&gt; getFunc() &#123; return Long::valueOf; &#125; &#125;, BOOLEAN_PARSE(Arrays.asList(boolean.class, Boolean.class)) &#123; @Override public Function&lt;String, Boolean&gt; getFunc() &#123; return Boolean::valueOf; &#125; &#125;, FLOAT_PARSE(Arrays.asList(float.class, Float.class)) &#123; @Override public Function&lt;String, Float&gt; getFunc() &#123; return Float::valueOf; &#125; &#125;, DOUBLE_PARSSE(Arrays.asList(double.class, Double.class)) &#123; @Override public Function&lt;String, Double&gt; getFunc() &#123; return Double::valueOf; &#125; &#125;, SHORT_PARSE(Arrays.asList(short.class, Short.class)) &#123; @Override public Function&lt;String, Short&gt; getFunc() &#123; return Short::valueOf; &#125; &#125;, BYTE_PARSE(Arrays.asList(byte.class, Byte.class)) &#123; @Override public Function&lt;String, Byte&gt; getFunc() &#123; return Byte::valueOf; &#125; &#125;, CHAR_PARSE(Arrays.asList(char.class, Character.class)) &#123; @Override public Function&lt;String, Character&gt; getFunc() &#123; return s -&gt; s.charAt(0); &#125; &#125;, STRING_PARSE(Arrays.asList(String.class)) &#123; @Override public Function&lt;String, String&gt; getFunc() &#123; return s -&gt; s; &#125; &#125;,; private List&lt;Class&gt; clzList; public abstract &lt;T&gt; Function&lt;String, T&gt; getFunc(); private static Map&lt;Class, ParseFuncEnum&gt; map = new ConcurrentHashMap&lt;&gt;(20); static &#123; for (ParseFuncEnum enu : ParseFuncEnum.values()) &#123; for (Class clz : enu.clzList) &#123; map.put(clz, enu); &#125; &#125; &#125; ParseFuncEnum(List&lt;Class&gt; clz) &#123; this.clzList = clz; &#125; public static &lt;T&gt; Function&lt;String, T&gt; getFunc(Class&lt;T&gt; clz) &#123; return map.get(clz).getFunc(); &#125;&#125; 3. æŠ¥è­¦è§„åˆ™åŠ è½½æ³¨å†Œä¿¡æ¯åŠ è½½å®Œæ¯•ä¹‹åï¼Œå°±å¯ä»¥è·å–æŠ¥è­¦è§„åˆ™çš„æ–‡ä»¶åœ°å€äº†ï¼Œå› æ­¤é¦–å…ˆæ˜¯è¯»å–é…ç½®è§„åˆ™çš„å†…å®¹ï¼ˆæˆ‘ä»¬è¦æ±‚æ˜¯JSONæ ¼å¼ï¼‰ï¼Œç„¶åååºåˆ—åŒ–å³å¯ å°†jsonä¸²æ ¼å¼é…ç½®ï¼Œååºåˆ—åŒ–ä¸º BaseAlarmConf å¯¹è±¡ 12345678910111213141516171819202122232425262728293031323334353637private static final TypeReference&lt;Map&lt;String, BasicAlarmConfig&gt;&gt; typeReference = new TypeReference&lt;Map&lt;String, BasicAlarmConfig&gt;&gt;() &#123;&#125;;/** * å°†jsonä¸²æ ¼å¼çš„æŠ¥è­¦è§„åˆ™é…ç½®ï¼Œæ˜ å°„ä¸ºå¯¹åº”å®ä½“ç±» * &lt;p&gt; * å¦‚æœä¼ å¦‚çš„æ˜¯null, åˆ™é‡‡ç”¨é»˜è®¤çš„å…œåº•é…ç½® * å¦‚æœä¼ å…¥çš„æ˜¯éæ³•çš„é…ç½®ï¼Œç›´æ¥è¿”å›nullï¼Œ è¿™æ ·åšçš„ç›®çš„å¦‚ä¸‹ * &lt;p&gt; * - å¯åŠ¨æ—¶ï¼Œç›´æ¥è·çŸ¥é…ç½®æœ‰é—®é¢˜ï¼Œéœ€è¦ä¿®æ”¹ * - å¯åŠ¨ä¸­ï¼Œä¿®æ”¹é…ç½®ï¼Œæ­¤æ—¶æ–°é…ç½®æœ‰é—®é¢˜ï¼Œä¾ç„¶ä½¿ç”¨æ—§çš„é…ç½® * * @param configs * @return */private static Map&lt;String, BasicAlarmConfig&gt; parseStrConfig2Map(String configs) &#123; Map&lt;String, BasicAlarmConfig&gt; map = null; if (configs != null) &#123; try &#123; map = JSON.parseObject(configs, typeReference); &#125; catch (Exception e) &#123; logger.error(\"ConfigWrapper.parseStrConfig2Map() init config error! configs: &#123;&#125;, e:&#123;&#125;\", configs, e); return null; &#125; &#125; if (map == null) &#123; map = new HashMap&lt;&gt;(1); &#125; if (!map.containsKey(DEFAULT_ALARM_KEY)) &#123; map.put(DEFAULT_ALARM_KEY, DEFAULT_ALARM_CONFIG); &#125; return map;&#125; éœ€è¦é¢å¤–è¯´æ˜ä¸€ä¸‹ï¼Œjsonä¸²å¹¶æ²¡æœ‰ç›´æ¥çš„æ˜ å°„æˆ‘ä»¬å‰é¢å®šä¹‰çš„ AlarmConfig å¯¹è±¡ï¼Œå› ä¸ºåœ¨åŸå‹ç‰ˆæœ¬çš„è®¾è®¡çš„è¿‡ç¨‹ä¸­ï¼Œè€ƒè™‘åˆ°é…ç½®ä¸å†…éƒ¨çš„ä½¿ç”¨å¯¹è±¡ï¼Œå¯èƒ½ä¸æ˜¯ç‰¹åˆ«åŒ¹é…ï¼Œæœ€åˆçš„è®¾è®¡ä¸­ï¼Œæ˜¯å¸Œæœ›ç›´æ¥å°†AlarmConfigä¸­çš„alarmLevelç›´æ¥æ›¿æ¢æˆ AlarmExecute å®ä¾‹å¯¹è±¡çš„ï¼Œç„¶è€Œåœ¨å®é™…å®ç°ä¸­æ²¡æœ‰è¿™ä¹ˆå¹²â€¦ï¼Œæ‰€ä»¥çœ‹æºç æ—¶ï¼Œè¿™é‡Œå°±æœ‰ç‚¹å¥‡æ€ªï¼Œåé¢å®Œå…¨å¯ä»¥å¹²æ‰è¿™ä¸ªæ— ç”¨çš„é€»è¾‘ æ­¤å¤–ï¼Œå°±æ˜¯éœ€è¦ç»™ä¸€ä¸ªé»˜è®¤çš„é…ç½®é¡¹ï¼Œå½“æŠ¥è­¦ç±»å‹åŒ¹é…ä¸åˆ°å¯¹åº”çš„æŠ¥è­¦è§„åˆ™æ—¶ï¼Œå°±é€‰æ‹©é»˜è®¤çš„äº† ä¸‹é¢æ˜¯ä¸€ä¸ªæŠ¥è­¦é…ç½®çš„demo 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899&#123; \"default\": &#123; \"level\": \"LOG\", \"autoIncEmergency\": true, \"max\": 30, \"min\": 3, \"threshold\": [ &#123; \"level\": \"SMS\", \"threshold\": 20, \"users\": [ \"345345345345\", \"123123123123\" ] &#125;, &#123; \"level\": \"WEIXIN\", \"threshold\": 10, \"users\": [ \"yihui\", \"erhui\" ] &#125;, &#123; \"level\": \"LOG\", \"threshold\": 5, \"users\": [ \"yihui\", \"erhui\" ] &#125; ], \"users\": [ \"yihui\" ] &#125;, \"NPE\": &#123; \"level\": \"WEIXIN\", \"autoIncEmergency\": false, \"max\": 30, \"min\": 0, \"threshold\": [ &#123; \"level\": \"SMS\", \"threshold\": 20, \"users\": [ \"345345345345\", \"123123123123\" ] &#125;, &#123; \"level\": \"WEIXIN\", \"threshold\": 10, \"users\": [ \"3h ui\", \"4hui\" ] &#125; ], \"users\": [ \"yihui\" ] &#125;, \"XXX,YYY\": &#123; \"level\": \"EMAIL\", \"autoIncEmergency\": true, \"max\": 30, \"min\": 3, \"threshold\": [ &#123; \"level\": \"SMS\", \"threshold\": 20, \"users\": [ \"345345345345\", \"123123123123\" ] &#125;, &#123; \"level\": \"WEIXIN\", \"threshold\": 10, \"users\": [ \"yihui\", \"erhui\" ] &#125;, &#123; \"level\": \"EMAIL\", \"threshold\": 5, \"users\": [ \"yihui@xxx.com\", \"erhui@xxx.com\" ] &#125; ], \"users\": [ \"yihui@xxx.com\" ] &#125;&#125; III. ConfLoaderé€‰æ‹©å¹¶åˆå§‹åŒ–å‰é¢è¯´æ˜ï¼Œä¸ºäº†ç¡®ä¿æŠ¥è­¦è§„åˆ™çš„å¤šæ ·æ€§å­˜å‚¨ä¸åŠ è½½ï¼Œæˆ‘ä»¬æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰åŠ è½½ç±»ï¼Œæ‰€ä»¥å°±ä¼šæœ‰è¿™ä¹ˆä¸ªConfLoaderFactory, æ¥åˆ›å»ºç³»ç»Ÿä¸­ä½¿ç”¨çš„ConfLoader 12345678910111213141516171819202122232425262728293031323334353637383940public class ConfLoaderFactory &#123; private static IConfLoader currentAlarmConfLoader; public static IConfLoader loader() &#123; if (currentAlarmConfLoader == null) &#123; synchronized (ConfLoaderFactory.class) &#123; if (currentAlarmConfLoader == null) &#123; initConfLoader(); &#125; &#125; &#125; return currentAlarmConfLoader; &#125; private static void initConfLoader() &#123; Iterator&lt;IConfLoader&gt; iterator = ServiceLoader.load(IConfLoader.class).iterator(); List&lt;IConfLoader&gt; list = new ArrayList&lt;&gt;(); // æ ¹æ®ä¼˜å…ˆçº§è¿›è¡Œæ’åºï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªåŠ è½½æˆåŠŸçš„Loader while (iterator.hasNext()) &#123; list.add(iterator.next()); &#125; list.sort(Comparator.comparingInt(IConfLoader::order)); for (IConfLoader iConfLoader : list) &#123; if (iConfLoader.load()) &#123; currentAlarmConfLoader = iConfLoader; break; &#125; &#125; if (currentAlarmConfLoader == null) &#123; throw new NoAlarmLoaderSpecifyException(\"no special alarmConfLoader selected!\"); &#125; &#125;&#125; å®ç°é€»è¾‘ä¾æ—§é‡‡å–äº†SPIæœºåˆ¶ï¼Œä¸å¤Ÿæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªä¼˜å…ˆçº§ï¼Œé»˜è®¤ä»æœ€é«˜ä¼˜å…ˆçº§çš„å¼€å§‹åŠ è½½ï¼ŒåŠ è½½æˆåŠŸä¹‹åï¼Œå°±é€‰æ‹©è¿™ä¸ªä¸œè¥¿äº†ï¼›å¦åˆ™ç»§ç»­åŠ è½½ä¸‹ä¸€ä¸ªï¼Œå½“æ‰€æœ‰çš„ConfLoaderåŠ è½½å®Œæ¯•ï¼Œéƒ½æ²¡æœ‰ä¸€ä¸ªæˆåŠŸçš„ï¼Œå°±æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ IV. å°ç»“é‰´äºç¯‡å¹…é—®é¢˜ï¼Œå…³äºæŠ¥è­¦è§„åˆ™ä¸æŠ¥è­¦æ‰§è¡Œå™¨ä¹‹é—´çš„å…³ç³»ï¼Œå¯¹åº”çš„è§£é‡Šå™¨æ”¾åœ¨ä¸‹ä¸€ç¯‡è¿›è¡Œè¯´æ˜ï¼Œç®€è¦å°ç»“ä¸€ä¸‹æœ¬æ–‡å†…å®¹ æŠ¥è­¦è§„åˆ™ï¼š é‡‡ç”¨é˜€å€¼åŒºé—´æ–¹å¼ï¼Œå°†æŠ¥è­¦é¢‘ç‡ä¸æŠ¥è­¦æ‰§è¡Œå™¨å…³è”èµ·æ¥ è§„åˆ™åŠ è½½ï¼š æ”¯æŒSPIæ–¹å¼æ³¨å…¥ç”¨æˆ·åŠ è½½å™¨ï¼Œé»˜è®¤æä¾›åŸºäºé…ç½®æ–‡ä»¶çš„åŠ è½½å™¨ï¼Œä¸”ä¼˜å…ˆçº§æœ€ä½ åŸºæœ¬ä¸Šæœ¬æ–‡è¯´çš„å°±æ˜¯ä¸‹é¢è¿™å¼ å›¾çš„å†…å®¹äº† V. å…¶ä»–ç›¸å…³åšæ–‡ æŠ¥è­¦ç³»ç»ŸQuickAlarmæ€»çº² æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦æ‰§è¡Œå™¨çš„è®¾è®¡ä¸å®ç° æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦è§„åˆ™çš„è®¾å®šä¸åŠ è½½ æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦è§„åˆ™è§£æ æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹é¢‘ç‡ç»Ÿè®¡åŠæ¥å£å°è£… æŠ¥è­¦ç³»ç»ŸQuickAlarmä½¿ç”¨æ‰‹å†Œ æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹é»˜è®¤æŠ¥è­¦è§„åˆ™æ‰©å±• é¡¹ç›® é¡¹ç›®åœ°å€ï¼š Quick-Alarm åšå®¢åœ°å€ï¼š å°ç°ç°Blog ä¸ªäººåšå®¢ï¼š Z+|blogåŸºäºhexo + github pagesæ­å»ºçš„ä¸ªäººåšå®¢ï¼Œè®°å½•æ‰€æœ‰å­¦ä¹ å’Œå·¥ä½œä¸­çš„åšæ–‡ï¼Œæ¬¢è¿å¤§å®¶å‰å»é€›é€› å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è¯†æœ‰é™ï¼Œå¦‚å‘ç°bugæˆ–è€…æœ‰æ›´å¥½çš„å»ºè®®ï¼Œéšæ—¶æ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼Œæˆ‘çš„å¾®åšåœ°å€: å°ç°ç°Blog æ‰«æå…³æ³¨ï¼Œjavaåˆ†äº«","categories":[{"name":"Quickç³»åˆ—é¡¹ç›®","slug":"Quickç³»åˆ—é¡¹ç›®","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/"},{"name":"QuickAlarm","slug":"Quickç³»åˆ—é¡¹ç›®/QuickAlarm","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/QuickAlarm/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"SPI","slug":"SPI","permalink":"https://zbang.online/hexblog/tags/SPI/"},{"name":"QuickAlarm","slug":"QuickAlarm","permalink":"https://zbang.online/hexblog/tags/QuickAlarm/"}],"keywords":[{"name":"Quickç³»åˆ—é¡¹ç›®","slug":"Quickç³»åˆ—é¡¹ç›®","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/"},{"name":"QuickAlarm","slug":"Quickç³»åˆ—é¡¹ç›®/QuickAlarm","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/QuickAlarm/"}]},{"title":"2. æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦æ‰§è¡Œå™¨çš„è®¾è®¡ä¸å®ç°","slug":"æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦æ‰§è¡Œå™¨çš„è®¾è®¡ä¸å®ç°","date":"2018-02-09T11:38:59.000Z","updated":"2018-03-05T12:31:01.015Z","comments":true,"path":"2018/02/09/æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦æ‰§è¡Œå™¨çš„è®¾è®¡ä¸å®ç°/","link":"","permalink":"https://zbang.online/hexblog/2018/02/09/æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦æ‰§è¡Œå™¨çš„è®¾è®¡ä¸å®ç°/","excerpt":"æ ¹æ®å‰é¢ä¸€ç¯‡æ€»çº²çš„åšæ–‡ï¼Œå°†æ•´ä½“ç»“æ„åˆ’åˆ†ä¸ºäº†å››å¤§å—ï¼Œæœ¬æ–‡åˆ™ä¸»è¦ç›®æ ‡é›†ä¸­åœ¨ç¬¬ä¸€å—ï¼ŒæŠ¥è­¦æ‰§è¡Œå™¨ï¼ˆAlarmExecuteï¼‰çš„è®¾è®¡ä¸åŠ è½½ä¸Šäº† ä¸»è¦çš„å…³æ³¨ç‚¹æ— å¤–ä¹ å®šä¹‰-ã€‹åŠ è½½-ã€‹å®ç°é€»è¾‘ä¸‰å—äº†ï¼š AlarmExecute çš„æ¥å£å®šä¹‰ å¦‚ä½•åŠ è½½ç”¨æˆ·è‡ªå®šä¹‰çš„AlarmExecute AlarmExecuteçš„å†…éƒ¨å®ç°","text":"æ ¹æ®å‰é¢ä¸€ç¯‡æ€»çº²çš„åšæ–‡ï¼Œå°†æ•´ä½“ç»“æ„åˆ’åˆ†ä¸ºäº†å››å¤§å—ï¼Œæœ¬æ–‡åˆ™ä¸»è¦ç›®æ ‡é›†ä¸­åœ¨ç¬¬ä¸€å—ï¼ŒæŠ¥è­¦æ‰§è¡Œå™¨ï¼ˆAlarmExecuteï¼‰çš„è®¾è®¡ä¸åŠ è½½ä¸Šäº† ä¸»è¦çš„å…³æ³¨ç‚¹æ— å¤–ä¹ å®šä¹‰-ã€‹åŠ è½½-ã€‹å®ç°é€»è¾‘ä¸‰å—äº†ï¼š AlarmExecute çš„æ¥å£å®šä¹‰ å¦‚ä½•åŠ è½½ç”¨æˆ·è‡ªå®šä¹‰çš„AlarmExecute AlarmExecuteçš„å†…éƒ¨å®ç° I. AlarmExecuteæ¥å£å®šä¹‰åœ¨å®šä¹‰æ¥å£ä¹‹å‰ï¼Œå…ˆæ¥æ ¹æ®å‡ ä¸ªé—®é¢˜æ¥åŠ æ·±ä¸‹è¿™ä¸ªæ¦‚å¿µçš„ç†è§£ï¼š 1. åŸºç¡€çŸ¥è¯† è¯´ä¸€ä¸‹è¿™ä¸ªæŠ¥è­¦æ‰§è¡Œå™¨åˆ°åº•æ˜¯å¹²å˜›çš„ï¼Ÿ æ‰§è¡Œå…·ä½“çš„æŠ¥è­¦é€»è¾‘ï¼ˆæ„Ÿè§‰è¯´äº†ä¾æ®åºŸè¯ï¼‰ å› æ­¤ä¸åŒçš„æŠ¥è­¦æ–¹å¼ï¼Œå¯ä»¥é€‰æ‹©ä¸åŒçš„å®ç°ï¼Œè¿™ä¸ªå¼ºä¸šåŠ¡å…³è”çš„é€»è¾‘å¯ä»¥äº¤ç”±é€‚ç”¨æ–¹è‡ªå·±æ¥æŠŠæ§ å¤šä¸ªalarmExecuteä¹‹é—´å¦‚ä½•åŒºåˆ†ï¼Ÿ ç»™ä¸€ä¸ªç±»ä¼¼èº«ä»½è¯çš„æ ‡è¯†ï¼Œå°†æ ‡è¯†ä¸alarmExecuteç»‘å®šï¼Œåˆ™å¯ä»¥æŠ¥è­¦è§„åˆ™ä¸­ï¼Œç”¨è¿™ä¸ªæ ‡è¯†æ¥è¡¨ç¤ºå¯¹åº”çš„æŠ¥è­¦æ‰§è¡Œå™¨ æ ‡è¯†è¦æ±‚å…¨å±€å”¯ä¸€ï¼Œå¦åˆ™å°±æ²¡æ³•æ‰¾åˆ°å¯¹åº”çš„æ‰§è¡Œå™¨ 2. æ¥å£å®šä¹‰æ ¹æ®ä¸Šé¢çš„åŸºç¡€çŸ¥è¯†ï¼Œé‚£ä¹ˆå¾ˆå®¹æ˜“ç»™å‡ºæ¥å£çš„å®šä¹‰äº† 123456789101112131415161718192021public interface IExecute &#123; /** * æŠ¥è­¦çš„å…·ä½“å®ç° * * @param users æŠ¥è­¦ç”¨æˆ·ï¼Œæ”¯æŒæ‰¹é‡ * @param title æŠ¥è­¦ä¿¡æ¯çš„title * @param msg æŠ¥è­¦çš„ä¸»é¢˜ä¿¡æ¯ */ void sendMsg(List&lt;String&gt; users, String title, String msg); /** * è·å–æŠ¥è­¦å•å…ƒå”¯ä¸€æ ‡è¯† * * @return name è¦æ±‚å…¨å±€å”¯ä¸€ */ default String getName() &#123; return ExecuteNameGenerator.genExecuteName(this.getClass()); &#125;&#125; ç¬¬ä¸€ä¸ªæ–¹æ³•sendMsgä¹Ÿå°±æ˜¯éœ€è¦ä½¿ç”¨è€…æ¥å®ç°çš„å…·ä½“æ‰§è¡ŒæŠ¥è­¦ä»£ç çš„æ ¸å¿ƒæ¨¡å—äº†ï¼Œæ¯”è¾ƒæ¸…æ™°ï¼Œå…¶ä¸­ç”¨æˆ·æ˜¯åˆ—è¡¨ï¼Œå› æ­¤ï¼Œæ”¯æŒåŒæ—¶æŠ¥è­¦ç»™å¤šä¸ªç”¨æˆ·ï¼ˆä½†æ˜¯æŠ¥è­¦å†…å®¹éƒ½æ˜¯ç›¸åŒçš„ï¼‰ ç¬¬äºŒä¸ªæ–¹æ³•getNameè¡¨ç¤ºè·å–æ ‡è¯†ï¼Œé»˜è®¤ç»™äº†ä¸€ä¸ªå®ç°ï¼Œè§„åˆ™å¦‚ä¸‹ è·å–ç±»çš„ SimpleName å¹²æ‰ç±»ååé¢çš„ Execute ï¼ˆå¦‚æœä¸æ˜¯ä»¥è¿™ä¸ªç»“å°¾çš„å°±ä¸éœ€è¦äº†ï¼‰ å‰©ä¸‹çš„å…¨éƒ¨è½¬å¤§å†™ å®ä¾‹ï¼š SmsExecute -&gt; SMS; LogExecute -&gt; LOG; 3. é¢å¤–è¯´æ˜ä¸Šé¢æ¥å£å®šä¹‰ä¸­çš„sendMsgä¸­ï¼Œæ”¯æŒç»™å¤šä¸ªç”¨æˆ·å‘é€æŠ¥è­¦ä¿¡æ¯ï¼Œå¦‚æœè¦æ±‚æ¯ä¸ªæŠ¥è­¦ä¿¡æ¯éƒ½ä¸åŒï¼Œæ¯”å¦‚æœ€å¸¸è§çš„æ˜¯: å‘é€ä¸€æ®µæ–‡æœ¬ï¼Œå…¶ä¸­é€šçŸ¥äººåœ°æ–¹æ ¹æ®æŠ¥è­¦äººæ¥æ›¿æ¢ï¼Œå…¶ä»–çš„ä¸å˜ å½“ç„¶è¿™æ ·çš„åœºæ™¯å®Œå…¨å¯ä»¥è‡ªå·±åœ¨å®ç°ä¸­æ¥åš ä¼ å…¥çš„contentä½œä¸ºä¸€ä¸ªè¯æœ¯æ¨¡æ¿ ç„¶ååˆ©ç”¨ String#format() æ¥å®ç°å‚æ•°ä»£æ›¿ å½“ç„¶æ›´æ¿€è¿›ä¸€ç‚¹å°±æ˜¯ï¼Œç©¿è¿›æ¥çš„titleæˆ–è€…contentä½œä¸ºä¸€ä¸ªkeyï¼Œç„¶åæˆ‘å¯ä»¥é€šè¿‡è¿™ä¸ªkeyï¼Œåˆ°å…¶ä»–çš„åœ°æ–¹ï¼ˆå¦‚dbï¼Œç¼“å­˜ç­‰ï¼‰è·å–æŠ¥è­¦å†…å®¹ï¼Œç”šè‡³æˆ‘è¿ä¼ è¿›æ¥çš„æŠ¥è­¦äººéƒ½ä¸careï¼Œç›´æ¥ä»å…¶ä»–åœ°æ–¹æ¥è·å– ç®€å•æ¥è¯´ï¼Œè¿™ä¸ªå®ç°å§”æ‰˜ç»™ç”¨æˆ·è‡ªå·±å®ç°ï¼Œä½ å®Œå…¨å¯ä»¥éšæ„çš„æ§åˆ¶ï¼Œåšä»»ä½•ä½ æƒ³åšçš„äº‹æƒ… II. AlarmExecuteçš„åŠ è½½1. é—®é¢˜åˆ†æåŠ è½½AlarmExecutï¼Œè²Œä¼¼æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«å¤æ‚çš„ä¸œè¥¿ï¼Œä¸€èˆ¬çš„æ€è·¯æ˜¯åˆ›å»ºä¸€ä¸ªç®€å•å·¥å‚ç±»ï¼Œç„¶åå®ä¾‹åŒ–å¯¹åº”çš„Executorè¿”å›ï¼Œï¼ˆå†å¤šä¸€ç‚¹ç¡®ä¿åªæœ‰ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼ŒåŠ ä»¥ç¼“å­˜ï¼‰ è¿™æ ·æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ å¾ˆç®€å•çš„å®ç°ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦åŠ è½½ç”¨æˆ·è‡ªå®šä¹‰çš„æ‰§è¡Œå™¨ï¼Œè¦æ€ä¹ˆæ”¯æŒå‘¢ï¼Ÿ å‡ ç§å¯è¡Œçš„è§£å†³æ‰‹æ®µ 1. å¼€æ”¾ä¸€ä¸ªæ³¨å†Œæ¥å£è¿™ä¸ªå¯ç®—æ˜¯æœ€å®¹æ˜“æƒ³åˆ°çš„äº†ï¼Œç›´æ¥è®©ç”¨æˆ·æŠŠè‡ªå·±çš„Executorå®ä¾‹ï¼Œä¸»åŠ¨çš„æ‰”è¿›æ¥ 2. æŠ½è±¡å·¥å‚å°†å‰é¢è¯´çš„ç®€å•å·¥å‚ï¼Œæ”¹æˆæŠ½è±¡å·¥å‚ç±»ï¼Œè®©åå…·ä½“çš„åŠ è½½å§”æ‰˜ç»™ç”¨æˆ·è‡ªå·±æ¥åš 3. å€ŸåŠ©Springå®¹å™¨æ¥åŠ è½½å¦‚æœæ‰€æœ‰çš„AlarmExecuteéƒ½å§”æ‰˜ç»™Springå®¹å™¨æ¥ç®¡ç†ï¼Œé‚£ä¹ˆå°±å¾ˆç®€å•äº†ï¼Œç›´æ¥é€šè¿‡ApplicationContext#getBeanæ¥è·å–æ‰€æœ‰çš„æ‰§è¡Œå™¨å³å¯ 4. SPIåŠ è½½æ–¹å¼é€šè¿‡JDKçš„spiæœºåˆ¶æ¥å®ç°ï¼ˆè¯¦ç»†åé¢æ¥è¯´ï¼‰ é’ˆå¯¹ä¸Šé¢çš„å‡ ä¸ªæ‰‹æ®µï¼Œé¦–å…ˆæ’é™¤æ‰å‰é¢ä¸¤ä¸ªï¼Œå› ä¸ºä¸æ»¡è¶³æˆ‘ä»¬çš„è®¾è®¡ç›®æ ‡ä¸€ï¼š ç®€å• ï¼ˆåªæœ‰æŠ¥è­¦è¿™ä¸ªæ¥å£è¿›è¡Œäº¤äº’ï¼Œä¸éœ€è¦é¢å¤–çš„æ¥å£è°ƒç”¨ï¼‰ ç„¶åä¹Ÿæ’é™¤æ‰springå®¹å™¨ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›è¿™ä¸ªä¸œè¥¿ï¼Œå¯ä»¥è¾ƒç‹¬ç«‹çš„è¢«å¼•ç”¨åˆ°javaå·¥ç¨‹ä¸­ï¼Œåé¢å¯ä»¥çœ‹æƒ…å†µå®ç°ä¸€ä¸ªspringç‰ˆ ä»ä½¿ç”¨æ¥è®²ï¼Œç”±springå®¹å™¨æ¥æ‰˜ç®¡çš„æ–¹å¼ï¼Œå¯¹ä½¿ç”¨è€…è€Œè¨€ï¼Œæ˜¯æœ€ç®€å•ï¼Œæˆæœ¬æœ€ä½çš„ï¼Œå› ä¸ºä¸éœ€è¦é¢å¤–æ·»åŠ SPIé…ç½® 2. å®ç°æˆ‘ä»¬é‡‡ç”¨SPIæ–¹å¼æ¥å®ç°åŠ è½½ï¼Œå¯¹äºSPIæ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Œè¿™é‡Œä¸è¯¦ç»†å±•çœ‹ï¼Œæœ‰å…´è¶£çš„ç«¥é‹å¯ä»¥çœ‹æˆ‘ä¹‹å‰çš„ä¸€ä¸ªç³»ç±»åšæ–‡ï¼šè‡ªå®šä¹‰SPIæ¡†æ¶è®¾è®¡ å®ç°æ–¹å¼ï¼Œå¯è¯´æ˜¯éå¸¸ç®€å•äº† 1234567891011121314151617181920212223242526272829303132333435363738394041public class SimpleExecuteFactory &#123; private static Map&lt;String, IExecute&gt; cacheMap; private static void loadAlarmExecute() &#123; Map&lt;String, IExecute&gt; map = new HashMap&lt;&gt;(); Iterator&lt;IExecute&gt; iExecutes = ServiceLoader.load(IExecute.class).iterator(); IExecute tmp; while (iExecutes.hasNext()) &#123; tmp = iExecutes.next(); if (!map.containsKey(tmp.getName())) &#123; map.put(tmp.getName(), tmp); &#125; else &#123; throw new DuplicatedAlarmExecuteDefinedException( \"duplicated alarm execute defined!\" + \"\\n\" + \"&gt;&gt;name:\" + tmp.getName() + \"&gt;&gt;&gt;clz:\" + tmp.getClass() + \"&gt;&gt;&gt;clz:\" + map.get(tmp.getName()) ); &#125; &#125; cacheMap = map; &#125; public static IExecute getExecute(String execute) &#123; if (cacheMap == null) &#123; synchronized (SimpleExecuteFactory.class) &#123; if (cacheMap == null) &#123; loadAlarmExecute(); &#125; &#125; &#125; // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™é™çº§ä¸º LogExecute IExecute e = cacheMap.get(execute); return e == null ? cacheMap.get(LogExecute.NAME) : e; &#125;&#125; ä¸Šé¢å¯¹å¤–å°±æš´éœ²ä¸€ä¸ªæ–¹æ³•ï¼Œå†…éƒ¨æ¯”è¾ƒç®€å•ï¼Œå¦‚æœä¼ å…¥æ ‡è¯†å¯¹åº”çš„æŠ¥è­¦å™¨æ²¡æœ‰ï¼Œåˆ™è¿”å›ä¸€ä¸ªé»˜è®¤çš„ï¼Œç¡®ä¿ä¸ä¼šå› æ­¤æŒ‚æ‰ é€šè¿‡SPIåŠ è½½æ‰€æœ‰çš„æ‰§è¡Œå™¨çš„é€»è¾‘å°±ä¸€è¡Œ 1Iterator&lt;IExecute&gt; iExecutes = ServiceLoader.load(IExecute.class).iterator(); ç„¶åéœ€è¦å…³æ³¨çš„æ˜¯å¾ªç¯å†…éƒ¨ï¼Œåšäº†nameçš„å”¯ä¸€æ€§åˆ¤æ–­ï¼Œä¸æ»¡è¶³å°±ç›´æ¥æŠ›å‡ºå¼‚å¸¸äº† III. AlarmExecuteå†…éƒ¨å®ç°å†…éƒ¨æä¾›äº†ä¸¤ä¸ªåŸºæœ¬çš„æŠ¥è­¦å®ç°ï¼Œæ¯”è¾ƒç®€å• æ—¥å¿—æŠ¥è­¦æ‰§è¡Œå™¨ 123456789101112131415/** * æœ‰äº›æŠ¥è­¦,ä¸éœ€è¦ç«‹å³ä¸ŠæŠ¥,ä½†æ˜¯å¸Œæœ›è®¡æ•°, å½“å¤§é‡å‡ºç°æ—¶, ç”¨äºå‡çº§ * &lt;p/&gt; * Created by yihui on 2017/4/28. */public class LogExecute implements IExecute &#123; public static final String NAME = ExecuteNameGenerator.genExecuteName(LogExecute.class); private static final Logger logger = LoggerFactory.getLogger(\"alarm\"); @Override public void sendMsg(List&lt;String&gt; users, String title, String msg) &#123; logger.info(\"Do send msg by &#123;&#125; to user:&#123;&#125;, title: &#123;&#125;, msg: &#123;&#125;\", getName(), users, title, msg); &#125;&#125; ç©ºæŠ¥è­¦æ‰§è¡Œå™¨ 12345678910111213/** * ç©ºæŠ¥è­¦æ‰§è¡Œå™¨, ä»€ä¹ˆéƒ½ä¸å¹² * &lt;p&gt; * Created by yihui on 2017/5/12. */public class NoneExecute implements IExecute &#123; public static final String NAME = ExecuteNameGenerator.genExecuteName(NoneExecute.class); @Override public void sendMsg(List&lt;String&gt; users, String title, String msg) &#123; &#125;&#125; IV. å°ç»“AlarmExecute çš„å®šä¹‰ï¼ŒåŠ è½½ä»¥åŠå®ç°è§„åˆ™ç›®å‰éƒ½å·²ç»å®Œæˆ å®šä¹‰ï¼šä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ‰§è¡ŒæŠ¥è­¦æ–¹æ³•ï¼Œä¸€ä¸ªè¿”å›å”¯ä¸€æ ‡è¯†æ–¹æ³• åŠ è½½ï¼šé€šè¿‡SPIæ–¹å¼åŠ è½½æ‰€æœ‰å®šä¹‰çš„alarmExecute å®ç°ï¼šç”±ç”¨æˆ·è‡ªå®šä¹‰å®ç°IExecuteæ¥å£ï¼Œå†…éƒ¨é€»è¾‘æ— ä»»åŠ¡ç‰¹æ®Šè¦æ±‚ï¼Œåªæ˜¯éœ€è¦ç¡®ä¿æ¯ä¸ªexecutorçš„nameå”¯ä¸€ æ•´ä¸ªç³»ç»Ÿçš„ç¬¬ä¸€æ­¥å·²ç»è¿ˆå‡ºï¼Œä½†æ˜¯æœ‰ä¸ªé—®é¢˜å°±æ˜¯ä»€ä¹ˆæ—¶å€™ï¼Œæ‰ä¼šæ¥è°ƒç”¨ com.hust.hui.alarm.core.execut.SimpleExecuteFactory#getExecute ä»è€Œè§¦å‘æ‰§è¡Œå™¨çš„åŠ è½½å‘¢ï¼Ÿ V. å…¶ä»–ç›¸å…³åšæ–‡ æŠ¥è­¦ç³»ç»ŸQuickAlarmæ€»çº² æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦æ‰§è¡Œå™¨çš„è®¾è®¡ä¸å®ç° æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦è§„åˆ™çš„è®¾å®šä¸åŠ è½½ æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦è§„åˆ™è§£æ æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹é¢‘ç‡ç»Ÿè®¡åŠæ¥å£å°è£… æŠ¥è­¦ç³»ç»ŸQuickAlarmä½¿ç”¨æ‰‹å†Œ æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹é»˜è®¤æŠ¥è­¦è§„åˆ™æ‰©å±• é¡¹ç›® é¡¹ç›®åœ°å€ï¼š Quick-Alarm åšå®¢åœ°å€ï¼š å°ç°ç°Blog ä¸ªäººåšå®¢ï¼š Z+|blogåŸºäºhexo + github pagesæ­å»ºçš„ä¸ªäººåšå®¢ï¼Œè®°å½•æ‰€æœ‰å­¦ä¹ å’Œå·¥ä½œä¸­çš„åšæ–‡ï¼Œæ¬¢è¿å¤§å®¶å‰å»é€›é€› å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è¯†æœ‰é™ï¼Œå¦‚å‘ç°bugæˆ–è€…æœ‰æ›´å¥½çš„å»ºè®®ï¼Œéšæ—¶æ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼Œæˆ‘çš„å¾®åšåœ°å€: å°ç°ç°Blog æ‰«æå…³æ³¨ï¼Œjavaåˆ†äº«","categories":[{"name":"Quickç³»åˆ—é¡¹ç›®","slug":"Quickç³»åˆ—é¡¹ç›®","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/"},{"name":"QuickAlarm","slug":"Quickç³»åˆ—é¡¹ç›®/QuickAlarm","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/QuickAlarm/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"SPI","slug":"SPI","permalink":"https://zbang.online/hexblog/tags/SPI/"},{"name":"QuickAlarm","slug":"QuickAlarm","permalink":"https://zbang.online/hexblog/tags/QuickAlarm/"}],"keywords":[{"name":"Quickç³»åˆ—é¡¹ç›®","slug":"Quickç³»åˆ—é¡¹ç›®","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/"},{"name":"QuickAlarm","slug":"Quickç³»åˆ—é¡¹ç›®/QuickAlarm","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/QuickAlarm/"}]},{"title":"1. æŠ¥è­¦ç³»ç»ŸQuickAlarmè®¾è®¡æ€»çº²","slug":"æŠ¥è­¦ç³»ç»ŸQuickAlarmæ€»çº²","date":"2018-02-09T11:37:29.000Z","updated":"2018-03-05T12:31:01.015Z","comments":true,"path":"2018/02/09/æŠ¥è­¦ç³»ç»ŸQuickAlarmæ€»çº²/","link":"","permalink":"https://zbang.online/hexblog/2018/02/09/æŠ¥è­¦ç³»ç»ŸQuickAlarmæ€»çº²/","excerpt":"èƒŒæ™¯æ—¥å¸¸çš„ç³»ç»Ÿä¸­ï¼ŒæŠ¥è­¦æ˜¯ä¸å¯ç¼ºå°‘çš„ä¸€ç¯ï¼Œç›®å‰æŠ¥è­¦æ–¹å¼å¾ˆå¤šï¼Œæœ€å¸¸è§çš„æœ‰ç›´æ¥æ‰“æ—¥å¿—ï¼Œå¾®ä¿¡æŠ¥è­¦ï¼ŒçŸ­ä¿¡æŠ¥è­¦ï¼Œé‚®ä»¶æŠ¥è­¦ç­‰ï¼›è€Œæ¶‰åŠåˆ°æŠ¥è­¦ï¼Œä¸€èˆ¬ä¸å¯é¿å…çš„éœ€è¦æå‰è®¾ç½®ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚æŠ¥è­¦æ–¹å¼ï¼ŒæŠ¥è­¦é¢‘ç‡ï¼ŒæŠ¥è­¦ç”¨æˆ·ï¼Œå¼€å…³ç­‰ï¼› å¦å¤–ä¸€ä¸ªå¸¸è§çš„é—®é¢˜æ˜¯ä¸€èˆ¬é‡‡ç”¨çš„æ˜¯å•ä¸€çš„æŠ¥è­¦æ–¹å¼ï¼Œæ¯”å¦‚ä¸ç®¡ä»€ä¹ˆç±»å‹çš„æŠ¥è­¦å…¨éƒ¨éƒ½ç”¨çŸ­ä¿¡æ–¹å¼è§¦è¾¾ï¼Œç„¶åå°±ä¼šå‘ç°æ‰‹æœºæ—¶å¸¸å¤„äºè¢«æ·¹æ²¡çš„çŠ¶æ€äº†ï¼Œä¹…è€Œä¹…ä¹‹å¯¹æŠ¥è­¦çŸ­ä¿¡å°±ä¸ä¼šæ•æ„Ÿäº†","text":"èƒŒæ™¯æ—¥å¸¸çš„ç³»ç»Ÿä¸­ï¼ŒæŠ¥è­¦æ˜¯ä¸å¯ç¼ºå°‘çš„ä¸€ç¯ï¼Œç›®å‰æŠ¥è­¦æ–¹å¼å¾ˆå¤šï¼Œæœ€å¸¸è§çš„æœ‰ç›´æ¥æ‰“æ—¥å¿—ï¼Œå¾®ä¿¡æŠ¥è­¦ï¼ŒçŸ­ä¿¡æŠ¥è­¦ï¼Œé‚®ä»¶æŠ¥è­¦ç­‰ï¼›è€Œæ¶‰åŠåˆ°æŠ¥è­¦ï¼Œä¸€èˆ¬ä¸å¯é¿å…çš„éœ€è¦æå‰è®¾ç½®ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚æŠ¥è­¦æ–¹å¼ï¼ŒæŠ¥è­¦é¢‘ç‡ï¼ŒæŠ¥è­¦ç”¨æˆ·ï¼Œå¼€å…³ç­‰ï¼› å¦å¤–ä¸€ä¸ªå¸¸è§çš„é—®é¢˜æ˜¯ä¸€èˆ¬é‡‡ç”¨çš„æ˜¯å•ä¸€çš„æŠ¥è­¦æ–¹å¼ï¼Œæ¯”å¦‚ä¸ç®¡ä»€ä¹ˆç±»å‹çš„æŠ¥è­¦å…¨éƒ¨éƒ½ç”¨çŸ­ä¿¡æ–¹å¼è§¦è¾¾ï¼Œç„¶åå°±ä¼šå‘ç°æ‰‹æœºæ—¶å¸¸å¤„äºè¢«æ·¹æ²¡çš„çŠ¶æ€äº†ï¼Œä¹…è€Œä¹…ä¹‹å¯¹æŠ¥è­¦çŸ­ä¿¡å°±ä¸ä¼šæ•æ„Ÿäº† ç›®æ ‡å› æ­¤æˆ‘ä»¬å‡†å¤‡è®¾è®¡ä¸€ä¸ªé€šç”¨çš„æŠ¥è­¦æ¡†æ¶ å¯ä»¥è‡ªç”±é€‰æ‹©æŠ¥è­¦æ–¹å¼ï¼Œ æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰æŠ¥è­¦æ–¹å¼æ‹“å±• æ”¯æŒåŠ¨æ€çš„æŠ¥è­¦é…ç½®ï¼Œ æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰æŠ¥è­¦è§„åˆ™æ‹“å±• æ”¯æŒæŠ¥è­¦æ–¹å¼è‡ªåŠ¨åˆ‡æ¢è§„åˆ™è®¾å®š æ”¯æŒæŠ¥è­¦æ–¹å¼è‡ªå®šä¹‰è‡ªåŠ¨åˆ‡æ¢è§„åˆ™æ‹“å±• è®¾è®¡æ•´ä½“æ¥è¯´ï¼ŒæŠ¥è­¦ä¸»è¦å¯ä»¥åˆ’åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼Œå¦‚ä¸‹ï¼š æäº¤æŠ¥è­¦ï¼šå¯¹å¤–éƒ¨ä½¿ç”¨è€…æä¾›çš„æ¥å£ é€‰æ‹©æŠ¥è­¦ï¼šæ ¹æ®æŠ¥è­¦ç›¸å…³ä¿¡æ¯ï¼Œé€‰æ‹©å…·ä½“çš„æŠ¥è­¦æ‰§è¡Œå•å…ƒ æ‰§è¡ŒæŠ¥è­¦ï¼šå®ç°å…·ä½“çš„æŠ¥è­¦é€»è¾‘ ä»ä»»åŠ¡åˆ’åˆ†ä¸Šæ¥çœ‹ï¼Œæ¯”è¾ƒæ¸…æ™°ç®€å•ï¼Œä½†æ˜¯æ¯ä¸€å—çš„å†…å®¹åˆå¿…é¡»å¯ä»¥æ‹“å±•ï¼Œ é€‰æ‹©æŠ¥è­¦ï¼š æŠ¥è­¦è§„åˆ™çš„åˆ¶å®š æŠ¥è­¦è§„åˆ™åŠ è½½å™¨ ConfLoader æŠ¥è­¦è§„åˆ™å˜æ›´çš„è§¦å‘å™¨ ConfChangeTrigger æŠ¥è­¦è§„åˆ™è§£æå™¨ ConfParse ï¼š è§£ææ–‡æœ¬æ ¼å¼æŠ¥è­¦è§„åˆ™ä¸ºä¸šåŠ¡å¯¹è±¡ AlarmSelector ï¼šæ ¹æ®æŠ¥è­¦è§„åˆ™å’ŒæŠ¥è­¦ç±»å‹ï¼Œé€‰æ‹©å…·ä½“æŠ¥è­¦æ‰§è¡Œå™¨ AlarmExecute æ‰§è¡ŒæŠ¥è­¦ï¼š çº¿ç¨‹æ± æ‰§è¡Œï¼ˆä»¥é˜²æ­¢å½±å“ä¸»ä¸šåŠ¡æµç¨‹ï¼‰ AlarmExecuteçš„åŠ¨æ€æ‹“å±•ï¼ˆæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰çš„æŠ¥è­¦å™¨å®ç°ï¼‰ å®é™…çš„æŠ¥è­¦é€»è¾‘ æ ¹æ®ä¸Šé¢çš„æ‹†è§£ï¼Œåœ¨åº”ç”¨å¯åŠ¨çš„æ—¶å€™ï¼Œå°±æœ‰ä¸€äº›äº‹æƒ…å¿…é¡»å»åšäº† ConfLoaderçš„é€‰æ‹© æŠ¥è­¦è§„åˆ™åŠ è½½ AlarmExecuteçš„åŠ è½½ï¼ˆåŒ…æ‹¬é»˜è®¤çš„+è‡ªå®šä¹‰å®ç°çš„ï¼‰ ä¸‹å›¾æ˜¾ç¤ºåœ¨åº”ç”¨å¯åŠ¨æ—¶ï¼ŒæŠ¥è­¦è§„åˆ™è§£æçš„ç›¸å…³æ­¥éª¤ è‡³äºæŠ¥è­¦æ‰§è¡Œå™¨çš„åŠ è½½å°±æ¯”è¾ƒç®€å•äº†ï¼Œå¦‚ä¸‹å›¾ å› æ­¤ï¼Œæ•´ä¸ªçš„å·¥ä½œæµç¨‹å¦‚ä¸‹å›¾ ä»»åŠ¡æ‹†è§£é€šè¿‡å‰é¢çš„ä»»åŠ¡è®¾è®¡ä¹‹åï¼Œå¯¹éœ€è¦åšçš„ä¸œè¥¿æœ‰äº†ä¸€ä¸ªå¤§æ¦‚çš„è„‰ç»œäº†ï¼Œå› æ­¤åœ¨æ­£å¼æ“åˆ€å®ç°ä¹‹å‰ï¼Œä¸‹å¯¹æ•´ä¸ªæ¶æ„è¿›è¡Œä»»åŠ¡æ‹†è§£ï¼Œçœ‹ä¸‹å¯ä»¥å…·ä½“çš„æ‰§è¡Œæ­¥éª¤å¯ä»¥æ€ä¹ˆæ¥ æœ€ç›´æ¥çš„å°±æ˜¯è®¾è®¡æŠ¥è­¦æ‰§è¡Œå™¨AlarmExecute å®šä¹‰åŸºæœ¬æ¥å£ åˆ¶å®šè‡ªå®šä¹‰æ‰©å±•è§„åˆ™ æ¥ä¸‹æ¥å°±æ˜¯è®¾è®¡æŠ¥è­¦è§„åˆ™ å¦‚ä½•åŠ è½½æŠ¥è­¦è§„åˆ™ï¼Ÿ æŠ¥è­¦è§„åˆ™å…·ä½“çš„å®šä¹‰ç»†åˆ™ æŠ¥è­¦è§„åˆ™çš„è§£æï¼šå³æ ¹æ®æŠ¥è­¦ç±»å‹æ¥è·å–æŠ¥è­¦æ‰§è¡Œå™¨ æŠ¥è­¦è§„åˆ™åŠ¨æ€æ›´æ–°æ”¯æŒ æŠ¥è­¦çº¿ç¨‹æ±  ç»´æŠ¤æŠ¥è­¦é˜Ÿåˆ— æŠ¥è­¦çš„è®¡æ•°ä¸é¢‘ç‡æ§åˆ¶ å°è£…å¯¹å¤–ä½¿ç”¨æ¥å£ æ‰€ä»¥ï¼Œé€šè¿‡ä¸Šé¢çš„åˆ†æå¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªç³»ç»Ÿçš„ç»“æ„è¿˜æ˜¯è›®ç®€å•çš„ï¼Œæ•´ä¸ªåªéœ€è¦å››ä¸ªéƒ¨åˆ†å°±å¯ä»¥æå®šï¼Œå…¶ä¸­æœ€ä¸»è¦çš„å°±æ˜¯å‰é¢ä¸¤ä¸ªäº†ï¼Œåé¢å°†åˆ†åˆ«è¯´æ˜ å°ç»“åšä¸€ä¸ªä¸œè¥¿ï¼Œå½“ç„¶æ˜¯å¸Œæœ›å¯ä»¥å¸¦æ¥ä¸€äº›ç”¨å¤„ï¼Œæˆ–è€…èƒ½å­¦ä¹ åˆ°ä»€ä¹ˆä¸œè¥¿ï¼Œæ‰ä¸æ‰èŠ±è´¹ç²¾åŠ›æ¥æŠ˜è…¾ä¸€ä¸‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿™ä¸ªæŠ¥è­¦ç³»ç»Ÿï¼Œç©¶ç«Ÿæœ‰ä»€ä¹ˆç”¨ï¼Œæˆ–è€…å¯ä»¥ä»ä¸­å­¦ä¹ åˆ°ä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿ ç”¨é€”ï¼š æ”¯æŒçµæ´»å¯é…çš„æŠ¥è­¦è§„åˆ™ï¼Œä»¥åŠå…·ä½“æŠ¥è­¦ä¸šåŠ¡çš„è‡ªå®šä¹‰æ‹“å±• ç›®æ ‡å°±æ˜¯ç»Ÿä¸€æŠ¥è­¦çš„ä½¿ç”¨å§¿åŠ¿ï¼Œä¹Ÿå°±æ˜¯ä¸ç®¡ä»€ä¹ˆæŠ¥è­¦ï¼Œéƒ½ä¸€ä¸ªå§¿åŠ¿ï¼Œä½†æ˜¯å†…éƒ¨å¯ä»¥ç©å‡ºå„ç§èŠ±æ ·ï¼Œå¯¹ä½¿ç”¨è€…è€Œè¨€å°±æ–¹ä¾¿ç®€æ´äº† å­¦ä¹ ï¼š æŠ›å¼€ç‰¹æœ‰çš„çŸ¥è¯†ç‚¹ï¼Œå¯ä»¥æŠ½è±¡ä¸€äº›å…¬å…±å¯ç”¨çš„åœ°æ–¹ï¼Œå¤§æ¦‚å°±ä¸‹é¢è¿™ä¸¤ç‚¹äº† æˆ‘ä»¬å¯ä»¥å¦‚ä½•æ”¯æŒåŠŸèƒ½çš„åŠ¨æ€å¯æ‹“å±• çº¿ç¨‹æ± çš„ä½¿ç”¨ IV. å…¶ä»–ç›¸å…³åšæ–‡ æŠ¥è­¦ç³»ç»ŸQuickAlarmæ€»çº² æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦æ‰§è¡Œå™¨çš„è®¾è®¡ä¸å®ç° æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦è§„åˆ™çš„è®¾å®šä¸åŠ è½½ æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹æŠ¥è­¦è§„åˆ™è§£æ æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹é¢‘ç‡ç»Ÿè®¡åŠæ¥å£å°è£… æŠ¥è­¦ç³»ç»ŸQuickAlarmä½¿ç”¨æ‰‹å†Œ æŠ¥è­¦ç³»ç»ŸQuickAlarmä¹‹é»˜è®¤æŠ¥è­¦è§„åˆ™æ‰©å±• é¡¹ç›® é¡¹ç›®åœ°å€ï¼š Quick-Alarm åšå®¢åœ°å€ï¼š å°ç°ç°Blog ä¸ªäººåšå®¢ï¼š Z+|blogåŸºäºhexo + github pagesæ­å»ºçš„ä¸ªäººåšå®¢ï¼Œè®°å½•æ‰€æœ‰å­¦ä¹ å’Œå·¥ä½œä¸­çš„åšæ–‡ï¼Œæ¬¢è¿å¤§å®¶å‰å»é€›é€› å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è¯†æœ‰é™ï¼Œå¦‚å‘ç°bugæˆ–è€…æœ‰æ›´å¥½çš„å»ºè®®ï¼Œéšæ—¶æ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼Œæˆ‘çš„å¾®åšåœ°å€: å°ç°ç°Blog æ‰«æå…³æ³¨ï¼Œjavaåˆ†äº«","categories":[{"name":"Quickç³»åˆ—é¡¹ç›®","slug":"Quickç³»åˆ—é¡¹ç›®","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/"},{"name":"QuickAlarm","slug":"Quickç³»åˆ—é¡¹ç›®/QuickAlarm","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/QuickAlarm/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"SPI","slug":"SPI","permalink":"https://zbang.online/hexblog/tags/SPI/"},{"name":"QuickAlarm","slug":"QuickAlarm","permalink":"https://zbang.online/hexblog/tags/QuickAlarm/"},{"name":"æ•´ä½“è®¾è®¡","slug":"æ•´ä½“è®¾è®¡","permalink":"https://zbang.online/hexblog/tags/æ•´ä½“è®¾è®¡/"}],"keywords":[{"name":"Quickç³»åˆ—é¡¹ç›®","slug":"Quickç³»åˆ—é¡¹ç›®","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/"},{"name":"QuickAlarm","slug":"Quickç³»åˆ—é¡¹ç›®/QuickAlarm","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/QuickAlarm/"}]},{"title":"Javaå¯ä»¥å¦‚ä½•å®ç°æ–‡ä»¶å˜åŠ¨çš„ç›‘å¬","slug":"Javaå¯ä»¥å¦‚ä½•å®ç°æ–‡ä»¶å˜åŠ¨çš„ç›‘å¬","date":"2018-02-08T04:01:58.000Z","updated":"2018-02-13T03:21:17.018Z","comments":true,"path":"2018/02/08/Javaå¯ä»¥å¦‚ä½•å®ç°æ–‡ä»¶å˜åŠ¨çš„ç›‘å¬/","link":"","permalink":"https://zbang.online/hexblog/2018/02/08/Javaå¯ä»¥å¦‚ä½•å®ç°æ–‡ä»¶å˜åŠ¨çš„ç›‘å¬/","excerpt":"Javaå¯ä»¥å¦‚ä½•å®ç°æ–‡ä»¶å˜åŠ¨çš„ç›‘å¬åº”ç”¨ä¸­ä½¿ç”¨logbackä½œä¸ºæ—¥å¿—è¾“å‡ºç»„ä»¶çš„è¯ï¼Œå¤§éƒ¨åˆ†ä¼šå»é…ç½® logback.xml è¿™ä¸ªæ–‡ä»¶ï¼Œè€Œä¸”ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œç›´æ¥å»ä¿®æ”¹logback.xmlæ–‡ä»¶ä¸­çš„æ—¥å¿—çº§åˆ«ï¼Œä¸ç”¨é‡å¯åº”ç”¨å°±å¯ä»¥ç”Ÿæ•ˆ é‚£ä¹ˆï¼Œè¿™ä¸ªåŠŸèƒ½æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ","text":"Javaå¯ä»¥å¦‚ä½•å®ç°æ–‡ä»¶å˜åŠ¨çš„ç›‘å¬åº”ç”¨ä¸­ä½¿ç”¨logbackä½œä¸ºæ—¥å¿—è¾“å‡ºç»„ä»¶çš„è¯ï¼Œå¤§éƒ¨åˆ†ä¼šå»é…ç½® logback.xml è¿™ä¸ªæ–‡ä»¶ï¼Œè€Œä¸”ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œç›´æ¥å»ä¿®æ”¹logback.xmlæ–‡ä»¶ä¸­çš„æ—¥å¿—çº§åˆ«ï¼Œä¸ç”¨é‡å¯åº”ç”¨å°±å¯ä»¥ç”Ÿæ•ˆ é‚£ä¹ˆï¼Œè¿™ä¸ªåŠŸèƒ½æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ I. é—®é¢˜æè¿°åŠåˆ†æé’ˆå¯¹ä¸Šé¢çš„è¿™ä¸ªé—®é¢˜ï¼Œé¦–å…ˆæŠ›å‡ºä¸€ä¸ªå®é™…çš„caseï¼Œåœ¨æˆ‘çš„ä¸ªäººç½‘ç«™ Z+ä¸­ï¼Œæ‰€æœ‰çš„å°å·¥å…·éƒ½æ˜¯é€šè¿‡é…ç½®æ–‡ä»¶æ¥åŠ¨æ€æ–°å¢å’Œéšè—çš„ï¼Œå› ä¸ºåªæœ‰ä¸€å°æœåŠ¡å™¨ï¼Œæ‰€ä»¥é…ç½®æ–‡ä»¶å°±ç®€åŒ–çš„ç›´æ¥æ”¾åœ¨äº†æœåŠ¡å™¨çš„æŸä¸ªç›®å½•ä¸‹ ç°åœ¨çš„é—®é¢˜æ—¶ï¼Œæˆ‘éœ€è¦åœ¨è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹å‘ç”Ÿå˜åŠ¨æ—¶ï¼Œåº”ç”¨å¯ä»¥æ„ŸçŸ¥è¿™ç§å˜åŠ¨ï¼Œå¹¶é‡æ–°åŠ è½½æ–‡ä»¶å†…å®¹ï¼Œæ›´æ–°åº”ç”¨å†…éƒ¨ç¼“å­˜ ä¸€ä¸ªæœ€å®¹æ˜“æƒ³åˆ°çš„æ–¹æ³•ï¼Œå°±æ˜¯è½®è¯¢ï¼Œåˆ¤æ–­æ–‡ä»¶æ˜¯å¦å‘ç”Ÿä¿®æ”¹ï¼Œå¦‚æœä¿®æ”¹äº†ï¼Œåˆ™é‡æ–°åŠ è½½ï¼Œå¹¶åˆ·æ–°å†…å­˜ï¼Œæ‰€ä»¥ä¸»è¦éœ€è¦å…³å¿ƒçš„é—®é¢˜å¦‚ä¸‹ï¼š å¦‚ä½•è½®è¯¢ï¼Ÿ å¦‚ä½•åˆ¤æ–­æ–‡ä»¶æ˜¯å¦ä¿®æ”¹ï¼Ÿ é…ç½®å¼‚å¸¸ï¼Œä¼šä¸ä¼šå¯¼è‡´æœåŠ¡ä¸å¯ç”¨ï¼Ÿï¼ˆå³å®¹é”™ï¼Œè¿™ä¸ªä¸æœ¬æ¬¡ä¸»é¢˜å…³è”ä¸å¤§ï¼Œä½†åˆæ¯”è¾ƒé‡è¦â€¦ï¼‰ II. è®¾è®¡ä¸å®ç°é—®é¢˜æŠ½è±¡å‡ºæ¥ä¹‹åï¼Œå¯¹åº”çš„è§£å†³æ–¹æ¡ˆå°±æ¯”è¾ƒæ¸…æ™°äº† å¦‚ä½•è½®è¯¢ ï¼Ÿ â€“ã€‹ å®šæ—¶å™¨ Timer, ScheduledExecutorService éƒ½å¯ä»¥å®ç° å¦‚ä½•åˆ¤æ–­æ–‡ä»¶ä¿®æ”¹ï¼Ÿ â€“ã€‹æ ¹æ® java.io.File#lastModified è·å–æ–‡ä»¶çš„ä¸Šæ¬¡ä¿®æ”¹æ—¶é—´ï¼Œæ¯”å¯¹å³å¯ é‚£ä¹ˆä¸€ä¸ªå¾ˆç®€å•çš„å®ç°å°±æ¯”è¾ƒå®¹æ˜“äº†: 12345678910111213141516171819202122232425262728293031public class FileUpTest &#123; private long lastTime; @Test public void testFileUpdate() &#123; File file = new File(\"/tmp/alarmConfig\"); // é¦–å…ˆæ–‡ä»¶çš„æœ€è¿‘ä¸€æ¬¡ä¿®æ”¹æ—¶é—´æˆ³ lastTime = file.lastModified(); // å®šæ—¶ä»»åŠ¡ï¼Œæ¯ç§’æ¥åˆ¤æ–­ä¸€ä¸‹æ–‡ä»¶æ˜¯å¦å‘ç”Ÿå˜åŠ¨ï¼Œå³åˆ¤æ–­lastModifiedæ˜¯å¦æ”¹å˜ ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(1); scheduledExecutorService.scheduleAtFixedRate(new Runnable() &#123; @Override public void run() &#123; if (file.lastModified() &gt; lastTime) &#123; System.out.println(\"file update! time : \" + file.lastModified()); lastTime = file.lastModified(); &#125; &#125; &#125;,0, 1, TimeUnit.SECONDS); try &#123; Thread.sleep(1000 * 60); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125;&#125; ä¸Šé¢è¿™ä¸ªå±äºä¸€ä¸ªéå¸¸ç®€å•ï¼Œéå¸¸åŸºç¡€çš„å®ç°äº†ï¼ŒåŸºæœ¬ä¸Šä¹Ÿå¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œé‚£ä¹ˆè¿™ä¸ªå®ç°æœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ å®šæ—¶ä»»åŠ¡çš„æ‰§è¡Œä¸­ï¼Œå¦‚æœå‡ºç°äº†å¼‚å¸¸ä¼šæ€æ ·ï¼Ÿ å¯¹ä¸Šé¢çš„ä»£ç ç¨ä½œä¿®æ”¹ 12345678910111213141516171819202122232425262728293031323334public class FileUpTest &#123; private long lastTime; private void ttt() &#123; throw new NullPointerException(); &#125; @Test public void testFileUpdate() &#123; File file = new File(\"/tmp/alarmConfig\"); lastTime = file.lastModified(); ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(1); scheduledExecutorService.scheduleAtFixedRate(new Runnable() &#123; @Override public void run() &#123; if (file.lastModified() &gt; lastTime) &#123; System.out.println(\"file update! time : \" + file.lastModified()); lastTime = file.lastModified(); ttt(); &#125; &#125; &#125;, 0, 1, TimeUnit.SECONDS); try &#123; Thread.sleep(1000 * 60 * 10); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125;&#125; å®é™…æµ‹è¯•ï¼Œå‘ç°åªæœ‰é¦–æ¬¡ä¿®æ”¹çš„æ—¶å€™ï¼Œè§¦å‘äº†ä¸Šé¢çš„ä»£ç ï¼Œä½†æ˜¯å†æ¬¡ä¿®æ”¹åˆ™æ²¡æœ‰æ•ˆæœäº†ï¼Œå³å½“æŠ›å‡ºå¼‚å¸¸ä¹‹åï¼Œå®šæ—¶ä»»åŠ¡å°†ä¸å†ç»§ç»­æ‰§è¡Œäº†ï¼Œè¿™ä¸ªé—®é¢˜çš„ä¸»è¦åŸå› æ˜¯å› ä¸º ScheduledExecutorService çš„åŸå› äº† ç›´æ¥æŸ¥çœ‹ScheduledExecutorServiceçš„æºç æ³¨é‡Šè¯´æ˜ If any execution of the task encounters an exception, subsequent executions are suppressed.Otherwise, the task will only terminate via cancellation or termination of the executor.å³å¦‚æœå®šæ—¶ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°å‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™åé¢çš„ä»»åŠ¡å°†ä¸å†æ‰§è¡Œã€‚ æ‰€ä»¥ï¼Œä½¿ç”¨è¿™ç§å§¿åŠ¿çš„æ—¶å€™ï¼Œå¾—ç¡®ä¿è‡ªå·±çš„ä»»åŠ¡ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¦åˆ™åé¢å°±æ²¡æ³•ç©äº† å¯¹åº”çš„è§£å†³æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ•´ä¸ªcatchä¸€ä¸‹å°±å¥½ III. è¿›é˜¶ç‰ˆå‰é¢æ˜¯ä¸€ä¸ªåŸºç¡€çš„å®ç°ç‰ˆæœ¬äº†ï¼Œå½“ç„¶åœ¨javaåœˆï¼ŒåŸºæœ¬ä¸Šå¾ˆå¤šå¸¸è§çš„éœ€æ±‚ï¼Œéƒ½æ˜¯å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„å¼€æºå·¥å…·æ¥ä½¿ç”¨çš„ï¼Œå½“ç„¶è¿™ä¸ªä¹Ÿä¸ä¾‹å¤–ï¼Œè€Œä¸”åº”è¯¥è¿˜æ˜¯å¤§å®¶æ¯”è¾ƒå±æ€§çš„apacheç³»åˆ— é¦–å…ˆmavenä¾èµ– 12345&lt;dependency&gt; &lt;groupId&gt;commons-io&lt;/groupId&gt; &lt;artifactId&gt;commons-io&lt;/artifactId&gt; &lt;version&gt;2.6&lt;/version&gt;&lt;/dependency&gt; ä¸»è¦æ˜¯å€ŸåŠ©è¿™ä¸ªå·¥å…·ä¸­çš„ FileAlterationObserver, FileAlterationListener, FileAlterationMonitor ä¸‰ä¸ªç±»æ¥å®ç°ç›¸å…³çš„éœ€æ±‚åœºæ™¯äº†ï¼Œå½“ç„¶ä½¿ç”¨ä¹Ÿç®—æ˜¯å¾ˆç®€å•äº†ï¼Œä»¥è‡³äºéƒ½ä¸å¤ªæ¸…æ¥šå¯ä»¥å†æ€ä¹ˆå»è¯´æ˜äº†ï¼Œç›´æ¥çœ‹ä¸‹é¢ä»æˆ‘çš„ä¸€ä¸ªå¼€æºé¡¹ç›®quick-alarmä¸­æ‹·è´å‡ºæ¥çš„ä»£ç  1234567891011121314151617181920212223242526272829303132333435363738394041424344public class PropertiesConfListenerHelper &#123; public static boolean registerConfChangeListener(File file, Function&lt;File, Map&lt;String, AlarmConfig&gt;&gt; func) &#123; try &#123; // è½®è¯¢é—´éš” 5 ç§’ long interval = TimeUnit.SECONDS.toMillis(5); // å› ä¸ºç›‘å¬æ˜¯ä»¥ç›®å½•ä¸ºå•ä½è¿›è¡Œçš„ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥è·å–æ–‡ä»¶çš„æ ¹ç›®å½• File dir = file.getParentFile(); // åˆ›å»ºä¸€ä¸ªæ–‡ä»¶è§‚å¯Ÿå™¨ç”¨äºè¿‡æ»¤ FileAlterationObserver observer = new FileAlterationObserver(dir, FileFilterUtils.and(FileFilterUtils.fileFileFilter(), FileFilterUtils.nameFileFilter(file.getName()))); //è®¾ç½®æ–‡ä»¶å˜åŒ–ç›‘å¬å™¨ observer.addListener(new MyFileListener(func)); FileAlterationMonitor monitor = new FileAlterationMonitor(interval, observer); monitor.start(); return true; &#125; catch (Exception e) &#123; log.error(\"register properties change listener error! e:&#123;&#125;\", e); return false; &#125; &#125; static final class MyFileListener extends FileAlterationListenerAdaptor &#123; private Function&lt;File, Map&lt;String, AlarmConfig&gt;&gt; func; public MyFileListener(Function&lt;File, Map&lt;String, AlarmConfig&gt;&gt; func) &#123; this.func = func; &#125; @Override public void onFileChange(File file) &#123; Map&lt;String, AlarmConfig&gt; ans = func.apply(file); // å¦‚æœåŠ è½½å¤±è´¥ï¼Œæ‰“å°ä¸€æ¡æ—¥å¿— log.warn(\"PropertiesConfig changed! reload ans: &#123;&#125;\", ans); &#125; &#125;&#125; é’ˆå¯¹ä¸Šé¢çš„å®ç°ï¼Œç®€å•è¯´æ˜å‡ ç‚¹ï¼š è¿™ä¸ªæ–‡ä»¶ç›‘å¬ï¼Œæ˜¯ä»¥ç›®å½•ä¸ºæ ¹æºï¼Œç„¶åå¯ä»¥è®¾ç½®è¿‡æ»¤å™¨ï¼Œæ¥å®ç°å¯¹åº”æ–‡ä»¶å˜åŠ¨çš„ç›‘å¬ å¦‚ä¸Šé¢registerConfChangeListeneræ–¹æ³•ï¼Œä¼ å…¥çš„fileæ˜¯å…·ä½“çš„é…ç½®æ–‡ä»¶ï¼Œå› æ­¤æ„å»ºå‚æ•°çš„æ—¶å€™ï¼Œæå‡ºäº†ç›®å½•ï¼Œæå‡ºäº†æ–‡ä»¶åä½œä¸ºè¿‡æ»¤ ç¬¬äºŒå‚æ•°æ˜¯jdk8è¯­æ³•ï¼Œå…¶ä¸­ä¸ºå…·ä½“çš„è¯»å–é…ç½®æ–‡ä»¶å†…å®¹ï¼Œå¹¶æ˜ å°„ä¸ºå¯¹åº”çš„å®ä½“å¯¹è±¡ ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœ funcæ–¹æ³•æ‰§è¡Œæ—¶ï¼Œä¹ŸæŠ›å‡ºäº†å¼‚å¸¸ï¼Œä¼šæ€æ ·ï¼Ÿ å®é™…æµ‹è¯•è¡¨ç°ç»“æœå’Œä¸Šé¢ä¸€æ ·ï¼ŒæŠ›å‡ºå¼‚å¸¸ä¹‹åï¼Œä¾ç„¶è·ªï¼Œæ‰€ä»¥ä¾ç„¶å¾—æ³¨æ„ï¼Œä¸è¦è·‘å¼‚å¸¸ é‚£ä¹ˆç®€å•æ¥çœ‹ä¸€ä¸‹ä¸Šé¢çš„å®ç°é€»è¾‘ï¼Œç›´æ¥æ‰£å‡ºæ ¸å¿ƒæ¨¡å— 1234567891011121314151617181920212223public void run() &#123; while(true) &#123; if(this.running) &#123; Iterator var1 = this.observers.iterator(); while(var1.hasNext()) &#123; FileAlterationObserver observer = (FileAlterationObserver)var1.next(); observer.checkAndNotify(); &#125; if(this.running) &#123; try &#123; Thread.sleep(this.interval); &#125; catch (InterruptedException var3) &#123; ; &#125; continue; &#125; &#125; return; &#125;&#125; ä»ä¸Šé¢åŸºæœ¬ä¸Šä¸€ç›®äº†ç„¶ï¼Œæ•´ä¸ªçš„å®ç°é€»è¾‘äº†ï¼Œå’Œæˆ‘ä»¬çš„ç¬¬ä¸€ç§å®šæ—¶ä»»åŠ¡çš„æ–¹æ³•ä¸å¤ªä¸€æ ·ï¼Œè¿™å„¿ç›´æ¥ä½¿ç”¨çº¿ç¨‹ï¼Œæ­»å¾ªç¯ï¼Œå†…éƒ¨é‡‡ç”¨sleepçš„æ–¹å¼æ¥æ¥æš‚åœï¼Œå› æ­¤å‡ºç°å¼‚å¸¸æ—¶ï¼Œç›¸å½“äºç›´æ¥æŠ›å‡ºå»äº†ï¼Œè¿™ä¸ªçº¿ç¨‹å°±è·ªäº† JDKç‰ˆæœ¬jdk1.7ï¼Œæä¾›äº†ä¸€ä¸ªWatchServiceï¼Œä¹Ÿå¯ä»¥ç”¨æ¥å®ç°æ–‡ä»¶å˜åŠ¨çš„ç›‘å¬ï¼Œä¹‹å‰ä¹Ÿæ²¡æœ‰æ¥è§¦è¿‡ï¼Œçœ‹åˆ°è¯´æ˜ï¼Œç„¶åæœäº†ä¸€ä¸‹ä½¿ç”¨ç›¸å…³ï¼Œå‘ç°ä¹ŸæŒºç®€å•çš„ï¼ŒåŒæ ·ç»™å‡ºä¸€ä¸ªç®€å•çš„ç¤ºä¾‹demo 1234567891011121314151617181920212223242526272829303132333435@Testpublic void testFileUpWather() throws IOException &#123; // è¯´æ˜ï¼Œè¿™é‡Œçš„ç›‘å¬ä¹Ÿå¿…é¡»æ˜¯ç›®å½• Path path = Paths.get(\"/tmp\"); WatchService watcher = FileSystems.getDefault().newWatchService(); path.register(watcher, ENTRY_MODIFY); new Thread(() -&gt; &#123; try &#123; while (true) &#123; WatchKey key = watcher.take(); for (WatchEvent&lt;?&gt; event : key.pollEvents()) &#123; if (event.kind() == OVERFLOW) &#123; //äº‹ä»¶å¯èƒ½lost or discarded continue; &#125; Path fileName = (Path) event.context(); System.out.println(\"æ–‡ä»¶æ›´æ–°: \" + fileName); &#125; if (!key.reset()) &#123; // é‡è®¾WatchKey break; &#125; &#125; &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125;).start(); try &#123; Thread.sleep(1000 * 60 * 10); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125;&#125; IV. å°ç»“ä½¿ç”¨Javaæ¥å®ç°é…ç½®æ–‡ä»¶å˜åŠ¨çš„ç›‘å¬ï¼Œä¸»è¦æ¶‰åŠåˆ°çš„å°±æ˜¯ä¸¤ä¸ªç‚¹ å¦‚ä½•è½®è¯¢ï¼š å®šæ—¶å™¨ï¼ˆTimer, ScheduledExecutorServiceï¼‰, çº¿ç¨‹æ­»å¾ªç¯+sleep æ–‡ä»¶ä¿®æ”¹ï¼š File#lastModified æ•´ä½“æ¥è¯´ï¼Œè¿™ä¸ªå®ç°è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæ— è®ºæ˜¯è‡ªå®šä¹‰å®ç°ï¼Œè¿˜æ˜¯ä¾èµ– commos-ioæ¥åšï¼Œéƒ½æ²¡å¤ªå¤§çš„æŠ€æœ¯æˆæœ¬ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼š åƒä¸‡ä¸è¦åœ¨å®šæ—¶ä»»åŠ¡ or æ–‡ä»¶å˜åŠ¨çš„å›è°ƒæ–¹æ³•ä¸­æŠ›å‡ºå¼‚å¸¸ï¼ï¼ï¼ ä¸ºäº†é¿å…ä¸Šé¢è¿™ä¸ªæƒ…å†µï¼Œä¸€ä¸ªå¯ä»¥åšçš„å®ç°æ˜¯å€ŸåŠ©EventBusçš„å¼‚æ­¥æ¶ˆæ¯é€šçŸ¥æ¥å®ç°ï¼Œå½“æ–‡ä»¶å˜åŠ¨ä¹‹åï¼Œå‘é€ä¸€ä¸ªæ¶ˆæ¯å³å¯ï¼Œç„¶ååœ¨å…·ä½“çš„é‡æ–°åŠ è½½æ–‡ä»¶å†…å®¹çš„æ–¹æ³•ä¸Šï¼Œæ·»åŠ ä¸€ä¸ª @Subscribeæ³¨è§£å³å¯ï¼Œè¿™æ ·æ—¢å®ç°äº†è§£è€¦ï¼Œä¹Ÿé¿å…äº†å¼‚å¸¸å¯¼è‡´çš„æœåŠ¡å¼‚å¸¸ ï¼ˆå¦‚æœå¯¹è¿™ä¸ªå®ç°æœ‰å…´è¶£çš„å¯ä»¥è¯„è®ºè¯´æ˜ï¼‰ V. å…¶ä»–å‚è€ƒé¡¹ç›® é¡¹ç›®ï¼š quick-alarm æµ‹è¯•ç±»ï¼š FileUpTest.java å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è§£ä¸å…¨ï¼Œå¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ æ‰«æå…³æ³¨ï¼Œjavaåˆ†äº«","categories":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"JDK","slug":"Java/JDK","permalink":"https://zbang.online/hexblog/categories/Java/JDK/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"File","slug":"File","permalink":"https://zbang.online/hexblog/tags/File/"},{"name":"ScheduledExecutorService","slug":"ScheduledExecutorService","permalink":"https://zbang.online/hexblog/tags/ScheduledExecutorService/"}],"keywords":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"JDK","slug":"Java/JDK","permalink":"https://zbang.online/hexblog/categories/Java/JDK/"}]},{"title":"Javaä¸­å˜é‡çš„åˆå§‹åŒ–é¡ºåº","slug":"Javaä¸­å˜é‡çš„åˆå§‹åŒ–é¡ºåº","date":"2018-02-07T04:28:12.000Z","updated":"2018-02-07T12:30:56.560Z","comments":true,"path":"2018/02/07/Javaä¸­å˜é‡çš„åˆå§‹åŒ–é¡ºåº/","link":"","permalink":"https://zbang.online/hexblog/2018/02/07/Javaä¸­å˜é‡çš„åˆå§‹åŒ–é¡ºåº/","excerpt":"Javaä¸­å˜é‡çš„åˆå§‹åŒ–é¡ºåº åœ¨å†™ä¸€ä¸ªé€šç”¨çš„æŠ¥è­¦æ¨¡å—æ—¶ï¼Œé‡åˆ°ä¸€ä¸ªæœ‰æ„æ€çš„é—®é¢˜ï¼Œåœ¨è°ƒç”¨é™æ€æ–¹æ³•æ—¶ï¼Œå‘ç°é™æ€æ–¹æ³•å†…éƒ¨å¯¹é™æ€å˜é‡å¼•ç”¨æ—¶ï¼Œå±…ç„¶æŠ›å‡ºäº†npeï¼Œä»¿ä½›æ˜¯å› ä¸ºè¿™ä¸ªé™æ€å˜é‡çš„åˆå§‹åŒ–åœ¨é™æ€æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œè¿˜æ²¡æœ‰è§¦å‘ï¼Œä»è€Œå¯¼è‡´è¿™ä¸ªé—®é¢˜ï¼Œå› æ­¤ä»Šå¤©ä¸“é—¨æ¥å­¦ä¹ ä¸‹é™æ€æˆå‘˜çš„åˆå§‹åŒ–é¡ºåºï¼Œä»¥åŠä¸Šé¢è¿™ä¸ªé—®é¢˜å¯¼è‡´çš„åŸå› ","text":"Javaä¸­å˜é‡çš„åˆå§‹åŒ–é¡ºåº åœ¨å†™ä¸€ä¸ªé€šç”¨çš„æŠ¥è­¦æ¨¡å—æ—¶ï¼Œé‡åˆ°ä¸€ä¸ªæœ‰æ„æ€çš„é—®é¢˜ï¼Œåœ¨è°ƒç”¨é™æ€æ–¹æ³•æ—¶ï¼Œå‘ç°é™æ€æ–¹æ³•å†…éƒ¨å¯¹é™æ€å˜é‡å¼•ç”¨æ—¶ï¼Œå±…ç„¶æŠ›å‡ºäº†npeï¼Œä»¿ä½›æ˜¯å› ä¸ºè¿™ä¸ªé™æ€å˜é‡çš„åˆå§‹åŒ–åœ¨é™æ€æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œè¿˜æ²¡æœ‰è§¦å‘ï¼Œä»è€Œå¯¼è‡´è¿™ä¸ªé—®é¢˜ï¼Œå› æ­¤ä»Šå¤©ä¸“é—¨æ¥å­¦ä¹ ä¸‹é™æ€æˆå‘˜çš„åˆå§‹åŒ–é¡ºåºï¼Œä»¥åŠä¸Šé¢è¿™ä¸ªé—®é¢˜å¯¼è‡´çš„åŸå›  I. åˆå§‹åŒ–é¡ºåºç±»çš„åˆå§‹åŒ–é¡ºåº é™æ€å˜é‡, é™æ€ä»£ç å¿« -ã€‹ å®ä¾‹å˜é‡ï¼ˆå±æ€§ï¼Œå®ä¾‹ä»£ç å—ï¼Œæ„é€ æ–¹æ³•ï¼‰ ç»§æ‰¿å…³ç³»åˆå§‹åŒ–é¡ºåº çˆ¶ç±»é™æ€æˆå‘˜ï¼Œé™æ€ä»£ç å— -ã€‹ å­ç±»é™æ€æˆå‘˜ï¼Œé™æ€ä»£ç å— -ã€‹ çˆ¶ç±»å®ä¾‹å˜é‡ï¼ˆå±æ€§ï¼Œå®ä¾‹ä»£ç å—ï¼Œæ„é€ æ–¹æ³•ï¼‰-ã€‹å­ç±»å®ä¾‹å˜é‡ï¼ˆå±æ€§ï¼Œå®ä¾‹ä»£ç å—ï¼Œæ„é€ æ–¹æ³•ï¼‰ II. é™æ€å˜é‡åˆå§‹åŒ–é¡ºåºç±»åˆå§‹åŒ–æ—¶ï¼Œä¼šä¼˜å…ˆåˆå§‹åŒ–é™æ€æˆå‘˜ï¼Œé‚£ä¹ˆä¸€ä¸ªç±»ä¸­æœ‰å¤šä¸ªé™æ€æˆå‘˜æ—¶ï¼Œå¦‚ä½•å¤„ç†çš„ï¼Ÿ ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨é™æ€æˆå‘˜ï¼Œé™æ€ä»£ç å—ï¼Œé™æ€æ–¹æ³•çš„æµ‹è¯•ç±»ï¼Œé‚£ä¹ˆä¸‹é¢çš„è¾“å‡ºåº”è¯¥æ˜¯æ€æ ·çš„å‘¢ï¼Ÿ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152public class StaticTest &#123; static class A &#123; public A(int i) &#123; System.out.println(\"a init! \" + i); &#125; &#125; static class B &#123; public B(int i) &#123; System.out.println(\"b init! \" + i); &#125; &#125; private static A a1 = new A(1); private static B b1; private static int num; private static B b2 = new B(2); private static A a2 = genA(2); static &#123; b1 = new B(1); &#125; private static A genA(int i) &#123; System.out.println(\"gen A: \" + i); return new A(i); &#125; private static B genB(int i) &#123; System.out.println(\"gen B: \" + i); return new B(i); &#125; public static void doSome() &#123; System.out.println(\"static function doSome called! a3!=null : \" + (a3 != null) + \" | num &gt; 0 : \" + num); &#125; private static A a3; private static B b3; static &#123; System.out.println(\"num : \" + num); num = 10; a3 = genA(3); b3 = genB(3); &#125; public static void main(String[] args) &#123; doSome(); &#125;&#125; è¾“å‡ºå¦‚ä¸‹ 1234567891011a init! 1b init! 2gen A: 2a init! 2b init! 1num : 0gen A: 3a init! 3gen B: 3b init! 3static function doSome called! a3!=null : true | num &gt; 0 : 10 ä»å®é™…çš„è¾“å‡ºç»“æœæ¥çœ‹ï¼š åˆå§‹åŒ–çš„é¡ºåºæ¯”è¾ƒæ¸…æ™°äº†ï¼Œå‹æ ¹å°±æ˜¯æ ¹æ®åˆå§‹åŒ–ä»£ç çš„å…ˆåé¡ºåºæ¥çš„ï¼Œ ä¸”åœ¨è°ƒç”¨é™æ€æ–¹æ³•æ—¶ï¼Œé™æ€æ–¹æ³•å†…éƒ¨çš„é™æ€æˆå‘˜å·²ç»è¢«åˆå§‹åŒ– é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚æœåœ¨æŸä¸ªé™æ€æˆå‘˜åˆå§‹åŒ–çš„æ—¶å€™æŠ›å‡ºäº†å¼‚å¸¸ï¼Œä¼šæ€æ ·ï¼Ÿ é‚£ä¹ˆç¨ç¨æ”¹ä¸€ä¸‹ä¸Šé¢çš„ä»£ç ï¼ŒåŠ ä¸€ä¸ªä¸»åŠ¨æŠ›å¼‚å¸¸çš„case 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465public class StaticTest &#123; static class A &#123; public A(int i) &#123; System.out.println(\"a init! \" + i); &#125; &#125; static class B &#123; public B(int i) &#123; System.out.println(\"b init! \" + i); &#125; &#125; private static A a1 = new A(1); private static B b1; private static int num; private static B b2 = new B(2); private static A a2 = genA(2); static &#123; b1 = new B(1); &#125; private static A genA(int i) &#123; System.out.println(\"gen A: \" + i); return new A(i); &#125; private static B genB(int i) &#123; System.out.println(\"gen B: \" + i); return new B(i); &#125; private static A aError = genError(); private static A genError() &#123; System.out.println(\"gen error!\"); throw new RuntimeException();// return new A(10); &#125; public static void doSome() &#123; System.out.println(\"static function doSome called! a3!=null : \" + (a3 != null) + \" | num &gt; 0 : \" + num); &#125; private static A a3; private static B b3; static &#123; System.out.println(\"num : \" + num); num = 10; a3 = genA(3); b3 = genB(3); &#125; public static void main(String[] args) &#123; doSome(); &#125;&#125; æ­¤æ—¶è¾“å‡ºï¼š 12345678a init! 1b init! 2gen A: 2a init! 2b init! 1gen error!Exception in thread \"main\" java.lang.ExceptionInInitializerErrorCaused by: java.lang.RuntimeException ä¹Ÿå°±æ˜¯è¯´ï¼Œåˆå§‹åŒ–å¼‚å¸¸ä¹‹åçš„ä»£ç å°†ä¸ä¼šåœ¨ç»§ç»­æ‰§è¡Œ é‚£ä¹ˆç¬¬äºŒä¸ªé—®é¢˜æ¥äº†ï¼Œå‰é¢è¯´åˆ°å“ªä¸ªé—®é¢˜æ˜¯ä»€ä¹ˆæƒ…å†µ æœ€å¼€å§‹è¯´åˆ°ï¼Œåœ¨è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•æ—¶ï¼Œå‘ç°æœ¬è¯¥è¢«åˆå§‹åŒ–çš„é™æ€æˆå‘˜ï¼Œä¾ç„¶æ˜¯nullï¼Œä»ä¸Šé¢çš„åˆ†ææ¥è¯´ï¼Œå”¯ä¸€çš„å¯èƒ½å°±æ˜¯åœ¨æˆå‘˜å˜é‡åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œå‡ºç°äº†å¼‚å¸¸ é‚£ä¹ˆï¼Œå°±æœ‰å¦ä¸€ä¸ªé—®é¢˜äº†ï¼Œåˆå§‹åŒ–å°±æŠ¥é”™äº†ï¼Œè¿™ä¸ªç±»çš„é™æ€æ–¹æ³•è¿˜èƒ½è¢«è°ƒç”¨æ‰§è¡Œä¹ˆï¼ˆåŠ å…¥è¿™ä¸ªé™æ€æ–¹æ³•ä¸ä¾èµ–å†…éƒ¨çš„é™æ€æˆå‘˜ï¼‰ï¼Ÿ å°†å‰é¢çš„ genA()æ–¹æ³•çš„privateå»æ‰ï¼Œæ”¹æˆé»˜è®¤çš„è®¿é—®èŒƒå›´ï¼Œç„¶åä¸‹é¢ç»™å‡ºä¸€ä¸ªæ¼”ç¤ºï¼š é€šè¿‡è¿™ä¸ªæ¼”ç¤ºï¼Œä¹ŸæŒºæœ‰æ„æ€çš„ï¼Œç¬¬ä¸€æ¬¡è®¿é—®ï¼Œä¼šæŠ›å‡ºä¸€ä¸ªåˆå§‹åŒ–å¼‚å¸¸ï¼›ä½†æ˜¯å†è°ƒç”¨ä¸€æ¬¡ï¼Œç»“æœå‘ç°å±…ç„¶æ­£å¸¸æ‰§è¡Œäº†ï¼›ä½†æ˜¯è°ƒç”¨publicæ–¹æ³•æ—¶ï¼Œæ¯æ¬¡éƒ½æ˜¯æŠ›å¼‚å¸¸ å¯¼è‡´è¿™ä¸ªé—®é¢˜çš„åŸå› ï¼Œè¿˜æœ‰å¾…è€ƒç©¶ï¼Œä½†æ˜¯å‰é¢è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆï¼Œä¼°æ‘¸ç€å’Œä¸‹é¢å·®ä¸å¤šäº†ï¼ˆä½†æ˜¯ä¸æ•¢ç¡®å®šï¼Œæœ‰å¾…å¤§ç¥æŒ‡ç‚¹ï¼‰ ç†è®ºä¸Šç±»åˆå§‹åŒ–å¤±è´¥ï¼Œåº”è¯¥å°±ä¸å…è®¸è¢«è°ƒç”¨äº† ä½†æ˜¯æŸäº›æƒ…å†µä¸‹ï¼Œå¯ä»¥ç»•è¿‡è¿™ä¸ªé™åˆ¶ III. æˆå‘˜å˜é‡çš„åˆå§‹åŒ–æµ‹è¯•caseä¹Ÿæ¯”è¾ƒç®€å•ï¼ŒæŠŠå‰é¢çš„ä»£ç ä¸­çš„staticå»æ‰å³å¯ï¼Œ è¾“å‡º 1234567891011a init! 1b init! 2gen A: 2a init! 2b init! 1num : 0gen A: 3a init! 3gen B: 3b init! 3static function doSome called! a3!=null : true | num &gt; 0 : 10 ä¾ç„¶æ˜¯æ ¹æ®åˆå§‹åŒ–ä»£ç çš„å…ˆåé¡ºåºè¿›è¡Œçš„ å½“ç„¶å¦‚æœå‡ºç°å¼‚å¸¸çš„æƒ…å†µï¼Œå’Œå‰é¢çš„ç»“æœç±»ä¼¼ï¼Œä¸å†èµ˜è¿° IV. å°ç»“1. åˆå§‹åŒ–é¡ºåºç±»çš„åˆå§‹åŒ–é¡ºåº é™æ€å˜é‡, é™æ€ä»£ç å¿« -ã€‹ å®ä¾‹å˜é‡ï¼ˆå±æ€§ï¼Œå®ä¾‹ä»£ç å—ï¼Œæ„é€ æ–¹æ³•ï¼‰ ç»§æ‰¿å…³ç³»åˆå§‹åŒ–é¡ºåº çˆ¶ç±»é™æ€æˆå‘˜ï¼Œé™æ€ä»£ç å— -ã€‹ å­ç±»é™æ€æˆå‘˜ï¼Œé™æ€ä»£ç å— -ã€‹ çˆ¶ç±»å®ä¾‹å˜é‡ï¼ˆå±æ€§ï¼Œå®ä¾‹ä»£ç å—ï¼Œæ„é€ æ–¹æ³•ï¼‰-ã€‹å­ç±»å®ä¾‹å˜é‡ï¼ˆå±æ€§ï¼Œå®ä¾‹ä»£ç å—ï¼Œæ„é€ æ–¹æ³•ï¼‰ ç›¸åŒç­‰çº§çš„åˆå§‹åŒ–çš„å…ˆåé¡ºåºï¼Œæ˜¯ç›´æ¥ä¾èµ–ä»£ç ä¸­åˆå§‹åŒ–çš„å…ˆåé¡ºåº 2. åˆå§‹åŒ–å¼‚å¸¸æ—¶ç†è®ºä¸Šï¼Œç±»åˆå§‹åŒ–ä¸­æŠ›å‡ºäº†å¼‚å¸¸ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å°†æ— æ³•è¢«classLoaderæ­£ç¡®çš„åŠ è½½ï¼Œå› æ­¤ä¹Ÿæ— æ³•æœ‰æ•ˆçš„ä½¿ç”¨è¿™ä¸ªç±» ä½†æ˜¯ä¸æ’é™¤æŸäº›æƒ…å†µä¸‹ï¼Œä¾ç„¶å¼ºè¡Œçš„ä½¿ç”¨äº†è¿™ä¸ªç±»ï¼ˆå¦‚ä¸Šé¢gifå›¾ä¸­çš„æ¼”ç¤ºï¼‰ï¼Œè¿™ä¸ªåŸç†è¿˜ä¸å¤ªæ¸…æ™°ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ideaçš„debugåŠŸèƒ½æœ‰ä»€ä¹ˆé»‘ç§‘æŠ€ï¼Ÿ æ³¨æ„ å› æ­¤ï¼Œè¯·æ ¼å¤–æ³¨æ„ï¼Œåœ¨åˆå§‹åŒ–ä»£ç ä¸­ï¼Œè¯·ç¡®ä¿ä¸ä¼šæœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœæ— æ³•æŠŠæ§ï¼Œä¸å¦¨æ–°å»ºä¸€ä¸ªinit()æ–¹æ³•æ¥å®ç°åˆå§‹åŒ–å„ç§çŠ¶æ€ï¼Œç„¶ååœ¨ä»£ç ä¸­ä¸»åŠ¨è°ƒç”¨å¥½äº† V. å…¶ä»–å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è§£ä¸å…¨ï¼Œå¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ æ‰«æå…³æ³¨ï¼Œjavaåˆ†äº«","categories":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"JDK","slug":"Java/JDK","permalink":"https://zbang.online/hexblog/categories/Java/JDK/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"JDK","slug":"JDK","permalink":"https://zbang.online/hexblog/tags/JDK/"},{"name":"Initialize","slug":"Initialize","permalink":"https://zbang.online/hexblog/tags/Initialize/"}],"keywords":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"JDK","slug":"Java/JDK","permalink":"https://zbang.online/hexblog/categories/Java/JDK/"}]},{"title":"SpringMVCç»Ÿä¸€å¼‚å¸¸å¤„ç†","slug":"SpringMVCç»Ÿä¸€å¼‚å¸¸å¤„ç†","date":"2018-02-04T11:21:15.000Z","updated":"2018-02-04T12:30:54.422Z","comments":true,"path":"2018/02/04/SpringMVCç»Ÿä¸€å¼‚å¸¸å¤„ç†/","link":"","permalink":"https://zbang.online/hexblog/2018/02/04/SpringMVCç»Ÿä¸€å¼‚å¸¸å¤„ç†/","excerpt":"ç»Ÿä¸€å¼‚å¸¸æ‹¦æˆªå¤„ç†æ–¹å¼ é¡¹ç›®ä¸­ä¸å¯é¿å…ä¼šå‡ºç°ä¸€äº›å¼‚å¸¸æƒ…å†µï¼Œè€Œä¸€ä¸ªwebé¡¹ç›®ï¼Œè‹¥ä¸æ‹¦æˆªå¼‚å¸¸ï¼Œç³Ÿç³•çš„æƒ…å†µä¸‹å¯èƒ½ç›´æ¥å°†å †æ ˆæŠ›ç»™å‰ç«¯ï¼Œä»è€Œå¯¼è‡´å„ç§é¬¼ç•œçš„é—®é¢˜","text":"ç»Ÿä¸€å¼‚å¸¸æ‹¦æˆªå¤„ç†æ–¹å¼ é¡¹ç›®ä¸­ä¸å¯é¿å…ä¼šå‡ºç°ä¸€äº›å¼‚å¸¸æƒ…å†µï¼Œè€Œä¸€ä¸ªwebé¡¹ç›®ï¼Œè‹¥ä¸æ‹¦æˆªå¼‚å¸¸ï¼Œç³Ÿç³•çš„æƒ…å†µä¸‹å¯èƒ½ç›´æ¥å°†å †æ ˆæŠ›ç»™å‰ç«¯ï¼Œä»è€Œå¯¼è‡´å„ç§é¬¼ç•œçš„é—®é¢˜ I. å€ŸåŠ©@ControllerAdviceæ‹¦æˆªå¼‚å¸¸ç»™ä¸€ä¸ªç®€å•çš„demoï¼Œä¾¿å¯ä»¥å¾ˆå®¹æ˜“çš„äº†è§£è¿™ç§æ‰‹æ®µå¦‚ä½•å¤„ç†äº† 1234567891011121314151617181920@ControllerAdvice@Slf4j@ResponseBodypublic class ActionExceptionHandler &#123; @ExceptionHandler(value = Exception.class) public String defaultHandler(HttpServletRequest request, Exception e) &#123; log.error(\"unexpected exception! request: &#123;&#125;, params: &#123;&#125; refer: &#123;&#125;, e: &#123;&#125;\", request.getRequestURI(), request.getParameterMap(), request.getHeader(\"referer\"), e); if (StringUtils.isBlank(e.getMessage())) &#123; return ResponseWrapper.errorReturn(new Status(500, \"å†…éƒ¨å¼‚å¸¸\")); &#125; else &#123; return ResponseWrapper.errorReturn(new Status(500, e.getMessage())); &#125; &#125;&#125; è¿™é‡Œä¸»è¦å€ŸåŠ©ä¸¤ä¸ªæ³¨è§£æ¥å®ç°ï¼ŒControllerAdvice å’Œ ExceptionHandler II. å…¶ä»–å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è§£ä¸å…¨ï¼Œå¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ æ‰«æå…³æ³¨ï¼Œjavaåˆ†äº«","categories":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"Spring","slug":"Java/Spring","permalink":"https://zbang.online/hexblog/categories/Java/Spring/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"Spring","slug":"Spring","permalink":"https://zbang.online/hexblog/tags/Spring/"},{"name":"Exception","slug":"Exception","permalink":"https://zbang.online/hexblog/tags/Exception/"}],"keywords":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"Spring","slug":"Java/Spring","permalink":"https://zbang.online/hexblog/categories/Java/Spring/"}]},{"title":" JavaWebä¸‰å¤§ç»„ä»¶ä¹‹Filterå­¦ä¹ è¯¦è§£","slug":"JavaWebä¸‰å¤§ç»„ä»¶ä¹‹Filterå­¦ä¹ è¯¦è§£","date":"2018-01-26T10:02:01.000Z","updated":"2018-02-13T03:21:17.017Z","comments":true,"path":"2018/01/26/JavaWebä¸‰å¤§ç»„ä»¶ä¹‹Filterå­¦ä¹ è¯¦è§£/","link":"","permalink":"https://zbang.online/hexblog/2018/01/26/JavaWebä¸‰å¤§ç»„ä»¶ä¹‹Filterå­¦ä¹ è¯¦è§£/","excerpt":"JavaWebä¸‰å¤§ç»„ä»¶ä¹‹Filterå­¦ä¹ è¯¦è§£ FilteråŸºæœ¬ä¸Šå¯ä»¥è¯´å­˜åœ¨æ‰€æœ‰çš„JavaWebé¡¹ç›®ä¸­ï¼Œæ¯”å¦‚æœ€åŸºæœ¬çš„ä¸€ä¸ªè¯·æ±‚å‚æ•°çš„ç¼–ç CharacterEncodingFilterï¼Œå¤§å®¶ä¸€èˆ¬éƒ½ä¼šé…ç½®ä¸‹ï¼Œé‚£ä¹ˆfilteræ˜¯å¹²å˜›çš„å‘¢ï¼Ÿ æœ¬ç¯‡å°†ä¸»è¦é›†ä¸­åœ¨fitlerçš„ä»¥ä¸‹å‡ ä¸ªçŸ¥è¯†ç‚¹: å¹²å˜›çš„ æ€ä¹ˆç”¨ å¤šä¸ªFilteræ‰§è¡Œçš„å…ˆåé¡ºåº æ³¨æ„äº‹é¡¹","text":"JavaWebä¸‰å¤§ç»„ä»¶ä¹‹Filterå­¦ä¹ è¯¦è§£ FilteråŸºæœ¬ä¸Šå¯ä»¥è¯´å­˜åœ¨æ‰€æœ‰çš„JavaWebé¡¹ç›®ä¸­ï¼Œæ¯”å¦‚æœ€åŸºæœ¬çš„ä¸€ä¸ªè¯·æ±‚å‚æ•°çš„ç¼–ç CharacterEncodingFilterï¼Œå¤§å®¶ä¸€èˆ¬éƒ½ä¼šé…ç½®ä¸‹ï¼Œé‚£ä¹ˆfilteræ˜¯å¹²å˜›çš„å‘¢ï¼Ÿ æœ¬ç¯‡å°†ä¸»è¦é›†ä¸­åœ¨fitlerçš„ä»¥ä¸‹å‡ ä¸ªçŸ¥è¯†ç‚¹: å¹²å˜›çš„ æ€ä¹ˆç”¨ å¤šä¸ªFilteræ‰§è¡Œçš„å…ˆåé¡ºåº æ³¨æ„äº‹é¡¹ I. åŸºæœ¬çŸ¥è¯†Filterç§°ä¹‹ä¸ºè¿‡æ»¤å™¨ï¼Œæ˜¯ç”¨æ¥åšä¸€äº›æ‹¦æˆªçš„ä»»åŠ¡ï¼Œ åœ¨Servletæ¥å—è¯·æ±‚ä¹‹å‰ï¼Œåšä¸€äº›äº‹æƒ…ï¼Œå¦‚æœä¸æ»¡è¶³é™å®šï¼Œå¯ä»¥æ‹’ç»è¿›å…¥Servlet ä»ä¸Šé¢çš„å›¾ï¼Œå¯ä»¥çœ‹å‡ºä¸€ä¸ªFilterçš„å·¥ä½œæµç¨‹: ä¸€ä¸ªhttpè¯·æ±‚è¿‡æ¥ä¹‹å é¦–å…ˆè¿›å…¥filterï¼Œæ‰§è¡Œç›¸å…³ä¸šåŠ¡é€»è¾‘ è‹¥åˆ¤å®šé€šè¡Œï¼Œåˆ™è¿›å…¥Servleté€»è¾‘ï¼ŒServletæ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œåˆè¿”å›Filterï¼Œæœ€ååœ¨è¿”å›ç»™è¯·æ±‚æ–¹ åˆ¤å®šå¤±è´¥ï¼Œç›´æ¥è¿”å›ï¼Œä¸éœ€è¦å°†è¯·æ±‚å‘ç»™Servlet é€šè¿‡ä¸Šé¢çš„æµç¨‹ï¼Œå¯ä»¥æ¨ç®—ä½¿ç”¨åœºæ™¯ï¼š åœ¨filterå±‚ï¼Œæ¥è·å–ç”¨æˆ·çš„èº«ä»½ å¯ä»¥è€ƒè™‘åœ¨filterå±‚åšä¸€äº›å¸¸è§„çš„æ ¡éªŒï¼ˆå¦‚å‚æ•°æ ¡éªŒï¼Œrefereræ ¡éªŒç­‰ï¼‰ å¯ä»¥åœ¨filterå±‚åšç¨³å®šæ€§ç›¸å…³çš„å·¥ä½œï¼ˆå¦‚å…¨é“¾è·¯æ‰“ç‚¹ï¼Œå¯ä»¥åœ¨filterå±‚åˆ†é…ä¸€ä¸ªtraceIdï¼›ä¹Ÿå¯ä»¥åœ¨è¿™ä¸€å±‚åšé™æµç­‰ï¼‰ 1. åŸºæœ¬ä½¿ç”¨å§¿åŠ¿è¦ä½¿ç”¨ä¸€ä¸ªFilterï¼Œä¸€åŠéœ€è¦ä¸¤æ­¥ï¼Œå®ç°Filteræ¥å£çš„è‡ªå®šä¹‰ç±»ï¼Œweb.xmlä¸­å¯¹filterçš„å®šä¹‰ 1234567891011public interface Filter &#123; public void init(FilterConfig filterConfig) throws ServletException; public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException; public void destroy();&#125; ä¸»è¦å°±ä¸‰ä¸ªæ–¹æ³•ï¼Œä»å‘½åæ¥çœ‹ï¼Œ ä¹Ÿæ¯”è¾ƒæ¸…æ™°ï¼Œåœ¨åˆ›å»ºFilterå¯¹è±¡çš„æ—¶å€™ï¼Œè°ƒç”¨ init æ–¹æ³• é”€æ¯Filterå¯¹è±¡çš„æ—¶å€™ï¼Œè°ƒç”¨ destroy æ–¹æ³• å½“è¯·æ±‚è¿‡æ¥ä¹‹åï¼Œè°ƒç”¨ doFilterï¼Œä¹Ÿå°±æ˜¯ä¸»è¦çš„ä¸šåŠ¡é€»è¾‘æ‰€åœ¨äº† è¯¦ç»†caseåé¢å†è¯´ æ¥ä¸‹æ¥å°±æ˜¯xmlçš„é…ç½®äº†ï¼Œå’ŒServletç±»ä¼¼ï¼Œæ¯è‡ªå®šä¹‰ä¸€ä¸ªï¼Œéƒ½éœ€è¦åœ¨xmlä¸­åŠ ä¸Šä¸€ä¸ªé…ç½®ï¼ˆæŒºç¹ççš„æ“ä½œçš„ï¼‰ 123456789101112131415161718&lt;!-- è§£å†³ä¹±ç çš„é—®é¢˜ --&gt;&lt;filter&gt; &lt;filter-name&gt;encodingFilter&lt;/filter-name&gt; &lt;filter-class&gt;org.springframework.web.filter.CharacterEncodingFilter&lt;/filter-class&gt; &lt;async-supported&gt;true&lt;/async-supported&gt; &lt;init-param&gt; &lt;param-name&gt;encoding&lt;/param-name&gt; &lt;param-value&gt;UTF-8&lt;/param-value&gt; &lt;/init-param&gt; &lt;init-param&gt; &lt;param-name&gt;forceEncoding&lt;/param-name&gt; &lt;param-value&gt;true&lt;/param-value&gt; &lt;/init-param&gt;&lt;/filter&gt;&lt;filter-mapping&gt; &lt;filter-name&gt;encodingFilter&lt;/filter-name&gt; &lt;url-pattern&gt;/*&lt;/url-pattern&gt;&lt;/filter-mapping&gt; é…ç½®ä¹Ÿæ¯”è¾ƒç®€å•äº†ï¼Œä¸€ä¸ª ä¸€ä¸ª å‰è€…å®šä¹‰å…·ä½“çš„Filterï¼Œåè€…è¡¨ç¤ºè¿™ä¸ªFilteræ‹¦æˆªçš„URL ï¼ˆçœ‹èµ·æ¥å’ŒServletçš„é…ç½®è§„åˆ™æ²¡ä»€ä¹ˆä¸¤æ ·ï¼‰ II. å®ä¾‹æˆ‘ä»¬çš„å®ä¾‹ï¼Œå°±æ‹¿å¤§åé¼é¼çš„CharacterEncodingFilteræ¥è¯´æ˜ï¼Œé¡ºå¸¦è†œæ‹œä¸‹Springçš„å¤§ç¥çš„ä¼˜ç§€æºç  123456789101112131415161718192021222324252627282930313233343536373839404142public class CharacterEncodingFilter extends OncePerRequestFilter &#123; private String encoding; private boolean forceEncoding = false; public CharacterEncodingFilter() &#123; &#125; public CharacterEncodingFilter(String encoding) &#123; this(encoding, false); &#125; public CharacterEncodingFilter(String encoding, boolean forceEncoding) &#123; Assert.hasLength(encoding, \"Encoding must not be empty\"); this.encoding = encoding; this.forceEncoding = forceEncoding; &#125; public void setEncoding(String encoding) &#123; this.encoding = encoding; &#125; public void setForceEncoding(boolean forceEncoding) &#123; this.forceEncoding = forceEncoding; &#125; @Override protected void doFilterInternal( HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException &#123; if (this.encoding != null &amp;&amp; (this.forceEncoding || request.getCharacterEncoding() == null)) &#123; request.setCharacterEncoding(this.encoding); if (this.forceEncoding) &#123; response.setCharacterEncoding(this.encoding); &#125; &#125; filterChain.doFilter(request, response); System.out.printl(\"servelt æ‰§è¡Œå®Œæˆï¼Œåˆè¿”å›filter\"); &#125;&#125; ä¸Šé¢çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°†è§†çº¿é›†ä¸­åœ¨ doFilterInternal æ–¹æ³•å†…éƒ¨ï¼Œå¦‚æœè¦è®¾ç½®ç¼–ç å‚æ•°ï¼Œåˆ™ç›´æ¥ä¿®æ”¹ HttpServletRequest, HttpServletResponse ä¸¤ä¸ªå‚æ•°ï¼Œæ“ä½œå®Œæˆä¹‹åï¼Œæ‰§è¡Œä¸‹é¢è¿™ä¸€è¡Œ 1filterChain.doFilter(request, response); æ³¨æ„ ä¸Šé¢è¿™ä¸€è¡Œæ‰§è¡Œï¼Œè¡¨ç¤ºFilterå±‚å·²ç»é€šè¿‡äº†ï¼Œè¯·æ±‚å¯ä»¥è½¬å‘ç»™ä¸‹ä¸€ä¸ªFilteræˆ–è€…ç›´æ¥ä¼ ç»™Servlet è€Œä¸‹ä¸€ä¸ªFilter, Servletæ‰§è¡Œå®Œæˆä¹‹åï¼Œè¿˜ä¼šç»§ç»­å¾€ä¸‹èµ°ï¼Œå°±æ˜¯ä¸Šé¢çš„é‚£ä¸€è¡Œè¾“å‡ºï¼Œä¹Ÿä¼šè¢«è°ƒç”¨ï¼ˆé‚£ä¸€è¡Œæ˜¯æˆ‘åŠ çš„ï¼Œæºç ä¸­æ²¡æœ‰ï¼‰ æ‰€ä»¥ï¼Œå¦‚æœä½ ä¸å¸Œæœ›ç»§ç»­å¾€ä¸‹èµ°ï¼Œé‚£ä¹ˆå°±ç®€å•äº†ï¼Œä¸æ‰§è¡Œä¸Šé¢çš„é‚£ä¸€è¡Œå³å¯ ç–‘é—®é—®é¢˜ä¸€ï¼šçœ‹äº†ä¸Šé¢çš„æºç ï¼Œä¸€ä¸ªå¾ˆæ˜æ˜¾çš„é—®é¢˜å°±æ˜¯ï¼Œå‚æ•°æ€ä¹ˆè®¾ç½®çš„ï¼Ÿ ä»”ç»†çœ‹ä¸Šé¢çš„æºç ï¼Œå‘ç°è‡ªå®šä¹‰Filteræ˜¯ç»§æ‰¿ org.springframework.web.filter.OncePerRequestFilter è€Œä¸æ˜¯ç›´æ¥å®ç°çš„ Filter æ¥å£ï¼Œè€Œä¸”æ–¹æ³•å†…ä¹Ÿæ²¡æœ‰æ˜¾ç¤ºçš„å®ç° init()æ–¹æ³•ï¼Œæ‰€æœ‰å¾ˆå®¹æ˜“çŒœåˆ°æ˜¯çˆ¶ç±»ä¸­å®ç°äº†å‚æ•°çš„åˆå§‹åŒ–è¿‡ç¨‹ å…·ä½“çš„å®ç°é€»è¾‘æ˜¯åœ¨ org.springframework.web.filter.GenericFilterBean#init ä¸­ï¼ŒåŒæ ·æ˜¯Springå®ç°çš„ï¼Œä¸»è¦ä»£ç æå‡ºæ¥ 12345678910111213141516171819202122232425262728293031public final void init(FilterConfig filterConfig) throws ServletException &#123; Assert.notNull(filterConfig, \"FilterConfig must not be null\"); if (logger.isDebugEnabled()) &#123; logger.debug(\"Initializing filter '\" + filterConfig.getFilterName() + \"'\"); &#125; this.filterConfig = filterConfig; // Set bean properties from init parameters. try &#123; PropertyValues pvs = new FilterConfigPropertyValues(filterConfig, this.requiredProperties); BeanWrapper bw = PropertyAccessorFactory.forBeanPropertyAccess(this); ResourceLoader resourceLoader = new ServletContextResourceLoader(filterConfig.getServletContext()); bw.registerCustomEditor(Resource.class, new ResourceEditor(resourceLoader, this.environment)); initBeanWrapper(bw); bw.setPropertyValues(pvs, true); &#125; catch (BeansException ex) &#123; String msg = \"Failed to set bean properties on filter '\" + filterConfig.getFilterName() + \"': \" + ex.getMessage(); logger.error(msg, ex); throw new NestedServletException(msg, ex); &#125; // Let subclasses do whatever initialization they like. initFilterBean(); if (logger.isDebugEnabled()) &#123; logger.debug(\"Filter '\" + filterConfig.getFilterName() + \"' configured successfully\"); &#125;&#125; çœ‹ä¸Šé¢ä¸€å¤§ä¸²çš„ä»£ç ï¼Œåˆ°åº•å¹²äº†å˜›ï¼Ÿ ç®€å•æ¥è®²ï¼Œå°±æ˜¯è·å–xmlä¸­é…ç½®çš„å‚æ•°ï¼Œç„¶åå¡«å……åˆ°Filterå¯¹è±¡ä¸­ï¼ˆå¯¹Srpingè€Œè¨€ï¼ŒCharacterEncodingFilterå°±æ˜¯ä¸€ä¸ªbeanï¼‰ï¼Œè¿™ä¸ªå…·ä½“çš„é€»è¾‘å’Œæœ¬ç¯‡å…³ç³»ä¸å¤§ï¼Œå°±ç›´æ¥è·³è¿‡äº† é—®é¢˜äºŒï¼šåœ¨Filterå±‚ä¸­å¯ä»¥è·å–å‚æ•°ä¹ˆ ä»doFilterçš„æ–¹æ³•ç­¾åä¸­çœ‹ï¼Œæ—¢ç„¶æœ‰Requestå‚æ•°ï¼Œé‚£ä¹ˆåº”è¯¥æ˜¯å¯ä»¥è·å–åˆ°è¯·æ±‚å‚æ•°çš„ï¼Œé‚£ä¹ˆå®é™…éªŒè¯ä¸€ä¸‹ å…ˆå®ç°ä¸€ä¸ªæœ€æœ€æœ€ç®€å•çš„Filter 123456789101112131415161718public class TestFilter implements Filter &#123; @Override public void init(FilterConfig filterConfig) throws ServletException &#123; &#125; @Override public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException &#123; System.out.println(\"in filter\"); System.out.println(\"args: \" + JSON.toJSONString(request.getParameterMap())); chain.doFilter(request, response); System.out.println(\"out filter\"); &#125; @Override public void destroy() &#123; &#125;&#125; å¼€å§‹æµ‹è¯• 1curl -d 'name=Hello&amp;password=world' http://127.0.0.1:8088/123 è¾“å‡ºå¦‚ä¸‹ 123in filterargs: &#123;\"name\":[\"Hello\"],\"password\":[\"world\"]&#125;out filter æ³¨æ„ åœ¨Filterä¸­è·å–å‚æ•°æ—¶ï¼Œæœ€å¥½ä¸è¦ç›´æ¥ä½¿ç”¨è·å–è¯·æ±‚æµçš„æ–¹å¼ï¼Œå¦‚æœè·å–è¯·æ±‚æµï¼Œé‚£ä¹ˆServletå°±è·å–ä¸åˆ°è¯·æ±‚å‚æ•°äº† é—®é¢˜ä¸‰ï¼šå¤šä¸ªfilterçš„é¡ºåºæ€ä¹ˆå®š å‰é¢å­¦ä¹ Servletçš„æ—¶å€™ï¼Œä¹Ÿæœ‰è¿™ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªURLè¢«å¤šä¸ªServletå‘½ä¸­äº†ï¼Œé‚£ä¹ˆå…ˆåé¡ºåºæ˜¯æ€æ ·çš„å‘¢ï¼Ÿ ç²¾ç¡®åŒ¹é… &gt; æœ€é•¿åŒ¹é… &gt; å…¶ä»–æ¨¡ç³ŠåŒ¹é… &gt; æ²¡æœ‰åŒ¹é…çš„åˆ™æ˜¯404 é‚£ä¹ˆFilterå‘¢ï¼Œä»–ä»¬çš„åŒºåˆ«è¿˜æ˜¯æ¯”è¾ƒæ˜æ˜¾çš„ï¼Œå¾ˆå¤šFilteréƒ½æ˜¯æ‹¦æˆªæ‰€æœ‰çš„è¯·æ±‚ï¼Œå³å¾ˆå¤šFilterçš„å‘½ä¸­è§„åˆ™éƒ½æ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆæ€ä¹ˆåŠï¼Ÿ å…ˆæ‰§è¡Œå¸¦æœ‰url-patternæ ‡ç­¾çš„filterï¼Œå†æ‰§è¡Œå¸¦æœ‰servlet-nameæ ‡ç­¾çš„filter å¦‚æœåŒä¸ºurl-patternæˆ–servlet-nameï¼Œåˆ™ä¼šæŒ‰ç…§åœ¨web.xmlä¸­çš„å£°æ˜é¡ºåºæ‰§è¡Œ æµ‹è¯•caseå¦‚ä¸‹ï¼Œæˆ‘ä»¬å®šä¹‰ä¸‰ä¸ªFilterï¼š TestFilter: åŒ¹é…æ‰€æœ‰è·¯å¾„ ATestFilter: åŒ¹é…æ‰€æœ‰è·¯å¾„ ServletFilter: åŒ¹é… mvc-servlet 123456789101112131415161718192021// ATestFilter@Overridepublic void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException &#123; System.out.println(\"in ATestFilter\"); chain.doFilter(request, response);&#125;// TestFilter@Overridepublic void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException &#123; System.out.println(\"in TestFilter\"); chain.doFilter(request, response);&#125;// ServletFilter@Overridepublic void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException &#123; System.out.println(\"in ServletFilter\"); chain.doFilter(request, response);&#125; å¯¹åº”çš„xmlé…ç½®å¦‚ä¸‹ 123456789101112131415161718192021222324252627282930&lt;filter&gt; &lt;filter-name&gt;servletFilter&lt;/filter-name&gt; &lt;filter-class&gt;com.test.ServletFilter&lt;/filter-class&gt; &lt;async-supported&gt;true&lt;/async-supported&gt;&lt;/filter&gt;&lt;filter-mapping&gt; &lt;filter-name&gt;servletFilter&lt;/filter-name&gt; &lt;servlet-name&gt;mvc-dispatcher&lt;/servlet-name&gt;&lt;/filter-mapping&gt;&lt;filter&gt; &lt;filter-name&gt;testFilter&lt;/filter-name&gt; &lt;filter-class&gt;com.test.TestFilter&lt;/filter-class&gt; &lt;async-supported&gt;true&lt;/async-supported&gt;&lt;/filter&gt;&lt;filter-mapping&gt; &lt;filter-name&gt;testFilter&lt;/filter-name&gt; &lt;url-pattern&gt;/*&lt;/url-pattern&gt;&lt;/filter-mapping&gt;&lt;filter&gt; &lt;filter-name&gt;atestFilter&lt;/filter-name&gt; &lt;filter-class&gt;com.test.ATestFilter&lt;/filter-class&gt; &lt;async-supported&gt;true&lt;/async-supported&gt;&lt;/filter&gt;&lt;filter-mapping&gt; &lt;filter-name&gt;atestFilter&lt;/filter-name&gt; &lt;url-pattern&gt;/*&lt;/url-pattern&gt;&lt;/filter-mapping&gt; è¾“å‡ºç»“æœ 123in TestFilterin ATestFilterin ServletFilter III. å°ç»“Filter é€šå¸¸ç”¨äºJavaWebçš„è¿‡æ»¤ä½¿ç”¨ï¼Œé€šè¿‡doFilteræ–¹æ³•ä¸­æ‰§è¡Œ chain.doFilter(request, response);ï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªFilteræˆ–è€…Servletæ‰§è¡Œé€»è¾‘ï¼Œå½“æ‰§è¡Œå®Œæˆä¹‹åï¼Œä¾ç„¶ä¼šå›åˆ°Filterè¿™ä¸€å±‚ï¼Œç»§ç»­èµ°ä¸‹å» é’ˆå¯¹ä¸Šé¢çš„é€»è¾‘ï¼ŒFilterçš„å¸¸è§åº”ç”¨åœºæ™¯æœ‰ï¼š ç”¨æˆ·ä¿¡æ¯è·å–ï¼Œèº«ä»½æ ¡éªŒ å®‰å…¨æ ¡éªŒï¼ˆrefereræ ¡éªŒå¤±è´¥ï¼Œç›´æ¥æ‹’ç»ï¼‰ ç¨³å®šæ€§ç›¸å…³ï¼ˆé™æµï¼Œç›‘æ§åŸ‹ç‚¹ï¼Œå…¨é“¾è·¯æ—¥å¿—åŸ‹ç‚¹ï¼‰ Filterçš„æ‰§è¡Œé¡ºåºï¼š url-mapping çš„ä¼˜å…ˆæ‰§è¡Œï¼Œå…¶æ¬¡æ˜¯ servlet-mapping åŒä¸€ä¸ªåŒ¹é…æ–¹å¼ï¼ˆå¦‚éƒ½æ˜¯url-mappingï¼‰ä¸­ï¼Œæ ¹æ®åœ¨xmlä¸­å®šä¹‰çš„å…ˆåé¡ºåºæ¥ç¡®å®š Filterçš„æ³¨æ„äº‹é¡¹ï¼š æ­£å¸¸ä¸šåŠ¡ï¼Œè¯·è®°å¾—ä¸€å®šæ‰§è¡Œ chain.doFilter(request, response)ï¼Œ æœ€åæŠŠå®ƒæ”¾åœ¨finnalå—ä¸­ï¼Œé˜²æ­¢ä½ åœ¨Filterä¸­çš„ä»£ç æŠ›å¼‚å¸¸å¯¼è‡´è¿›å…¥ä¸åˆ°åç»­çš„é€»è¾‘ åœ¨Filterä¸­ä¸è¦ç›´æ¥è·å–è¯·æ±‚æ•°æ®æµï¼ˆè¯·æ±‚æµè¢«è¯»å–å®Œä¹‹åï¼ŒServletå°±getä¸åˆ°äº†!ï¼‰ IV. å…¶ä»–å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è§£ä¸å…¨ï¼Œå¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ æ‰«æå…³æ³¨ï¼Œjavaåˆ†äº«","categories":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"JavaWeb","slug":"Java/JavaWeb","permalink":"https://zbang.online/hexblog/categories/Java/JavaWeb/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"JavaWeb","slug":"JavaWeb","permalink":"https://zbang.online/hexblog/tags/JavaWeb/"},{"name":"Filter","slug":"Filter","permalink":"https://zbang.online/hexblog/tags/Filter/"}],"keywords":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"JavaWeb","slug":"Java/JavaWeb","permalink":"https://zbang.online/hexblog/categories/Java/JavaWeb/"}]},{"title":"JavaWebä¸‰å¤§ç»„ä»¶ä¹‹Servletå­¦ä¹ ","slug":"JavaWebä¸‰å¤§ç»„ä»¶ä¹‹Servletå­¦ä¹ ","date":"2018-01-24T01:55:49.000Z","updated":"2018-02-13T03:21:17.017Z","comments":true,"path":"2018/01/24/JavaWebä¸‰å¤§ç»„ä»¶ä¹‹Servletå­¦ä¹ /","link":"","permalink":"https://zbang.online/hexblog/2018/01/24/JavaWebä¸‰å¤§ç»„ä»¶ä¹‹Servletå­¦ä¹ /","excerpt":"JavaWebä¸‰å¤§ç»„ä»¶ä¹‹Servletå­¦ä¹  å¹³æ—¶ç›´æ¥ç”¨springmvcè¾ƒå¤šï¼Œéƒ½æ²¡æ€ä¹ˆæ¥è§¦åº•å±‚çš„Servletï¼Œå¯¼è‡´å¯¹ä¸€äº›åŸºæœ¬çš„çŸ¥è¯†ç‚¹äº†è§£éƒ½ä¸å¤Ÿï¼Œæ‰€ä»¥ä»Šå¤©ä¸“é—¨çš„æŠ½å‡ºæ—¶é—´æ¥å­¦ä¹ ä¸€ä¸‹ å¸¦ç€é—®é¢˜å‡ºå‘ï¼Œçœ‹ä¸‹å¯ä»¥æ€ä¹ˆç© å¦‚ä½•è‡ªå®šä¹‰ä¸€ä¸ªServlet è‡ªå®šä¹‰çš„Serlvetå¦‚ä½•å·¥ä½œ servletçš„ä¼˜å…ˆé¡ºåºæ€ä¹ˆåˆ¤å®š servletåŒ¹é…æ˜¯æ€æ ·çš„ (url-mappingâ€¦ï¼‰ å¦‚ä½•è·å–å‚æ•°ï¼ˆgetè¯·æ±‚å‚æ•°ï¼Œpostè¯·æ±‚å‚æ•°ï¼Œä¸Šä¼ æ–‡ä»¶ï¼‰ å¦‚ä½•è¿”å›æ•°æ®ï¼ˆè¿”å›é¡µé¢ï¼Œè¿”å›æ–‡ä»¶ï¼Œè¿”å›äºŒè¿›åˆ¶ï¼‰ è¯·æ±‚å¤´å’Œè¿”å›å¤´çš„è®¾ç½®","text":"JavaWebä¸‰å¤§ç»„ä»¶ä¹‹Servletå­¦ä¹  å¹³æ—¶ç›´æ¥ç”¨springmvcè¾ƒå¤šï¼Œéƒ½æ²¡æ€ä¹ˆæ¥è§¦åº•å±‚çš„Servletï¼Œå¯¼è‡´å¯¹ä¸€äº›åŸºæœ¬çš„çŸ¥è¯†ç‚¹äº†è§£éƒ½ä¸å¤Ÿï¼Œæ‰€ä»¥ä»Šå¤©ä¸“é—¨çš„æŠ½å‡ºæ—¶é—´æ¥å­¦ä¹ ä¸€ä¸‹ å¸¦ç€é—®é¢˜å‡ºå‘ï¼Œçœ‹ä¸‹å¯ä»¥æ€ä¹ˆç© å¦‚ä½•è‡ªå®šä¹‰ä¸€ä¸ªServlet è‡ªå®šä¹‰çš„Serlvetå¦‚ä½•å·¥ä½œ servletçš„ä¼˜å…ˆé¡ºåºæ€ä¹ˆåˆ¤å®š servletåŒ¹é…æ˜¯æ€æ ·çš„ (url-mappingâ€¦ï¼‰ å¦‚ä½•è·å–å‚æ•°ï¼ˆgetè¯·æ±‚å‚æ•°ï¼Œpostè¯·æ±‚å‚æ•°ï¼Œä¸Šä¼ æ–‡ä»¶ï¼‰ å¦‚ä½•è¿”å›æ•°æ®ï¼ˆè¿”å›é¡µé¢ï¼Œè¿”å›æ–‡ä»¶ï¼Œè¿”å›äºŒè¿›åˆ¶ï¼‰ è¯·æ±‚å¤´å’Œè¿”å›å¤´çš„è®¾ç½® I. åŸºæœ¬çŸ¥è¯†ç‚¹1. ä»€ä¹ˆæ˜¯ServletServletæ˜¯JavaWebçš„ä¸‰å¤§ç»„ä»¶ä¹‹ä¸€ï¼Œå®ƒå±äºåŠ¨æ€èµ„æºã€‚Servletçš„ä½œç”¨æ˜¯å¤„ç†è¯·æ±‚ï¼ŒæœåŠ¡å™¨ä¼šæŠŠæ¥æ”¶åˆ°çš„è¯·æ±‚äº¤ç»™Servletæ¥å¤„ç†ï¼Œåœ¨Servletä¸­é€šå¸¸éœ€è¦ï¼š æ¥å—è¯·æ±‚ å¤„ç†è¯·æ±‚ å®Œæˆå“åº” 2. æ€ä¹ˆç©Servletä¸€èˆ¬æ¥è®²ï¼Œåˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„Servletæœ‰ä¸¤ä¸ªæ­¥éª¤ï¼Œåœ¨web.xmlä¸­é…ç½®serverltçš„å£°æ˜ï¼›å®ç°Servletæ¥å£ï¼Œå®ç°è‡ªå®šä¹‰çš„Servleté€»è¾‘ ä¸€ä¸ªç®€å•çš„caseå¦‚ä¸‹ web.xmlä¸­ï¼Œæ·»åŠ é…ç½® 123456789&lt;servlet&gt; &lt;servlet-name&gt;doc-servlet&lt;/servlet-name&gt; &lt;servlet-class&gt;com.yihui.study.DocServlet&lt;/servlet-class&gt; &lt;load-on-startup&gt;0&lt;/load-on-startup&gt;&lt;/servlet&gt;&lt;servlet-mapping&gt; &lt;servlet-name&gt;doc-servlet&lt;/servlet-name&gt; &lt;url-pattern&gt;/study/*&lt;/url-pattern&gt;&lt;/servlet-mapping&gt; å®ç°è‡ªå®šä¹‰Servlet 1234567891011public class DocServlet extends HttpServlet &#123; protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; resp.setCharacterEncoding(\"utf-8\"); PrintWriter writer = resp.getWriter(); writer.append(\"è¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰servlet\") .append(\"emojğŸ˜„==\").flush(); System.out.println(\"hereher!!!!\"); &#125;&#125; ä¸Šé¢è¿™ä¸ªServletï¼Œå®ç°äº†æ‹¦æˆª /study ä¸‹çš„æ‰€æœ‰è¯·æ±‚ï¼Œ ç„¶åè¿”å›ä¸€æ®µæ–‡æœ¬ï¼Œä¸Šé¢ä½œä¸ºæ¼”ç¤ºï¼Œå…·ä½“çš„å±•å¼€ä¸‹é¢è¯´æ˜ 3. Servletæ¥å£è¯´æ˜ä¸Šé¢æ˜¯ç›´æ¥ç»§æ‰¿äº†HttpServletï¼Œå¯èƒ½æ²¡æ³•å®Œå…¨çš„æš´éœ²ä¸€ä¸ªServletçš„å…·ä½“æ¥å£æœ‰å“ªäº›ï¼Œä»¥åŠå®ƒçš„ç”Ÿå‘½å‘¨æœŸæ˜¯æ€æ ·çš„ï¼Œæ¥ä¸‹æ¥åˆ™ç›´æ¥é’ˆå¯¹æºå¤´è¿›è¡Œè¯´æ˜ 1234567891011121314151617public interface Servlet &#123; // åˆå§‹åŒ– public void init(ServletConfig config) throws ServletException; // è·å–é…ç½®ä¿¡æ¯ public ServletConfig getServletConfig(); // å¤„ç†è¯·æ±‚ public void service(ServletRequest req, ServletResponse res) throws ServletException, IOException; // Returns information about the servlet, such as author, version, and copyright public String getServletInfo(); // é”€æ¯ public void destroy();&#125; äº”ä¸ªæ–¹æ³•ï¼Œä»å‘½åä¹Ÿå¯ä»¥çœ‹å‡ºå¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸ é¦–å…ˆæ˜¯åˆ›å»ºï¼š init() æ–¹æ³•è¢«åˆ›å»º åˆ›å»ºå®Œæ¯•ä¹‹åï¼Œè¯·æ±‚æ¥äº†ï¼Œåˆ†ç»™ serviceæ–¹æ³•ï¼Œæ‰§è¡Œå¯¹åº”çš„ä¸šåŠ¡é€»è¾‘ æœ€åä¸æƒ³ç©äº†ï¼Œå°±é”€æ¯æ‰ï¼Œæ­¤æ—¶è§¦å‘ destroyæ–¹æ³• è¯´æ˜ åœ¨Servletè¢«åˆ›å»ºåï¼ŒæœåŠ¡å™¨ä¼šé©¬ä¸Šè°ƒç”¨Servletçš„void init(ServletConfig)æ–¹æ³•ã€‚è¯·è®°ä½ï¼Œ Servletå‡ºç”Ÿåé©¬ä¸Šå°±ä¼šè°ƒç”¨init()æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¸€äº›å¯¹Servletçš„åˆå§‹åŒ–å·¥ä½œæ”¾åˆ°initæ–¹æ³•ä¸­ï¼Œä»Šåæ‰€æœ‰åˆ†é…åˆ°è¿™ä¸ªServletçš„è¯·æ±‚ï¼Œéƒ½æ˜¯å…¬ç”¨è¿™ä¸ªServletçš„ 4. ServletConfig init()æ–¹æ³•çš„å‚æ•° ServletConfigå¯¹è±¡å¯¹åº”web.xmlæ–‡ä»¶ä¸­çš„å…ƒç´ ã€‚ä¾‹å¦‚ä½ æƒ³è·å–å½“å‰Servletåœ¨web.xmlæ–‡ä»¶ä¸­çš„é…ç½®åï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨servletConfig.getServletName()æ–¹æ³•è·å– 1234String getServletName()ï¼šè·å–Servletåœ¨web.xmlæ–‡ä»¶ä¸­çš„é…ç½®åç§°ï¼Œå³æŒ‡å®šçš„åç§°ï¼› ServletContext getServletContext()ï¼šç”¨æ¥è·å–ServletContextå¯¹è±¡ï¼ŒServletContextä¼šåœ¨åé¢è®²è§£ï¼› String getInitParameter(String name)ï¼šç”¨æ¥è·å–åœ¨web.xmlä¸­é…ç½®çš„åˆå§‹åŒ–å‚æ•°ï¼Œé€šè¿‡å‚æ•°åæ¥è·å–å‚æ•°å€¼ï¼› Enumeration getInitParameterNames()ï¼šç”¨æ¥è·å–åœ¨web.xmlä¸­é…ç½®çš„æ‰€æœ‰åˆå§‹åŒ–å‚æ•°åç§°ï¼› 5. ServletRequest è¯·æ±‚å¯¹è±¡ï¼Œå¯ä»¥ä»å…¶ä¸­è·å–è¯·æ±‚æ•°æ®ï¼Œè¯·æ±‚å¤´ç­‰ å†…éƒ¨æä¾›çš„æ–¹æ³•æŒºå¤šï¼Œé€šå¸¸æˆ‘ä»¬æœ€å…³å¿ƒçš„æœ‰: è·å–å‚æ•°: javax.servlet.ServletRequest#getParameter è·å–å¤´ : javax.servlet.http.HttpServletRequest#getHeader è·å–cookie: javax.servlet.http.HttpServletRequest#getCookies è·å–è¯·æ±‚ : javax.servlet.http.HttpServletRequest#getRequestURI â€¦ è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„å°±æ˜¯æŒ‡å®šå­—ç¬¦ç¼–ç ï¼Œå¦‚æˆ‘ä»¬é€šå¸¸è¦æ±‚æäº¤çš„å‚æ•°æ»¡è¶³utf8ç¼–ç ï¼Œè¿™æ—¶å°±å¯ä»¥å¦‚ä¸‹è®¾ç½® 12// javax.servlet.ServletRequest#setCharacterEncodingrequest.setCharacterEncoding(&quot;utf-8&quot;); å¦‚æˆ‘ä»¬æœ€å¸¸ç”¨çš„ä¸€ä¸ªspringçš„fitlerï¼Œå…³é”®ä»£ç å¦‚ä¸‹ 123456789101112131415// org.springframework.web.filter.CharacterEncodingFilter#doFilterInternal// @Overrideprotected void doFilterInternal( HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException &#123; if (this.encoding != null &amp;&amp; (this.forceEncoding || request.getCharacterEncoding() == null)) &#123; request.setCharacterEncoding(this.encoding); if (this.forceEncoding) &#123; response.setCharacterEncoding(this.encoding); &#125; &#125; filterChain.doFilter(request, response);&#125; 6. ServletResponse è¿”å›å¯¹è±¡ï¼Œè¿”å›å“åº”ç»™è°ƒç”¨æ–¹çš„ç»“æ„ï¼Œè®¾ç½®è¿”å›å¤´ è¿”å›æ•°æ®ç»™è°ƒç”¨æ–¹ï¼Œä¸»è¦å°±æ˜¯åˆ©ç”¨è¿™ä¸ªä¸œè¥¿äº†ï¼Œå†…éƒ¨æä¾›çš„æ–¹æ³•ä¹Ÿä¸å°‘ï¼Œæˆ‘ä»¬ä¸»è¦å…³å¿ƒçš„å…¶å®ä¹Ÿå¹¶ä¸å¤ªå¤š è®¾ç½®è¿”å›å¤´ï¼šjavax.servlet.http.HttpServletResponse#setHeader æ·»åŠ cookie: javax.servlet.http.HttpServletResponse#addCookie é‡å®šå‘ : javax.servlet.http.HttpServletResponse#sendRedirect å¼‚å¸¸ : javax.servlet.http.HttpServletResponse#sendError è®¾ç½®ContentType: javax.servlet.ServletResponse#setContentType è®¾ç½®è¿”å›æµ: javax.servlet.ServletResponse#getOutputStream, javax.servlet.ServletResponse#getWriter è®¾ç½®ç¼–ç : javax.servlet.ServletResponse#setCharacterEncoding II. è¿›é˜¶1. web.xmlä¸­é…ç½® è¿™ä¸ªé…ç½®ï¼Œä¸»è¦é’ˆå¯¹ Servlet çš„é¡ºåºæŒ‡å®šï¼ŒURLåŒ¹é…è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥æœ‰å¿…è¦ç ”ç©¶ä¸‹è¿™ä¸ªé…ç½®ä¸­çš„è¯´æ˜ é€šå¸¸web.xmlçš„é…ç½®ï¼Œä¸‹é¢ä¸¤ä¸ªæ˜¯å¿…é¡»çš„ 1234567891011121314&lt;!-- servletçš„é…ç½® --&gt;&lt;servlet&gt; &lt;!-- servletçš„å†…éƒ¨åç§°ï¼Œè‡ªå®šä¹‰ã€‚å°½é‡æœ‰æ„ä¹‰ --&gt; &lt;servlet-name&gt;ServletDemo&lt;/servlet-name&gt; &lt;!-- servletçš„ç±»å…¨åï¼š åŒ…å+ç®€å•ç±»å --&gt; &lt;servlet-class&gt;com.xxx.ServletDemo&lt;/servlet-class&gt;&lt;/servlet&gt;&lt;!-- servletçš„æ˜ å°„é…ç½® --&gt;&lt;servlet-mapping&gt; &lt;!-- servletçš„å†…éƒ¨åç§°ï¼Œä¸€å®šè¦å’Œä¸Šé¢çš„å†…éƒ¨åç§°ä¿æŒä¸€è‡´ï¼ï¼ --&gt; &lt;servlet-name&gt;ServletDemo&lt;/servlet-name&gt; &lt;!-- servletçš„æ˜ å°„è·¯å¾„ï¼ˆè®¿é—®servletçš„åç§°ï¼‰ --&gt; &lt;url-pattern&gt;/servlet&lt;/url-pattern&gt;&lt;/servlet-mapping&gt; å…¶ä¸­ servlet-mapping æŒ‡å®šæ˜ å°„çš„è·¯å¾„ï¼Œæ»¡è¶³æ¡ä»¶çš„ä¼šåŒ¹é…å¯¹åº”çš„Servletï¼ŒåŒ¹é…è§„åˆ™æœ‰ä»¥ä¸‹å‡ ä¸ªå®šä¹‰ å¿…é¡» / å¼€å¤´ /servlet è¡¨ç¤ºç²¾ç¡®åŒ¹é… http://localhost:8088/servlet åŒ¹é… http://localhost:8088/servlets ä¸åŒ¹é… http://localhost:8088/servlet/123 ä¸åŒ¹é… /servlet/* è¡¨ç¤ºç›®å½•åŒ¹é…ï¼Œæ‰€æœ‰servletè·¯å¾„å¼€å¤´çš„éƒ½å¯ä»¥åŒ¹é… http://localhost:8088/servlet åŒ¹é… http://localhost:8088/servlet/123 åŒ¹é… http://localhost:8088/servlet/123/123 åŒ¹é… http://localhost:8088/servlets ä¸åŒ¹é… /*.do è¡¨ç¤ºæ‰©å±•ååŒ¹é…ï¼Œæ‰€æœ‰ä»¥ .do ç»“å°¾çš„åŒ¹é… æ—¢ç„¶è¿™ä¸ªurlåŒ¹é…æ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚æœä¸¤ä¸ªservletéƒ½åŒ¹é…äº†è¿™ä¸ªpathè·¯å¾„ï¼Œé‚£ä¹ˆåˆ°åº•æ˜¯å“ªä¸ªå¤„ç†å‘¢ï¼Ÿ æ³¨æ„åˆ°å‰é¢æœ‰ä¸ªé…ç½®å‚æ•°ï¼šload-on-startup å½“å€¼ä¸º0æˆ–è€…å¤§äº0æ—¶ï¼Œè¡¨ç¤ºå®¹å™¨åœ¨åº”ç”¨å¯åŠ¨æ—¶å°±åŠ è½½è¿™ä¸ªservletï¼› å½“æ˜¯ä¸€ä¸ªè´Ÿæ•°æ—¶æˆ–è€…æ²¡æœ‰æŒ‡å®šæ—¶ï¼Œåˆ™æŒ‡ç¤ºå®¹å™¨åœ¨è¯¥servletè¢«é€‰æ‹©æ—¶æ‰åŠ è½½ æ­£æ•°çš„å€¼è¶Šå°ï¼Œå¯åŠ¨è¯¥servletçš„ä¼˜å…ˆçº§è¶Šé«˜ æ³¨æ„ è¿™ä¸ªå‚æ•°æ˜¯åŠ è½½é¡ºåºï¼Œè€Œä¸æ˜¯æœ€ç»ˆçš„åŒ¹é…é¡ºåº é‚£ä¹ˆåŒ¹é…é¡ºåºçš„ä¼˜å…ˆçº§æ˜¯ï¼š ç²¾ç¡®è·¯å¾„åŒ¹é… æ¯”å¦‚servletA çš„url-patternä¸º /testï¼ŒservletBçš„url-patternä¸º /* ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœæˆ‘è®¿é—®çš„urlä¸ºhttp://localhost/test ï¼Œè¿™ä¸ªæ—¶å€™å®¹å™¨å°±ä¼šå…ˆ è¿›è¡Œç²¾ç¡®è·¯å¾„åŒ¹é…ï¼Œå‘ç°/testæ­£å¥½è¢«servletAç²¾ç¡®åŒ¹é…ï¼Œé‚£ä¹ˆå°±å»è°ƒç”¨servletAï¼Œä¹Ÿä¸ä¼šå»ç†ä¼šå…¶ä»–çš„servletäº† æœ€é•¿è·¯å¾„åŒ¹é… servletAçš„url-patternä¸º/test/ï¼Œè€ŒservletBçš„url-patternä¸º/test/a/ï¼Œæ­¤æ—¶è®¿é—®http://localhost/test/aæ—¶ï¼Œå®¹å™¨ä¼šé€‰æ‹©è·¯å¾„æœ€é•¿çš„servletæ¥åŒ¹é…ï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„servletB æ‰©å±•åŒ¹é…ï¼Œå¦‚æœurlæœ€åä¸€æ®µåŒ…å«æ‰©å±•ï¼Œå®¹å™¨å°†ä¼šæ ¹æ®æ‰©å±•é€‰æ‹©åˆé€‚çš„servlet å¦‚æœå‰é¢ä¸‰æ¡è§„åˆ™éƒ½æ²¡æœ‰æ‰¾åˆ°ä¸€ä¸ªservletï¼Œå®¹å™¨ä¼šæ ¹æ®urlé€‰æ‹©å¯¹åº”çš„è¯·æ±‚èµ„æºï¼Œå³åŒ¹é…defaultServlet 2. å‚æ•°è·å– å‚æ•°è·å–ï¼Œåˆ™ä¸»è¦åŒºåˆ†getè¯·æ±‚å‚æ•°ï¼Œpostæäº¤è¡¨å•ï¼Œä¸Šä¼ çš„æ–‡ä»¶äº† a. é€šè¿‡ getQueryStringè¿™ç§è·å–å‚æ•°çš„æ–¹å¼ï¼Œåªèƒ½è·å–urlä¸Šé¢çš„å‚æ•°ï¼Œæ— æ³•è·å–åˆ°postçš„è¡¨å•å†…å®¹ 1String str = req.getQueryString(); b. é€šè¿‡ getParameter12// è¿”å›æ‰€æœ‰çš„è¯·æ±‚å‚æ•°javax.servlet.ServletRequest#getParameterMap è¿™ç§ä½¿ç”¨å§¿åŠ¿ï¼Œå’Œæˆ‘ä»¬åœ¨SpringMVCä¸­å¸¸è§çš„åŸºæœ¬ä¸€è‡´ c. é€šè¿‡ getInputStreamè·å–è¯·æ±‚æµï¼Œä¸€èˆ¬çš„ä½¿ç”¨å§¿åŠ¿å¦‚ä¸‹ 1234InputStream stream = req.getInputStream();byte[] bytes = new byte[stream.available()];stream.read(bytes);String str = new String(bytes); ç„¶åå°±éœ€è¦è‡ªå·±å¯¹ä¸Šé¢çš„è¯·æ±‚å‚æ•°è¿›è¡Œå¤„ç†äº†ï¼›ä¸¤å¢å¯¹æ¯”ï¼Œå¸¸è§„çš„è·å–æ–¹æ³•ï¼Œç›´æ¥ä½¿ç”¨ getParameteræ–¹å¼æ›´åŠ ä¼˜é›… æ³¨æ„ é€šè¿‡getInputStreamæ–¹å¼è·å–äº†è¯·æ±‚æ•°æ®ä¹‹åï¼Œå†é€šè¿‡ getParameterè·å–ä¸åˆ°å‚æ•°çš„ï¼Œä¹Ÿå¥½ç†è§£ï¼Œè¯·æ±‚çš„æµï¼Œè¢«ä½ è¯»å–ä¹‹åï¼Œå…¶ä»–çš„åœ°æ–¹å°±æ— æ³•è·å–æµä¸­çš„æ•°æ®äº† d. è·å–ä¸Šä¼ çš„æ–‡ä»¶ä»è¯·æ±‚å‚æ•°ä¸­è·å–ä¸Šä¼ çš„æ–‡ä»¶ï¼Œç½‘ä¸Šéšæ„æœç´¢äº†ä¸€ä¸‹ï¼Œå‘ç°å¤§éƒ¨åˆ†éƒ½ä½¿ç”¨apacheçš„fileuploadåŒ…ï¼Œ å…¶å®å¤„ç†çš„ä¾ç„¶æ˜¯inputstreamè¿™ä¸ªè¯·æ±‚æµï¼Œåªæ˜¯é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œç²—ç•¥çš„ç¿»çœ‹äº†ä¸€ä¸‹æºç ï¼Œå‘ç°è¿™ä¸€å—è¿˜æŒºæœ‰æ„æ€çš„ï¼Œå‡†å¤‡å•ç‹¬çš„æ·±å…¥çœ‹ä¸€ä¸‹ 3. æ•°æ®è¿”å›è¿”å›æ•°æ®ï¼Œå‰é¢ä»‹ç»HttpServletResponseçš„æ—¶å€™ï¼Œå°±ç»™å‡ºäº†ä¸¤ä¸ªæ–¹æ³• a. getWriter1public PrintWriter getWriter() throws IOException; b. getOutputStream1public ServletOutputStream getOutputStream() throws IOException; ä¸‹é¢ç®€å•è¯´ä¸€ä¸‹ä¸Šé¢çš„åŒºåˆ« PrintWriter ServletOutputStream å­—ç¬¦æµè¿”å› å­—èŠ‚æµè¿”å› éœ€è¦å­—ç¬¦ç¼–ç  å­—èŠ‚æµç›´æ¥è¿”å›ï¼ˆè¿”å›æ–‡ä»¶å°±å¾ˆå ä¼˜åŠ¿äº†ï¼‰ è¯´æ˜ ä¸Šé¢ä¸¤ç§æ–¹å¼äº’æ–¥ï¼Œåªèƒ½ä½¿ç”¨å…¶ä¸­ä¸€ç§case Servletç¨‹åºå‘ServletOutputStreamæˆ–PrintWriterå¯¹è±¡ä¸­å†™å…¥çš„æ•°æ®å°†è¢«Servletå¼•æ“è·å–ï¼ŒServletå¼•æ“å°†è¿™äº›æ•°æ®å½“ä½œå“åº”æ¶ˆæ¯çš„æ­£æ–‡ï¼Œç„¶åå†ä¸å“åº”çŠ¶æ€è¡Œå’Œå„å“åº”å¤´ç»„åˆåè¾“å‡ºåˆ°å®¢æˆ·ç«¯ Serlvetçš„serviceæ–¹æ³•ç»“æŸåï¼ŒServletå¼•æ“å°†æ£€æŸ¥getWriteræˆ–getOutputStreamæ–¹æ³•è¿”å›çš„è¾“å‡ºæµå¯¹è±¡æ˜¯å¦å·²ç»è°ƒç”¨è¿‡closeæ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰ï¼ŒServletå¼•æ“å°†è°ƒç”¨closeæ–¹æ³•å…³é—­è¯¥è¾“å‡ºæµå¯¹è±¡ 4. è¿”å›å¤´è®¾ç½®å¸¸è§çš„è¯·æ±‚å¤´å’Œè¿”å›å¤´è®¾ç½®ï¼Œå¯¹äºservletè€Œè¨€ä¹Ÿæ˜¯æ¯”è¾ƒå¸¸è§çš„ï¼Œä¸€èˆ¬å¸¸è§çš„å‡ ä¸ªè®¾ç½® æ˜¯å¦ç¼“å­˜ï¼Œç¼“å­˜æ—¶é—´ è®¾ç½®cookie è®¾ç½® corss-origin ç›¸å…³ï¼Œä»¥æ”¯æŒè·¨åŸŸ è®¾ç½® content-typeâ€¦ è€Œå®é™…çš„ä½¿ç”¨ä¹Ÿæ¯”è¾ƒç®€å•äº†ï¼Œå¦‚ä¸‹å³å¯ 12# javax.servlet.http.HttpServletResponse#addHeaderresponse.addHeader(\"Content-Type\", \"text/html; charset=UTF-8\"); III. å®ä¾‹æµ‹è¯•åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„å—¯Servletï¼Œç„¶åæ‹¦æˆªæ‰€æœ‰ /study ä¸‹é¢çš„è¯·æ±‚ 1234567891011121314151617public class DocServlet extends HttpServlet &#123; protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; resp.setCharacterEncoding(\"utf-8\"); PrintWriter writer = resp.getWriter(); writer.append(\"è¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰servlet\") .append(\"emojğŸ˜„==\").flush(); System.out.println(\"hereher!!!!\"); &#125; protected void doPost(HttpServletRequest req, HttpServletResponse res) throws IOException &#123; Map map = req.getParameterMap(); System.out.println(\"arg: \" + map); res.getWriter().append(\"success\").flush(); &#125;&#125; å¯¹åº”çš„xmlé…ç½®å¦‚ä¸‹ 123456789 &lt;servlet&gt; &lt;servlet-name&gt;doc-servlet&lt;/servlet-name&gt; &lt;servlet-class&gt;com.yihui.study.DocServlet&lt;/servlet-class&gt; &lt;load-on-startup&gt;2&lt;/load-on-startup&gt;&lt;/servlet&gt;&lt;servlet-mapping&gt; &lt;servlet-name&gt;doc-servlet&lt;/servlet-name&gt; &lt;url-pattern&gt;/study/*&lt;/url-pattern&gt;&lt;/servlet-mapping&gt; å®æµ‹æ¼”ç¤ºï¼š IV. å…¶ä»–å‚è€ƒ servletè¯¦è§£(ç¬¬ä¸€ç¯‡) å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è§£ä¸å…¨ï¼Œå¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ æ‰«æå…³æ³¨ï¼Œjavaåˆ†äº«","categories":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"JavaWeb","slug":"Java/JavaWeb","permalink":"https://zbang.online/hexblog/categories/Java/JavaWeb/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"JavaWeb","slug":"JavaWeb","permalink":"https://zbang.online/hexblog/tags/JavaWeb/"},{"name":"Servlet","slug":"Servlet","permalink":"https://zbang.online/hexblog/tags/Servlet/"}],"keywords":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"JavaWeb","slug":"Java/JavaWeb","permalink":"https://zbang.online/hexblog/categories/Java/JavaWeb/"}]},{"title":"Androidå­¦ä¹ ä¹‹æ—…1D:é¦–å±é¡µçš„å¼€å‘","slug":"Androidå­¦ä¹ ä¹‹æ—…1D-é¦–å±é¡µçš„å¼€å‘","date":"2018-01-22T12:16:18.000Z","updated":"2018-01-22T12:30:56.393Z","comments":true,"path":"2018/01/22/Androidå­¦ä¹ ä¹‹æ—…1D-é¦–å±é¡µçš„å¼€å‘/","link":"","permalink":"https://zbang.online/hexblog/2018/01/22/Androidå­¦ä¹ ä¹‹æ—…1D-é¦–å±é¡µçš„å¼€å‘/","excerpt":"Androidå­¦ä¹ ä¹‹æ—…ï¼šç¬¬ä¸€å¤© é‡‡ç”¨ä¾è‘«èŠ¦ç”»ç“¢çš„æ–¹å¼æ¥å­¦ä¹ androidçš„å¼€å‘ï¼Œå‡†å¤‡é€æ­¥çš„å¼€å‘å‡ºã€Šä¸€å°ã€‹è¿™ä¸ªapp æœ¬ç‰‡ä¸»è¦è®°å½•äº†SplashActivityçš„å¼€å‘è¿‡ç¨‹","text":"Androidå­¦ä¹ ä¹‹æ—…ï¼šç¬¬ä¸€å¤© é‡‡ç”¨ä¾è‘«èŠ¦ç”»ç“¢çš„æ–¹å¼æ¥å­¦ä¹ androidçš„å¼€å‘ï¼Œå‡†å¤‡é€æ­¥çš„å¼€å‘å‡ºã€Šä¸€å°ã€‹è¿™ä¸ªapp æœ¬ç‰‡ä¸»è¦è®°å½•äº†SplashActivityçš„å¼€å‘è¿‡ç¨‹ I. å‰ç½®ä¸»è¦copyä¸¤ä¸ªå¼€æºé¡¹ç›® JianshuApp SUESNews ä¸Šé¢ä¸¤ä¸ªå·¥ç¨‹ï¼Œç¬¬äºŒä¸ªç”¨åˆ°çš„ä¾èµ–æ¯”è¾ƒå°‘ï¼Œå®ç°çš„åŸºæœ¬åŠŸèƒ½ä¹Ÿéƒ½å¾ˆokï¼Œè€Œç¬¬ä¸€ä¸ªé‡Œé¢åˆ™ç”¨äº†å¾ˆå¤šæœ‰æ„æ€çš„ç¬¬ä¸‰æ–¹æ¡†æ¶ï¼Œä½†æ˜¯ç›®å‰æˆ‘çœ‹ä¸å¤ªæ‡‚ï¼Œæ‰€ä»¥ç¬¬ä¸€ç‰ˆä»¥SUESNewsä½œä¸ºä¸»è¦çš„å­¦ä¹ ç›®æ ‡ æ‰€ä»¥ï¼Œç¬¬ä¸€ç‰ˆçš„ç›®æ ‡æ˜¯ï¼š å®ç°åŸºæœ¬åŠŸèƒ½ å®Œæˆä¸»ä½“ä¸šåŠ¡é€»è¾‘ II. Splashé¡µé¢å¼€å‘ä¸€èˆ¬æ¥å°†ï¼Œè¿›å…¥appä¹‹å‰ï¼Œä¼šè¿›å…¥ä¸€ä¸ªç±»ä¼¼é¦–å±é¡µçš„é¡µé¢ï¼ˆæ¯”å¦‚12306çš„æ˜¾ç¤ºå¹¿å‘Šå•¥çš„ï¼‰ï¼Œé‚£ä¹ˆç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯åšè¿™ä¸ªäº† 1. åšä»€ä¹ˆè¿™ä¸ªé¡µé¢ï¼Œä¸»è¦æ˜¾ç¤ºçš„ä¸œè¥¿æ¯”è¾ƒç®€å•äº† ä¸Šè¾¹æ˜¯ä¸€ä¸ªå›¾ç‰‡ï¼Œå³ä¸Šè§’ä¸€ä¸ªå€’è®¡æ—¶ ä¸‹è¾¹æ˜¾ç¤ºçš„åº”ç”¨ä¿¡æ¯ï¼Œç‰ˆæœ¬ç­‰ ä¸šåŠ¡é€»è¾‘ï¼š æ˜¾ç¤ºå¹¿å‘Šï¼ˆğŸ˜„ï¼‰ï¼Œç‚¹å‡»è¿›å…¥ç›¸åº”çš„è¯¦æƒ…é¡µ åˆ¤æ–­æ˜¯å¦ç™»å½•ï¼Œè‹¥æœªç™»å½•ï¼Œåˆ™è¿›å…¥ç™»å½•é¡µ è‹¥å·²ç»ç™»å½•ï¼Œåˆ™è¿›å…¥ä¸»APP 2. å¼€åŠ¨a. å…¨å±è¿›å…¥çš„é¦–é¡µï¼Œæ‰€ä»¥çŠ¶æ€æ ï¼Œæ ‡é¢˜å•¥çš„éƒ½ä¸è¦ï¼Œä¸»è¦çš„é€»è¾‘å¦‚ä¸‹ styles.xml æ–‡ä»¶ä¸­æ–°å¢ 1234&lt;style name=\"AppTheme.FullScreen\"&gt; &lt;item name=\"windowNoTitle\"&gt;true&lt;/item&gt; &lt;item name=\"android:windowFullscreen\"&gt;true&lt;/item&gt;&lt;/style&gt; å…¶æ¬¡ï¼Œå°±æ˜¯åœ¨å®šä¹‰çš„Activityä¸­ï¼Œä½¿ç”¨å¯¹åº”çš„style AndroidManifest.xml 1234567&lt;activity android:name=\".ui.SplashActivity\" android:theme=\"@style/AppTheme.FullScreen\"&gt; &lt;intent-filter&gt; &lt;action android:name=\"android.intent.action.MAIN\" /&gt; &lt;category android:name=\"android.intent.category.LAUNCHER\" /&gt; &lt;/intent-filter&gt;&lt;/activity&gt; b. xmlå®ç°activity_splash.xml å¯¹åº”çš„å®ç°å¦‚ä¸‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;&lt;RelativeLayout xmlns:android=\"http://schemas.android.com/apk/res/android\" xmlns:tools=\"http://schemas.android.com/tools\" android:id=\"@+id/content\" android:layout_width=\"match_parent\" android:layout_height=\"match_parent\" android:fitsSystemWindows=\"false\" tools:context=\"com.yihui.yifeng.ui.SplashActivity\"&gt; &lt;ImageView android:id=\"@+id/image_background\" android:layout_width=\"match_parent\" android:layout_height=\"match_parent\" android:layout_alignBottom=\"@+id/title_text\" android:layout_alignParentLeft=\"true\" android:layout_alignParentStart=\"true\" android:layout_marginBottom=\"52dp\" android:scaleType=\"centerCrop\" /&gt; &lt;ImageView android:id=\"@+id/image_info_bg\" android:layout_width=\"match_parent\" android:layout_height=\"match_parent\" android:layout_alignTop=\"@+id/title_text\" android:layout_centerHorizontal=\"true\" android:scaleType=\"centerCrop\" /&gt; &lt;TextView android:id=\"@+id/title_text\" android:layout_width=\"wrap_content\" android:layout_height=\"wrap_content\" android:layout_above=\"@+id/version_text\" android:layout_centerHorizontal=\"true\" android:layout_marginBottom=\"17dp\" android:text=\"@string/app_name\" android:textColor=\"@color/text_color\" android:textSize=\"@dimen/text_size_title_bigger\" android:textStyle=\"bold\" /&gt; &lt;TextView android:id=\"@+id/version_text\" android:layout_width=\"wrap_content\" android:layout_height=\"wrap_content\" android:layout_alignParentBottom=\"true\" android:layout_centerHorizontal=\"true\" android:layout_marginBottom=\"11dp\" android:textColor=\"@color/secondary_text\" android:textSize=\"@dimen/text_size_subhead\" android:textStyle=\"bold\" tools:text=\"Copyright @2017-2018 ä¸€å° | å°ç°ç°æŠ€æœ¯æ”¯æŒ\" /&gt;&lt;/RelativeLayout&gt; è¿è¡Œæˆªå›¾å¦‚ä¸‹ï¼š ä¸Šé¢è¿™ä¸ªå¸ƒå±€ï¼Œæ˜¯ç›´æ¥ä½¿ç”¨å¯è§†åŒ–çš„æ‹–æ‹½çš„ï¼Œæ‰€ä»¥æ“ä½œèµ·æ¥æŒºè›‹ç–¼çš„ï¼Œè€Œä¸”æœ€ç»ˆçš„ç»“æœä¹Ÿä¸å¤ªå¥½ï¼Œä¸‹é¢å•ç‹¬çš„å¼€ä¸€èŠ‚æ¥ç ”ç©¶ä¸‹è¿™ä¸ªå¸ƒå±€çš„ä¸œè¥¿äº† c. Activityçš„å®ç°ä¸Šé¢æ˜¯xmlçš„é…ç½®ï¼Œå½“ç„¶è¿˜å¾—æœ‰å¯¹åº”çš„å®ä½“ç±»äº†ï¼Œå¤§éƒ¨åˆ†é€»è¾‘æ˜¯ç›´æ¥ä»å‚è€ƒçš„å·¥ç¨‹ä¸­copyè¿‡æ¥çš„ï¼Œæ‰€ä»¥ç›¸å…³çš„åŠ¨ç”»é…ç½®ï¼Œå›¾ç‰‡ä¹Ÿæ˜¯ç›´æ¥æ‰£è¿‡æ¥çš„ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263public class SplashActivity extends Activity &#123; private ImageView mBackgroundImage; private ImageView infoBgImg; private TextView mTitleText; private TextView mVersionText; private int[] ary = new int[] &#123;R.drawable.pic_background_1, R.drawable.pic_background_2, R.drawable.pic_background_3, R.drawable.pic_background_4&#125;; private int getBgDrawable() &#123; return ary[new Random().nextInt(ary.length)]; &#125; private void initInfoBg() &#123; infoBgImg = findViewById(R.id.image_info_bg); infoBgImg.setImageDrawable(getResources().getDrawable(ary[0])); &#125; private void initAdBg() &#123; mBackgroundImage = findViewById(R.id.image_background); mBackgroundImage.setImageDrawable(getResources().getDrawable(getBgDrawable())); Animation animImage = AnimationUtils.loadAnimation(this, R.anim.image_welcome); mBackgroundImage.startAnimation(animImage); animImage.setAnimationListener(new Animation.AnimationListener() &#123; @Override public void onAnimationStart(Animation animation) &#123; &#125; @Override public void onAnimationEnd(Animation animation) &#123; //åŠ¨ç”»ç»“æŸæ—¶æ‰“å¼€é¦–é¡µ startActivity(new Intent(SplashActivity.this, MainActivity.class)); overridePendingTransition(R.anim.activity_slide_in, R.anim.no_anim); finish(); &#125; @Override public void onAnimationRepeat(Animation animation) &#123; &#125; &#125;); &#125; @Override protected void onCreate(Bundle savedInstanceState) &#123; super.onCreate(savedInstanceState); setContentView(R.layout.activity_splash); // ä¸‹åŠçš„æç¤ºæ–‡æ¡ˆä¿¡æ¯ initInfoBg(); // ä¸ŠåŠçš„å¹¿å‘ŠåŠ¨ç”» initAdBg(); &#125;&#125; todoç™»å½•çŠ¶æ€åˆ¤æ–­ï¼Œå¦‚æœæœªç™»å½•ï¼Œåˆ™åº”è¯¥è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼›å¦åˆ™æ‰æ˜¯è·³è½¬åˆ°ä¸»é¡µ III. çŸ¥è¯†ç‚¹å°ç»“ä¸Šé¢åªæ˜¯å®ç°äº†ä¸€ä¸ªç®€å•çš„åº”ç”¨å¼€å¯é¡µé¢ï¼Œä½†ä¹Ÿæ¶‰åŠäº†å‡ ä¸ªæœ‰è¶£çš„çŸ¥è¯†ç‚¹ï¼Œä¸‹é¢æ¥æ·±å…¥ä¸€ä¸‹ 1. RelativeLayout å¸ƒå±€æ§ä»¶çš„ä½ç½®æ˜¯æŒ‰ç…§ç›¸å¯¹ä½ç½®æ¥è®¡ç®—çš„ï¼Œåä¸€ä¸ªæ§ä»¶åœ¨ä»€ä¹ˆä½ç½®ä¾èµ–äºå‰ä¸€ä¸ªæ§ä»¶çš„åŸºæœ¬ä½ç½®ï¼Œæ˜¯å¸ƒå±€æœ€å¸¸ç”¨ï¼Œä¹Ÿæ˜¯æœ€çµæ´»çš„ä¸€ç§å¸ƒå±€ å¸¸è§çš„å±æ€§å€¼ 123456789101112131415161718192021222324ç¬¬ä¸€ç±»:å±æ€§å€¼ä¸ºtrueæˆ–falseandroid:layout_centerHrizontal æ°´å¹³å±…ä¸­android:layout_centerVertical å‚ç›´å±…ä¸­android:layout_centerInparent ç›¸å¯¹äºçˆ¶å…ƒç´ å®Œå…¨å±…ä¸­android:layout_alignParentBottom è´´ç´§çˆ¶å…ƒç´ çš„ä¸‹è¾¹ç¼˜android:layout_alignParentLeft è´´ç´§çˆ¶å…ƒç´ çš„å·¦è¾¹ç¼˜android:layout_alignParentRight è´´ç´§çˆ¶å…ƒç´ çš„å³è¾¹ç¼˜android:layout_alignParentTop è´´ç´§çˆ¶å…ƒç´ çš„ä¸Šè¾¹ç¼˜ ç¬¬äºŒç±»ï¼šå±æ€§å€¼å¿…é¡»ä¸ºidçš„å¼•ç”¨åâ€œ@id/id-nameâ€android:layout_below åœ¨æŸå…ƒç´ çš„ä¸‹æ–¹android:layout_above åœ¨æŸå…ƒç´ çš„çš„ä¸Šæ–¹android:layout_toLeftOf åœ¨æŸå…ƒç´ çš„å·¦è¾¹android:layout_toRightOf åœ¨æŸå…ƒç´ çš„å³è¾¹android:layout_alignTop æœ¬å…ƒç´ çš„ä¸Šè¾¹ç¼˜å’ŒæŸå…ƒç´ çš„çš„ä¸Šè¾¹ç¼˜å¯¹é½android:layout_alignLeft æœ¬å…ƒç´ çš„å·¦è¾¹ç¼˜å’ŒæŸå…ƒç´ çš„çš„å·¦è¾¹ç¼˜å¯¹é½android:layout_alignBottom æœ¬å…ƒç´ çš„ä¸‹è¾¹ç¼˜å’ŒæŸå…ƒç´ çš„çš„ä¸‹è¾¹ç¼˜å¯¹é½android:layout_alignRight æœ¬å…ƒç´ çš„å³è¾¹ç¼˜å’ŒæŸå…ƒç´ çš„çš„å³è¾¹ç¼˜å¯¹é½ç¬¬ä¸‰ç±»ï¼šå±æ€§å€¼ä¸ºå…·ä½“çš„åƒç´ å€¼ï¼Œå¦‚30dipï¼Œ40pxandroid:layout_marginBottom ç¦»æŸå…ƒç´ åº•è¾¹ç¼˜çš„è·ç¦»android:layout_marginLeft ç¦»æŸå…ƒç´ å·¦è¾¹ç¼˜çš„è·ç¦»android:layout_marginRight ç¦»æŸå…ƒç´ å³è¾¹ç¼˜çš„è·ç¦»android:layout_marginTop ç¦»æŸå…ƒç´ ä¸Šè¾¹ç¼˜çš„è·ç¦» æ‰€ä»¥å¯ä»¥ç®€å•çš„ä¿®æ”¹ä¸€ä¸‹ä¸Šé¢çš„å¸ƒå±€ï¼Œç›¸å¯¹å¸ƒå±€çš„æ ·å¼å°±ä¸¤ä¸ªï¼Œä¸Šé¢ä¸€ä¸ªå›¾ï¼Œä¸‹é¢ä¸€ä¸ªå›¾ 1234567891011121314151617181920&lt;ImageView android:id=\"@+id/image_background\" android:layout_width=\"match_parent\" android:layout_height=\"match_parent\" &lt;!-- æ³¨æ„è¿™ä¸€è¡Œ --&gt; android:layout_alignBottom=\"@+id/image_info_bg\" android:layout_alignParentLeft=\"true\" android:layout_alignParentStart=\"true\" android:layout_marginBottom=\"52dp\" android:scaleType=\"centerCrop\" /&gt;&lt;ImageView android:id=\"@+id/image_info_bg\" android:layout_width=\"match_parent\" android:layout_height=\"match_parent\" &lt;!-- æ³¨æ„è¿™ä¸€è¡Œï¼Œç¡®ä¿èƒŒæ™¯å›¾å¯ä»¥åŒ…å«æ–‡æœ¬ä¿¡æ¯ --&gt; android:layout_alignTop=\"@+id/title_text\" android:layout_centerHorizontal=\"true\" android:scaleType=\"centerCrop\" /&gt; é‚£ä¹ˆå‰©ä¸‹çš„ä¸¤ä¸ªæ–‡æœ¬æ˜¾ç¤ºå°±å¯ä»¥ç›´æ¥æŒ‡å®šä¸‹è¾¹è·æ¥ç¡®å®šä½ç½®äº† 123456789101112131415161718192021222324&lt;TextView android:id=\"@+id/title_text\" android:layout_width=\"wrap_content\" android:layout_height=\"wrap_content\" android:layout_above=\"@+id/version_text\" android:layout_centerHorizontal=\"true\" &lt;!-- è¿™é‡Œç¡®å®šäº†é«˜åº¦ --&gt; android:layout_marginBottom=\"17dp\" android:text=\"@string/app_name\" android:textColor=\"@color/text_color\" android:textSize=\"@dimen/text_size_title_bigger\" android:textStyle=\"bold\" /&gt;&lt;TextView android:id=\"@+id/version_text\" android:layout_width=\"wrap_content\" android:layout_height=\"wrap_content\" android:layout_alignParentBottom=\"true\" android:layout_centerHorizontal=\"true\" &lt;!-- è¿™é‡Œç¡®å®šäº†é«˜åº¦ --&gt; android:layout_marginBottom=\"11dp\" android:textColor=\"@color/secondary_text\" android:textSize=\"@dimen/text_size_subhead\" android:text=\"@string/splash_copyright\" /&gt; 2. è·å–ç»„ä»¶åœ¨Activityä¸­ï¼Œå…ˆè¦ç»‘å®šè§†å›¾ï¼Œç„¶åå†è·å–viewè¿›è¡Œç›¸å…³çš„æ“ä½œï¼ˆå¦‚ä¿®æ”¹å€¼ï¼Œç»‘å®šäº‹ä»¶ç­‰ï¼‰ 12345678910// Activity çš„ oncreateæ–¹æ³•ä¸­ï¼Œè¿›è¡Œåˆå§‹åŒ–// ç»‘å®šè§†å›¾super.onCreate(savedInstanceState);setContentView(R.layout.activity_splash);// è·å–ç»„ä»¶findViewById(R.id.image_info_bg);// è·å–èµ„æºï¼Œå¦‚å›¾ç‰‡Drawable drawable = getResources().getDrawable(R.drawable.pic_background_1) æœ‰ä¸€ä¸ªéå¸¸æœ‰åçš„å·¥å…·å«åš butterknife, å¯ä»¥é€šè¿‡æ³¨è§£çš„æ–¹å¼æ¥è§£å†³ findViewByIdè¿™ç§é¢‘ç¹çš„è°ƒç”¨å§¿åŠ¿ï¼Œè¿™ä¸ªæ”¾åœ¨åç»­çš„è¿›é˜¶ç‰ˆä¸­ä½¿ç”¨ 3. è®¾ç½®åŠ¨ç”»å¼€å±ä½¿ç”¨äº†ä¸€ä¸ªå›¾ç‰‡æ”¾å¤§çš„åŠ¨ç”»ï¼ŒæŒç»­3sï¼ŒåŠ¨ç”»æ’­æ”¾å®Œæ¯•ä¹‹åè·³è½¬ä¸»é¡µï¼›æ‰€ä»¥è¿™é‡Œæœ‰ä¸ªæœ‰è¶£çš„çŸ¥è¯†ç‚¹å°±æ˜¯å¦‚ä½•ä½¿ç”¨xmlæ¥é…ç½®åŠ¨ç”»æ•ˆæœï¼Œä»å®ç°æ¥çœ‹ä¹ŸæŒºç®€å•çš„ 123456789101112131415161718192021222324// è§£æxmlé…ç½®ä¸º Animation å¯¹è±¡Animation animImage = AnimationUtils.loadAnimation(this, R.anim.image_welcome);// è®¾ç½®ç»„ä»¶çš„åŠ¨ç”»å±æ€§mBackgroundImage.startAnimation(animImage);// é…ç½®ç›‘å¬äº‹ä»¶animImage.setAnimationListener(new Animation.AnimationListener() &#123; @Override public void onAnimationStart(Animation animation) &#123; &#125; // åŠ¨ç”»ç»“æŸåçš„å›è°ƒ @Override public void onAnimationEnd(Animation animation) &#123; //åŠ¨ç”»ç»“æŸæ—¶æ‰“å¼€é¦–é¡µ startActivity(new Intent(SplashActivity.this, MainActivity.class)); overridePendingTransition(R.anim.activity_slide_in, R.anim.no_anim); finish(); &#125; @Override public void onAnimationRepeat(Animation animation) &#123; &#125;&#125;); å¯¹åº”çš„xmlé…ç½®å¦‚ä¸‹ image_welcome.xml 1234567891011&lt;set xmlns:android=\"http://schemas.android.com/apk/res/android\"&gt; &lt;scale android:fromXScale=\"1.0\" android:toXScale=\"1.3\" android:fromYScale=\"1.0\" android:toYScale=\"1.3\" android:duration=\"3000\" android:pivotY=\"50%\" android:pivotX=\"50%\" /&gt;&lt;/set&gt; é‚£ä¹ˆï¼Œæˆ‘ä»¬éœ€è¦å®ç°å¼€å¤´è¯´çš„ï¼Œè¿™ä¸ªå›¾ç‰‡å¦‚æœæ˜¯ä¸ªå¹¿å‘Šï¼Œç‚¹å‡»æ—¶å±•å¼€è¯¦æƒ…é¡µï¼›å³ä¸Šè§’æ˜¾ç¤ºä¸€ä¸ªå€’è®¡æ—¶çš„å°æ§ä»¶ï¼Œå¯ä»¥æ€ä¹ˆå¤„ç†ï¼Ÿï¼ˆçœ‹æœ€åï¼‰ 4. é¡µé¢è·³è½¬ä»ä¸€ä¸ªActivityè·³è½¬åˆ°å¦ä¸€ä¸ªï¼Œå¸¸è§çš„ä½¿ç”¨å§¿åŠ¿å¦‚ä¸‹ 1startActivity(new Intent(SplashActivity.this, MainActivity.class)); IV. å€’è®¡æ—¶æ”¹è¿›å¦‚ä½•ä½¿ç”¨å€’è®¡æ—¶æ¥æ›¿æ¢å‰é¢çš„åŠ¨ç”»å‘¢ï¼Ÿæœ€å®¹æ˜“æƒ³åˆ°çš„å°±æ˜¯ç”¨Timeræˆ–è€…ScheduleServiceæ¥å®ç°ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œå½“ç„¶è¿™æ˜¯ä¸€ä¸ªåç«¯javaçš„æƒ³æ³•ï¼Œå¯¹äºAndroidå‘¢ï¼Œç‰¹æ„æŸ¥äº†ä¸€ä¸‹ï¼Œå‘ç°æœ‰ä¸ª CountDownTimer çš„ç±»ï¼Œä¸“é—¨å¹²è¿™ä¸ªçš„ï¼Œæ‰€ä»¥ç®€å•çš„æ”¹é€ ä¸€ä¸‹ 12345678910111213141516171819202122232425262728private void initAdBg() &#123; mBackgroundImage = findViewById(R.id.image_background); mBackgroundImage.setImageDrawable(getResources().getDrawable(getBgDrawable())); mBackgroundImage.setOnClickListener(new View.OnClickListener() &#123; @Override public void onClick(View view) &#123; // ç‚¹å‡» Toast.makeText(SplashActivity.this, \"ç‚¹å‡»äº†\", Toast.LENGTH_SHORT).show(); &#125; &#125;); final TextView countDown = findViewById(R.id.splash_timedown); CountDownTimer timer = new CountDownTimer(10000, 1000) &#123; @Override public void onTick(long l) &#123; countDown.setText(\"å€’è®¡æ—¶:\" + (l / 1000) + \"s\"); &#125; @Override public void onFinish() &#123; //åŠ¨ç”»ç»“æŸæ—¶æ‰“å¼€é¦–é¡µ startActivity(new Intent(SplashActivity.this, MainActivity.class)); overridePendingTransition(R.anim.activity_slide_in, R.anim.no_anim); finish(); &#125; &#125;; timer.start();&#125; æ”¹é€ åçš„è¾“å‡ºå›¾, æ³¨æ„å³ä¸Šè§’çš„æ—¶é—´ï¼Œå·²ç»ä¸‹é¢åˆ†å‰²å¤„ï¼Œä¸ä¼šæœ‰å‰é¢çš„ç©ºç™½äº† V. å…¶ä»–é¢å¤–è¯æ„Ÿè§‰æœ€è¿‘ä¸å¤ªèƒ½ä¸“å¿ƒä¸‹æ¥å­¦ä¹ ä¸€é—¨æŠ€æœ¯ï¼Œæœ‰ç‚¹æµ®èºäº†ï¼Œæ‰€ä»¥å†³å®šå­¦ä¹ ä¸‹andoridï¼Œé”»ç‚¼ä¸‹è‡ªå·±ï¼Œåˆæ­¥è§„åˆ’ï¼Œå…ˆå…¥é—¨ï¼Œç„¶åæ¥æ”¶ä¸€äº›æœ‰è¶£çš„ç¬¬ä¸‰æ–¹æ¡†æ¶ï¼Œæœ€åå†è¯•ä¸€ä¸‹kotalin Androidå­¦ä¹ ç¬¬ä¸€å¤©ï¼Œæ€»æ„Ÿè§‰è¿™å°†æ˜¯ä¸ªæ¼«é•¿çš„è¿‡ç¨‹ï¼Œä¹Ÿä¸æ™“å¾—æœ€ç»ˆä¼šå®Œæˆå¾—æ€ä¹ˆæ ·ï¼ŒåŠªåŠ›åšæŒå§ æ‰«æå…³æ³¨ï¼Œjavaåˆ†äº«","categories":[{"name":"Android","slug":"Android","permalink":"https://zbang.online/hexblog/categories/Android/"},{"name":"ä¸€å°","slug":"Android/ä¸€å°","permalink":"https://zbang.online/hexblog/categories/Android/ä¸€å°/"}],"tags":[{"name":"Android","slug":"Android","permalink":"https://zbang.online/hexblog/tags/Android/"},{"name":"ä¸€å°","slug":"ä¸€å°","permalink":"https://zbang.online/hexblog/tags/ä¸€å°/"},{"name":"RelativeLayout","slug":"RelativeLayout","permalink":"https://zbang.online/hexblog/tags/RelativeLayout/"},{"name":"CountDownTimer","slug":"CountDownTimer","permalink":"https://zbang.online/hexblog/tags/CountDownTimer/"}],"keywords":[{"name":"Android","slug":"Android","permalink":"https://zbang.online/hexblog/categories/Android/"},{"name":"ä¸€å°","slug":"Android/ä¸€å°","permalink":"https://zbang.online/hexblog/categories/Android/ä¸€å°/"}]},{"title":"å…¼å®¹ImageIOè¯»å–jpegå›¾ç‰‡å˜çº¢","slug":"å…¼å®¹ImageIOè¯»å–jpegå›¾ç‰‡å˜çº¢","date":"2018-01-22T06:38:39.000Z","updated":"2018-02-13T03:21:17.019Z","comments":true,"path":"2018/01/22/å…¼å®¹ImageIOè¯»å–jpegå›¾ç‰‡å˜çº¢/","link":"","permalink":"https://zbang.online/hexblog/2018/01/22/å…¼å®¹ImageIOè¯»å–jpegå›¾ç‰‡å˜çº¢/","excerpt":"å…¼å®¹ImageIOè¯»å–jpegå›¾ç‰‡å˜çº¢ ä½¿ç”¨ImageIO.read()æ–¹æ³•ï¼ŒåŠ è½½å›¾ç‰‡ä¸ºBufferedImageå¯¹è±¡æ—¶ï¼Œå¯¹äºæŸäº›å›¾ç‰‡ï¼Œä¼šå‡ºç°å˜çº¢çš„case","text":"å…¼å®¹ImageIOè¯»å–jpegå›¾ç‰‡å˜çº¢ ä½¿ç”¨ImageIO.read()æ–¹æ³•ï¼ŒåŠ è½½å›¾ç‰‡ä¸ºBufferedImageå¯¹è±¡æ—¶ï¼Œå¯¹äºæŸäº›å›¾ç‰‡ï¼Œä¼šå‡ºç°å˜çº¢çš„case é—®é¢˜é‡ç°æœ‰é—®é¢˜çš„å›¾ç‰‡ï¼š æµ‹è¯•éªŒè¯ä»£ç  123456789101112/** * å›¾ç‰‡è¯»å–ä¹‹åï¼Œé¢œè‰²å˜çº¢çš„æµ‹è¯• */@Testpublic void testLoadRedImg() throws IOException &#123; String url = \"http://s17.mogucdn.com/mlcdn/c45406/170418_68lkjddg3bll08h9c9bk0d8ihkffi_800x1200.jpg\"; URL u = new URL(url); BufferedImage bf = ImageIO.read(u); ImageIO.write System.out.println(\"--over--\");&#125; debugæˆªå›¾å¦‚ä¸‹ï¼š é—®é¢˜å…¼å®¹ä¸å®ç”¨ImageIOæ¥åŠ è½½å›¾ç‰‡ï¼Œæ”¹ç”¨Toolkitæ¥å®ç°å›¾ç‰‡è¯»å–ï¼Œç„¶åå†å°†è¯»å–åˆ°çš„å›¾ç‰‡ç»˜åˆ¶åˆ°BufferedImageå¯¹è±¡ä¸Š 1234567891011121314151617181920212223242526272829303132333435363738394041@Testpublic void testLoadRedImg2() throws MalformedURLException &#123; String url = \"http://s17.mogucdn.com/mlcdn/c45406/170418_68lkjddg3bll08h9c9bk0d8ihkffi_800x1200.jpg\"; URL u = new URL(url); Image img = Toolkit.getDefaultToolkit().getImage(u); BufferedImage bf = toBufferedImage(img); System.out.println(\"eeee\");&#125;static BufferedImage toBufferedImage(Image image) &#123; if (image instanceof BufferedImage) &#123; return (BufferedImage) image; &#125; // This code ensures that all the pixels in the image are loaded image = new ImageIcon(image).getImage(); BufferedImage bimage = null; GraphicsEnvironment ge = GraphicsEnvironment .getLocalGraphicsEnvironment(); try &#123; int transparency = Transparency.OPAQUE; GraphicsDevice gs = ge.getDefaultScreenDevice(); GraphicsConfiguration gc = gs.getDefaultConfiguration(); bimage = gc.createCompatibleImage(image.getWidth(null), image.getHeight(null), transparency); &#125; catch (HeadlessException e) &#123; // The system does not have a screen &#125; if (bimage == null) &#123; // Create a buffered image using the default color model int type = BufferedImage.TYPE_INT_RGB; bimage = new BufferedImage(image.getWidth(null), image.getHeight(null), type); &#125; // Copy image to buffered image Graphics g = bimage.createGraphics(); // Paint the image onto the buffered image g.drawImage(image, 0, 0, null); g.dispose(); return bimage;&#125; å®æµ‹éªŒè¯ ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ï¼š ImageIO.read()æ–¹æ³•è¯»å–å›¾ç‰‡æ—¶å¯èƒ½å­˜åœ¨ä¸æ­£ç¡®å¤„ç†å›¾ç‰‡ICCä¿¡æ¯çš„é—®é¢˜ï¼ŒICCä¸ºJPEGå›¾ç‰‡æ ¼å¼ä¸­çš„ä¸€ç§å¤´éƒ¨ä¿¡æ¯ï¼Œå¯¼è‡´æ¸²æŸ“å›¾ç‰‡å‰æ™¯è‰²æ—¶è’™ä¸Šä¸€å±‚çº¢è‰²ã€‚ å…¶ä»–å‚è€ƒ Javaå¤„ç†æŸäº›å›¾ç‰‡çº¢è‰²é—®é¢˜ æ‰«æå…³æ³¨ï¼Œjavaåˆ†äº«","categories":[{"name":"BugFix","slug":"BugFix","permalink":"https://zbang.online/hexblog/categories/BugFix/"},{"name":"Java","slug":"BugFix/Java","permalink":"https://zbang.online/hexblog/categories/BugFix/Java/"},{"name":"Image","slug":"BugFix/Java/Image","permalink":"https://zbang.online/hexblog/categories/BugFix/Java/Image/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"BugFix","slug":"BugFix","permalink":"https://zbang.online/hexblog/tags/BugFix/"},{"name":"BufferedImage","slug":"BufferedImage","permalink":"https://zbang.online/hexblog/tags/BufferedImage/"},{"name":"Jpeg","slug":"Jpeg","permalink":"https://zbang.online/hexblog/tags/Jpeg/"}],"keywords":[{"name":"BugFix","slug":"BugFix","permalink":"https://zbang.online/hexblog/categories/BugFix/"},{"name":"Java","slug":"BugFix/Java","permalink":"https://zbang.online/hexblog/categories/BugFix/Java/"},{"name":"Image","slug":"BugFix/Java/Image","permalink":"https://zbang.online/hexblog/categories/BugFix/Java/Image/"}]},{"title":"Batikæ¸²æŸ“pngå›¾ç‰‡å¼‚å¸¸çš„bugä¿®å¤","slug":"Batikæ¸²æŸ“pngå›¾ç‰‡å¼‚å¸¸çš„bugä¿®å¤","date":"2018-01-20T12:36:56.000Z","updated":"2018-02-13T03:21:17.017Z","comments":true,"path":"2018/01/20/Batikæ¸²æŸ“pngå›¾ç‰‡å¼‚å¸¸çš„bugä¿®å¤/","link":"","permalink":"https://zbang.online/hexblog/2018/01/20/Batikæ¸²æŸ“pngå›¾ç‰‡å¼‚å¸¸çš„bugä¿®å¤/","excerpt":"Batikæ¸²æŸ“pngå›¾ç‰‡å¼‚å¸¸çš„bugä¿®å¤batikæ˜¯apacheçš„ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œå¯ä»¥å®ç°svgçš„æ¸²æŸ“ï¼Œåç«¯å€ŸåŠ©å®ƒå¯ä»¥æ¯”è¾ƒç®€å•çš„å®ç°å›¾ç‰‡æ¸²æŸ“ï¼Œå½“ç„¶å’Œjavaä¸€è´¯å¤„ç†å›¾ç‰‡ä¸å¤ªæ–¹ä¾¿ä¸€æ ·ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿæœ‰ä¸å°‘å‘ ä¸‹é¢è®°å½•ä¸€ä¸ªbugçš„ä¿®å¤è¿‡ç¨‹","text":"Batikæ¸²æŸ“pngå›¾ç‰‡å¼‚å¸¸çš„bugä¿®å¤batikæ˜¯apacheçš„ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œå¯ä»¥å®ç°svgçš„æ¸²æŸ“ï¼Œåç«¯å€ŸåŠ©å®ƒå¯ä»¥æ¯”è¾ƒç®€å•çš„å®ç°å›¾ç‰‡æ¸²æŸ“ï¼Œå½“ç„¶å’Œjavaä¸€è´¯å¤„ç†å›¾ç‰‡ä¸å¤ªæ–¹ä¾¿ä¸€æ ·ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿæœ‰ä¸å°‘å‘ ä¸‹é¢è®°å½•ä¸€ä¸ªbugçš„ä¿®å¤è¿‡ç¨‹ I. é—®é¢˜é‡ç°svgæ–‡ä»¶: 123456&lt;svg width=\"200\" height=\"200\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\"&gt;&lt;image y=\"0\" width=\"100%\" height=\"100%\" x=\"0\" xlink:href=\"http://image.uc.cn/o/wemedia/s/upload/2017/39c53604fe3587a4876396cf3785b801x200x200x13.png\"/&gt; &lt;!--xlink:href=\"https://s17.mogucdn.com/mlcdn/c45406/180119_46ld8kkb54d3el06hela5d61e18f5_1024x966.png\"/&gt;--&gt; &lt;!--xlink:href=\"http://avatar.csdn.net/A/8/B/3_u010889145.jpg\"/&gt;--&gt;&lt;/svg&gt; ä¾æ¬¡æµ‹è¯•äº†ä¸‰ä¸ªå›¾ç‰‡ï¼Œä¸¤ä¸ªpngï¼Œä¸€ä¸ªjpgï¼Œå¾ˆä¸å¹¸ç¬¬ä¸€ä¸ªpngä¼šæŠ›å¼‚å¸¸ è¾“å‡ºçš„å †æ ˆä¿¡æ¯å¦‚ 12345678910111213141516The URI \"http://image.uc.cn/o/wemedia/s/upload/2017/39c53604fe3587a4876396cf3785b801x200x200x13.png\"on element &lt;image&gt; can't be opened because:PNG URL is corrupt or unsupported variant at org.apache.batik.bridge.UserAgentAdapter.getBrokenLinkDocument(UserAgentAdapter.java:448) at org.apache.batik.bridge.SVGImageElementBridge.createRasterImageNode(SVGImageElementBridge.java:642) at org.apache.batik.bridge.SVGImageElementBridge.createImageGraphicsNode(SVGImageElementBridge.java:340) at org.apache.batik.bridge.SVGImageElementBridge.buildImageGraphicsNode(SVGImageElementBridge.java:180) at org.apache.batik.bridge.SVGImageElementBridge.createGraphicsNode(SVGImageElementBridge.java:122) at org.apache.batik.bridge.GVTBuilder.buildGraphicsNode(GVTBuilder.java:213) at org.apache.batik.bridge.GVTBuilder.buildComposite(GVTBuilder.java:171) at org.apache.batik.bridge.GVTBuilder.build(GVTBuilder.java:82) at org.apache.batik.transcoder.SVGAbstractTranscoder.transcode(SVGAbstractTranscoder.java:208) at org.apache.batik.transcoder.image.ImageTranscoder.transcode(ImageTranscoder.java:92) at org.apache.batik.transcoder.XMLAbstractTranscoder.transcode(XMLAbstractTranscoder.java:142) at org.apache.batik.transcoder.SVGAbstractTranscoder.transcode(SVGAbstractTranscoder.java:156) ... II. é—®é¢˜å®šä½åŠåˆ†ææ—¢ç„¶å‡ºç°äº†è¿™ä¸ªé—®é¢˜ï¼Œé‚£ä¹ˆå°±è¦å»ä¿®å¤è§£å†³äº†ï¼Œå½“ç„¶é‡åˆ°è¿™ä¹ˆé¬¼ç•œçš„é—®é¢˜ï¼Œæœ€å¸¸è§çš„å‡ ä¸ªæ­¥éª¤ï¼š å…¶ä»–äººé‡åˆ°è¿‡ä¹ˆ ï¼ˆé—®ç™¾åº¦ï¼‰ â€“ ç»“æœåº¦å¨˜æ²¡æœ‰ç»™å‡ºä»»ä½•æœ‰æ•ˆçš„å»ºè®®ï¼Œä¹Ÿæ²¡æœ‰æœåˆ°ä»»ä½•æœ‰ç”¨çš„ä¿¡æ¯ ç„¶åé—®è°·æ­Œï¼Œé è°±äº†ä¸€ç‚¹ï¼Œè‡³å°‘æœ‰äº›ç›¸å…³çš„ä¸»é¢˜äº†ï¼Œä½†å»ºè®¾æ€§çš„æ„è§ä¹Ÿæ²¡æ”¶åˆ° å¤–æ´å®åœ¨æ‰¾ä¸åˆ°ï¼Œåªèƒ½debugæŸ¥é—®é¢˜äº† 1. DEBUGçš„ä¸€è·¯é€šè¿‡ä¸Šé¢çš„å †æ ˆä¿¡æ¯ï¼Œå¯ä»¥æƒ³è§ï¼Œdebugçš„å‡ ä¸ªåœ°æ–¹ä¹Ÿå’Œæ˜ç¡®äº†ï¼Œé¦–å…ˆå®šä½åˆ°ä¸‹é¢è¿™ä¸€è¡Œ 1at org.apache.batik.bridge.UserAgentAdapter.getBrokenLinkDocument(UserAgentAdapter.java:448) ä¸ºä»€ä¹ˆè¿™ä¹ˆå¹²ï¼Ÿå› ä¸ºé¦–å…ˆå¾—ç¡®è®¤ä¸‹è¿™ä¸ªå¼‚å¸¸æ˜¯æ€ä¹ˆæŠ›å‡ºæ¥çš„ï¼Œé€†å‘æ¨ï¼Œç›´æ¥çœ‹æºç ï¼Œå‘ç°ç›´æ¥æŠ›å‡ºå¼‚å¸¸ å†å¾€ä¸Šèµ° 1at org.apache.batik.bridge.SVGImageElementBridge.createRasterImageNode(SVGImageElementBridge.java:642) æ‰€ä»¥è¯´å› ä¸ºè¿™ä¸ªifæ¡ä»¶åˆ¤æ–­æˆç«‹ï¼Œå¯¼è‡´è¿›å…¥äº†è¿™ä¸ªå¼‚å¸¸é€»è¾‘ï¼Œåˆ¤æ–­çš„é€»è¾‘ä¹Ÿæ²¡å•¥å¥½è¯´çš„ï¼Œç°åœ¨çš„å…³é”®æ˜¯è¿™ä¸ªå‚æ•°å¯¹è±¡imgæ˜¯æ€ä¹ˆæ¥çš„ 1at org.apache.batik.bridge.SVGImageElementBridge.createImageGraphicsNode(SVGImageElementBridge.java:340) ç„¶åå°±ç¨å¾®æ¸…æ™°ä¸€ç‚¹äº†ï¼Œç›´æ¥å°†ç«åŠ›æ”¾åœ¨ä¸‹é¢çš„æ–¹æ³•ä¸­ 12345org.apache.batik.ext.awt.image.spi.ImageTagRegistry#readURL(java.io.InputStream, org.apache.batik.util.ParsedURL, org.apache.xmlgraphics.java2d.color.ICCColorSpaceWithIntent, boolean, boolean) åœ¨è¿™ä¸ªæ–¹æ³•å†…éƒ¨ï¼Œä¹Ÿæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå•æ­¥å¤šè°ƒå‡ æ¬¡ï¼Œå°±èƒ½å‘ç°å¼‚å¸¸çš„caseæ˜¯æ€ä¹ˆæ¥çš„äº†ï¼Œçœç•¥æ‰ä¸­é—´å„ç§å•æ­¥debugçš„è¿‡ç¨‹ï¼Œä¸‹é¢ç›´æ¥è¿›å…¥å…³é”®é“¾è·¯ 2. ç«åŠ›å…¨å¼€ï¼Œé—®é¢˜å®šä½1org.apache.batik.ext.awt.image.codec.imageio.AbstractImageIORegistryEntry é€šè¿‡ä¸Šé¢çš„ä¸€è·¯ä¹‹åï¼Œå‘ç°æœ€ç»ˆçš„å…³é”®å°±æ˜¯ä¸Šé¢è¿™ä¸ªæŠ½è±¡ç±»ï¼Œé¡ºå¸¦ä¹Ÿå¯ä»¥çœ‹ä¸‹è¿™ä¸ªæŠ½è±¡ç±»çš„å‡ ä¸ªå­ç±»ï¼Œæœ‰JPEGxxx, PNGxxx, TIFFxxxï¼Œç„¶åé—®é¢˜æ¥äº†ï¼Œéƒ½å·²ç»æœ‰ç›¸å…³å®ç°äº†ï¼Œæ‰€ä»¥pngè®²é“ç†åº”è¯¥æ˜¯ä¼šæ”¯æŒçš„æ‰å¯¹å§ï¼Œä½†å’Œå®é™…çš„è¡¨ç°å¤ªä¸ä¸€æ ·äº†å§ï¼Œæ‰€ä»¥æœ‰å¿…è¦æ’¸ä¸€æŠŠæºç äº† 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273public Filter handleStream(InputStream inIS, ParsedURL origURL, boolean needRawData) &#123; final DeferRable dr = new DeferRable(); final InputStream is = inIS; final String errCode; final Object [] errParam; if (origURL != null) &#123; errCode = ERR_URL_FORMAT_UNREADABLE; errParam = new Object[] &#123;getFormatName(), origURL&#125;; &#125; else &#123; errCode = ERR_STREAM_FORMAT_UNREADABLE; errParam = new Object[] &#123;getFormatName()&#125;; &#125; Thread t = new Thread() &#123; @Override public void run() &#123; Filter filt; try&#123; Iterator&lt;ImageReader&gt; iter = ImageIO.getImageReadersByMIMEType( getMimeTypes().get(0).toString()); if (!iter.hasNext()) &#123; throw new UnsupportedOperationException( \"No image reader for \" + getFormatName() + \" available!\"); &#125; ImageReader reader = iter.next(); ImageInputStream imageIn = ImageIO.createImageInputStream(is); reader.setInput(imageIn, true); int imageIndex = 0; dr.setBounds(new Rectangle2D.Double (0, 0, reader.getWidth(imageIndex), reader.getHeight(imageIndex))); CachableRed cr; //Naive approach possibly wasting lots of memory //and ignoring the gamma correction done by PNGRed :-( //Matches the code used by the former JPEGRegistryEntry, though. BufferedImage bi = reader.read(imageIndex); cr = GraphicsUtil.wrap(bi); cr = new Any2sRGBRed(cr); cr = new FormatRed(cr, GraphicsUtil.sRGB_Unpre); WritableRaster wr = (WritableRaster)cr.getData(); ColorModel cm = cr.getColorModel(); BufferedImage image = new BufferedImage (cm, wr, cm.isAlphaPremultiplied(), null); cr = GraphicsUtil.wrap(image); filt = new RedRable(cr); &#125; catch (IOException ioe) &#123; // Something bad happened here... filt = ImageTagRegistry.getBrokenLinkImage (AbstractImageIORegistryEntry.this, errCode, errParam); &#125; catch (ThreadDeath td) &#123; filt = ImageTagRegistry.getBrokenLinkImage (AbstractImageIORegistryEntry.this, errCode, errParam); dr.setSource(filt); throw td; &#125; catch (Throwable t) &#123; filt = ImageTagRegistry.getBrokenLinkImage (AbstractImageIORegistryEntry.this, errCode, errParam); &#125; dr.setSource(filt); &#125; &#125;; t.start(); return dr;&#125; çœ‹ä¸Šé¢çš„å®ç°æ˜¯ä¸€ä¸ªéå¸¸æœ‰æ„æ€çš„äº‹æƒ…ï¼Œ å¼€äº†ä¸€ä¸ªçº¿ç¨‹åšäº‹æƒ…ï¼Œè€Œä¸”ç›´æ¥å°±è¿”å›äº†ï¼Œç›¸å½“äºç»™äº†åˆ«äººä¸€ä¸ªå‚¨ç‰©ç®±çš„é’¥åŒ™ï¼Œè™½ç„¶ç°åœ¨å‚¨ç‰©ç®±æ˜¯ç©ºçš„ï¼Œä½†æ˜¯å›å¤´æˆ‘ä¼šå¡«æ»¡çš„ è¨€å½’æ­£ä¼ ï¼Œä¸»è¦çš„ä¸šåŠ¡é€»è¾‘å°±åœ¨è¿™ä¸ªçº¿ç¨‹é‡Œäº†ï¼Œæ ¸å¿ƒçš„å‡ è¡Œä»£ç å°±æ˜¯ 123456789101112// åŠ è½½å›¾ç‰‡ï¼Œè½¬ä¸ºBufferedImageå¯¹è±¡BufferedImage bi = reader.read(imageIndex);cr = GraphicsUtil.wrap(bi);// ä¸‹é¢å®ç°å¯¹å›¾ç‰‡çš„ARGBè¿›è¡Œä¿®æ”¹cr = new Any2sRGBRed(cr);cr = new FormatRed(cr, GraphicsUtil.sRGB_Unpre);WritableRaster wr = (WritableRaster)cr.getData();ColorModel cm = cr.getColorModel();BufferedImage image = new BufferedImage (cm, wr, cm.isAlphaPremultiplied(), null);cr = GraphicsUtil.wrap(image);filt = new RedRable(cr); debugä¸Šé¢çš„å‡ è¡Œä»£ç ï¼Œå‘ç°é—®é¢˜æ¯”è¾ƒæ˜æ˜¾äº†ï¼Œå°±æ˜¯è¿™ä¸ªå›¾ç‰‡çš„è½¬æ¢è·ªäº†ï¼Œè‡³äºä¸ºå•¥ï¼Ÿ javaçš„å›¾ç‰‡å„ç§è›‹ç–¼è‡³æï¼Œè¿™é‡Œé¢çš„é€»è¾‘ï¼ŒçœŸå¿ƒæä¸è¿›å»ï¼Œsoæ·±æŒ–åˆ°æ­¤ä¸ºæ­¢ III. å…¼å®¹é€»è¾‘é—®é¢˜å®šä½åˆ°äº†ï¼Œå½“ç„¶å°±æ˜¯æƒ³åŠæ³•æ¥ä¿®å¤äº†ï¼Œç®€å•æ¥è¯´ï¼Œéœ€è¦å…¼å®¹çš„å°±æ˜¯å›¾ç‰‡çš„ç±»å‹è½¬æ¢ä¸Šäº†ï¼Œç›´æ¥ç”¨åŸæ¥çš„å¯èƒ½ä¼šæŠ›å¼‚å¸¸ï¼Œæ‰€ä»¥åšäº†ä¸€ä¸ªç®€å•çš„å…¼å®¹é€»è¾‘ 12345678910111213141516if(bi.getType() == BufferedImage.TYPE_BYTE_INDEXED) &#123; BufferedImage image = new BufferedImage(bi.getWidth(), bi.getHeight(), BufferedImage.TYPE_INT_ARGB); Graphics2D g2d = image.createGraphics(); g2d.drawImage(bi, 0, 0, null); g2d.dispose(); cr = GraphicsUtil.wrap(image);&#125; else &#123; cr = GraphicsUtil.wrap(bi); cr = new Any2sRGBRed(cr); cr = new FormatRed(cr, GraphicsUtil.sRGB_Unpre); WritableRaster wr = (WritableRaster)cr.getData(); ColorModel cm = cr.getColorModel(); BufferedImage image = new BufferedImage (cm, wr, cm.isAlphaPremultiplied(), null); cr = GraphicsUtil.wrap(image);&#125; å†æ¬¡éªŒè¯ï¼Œok æ³¨æ„ï¼š ä¸€ä¸ªé—®é¢˜æ¥äº†ï¼Œä¸Šé¢çš„å…¼å®¹æ˜¯éœ€è¦ä¿®æ”¹æºç çš„ï¼Œæˆ‘ä»¬å¯ä»¥æ€ä¹ˆåŠï¼Ÿæœ‰å‡ ç§è§£å†³æ–¹æ³• çŒ¥çæ–¹æ³•ä¸€ï¼šdownä¸‹æºç ï¼Œä¿®æ”¹ç‰ˆæœ¬ï¼Œç„¶åä¼ åˆ°è‡ªå·±çš„ç§æœï¼Œä½¿ç”¨è‡ªå·±çš„vipåŒ… çŒ¥çæ–¹æ³•äºŒï¼šæŠŠ batik-codec å·¥ç¨‹åŸæ ·æ‹·è´åˆ°è‡ªå·±çš„é¡¹ç›®ä¸­ï¼Œå°±å¯ä»¥éšæ„çš„ä½¿ç”¨æ”¹äº† çŒ¥çæ–¹æ³•ä¸‰ï¼šå†™ä¸€ä¸ªå®Œå…¨ç›¸åŒçš„ç±»ï¼ˆåŒ…è·¯å¾„å®Œå…¨ç›¸åŒï¼‰ï¼Œç„¶åæ„é€ ä¸€ä¸ªè‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼ŒåŠ è½½è¿™ä¸ªè‡ªå·±çš„è¿™ä¸ªå…¼å®¹ç‰ˆæœ¬çš„ï¼Œæ›¿æ¢åŸæ¥çš„ï¼ˆæœªæµ‹è¯•ï¼Œä¸ç¡®å®šæ˜¯å¦èƒ½è¡Œï¼‰ è‡³äºæˆ‘çš„é€‰æ‹©ï¼Œå°±æ˜¯ä½¿ç”¨äº†çŒ¥çæ–¹æ³•äºŒ IV. å…¶ä»–å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è§£ä¸å…¨ï¼Œå¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ æ‰«æå…³æ³¨ï¼Œjavaåˆ†äº«","categories":[{"name":"BugFix","slug":"BugFix","permalink":"https://zbang.online/hexblog/categories/BugFix/"},{"name":"Java","slug":"BugFix/Java","permalink":"https://zbang.online/hexblog/categories/BugFix/Java/"},{"name":"Image","slug":"BugFix/Java/Image","permalink":"https://zbang.online/hexblog/categories/BugFix/Java/Image/"}],"tags":[{"name":"Bugfix","slug":"Bugfix","permalink":"https://zbang.online/hexblog/tags/Bugfix/"},{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"batik","slug":"batik","permalink":"https://zbang.online/hexblog/tags/batik/"},{"name":"Png","slug":"Png","permalink":"https://zbang.online/hexblog/tags/Png/"}],"keywords":[{"name":"BugFix","slug":"BugFix","permalink":"https://zbang.online/hexblog/categories/BugFix/"},{"name":"Java","slug":"BugFix/Java","permalink":"https://zbang.online/hexblog/categories/BugFix/Java/"},{"name":"Image","slug":"BugFix/Java/Image","permalink":"https://zbang.online/hexblog/categories/BugFix/Java/Image/"}]},{"title":"SpringMVCæ”¯æŒè·¨åŸŸçš„å‡ ç§å§¿åŠ¿","slug":"SpringMVCæ”¯æŒè·¨åŸŸçš„å‡ ç§å§¿åŠ¿","date":"2018-01-19T07:43:38.000Z","updated":"2018-01-18T12:30:56.242Z","comments":true,"path":"2018/01/19/SpringMVCæ”¯æŒè·¨åŸŸçš„å‡ ç§å§¿åŠ¿/","link":"","permalink":"https://zbang.online/hexblog/2018/01/19/SpringMVCæ”¯æŒè·¨åŸŸçš„å‡ ç§å§¿åŠ¿/","excerpt":"SpringMVCæ”¯æŒè·¨åŸŸçš„å‡ ç§å§¿åŠ¿ è·¨åŸŸå¥½åƒæ˜¯ä¸€ä¸ªå‰ç«¯çš„é—®é¢˜ï¼Œé€šå¸¸æ˜¯aåŸŸåä¸‹å‘båŸŸåçš„æœåŠ¡å‘èµ·è¯·æ±‚ï¼Œç„¶åå¤„äºæµè§ˆå™¨çš„å®‰å…¨åŸåˆ™ï¼Œè¢«æ‹¦æˆªäº†ï¼Œè€Œè¿™ç§åœºæ™¯ï¼Œåœ¨å®é™…çš„é¡¹ç›®ä¸­å¹¶ä¸å°‘è§ï¼Œé‚£ä¹ˆä½œä¸ºåç«¯å¯ä»¥æ€ä¹ˆå»æ”¯æŒè·¨åŸŸçš„caseå‘¢ï¼Ÿ åç«¯éœ€è¦æ”¯æŒè·¨åŸŸï¼Œä¸€ä¸ªæ˜¯æ”¯æŒjsonpè¯·æ±‚ï¼›è¿˜æœ‰ä¸€ä¸ªå°±æ˜¯è®¾ç½®responseHeaderä¸­crossOriginç­‰ç›¸å…³å‚æ•°","text":"SpringMVCæ”¯æŒè·¨åŸŸçš„å‡ ç§å§¿åŠ¿ è·¨åŸŸå¥½åƒæ˜¯ä¸€ä¸ªå‰ç«¯çš„é—®é¢˜ï¼Œé€šå¸¸æ˜¯aåŸŸåä¸‹å‘båŸŸåçš„æœåŠ¡å‘èµ·è¯·æ±‚ï¼Œç„¶åå¤„äºæµè§ˆå™¨çš„å®‰å…¨åŸåˆ™ï¼Œè¢«æ‹¦æˆªäº†ï¼Œè€Œè¿™ç§åœºæ™¯ï¼Œåœ¨å®é™…çš„é¡¹ç›®ä¸­å¹¶ä¸å°‘è§ï¼Œé‚£ä¹ˆä½œä¸ºåç«¯å¯ä»¥æ€ä¹ˆå»æ”¯æŒè·¨åŸŸçš„caseå‘¢ï¼Ÿ åç«¯éœ€è¦æ”¯æŒè·¨åŸŸï¼Œä¸€ä¸ªæ˜¯æ”¯æŒjsonpè¯·æ±‚ï¼›è¿˜æœ‰ä¸€ä¸ªå°±æ˜¯è®¾ç½®responseHeaderä¸­crossOriginç­‰ç›¸å…³å‚æ•° I. Jsonpçš„æ”¯æŒjsonpçš„è¯·æ±‚è¡¨ç°æ–¹å¼å°±æ˜¯urlé‡Œé¢ä¼šå¤šä¸€ä¸ªå‚æ•° callbackï¼Œä¸€èˆ¬å¦‚ä¸‹ 1callback=jQuery21105810685605043302_1516257942328 jsonpçš„è¿”å›ä¸ä¸€èˆ¬è°ƒç”¨æ–¹å¼çš„è¿”å›ä¹Ÿä¼šæœ‰ç‚¹åŒºåˆ«ï¼Œä¼šåœ¨å¤–é¢åŒ…è£…ä¸€å±‚ï¼Œå¦‚ 1jQuery21105810685605043302_1516257942328(...); springmvcä¸­ï¼Œjsonpçš„æ”¯æŒå´æ˜¯æ¯”è¾ƒç®€å•äº†ï¼Œä¸éœ€è¦å¯¹ç°æœ‰çš„æ¥å£è¿›è¡Œä»»ä½•å¤„ç†ï¼Œåªéœ€è¦åƒä¸‹é¢è¿™ä¹ˆç©å³å¯ 123456@ControllerAdvicepublic class JsonpAdvice extends AbstractJsonpResponseBodyAdvice &#123; public JsonpAdvice() &#123; super(\"callback\"); &#125;&#125; åˆ†æè¯´æ˜é¦–å…ˆæ˜¯åˆ©ç”¨äº†æ³¨è§£ @ControllerAdvice ï¼Œ è¿™ä¸ªæ³¨è§£åœ¨åé¢è¯´åˆ°çš„ç»Ÿä¸€å¼‚å¸¸å¤„ç†æ—¶ï¼Œä¹Ÿä¼šç”¨åˆ°ï¼Œä»å‘½åä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œå°±æ˜¯ä¸ºControlleræ·»åŠ ä¸€ä¸ªåˆ‡é¢ï¼Œç®€å•æ¥è®²ï¼Œå°±æ˜¯åœ¨ç›´æ¥è¿”å›æ•°æ®å‰ï¼Œå¯¹è¿”å›çš„ç»“æœåŒ…è£…ä¸€æŠŠï¼›ä»å®ç°ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œä¸»è¦çš„é€»è¾‘å°±åœ¨ AbstractJsonpResponseBodyAdvice é‡Œé¢ï¼Œæ‰€ä»¥æœ‰å¿…è¦çœ‹ä¸€ä¸‹è¿™ä¸ªä¸œè¥¿æ˜¯æ€ä¹ˆæ”¯æŒçš„äº† æ ¸å¿ƒçš„ä»£ç é€»è¾‘å°±æ˜¯ 123456789101112131415161718192021222324@Overrideprotected void beforeBodyWriteInternal(MappingJacksonValue bodyContainer, MediaType contentType, MethodParameter returnType, ServerHttpRequest request, ServerHttpResponse response) &#123; HttpServletRequest servletRequest = ((ServletServerHttpRequest) request).getServletRequest(); for (String name : this.jsonpQueryParamNames) &#123; String value = servletRequest.getParameter(name); if (value != null) &#123; if (!isValidJsonpQueryParam(value)) &#123; if (logger.isDebugEnabled()) &#123; logger.debug(\"Ignoring invalid jsonp parameter value: \" + value); &#125; continue; &#125; // ä¸‹é¢ä¸‰è¡Œæ˜¯ä¸»è¦çš„é€»è¾‘ MediaType contentTypeToUse = getContentType(contentType, request, response); response.getHeaders().setContentType(contentTypeToUse); bodyContainer.setJsonpFunction(value); break; &#125; &#125;&#125; ç›´æ¥çœ‹å¯èƒ½çœ‹ä¸å¤ªæ˜ç™½ç©¶ç«Ÿåšäº†ä»€ä¹ˆï¼Œå†™äº†ä¸ªæµ‹è¯•ï¼Œdebugä¸‹ç›¸å…³çš„å‚æ•°å¦‚ä¸‹ å³ï¼Œä¿®æ”¹è¿”å›çš„ content-type ä¸ºï¼š application/javascript è¿”å›çš„Containeré‡Œé¢è®¾ç½®äº†jsonpFunctionï¼Œä¸ºè¯·æ±‚å‚æ•°çš„valueï¼Œè‡³äºæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™å°è£…çš„è¿”å›ç»“æœå‘¢ï¼Ÿè¿™ä¸ªæœ‰å¾…åç»­è¡¥å…¨ II. æ”¯æŒcorsè·¨åŸŸ Cross-Origin Resource Sharingï¼ˆCORSï¼‰è·¨æ¥æºèµ„æºå…±äº«æ˜¯ä¸€ä»½æµè§ˆå™¨æŠ€æœ¯çš„è§„èŒƒï¼Œæä¾›äº† Web æœåŠ¡ä»ä¸åŒåŸŸä¼ æ¥æ²™ç›’è„šæœ¬çš„æ–¹æ³•ï¼Œä»¥é¿å¼€æµè§ˆå™¨çš„åŒæºç­–ç•¥ï¼Œæ˜¯ JSONP æ¨¡å¼çš„ç°ä»£ç‰ˆã€‚ä¸ JSONP ä¸åŒï¼ŒCORS é™¤äº† GET è¦æ±‚æ–¹æ³•ä»¥å¤–ä¹Ÿæ”¯æŒå…¶ä»–çš„ HTTP è¦æ±‚ 1. èƒŒæ™¯CORSèƒŒåçš„åŸºæœ¬æ€æƒ³æ˜¯ä½¿ç”¨è‡ªå®šä¹‰çš„HTTPå¤´éƒ¨å…è®¸æµè§ˆå™¨å’ŒæœåŠ¡å™¨ç›¸äº’äº†è§£å¯¹æ–¹ï¼Œä»è€Œå†³å®šè¯·æ±‚æˆ–å“åº”æˆåŠŸä¸å¦ æ‰€ä»¥é—®é¢˜å°±æ¥äº†ï¼Œå®‰å…¨å¦‚ä½•ä¿è¯ï¼Ÿ ä¸€èˆ¬è€Œè¨€ï¼Œä¸ºäº†é¿å…å¤¸ç«™ç‚¹æ”»å‡»(csrf)ï¼Œå¸¸è§çš„æ‰‹æ®µæ— éï¼š èº«ä»½æ ¡éªŒï¼ˆæ¯”å¦‚è¦æ±‚ç”¨æˆ·ç™»å½•ï¼‰ tokenéªŒè¯ ipç™½åå• æ¥æºrefereræ ¡éªŒ é¢‘ç‡é™åˆ¶ 2. å®ç°æ–¹å¼è¦æ”¯æŒcsrfï¼Œä¹Ÿæ¯”è¾ƒç®€å•äº†ï¼Œæ— éå°±æ˜¯è®¾ç½®ä¸‹responseHeaderäº†, ä¸€èˆ¬éœ€è¦è®¾ç½®ä»¥ä¸‹å‡ é¡¹ Access-Control-Allow-Origin: *; // å…è®¸çš„æ¥æº Access-Control-Allow-Methods: GET, POST, PUT, DELETE Access-Control-Allow-Credentials: true Access-Control-Allow-Headers: Content-Type Access-Control-Max-Age: 1800 //30 min æ‰€ä»¥å®ç°èµ·æ¥çš„æ–¹å¼å°±æ¯”è¾ƒå¤šäº†ï¼Œä¸€ä¸ªæ˜¯æ–°å¢ä¸€ä¸ªfilterï¼Œä¸»åŠ¨è®¾ç½®ä¸‹è¿”å›å¤´ï¼Œå½“ç„¶spring mvcæä¾›äº†æ›´å‹å¥½çš„æ–¹å¼äº† å¸¸è§çš„å‡ ç§æ‰‹æ®µå¦‚ä¸‹: a. xmlé…ç½®æ–¹å¼12345&lt;mvc:cors&gt; &lt;mvc:mapping path=\"/ajax/*\" allowed-origins=\"*\" max-age=\"3600\" /&gt;&lt;/mvc:cors&gt; b. æ³¨è§£æ–¹å¼åœ¨controlleræ–¹æ³•ä¸Šï¼Œæ·»åŠ ä¸‹é¢è¿™ä¸ªæ³¨è§£å³å¯ 12345@CrossOrigin(origins = \"*\")@RequestMapping(value = &#123;\"xx\"&#125;, method = &#123;RequestMethod.GET, RequestMethod.POST, RequestMethod.OPTIONS&#125;)public ResponseWrapper&lt;WxBaseResponse&gt; create(HttpServletRequest httpServletRequest) &#123;&#125; c. ç›´æ¥ä¿®æ”¹è¿”å›çš„responseHeader123response.setHeader(\"Access-Control-Allow-Origin\", request.getHeader(\"origin\"));response.setHeader(\"Access-Control-Allow-Methods\", \"*\");response.setHeader(\"Access-Control-Allow-Credentials\", \"true\"); III. å°ç»“ä¸Šé¢ä»‹ç»äº†ä¸¤ç§æ–¹å¼ï¼Œæ”¯æŒèµ·æ¥éƒ½æ¯”è¾ƒç®€å• jsonp: é€šè¿‡ControllerAdviceæ‹¦æˆªControllerï¼Œç„¶åç»§æ‰¿AbstractJsonpResponseBodyAdviceå³å¯ cors: é€šè¿‡xmlé…ç½®æˆ–è€…ç›´æ¥ä½¿ç”¨ @CrossOriginæ³¨è§£ IV. å…¶ä»–å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è§£ä¸å…¨ï¼Œå¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ æ‰«æå…³æ³¨ï¼Œjavaåˆ†äº«","categories":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"Spring","slug":"Java/Spring","permalink":"https://zbang.online/hexblog/categories/Java/Spring/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"Spring","slug":"Spring","permalink":"https://zbang.online/hexblog/tags/Spring/"},{"name":"Jsonp","slug":"Jsonp","permalink":"https://zbang.online/hexblog/tags/Jsonp/"},{"name":"CORS","slug":"CORS","permalink":"https://zbang.online/hexblog/tags/CORS/"}],"keywords":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"Spring","slug":"Java/Spring","permalink":"https://zbang.online/hexblog/categories/Java/Spring/"}]},{"title":"SpringMVCè¿”å›å›¾ç‰‡çš„å‡ ç§æ–¹å¼","slug":"SpringMVCè¿”å›å›¾ç‰‡çš„å‡ ç§æ–¹å¼","date":"2018-01-18T03:13:22.000Z","updated":"2018-01-18T03:24:32.127Z","comments":true,"path":"2018/01/18/SpringMVCè¿”å›å›¾ç‰‡çš„å‡ ç§æ–¹å¼/","link":"","permalink":"https://zbang.online/hexblog/2018/01/18/SpringMVCè¿”å›å›¾ç‰‡çš„å‡ ç§æ–¹å¼/","excerpt":"SpringMVCè¿”å›å›¾ç‰‡çš„å‡ ç§æ–¹å¼ åç«¯æä¾›æœåŠ¡ï¼Œé€šå¸¸è¿”å›çš„jsonä¸²ï¼Œä½†æ˜¯æŸäº›åœºæ™¯ä¸‹å¯èƒ½éœ€è¦ç›´æ¥è¿”å›äºŒè¿›åˆ¶æµï¼Œå¦‚ä¸€ä¸ªå›¾ç‰‡ç¼–è¾‘æ¥å£ï¼Œå¸Œæœ›ç›´æ¥å°†å›¾ç‰‡æµè¿”å›ç»™å‰ç«¯ï¼›å¦‚æœè¦æ±‚è¿”å›base64ï¼Œæ­¤æ—¶å¯ä»¥æ€ä¹ˆå¤„ç†ï¼Ÿ","text":"SpringMVCè¿”å›å›¾ç‰‡çš„å‡ ç§æ–¹å¼ åç«¯æä¾›æœåŠ¡ï¼Œé€šå¸¸è¿”å›çš„jsonä¸²ï¼Œä½†æ˜¯æŸäº›åœºæ™¯ä¸‹å¯èƒ½éœ€è¦ç›´æ¥è¿”å›äºŒè¿›åˆ¶æµï¼Œå¦‚ä¸€ä¸ªå›¾ç‰‡ç¼–è¾‘æ¥å£ï¼Œå¸Œæœ›ç›´æ¥å°†å›¾ç‰‡æµè¿”å›ç»™å‰ç«¯ï¼›å¦‚æœè¦æ±‚è¿”å›base64ï¼Œæ­¤æ—¶å¯ä»¥æ€ä¹ˆå¤„ç†ï¼Ÿ I. è¿”å›äºŒè¿›åˆ¶å›¾ç‰‡ä¸»è¦å€ŸåŠ©çš„æ˜¯ HttpServletResponseè¿™ä¸ªå¯¹è±¡ï¼Œå®ç°caseå¦‚ä¸‹ 1234567891011121314@RequestMapping(value = &#123;\"/img/render\"&#125;, method = &#123;RequestMethod.GET, RequestMethod.POST, RequestMethod.OPTIONS&#125;)@CrossOrigin(origins = \"*\")@ResponseBodypublic String execute(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse) &#123; // imgä¸ºå›¾ç‰‡çš„äºŒè¿›åˆ¶æµ byte[] img = xxx; httpServletResponse.setContentType(\"image/png\"); OutputStream os = httpServletResponse.getOutputStream(); os.write(img); os.flush(); os.close(); return \"success\";&#125; æ³¨æ„äº‹é¡¹ æ³¨æ„ContentTypeå®šä¹‰äº†å›¾ç‰‡ç±»å‹ å°†äºŒè¿›åˆ¶å†™å…¥ httpServletResponse#getOutputStream å†™å®Œä¹‹åï¼Œflush(), close()è¯·åŠ¡å¿…æ‰§è¡Œä¸€æ¬¡ II. è¿”å›å›¾ç‰‡çš„å‡ ç§æ–¹å¼å°è£…ä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªåç«¯æä¾›çš„æœåŠ¡æ¥å£ï¼Œå¾€å¾€æ˜¯è¿”å›jsonæ•°æ®çš„å±…å¤šï¼Œå‰é¢æåˆ°äº†ç›´æ¥è¿”å›å›¾ç‰‡çš„åœºæ™¯ï¼Œé‚£ä¹ˆå¸¸è§çš„è¿”å›å›¾ç‰‡æœ‰å“ªäº›æ–¹å¼å‘¢ï¼Ÿ è¿”å›å›¾ç‰‡çš„httpåœ°å€ è¿”å›base64æ ¼å¼çš„å›¾ç‰‡ ç›´æ¥è¿”å›äºŒè¿›åˆ¶çš„å›¾ç‰‡ å…¶ä»–â€¦ï¼ˆæˆ‘å°±è§è¿‡ä¸Šé¢ä¸‰ç§ï¼Œåˆ«çš„è¿˜çœŸä¸çŸ¥é“ï¼‰ é‚£ä¹ˆæˆ‘ä»¬æä¾›çš„ä¸€ä¸ªControllerï¼Œåº”è¯¥å¦‚ä½•åŒæ—¶æ”¯æŒä¸Šé¢è¿™ä¸‰ç§ä½¿ç”¨å§¿åŠ¿å‘¢ï¼Ÿ 1. beanå®šä¹‰å› ä¸ºæœ‰å‡ ç§ä¸åŒçš„è¿”å›æ–¹å¼ï¼Œè‡³äºè¯¥é€‰æ‹©å“ªä¸€ä¸ªï¼Œå½“ç„¶æ˜¯ç”±å‰ç«¯æ¥æŒ‡å®šäº†ï¼Œæ‰€ä»¥ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªè¯·æ±‚å‚æ•°çš„beanå¯¹è±¡ 123456789101112131415161718192021222324252627282930@Datapublic class BaseRequest &#123; private static final long serialVersionUID = 1146303518394712013L; /** * è¾“å‡ºå›¾ç‰‡æ–¹å¼: * * url : httpåœ°å€ ï¼ˆé»˜è®¤æ–¹å¼ï¼‰ * base64 : base64ç¼–ç  * stream : ç›´æ¥è¿”å›å›¾ç‰‡ * */ private String outType; /** * è¿”å›å›¾ç‰‡çš„ç±»å‹ * jpg | png | webp | gif */ private String mediaType; public ReturnTypeEnum returnType() &#123; return ReturnTypeEnum.getEnum(outType); &#125; public MediaTypeEnum mediaType() &#123; return MediaTypeEnum.getEnum(mediaType); &#125;&#125; ä¸ºäº†ç®€åŒ–åˆ¤æ–­ï¼Œå®šä¹‰äº†ä¸¤ä¸ªæ³¨è§£ï¼Œä¸€ä¸ªReturnTypeEnum, ä¸€ä¸ª MediaTypeEnumï¼Œ å½“ç„¶å¿…è¦æ€§ä¸æ˜¯ç‰¹åˆ«å¤§ï¼Œä¸‹é¢æ˜¯ä¸¤è€…çš„å®šä¹‰ 12345678910111213141516171819202122232425262728293031public enum ReturnTypeEnum &#123; URL(\"url\"), STREAM(\"stream\"), BASE64(\"base\"); private String type; ReturnTypeEnum(String type) &#123; this.type = type; &#125; private static Map&lt;String, ReturnTypeEnum&gt; map; static &#123; map = new HashMap&lt;&gt;(3); for(ReturnTypeEnum e: ReturnTypeEnum.values()) &#123; map.put(e.type, e); &#125; &#125; public static ReturnTypeEnum getEnum(String type) &#123; if (type == null) &#123; return URL; &#125; ReturnTypeEnum e = map.get(type.toLowerCase()); return e == null ? URL : e; &#125;&#125; 12345678910111213141516171819202122232425262728293031323334353637@Datapublic enum MediaTypeEnum &#123; ImageJpg(\"jpg\", \"image/jpeg\", \"FFD8FF\"), ImageGif(\"gif\", \"image/gif\", \"47494638\"), ImagePng(\"png\", \"image/png\", \"89504E47\"), ImageWebp(\"webp\", \"image/webp\", \"52494646\"), private final String ext; private final String mime; private final String magic; MediaTypeEnum(String ext, String mime, String magic) &#123; this.ext = ext; this.mime = mime; this.magic = magic; &#125; private static Map&lt;String, MediaTypeEnum&gt; map; static &#123; map = new HashMap&lt;&gt;(4); for (MediaTypeEnum e: values()) &#123; map.put(e.getExt(), e); &#125; &#125; public static MediaTypeEnum getEnum(String type) &#123; if (type == null) &#123; return ImageJpg; &#125; MediaTypeEnum e = map.get(type.toLowerCase()); return e == null ? ImageJpg : e; &#125;&#125; ä¸Šé¢æ˜¯è¯·æ±‚å‚æ•°å°è£…çš„beanï¼Œè¿”å›å½“ç„¶ä¹Ÿæœ‰ä¸€ä¸ªå¯¹åº”çš„bean 1234567891011121314151617181920@Datapublic class BaseResponse &#123; /** * è¿”å›å›¾ç‰‡çš„ç›¸å¯¹è·¯å¾„ */ private String path; /** * è¿”å›å›¾ç‰‡çš„httpsæ ¼å¼ */ private String url; /** * base64æ ¼å¼çš„å›¾ç‰‡ */ private String base;&#125; è¯´æ˜ï¼š å®é™…çš„é¡¹ç›®ç¯å¢ƒä¸­ï¼Œè¯·æ±‚å‚æ•°å’Œè¿”å›è‚¯å®šä¸ä¼šåƒä¸Šé¢è¿™ä¹ˆç®€å•ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ç»§æ‰¿ä¸Šé¢çš„beanæˆ–è€…è‡ªå·±å®šä¹‰å¯¹åº”çš„æ ¼å¼æ¥å®ç° 2. è¿”å›çš„å°è£…æ–¹å¼æ—¢ç„¶ç›®æ ‡æ˜ç¡®ï¼Œå°è£…å¯ç®—æ˜¯è¿™ä¸ªé‡Œé¢æœ€æ¸…æ™°çš„ä¸€ä¸ªæ­¥éª¤äº† 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758protected void buildResponse(BaseRequest request, BaseResponse response, byte[] bytes) throws SelfError &#123; switch (request.returnType()) &#123; case URL: upload(bytes, response); break; case BASE64: base64(bytes, response); break; case STREAM: stream(bytes, request); &#125;&#125;private void upload(byte[] bytes, BaseResponse response) throws SelfError &#123; try &#123; // ä¸Šä¼ åˆ°å›¾ç‰‡æœåŠ¡å™¨ï¼Œæ ¹æ®å„è‡ªçš„å®é™…æƒ…å†µè¿›è¡Œæ›¿æ¢ String path = UploadUtil.upload(bytes); if (StringUtils.isBlank(path)) &#123; // ä¸Šä¼ å¤±è´¥ throw new InternalError(null); &#125; response.setPath(path); response.setUrl(CdnUtil.img(path)); &#125; catch (IOException e) &#123; // cdnå¼‚å¸¸ log.error(\"upload to cdn error! e:&#123;&#125;\", e); throw new CDNUploadError(e.getMessage()); &#125;&#125;// è¿”å›base64private void base64(byte[] bytes, BaseResponse response) &#123; String base = Base64.getEncoder().encodeToString(bytes); response.setBase(base);&#125;// è¿”å›äºŒè¿›åˆ¶å›¾ç‰‡private void stream(byte[] bytes, BaseRequest request) throws SelfError &#123; try &#123; MediaTypeEnum mediaType = request.mediaType(); HttpServletResponse servletResponse = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getResponse(); servletResponse.setContentType(mediaType.getMime()); OutputStream os = servletResponse.getOutputStream(); os.write(bytes); os.flush(); os.close(); &#125; catch (Exception e) &#123; log.error(\"general return stream img error! req: &#123;&#125;, e:&#123;&#125;\", request, e); if (StringUtils.isNotBlank(e.getMessage())) &#123; throw new InternalError(e.getMessage()); &#125; else &#123; throw new InternalError(null); &#125; &#125;&#125; è¯´æ˜ï¼š è¯·æ— è§†ä¸Šé¢çš„å‡ ä¸ªè‡ªå®šä¹‰å¼‚å¸¸æ–¹å¼ï¼Œéœ€è¦ä½¿ç”¨æ—¶ï¼Œå®Œå…¨å¯ä»¥å¹²æ‰è¿™äº›è‡ªå®šä¹‰å¼‚å¸¸å³å¯ï¼›è¿™é‡Œç®€å•è¯´ä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆä¼šåœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨è¿™ç§è‡ªå®šä¹‰å¼‚å¸¸çš„æ–¹å¼ï¼Œä¸»è¦æ˜¯æœ‰ä»¥ä¸‹å‡ ä¸ªä¼˜ç‚¹ é…åˆå…¨å±€å¼‚å¸¸æ•è·(ControllerAdvie)ï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ç®€å• æ‰€æœ‰çš„å¼‚å¸¸é›†ä¸­å¤„ç†ï¼Œæ–¹ä¾¿ä¿¡æ¯ç»Ÿè®¡å’ŒæŠ¥è­¦ 1å¦‚ï¼Œåœ¨ç»Ÿä¸€çš„åœ°æ–¹è¿›è¡Œå¼‚å¸¸è®¡æ•°ï¼Œç„¶åè¶…è¿‡æŸä¸ªé˜€å€¼ä¹‹åï¼ŒæŠ¥è­¦ç»™è´Ÿè´£äººï¼Œè¿™æ ·å°±ä¸éœ€è¦åœ¨æ¯ä¸ªå‡ºç°å¼‚å¸¸caseçš„åœ°æ–¹æ¥ä¸»åŠ¨åŸ‹ç‚¹äº† é¿å…é”™è¯¯çŠ¶æ€ç çš„å±‚å±‚ä¼ é€’ 12- è¿™ä¸ªä¸»è¦é’ˆå¯¹webæœåŠ¡ï¼Œä¸€èˆ¬æ˜¯åœ¨è¿”å›çš„jsonä¸²ä¸­ï¼Œä¼šåŒ…å«å¯¹åº”çš„é”™è¯¯çŠ¶æ€ç ï¼Œé”™è¯¯ä¿¡æ¯- è€Œå¼‚å¸¸caseæ˜¯å¯èƒ½å‡ºç°åœ¨ä»»ä½•åœ°æ–¹çš„ï¼Œä¸ºäº†ä¿æŒè¿™ä¸ªå¼‚å¸¸ä¿¡æ¯ï¼Œè¦ä¹ˆå°†è¿™äº›æ•°æ®å±‚å±‚ä¼ é€’åˆ°controllerï¼›è¦ä¹ˆå°±æ˜¯å­˜åœ¨ThreadLocalä¸­ï¼›æ˜¾ç„¶è¿™ä¸¤ç§æ–¹å¼éƒ½æ²¡æœ‰æŠ›å¼‚å¸¸çš„ä½¿ç”¨æ–¹ä¾¿ æœ‰ä¼˜ç‚¹å½“ç„¶å°±æœ‰ç¼ºç‚¹äº†ï¼š å¼‚å¸¸æ–¹å¼ï¼Œé¢å¤–çš„æ€§èƒ½å¼€é”€ï¼Œæ‰€ä»¥åœ¨è‡ªå®šä¹‰å¼‚å¸¸ä¸­ï¼Œæˆ‘éƒ½è¦†ç›–äº†ä¸‹é¢è¿™ä¸ªæ–¹æ³•ï¼Œä¸è¦å®Œæ•´çš„å †æ ˆ 1234@Overridepublic synchronized Throwable fillInStackTrace() &#123; return this;&#125; ç¼–ç ä¹ æƒ¯é—®é¢˜ï¼Œæœ‰äº›äººå¯èƒ½å°±éå¸¸ä¸å–œæ¬¢è¿™ç§ä½¿ç”¨æ–¹å¼ III. é¡¹ç›®ç›¸å…³åªè¯´ä¸ç»ƒå¥½åƒæ²¡ä»€ä¹ˆæ„æ€ï¼Œä¸Šé¢çš„è¿™ä¸ªè®¾è®¡ï¼Œå®Œå…¨ä½“ç°åœ¨äº†æˆ‘ä¸€ç›´ç»´æŠ¤çš„å¼€æºé¡¹ç›® Quick-Mediaä¸­ï¼Œå½“ç„¶å®é™…å’Œä¸Šé¢æœ‰ä¸€äº›ä¸åŒï¼Œæ¯•ç«Ÿä¸ä¸šåŠ¡ç›¸å…³è¾ƒå¤§ï¼Œæœ‰å…´è¶£çš„å¯ä»¥å‚è€ƒ QuickMedia: https://github.com/liuyueyi/quick-media : BaseAction: com.hust.hui.quickmedia.web.wxapi.WxBaseAction#buildReturn IV. å…¶ä»–å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è§£ä¸å…¨ï¼Œå¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ æ‰«æå…³æ³¨ï¼Œjavaåˆ†äº«","categories":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"Spring","slug":"Java/Spring","permalink":"https://zbang.online/hexblog/categories/Java/Spring/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"Spring","slug":"Spring","permalink":"https://zbang.online/hexblog/tags/Spring/"},{"name":"Response","slug":"Response","permalink":"https://zbang.online/hexblog/tags/Response/"}],"keywords":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"Spring","slug":"Java/Spring","permalink":"https://zbang.online/hexblog/categories/Java/Spring/"}]},{"title":"2017å¹´å…¨å¹´å›é¡¾å°ç»“","slug":"2017å¹´å…¨å¹´å›é¡¾å°ç»“","date":"2018-01-17T12:23:52.000Z","updated":"2018-01-17T12:35:08.800Z","comments":true,"path":"2018/01/17/2017å¹´å…¨å¹´å›é¡¾å°ç»“/","link":"","permalink":"https://zbang.online/hexblog/2018/01/17/2017å¹´å…¨å¹´å›é¡¾å°ç»“/","excerpt":"ä¸€æœˆéƒ½è¿‡äº†å¿«ä¸€åŠäº†ï¼Œç°åœ¨å†™17å¹´çš„æ€»ç»“ç¡®å®æœ‰ç‚¹å°æ™šï¼Œä¹‹å‰å°±å‡†å¤‡å¥½å¥½çš„å†™ä¸€ä¸‹çš„ï¼Œå´æ˜¯å› ä¸ºå„ç§çç¢çš„äº‹æƒ…è€½æäº†ï¼Œå¥½åœ¨æœ€è¿‘æ¸…é—²äº†ä¸å°‘ï¼ŒåŸºæœ¬ä¸Šæ²¡å•¥äº‹æƒ…å¯åšï¼Œå¹²è„†å¥½å¥½çš„æ€»ç»“ä¸‹17å¹´çš„å·¥ä½œç”Ÿæ´»å§ã€‚","text":"ä¸€æœˆéƒ½è¿‡äº†å¿«ä¸€åŠäº†ï¼Œç°åœ¨å†™17å¹´çš„æ€»ç»“ç¡®å®æœ‰ç‚¹å°æ™šï¼Œä¹‹å‰å°±å‡†å¤‡å¥½å¥½çš„å†™ä¸€ä¸‹çš„ï¼Œå´æ˜¯å› ä¸ºå„ç§çç¢çš„äº‹æƒ…è€½æäº†ï¼Œå¥½åœ¨æœ€è¿‘æ¸…é—²äº†ä¸å°‘ï¼ŒåŸºæœ¬ä¸Šæ²¡å•¥äº‹æƒ…å¯åšï¼Œå¹²è„†å¥½å¥½çš„æ€»ç»“ä¸‹17å¹´çš„å·¥ä½œç”Ÿæ´»å§ã€‚ 15å¹´å¼€å§‹å·¥ä½œï¼Œ17å¹´å‘¢ï¼Œä¸å†æ˜¯èŒåœºæ–°äººï¼Œä½†æ˜¯è¯´åˆ°è€é¸Ÿï¼Œå´ä¹Ÿç›¸å·®ç”šè¿œï¼Œå·¥ä½œçš„ç¬¬äºŒä¸ªå¹´åº¦ï¼Œæ€»æ„Ÿè§‰æœ‰äº›ä¸æ¸©ä¸ç«çš„ï¼Œä»”ç»†çœ‹çœ‹è¿™ä¸€å¹´ï¼Œå°è¯•äº†å¾ˆå¤šä¸œè¥¿ï¼Œä¹Ÿåšäº†ä¸€äº›äº‹æƒ…ï¼Œä½†æ€»çš„æ¥è¯´ï¼Œä¾ç„¶æ˜¯è¾¾ä¸åˆ°é¢„æœŸã€‚ ä¸€ä¸ªæ¯”è¾ƒå¥½çš„åšæŒä¸‹å»çš„ä¹ æƒ¯å°±æ˜¯æ¯å‘¨ä¸€æ¬¡çš„é”»ç‚¼ï¼Œè™½ç„¶æ˜¯å› ä¸ºå°å›¢é˜Ÿå†…çš„è¦æ±‚ï¼Œä¸è¾¾æ ‡å°±ç½šæ¬¾çš„å‰æå®šåœ¨è¿™ï¼Œæ‰€ä»¥åŠªåŠ›çš„åšæŒäº†ä¸‹æ¥ï¼Œè¿˜æ˜¯å€¼å¾—è¡¨æ‰¬çš„ã€‚å”¯ä¸€å’Œé¢„æœŸä¸ä¸€è‡´çš„å°±æ˜¯é”»ç‚¼çš„æ•ˆæœå¥½åƒä¸å¤ªæ˜æ˜¾ï¼Œæ¯”å»å»å¹´ï¼Œä½“é‡ç¡®å®åˆå¢åŠ äº†ä¸å°‘ã€‚ä»å·¥ä½œæ¥ï¼Œä½“é‡å¯ç®—æ˜¯ç®—ç€å·¥ä½œæ—¶é•¿çº¿æ€§å¢åŠ ï¼Œæœ‰ç‚¹å¯æ€•ï¼Œæ„Ÿè§‰å†è¿™ä¹ˆä¸‹å»ï¼Œå°±æ²¡æ³•ç©äº†ã€‚åšæŒé”»ç‚¼ï¼ŒåŠªåŠ›è¿åŠ¨ï¼Œå¥åº·ç”Ÿæ´»ï¼Œä¾ç„¶æ˜¯18å¹´éœ€è¦å»ç»´æŒçš„äº‹æƒ…ï¼›æ­¤å¤–ä¹Ÿæœ‰å¿…è¦ï¼Œå¢åŠ ä¸‹è¿åŠ¨çš„ç±»å‹ï¼Œé™¤äº†è·‘æ­¥ã€éª‘è½¦ï¼Œè¿˜æœ‰é‚£ä¹ˆå¤šå¯ä»¥å»å°è¯•çš„æ´»åŠ¨ï¼Œæœ‰å¿…è¦å»æ¢ç´¢ä¸€ä¸‹ã€‚ 17å¹´ï¼Œä¸ä¹‹å‰é‚£ä¹ˆå¤šå¹´ï¼Œæœ€ä¸åŒçš„æœ‰ä¸¤ä»¶äº‹ï¼Œä¸€ä¸ªæ˜¯å…¥äº†ç‹è€…è£è€€çš„å‘ã€å˜æˆäº†ä¸€ä¸ªæ‰‹æ¸¸çˆ±å¥½è€…ï¼›è¿˜æœ‰ä¸€ä¸ªå°±æ˜¯å†™åšå®¢ï¼Œæ¯å‘¨æœ€å°‘ä¸€ç¯‡åšæ–‡ã€‚ç„¶åè¿™ä¸€å¹´çš„å¸¸æ€å°±å˜æˆäº†æ¯å¤©æ™šä¸ŠæŠ±ç€æ‰‹æœºç©æ¸¸æˆï¼Œæ¯ä¸ªå‘¨æœ«è·‘åˆ°å…¬å¸å­å“§å­å“§çš„å†™åšæ–‡ï¼ˆå½“ç„¶æœ‰ä¸å°‘æ—¶å€™æ˜¯ä¸ºäº†å†™è€Œå†™ï¼Œæ‰€ä»¥æœ‰äº›å†…å®¹æ¯”è¾ƒéš¾å…¥çœ¼ï¼‰ã€‚è¿™ä¸¤ä»¶äº‹æƒ…ï¼Œåˆ™æœ‰å¿…è¦å¥½å¥½çš„è°ˆä¸€ä¸‹äº†ã€‚ é¦–å…ˆæ˜¯ç©æ¸¸æˆè¿™ä¸ªï¼Œä¹‹å‰ä¸æ€ä¹ˆç©ï¼ŒæŒºæµªè´¹æ—¶é—´çš„ï¼Œè€Œä¸”ä¹Ÿæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«æœ‰æ„æ€çš„ï¼Œä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™å¼€å§‹æ¥è§¦å†œè¯ï¼ŒæœŸé—´å¸è½½äº†åˆé‡è£…äº†næ¬¡ï¼Œç°åœ¨æ°´å¹³ä¾ç„¶å¾ˆçƒ‚ï¼Œä»”ç»†æƒ³äº†æƒ³è‡ªå·±ï¼Œå¯¹äºç©æ¸¸æˆæœ‰ä¸ªå¥‡æ€ªçš„åœ°æ–¹ï¼Œä¸æ„¿æ„å»ç ”ç©¶ï¼Œåˆ°ç°åœ¨ç©è€äº†å¤§åŠå¹´ï¼Œä¾ç„¶ä¸çŸ¥é“è£…å¤‡æ€ä¹ˆå‡ºï¼Œä¸çŸ¥é“é“­æ–‡æ€ä¹ˆç»„åˆï¼Œåæ­£éƒ½æ˜¯éšæ„ç©ï¼Œä¸ç®¡ä»€ä¹ˆåœºæ™¯ï¼Œé¡ºé£é€†é£ï¼Œéƒ½æ˜¯é‚£ä¹ˆä¸€å¥—ç©æ³•ï¼Œç©æ¥ç©å»ä¹Ÿå°±æ˜¯é‚£ä¸€ä¸ªè‹±é›„ï¼ˆèŠˆæœˆï¼‰ï¼›ä¸€èµ·ç©çš„å°ä¼™ä¼´å·²ç»è£å‡æ˜Ÿæ›œï¼Œè€Œæˆ‘ä¾ç„¶åœ¨é»„é‡‘ç™½é“¶å¾˜å¾Šï¼Œç®€ç›´äº†ã€‚å…¶å®ä»è¿™ä¸ªç©æ¸¸æˆçš„çŠ¶æ€ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œæˆ‘å±äºé‚£ç§ä¸€æ—¦ç†Ÿæ‚‰äº†æŸç§äº‹åŠ¡ä¹‹åï¼Œä¸å¤ªæ„¿æ„å»æ›´æ”¹ã€å»å˜åŠ¨çš„æ€§æ ¼ï¼ˆæ€»æ˜¯ç©ä¸€ä¸ªè‹±é›„ï¼‰ï¼Œä¸»åŠ¨ä¸“ç ”èƒ½åŠ›ä¸å¤Ÿï¼ˆä¸çœ‹æ•™ç¨‹ï¼Œä¸çœ‹è§†é¢‘â€¦ï¼‰ï¼Œè„¾æ°”è¿˜ä¸é”™ï¼ˆè¢«å‘äº†ä¹Ÿä¸éª‚äººï¼‰,è¿˜æœ‰å°±æ˜¯å®šåŠ›ä¸è¶³ï¼ˆå¤šæ¬¡å¸è½½æ¸¸æˆåˆé‡è£…ï¼‰; (å†æ¬¡ä¸å¾—ä¸è¯´ä¸€å¥ï¼Œæ„Ÿè°¢æ¸©æŸ”æ¼‚äº®çš„ç¾äººå§£ï¼Œéå¸¸ç†æ€§çš„å¯¹å¾…æˆ‘ç©æ¸¸æˆè¿™ä¸€ç‚¹ï¼‰ å¦ä¸€ä¸ªå°±æ˜¯å†™åšæ–‡äº†ï¼Œè¿™ä¸€å¹´çš„å†™ä½œï¼Œæ„Ÿè§‰æ¯”æˆ‘ä¸Šå¤§å­¦ä¹‹åå†™çš„ä¸œè¥¿éƒ½è¦å¤šäº†ï¼Œå·®ä¸å¤šæœ‰å…«ä¹åç¯‡çš„æ ·å­äº†ï¼Œä¹‹å‰æŠ½ç©ºæ•´ç†äº†ä¸ªgitbookï¼ŒæŒ‚åœ¨äº†ç§äººæœåŠ¡å™¨ä¸Š: å°ç°ç°åšæ–‡Bookã€‚å†™åšæ–‡çš„æ”¶è·å…¶å®æŒºå¤§çš„ï¼Œå¾ˆå¤šæ—¶å€™å¯¹äºä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œå¦‚æœä¸å°è¯•ç€å»åƒå…¶ä»–äººåˆ†äº«ï¼Œä½ éƒ½ä¸çŸ¥é“ä½ åˆ°åº•æŒæ¡åˆ°ä»€ä¹ˆç¨‹åº¦äº†ã€‚è€Œä¸”å¦‚ä½•æ‰èƒ½å†™å‡ºä¸€ä¸ªæ¼‚äº®çš„åšæ–‡ï¼ŒçœŸçš„æ²¡é‚£ä¹ˆç®€å•ï¼Œè¿™ä¸€å¹´çœ‹äº†ä¸å°‘ï¼Œæœ‰è§è¿‡å†™çš„ç‰¹åˆ«æ¼‚äº®çš„ï¼Œä¹Ÿçœ‹è¿‡å†™çš„ä¸çŸ¥é“ä»€ä¹ˆé¬¼çš„ä¸œè¥¿ï¼Œå½“ç„¶ç°åœ¨æˆ‘è‡ªå·±æ°´å¹³ä¹Ÿä¸æ€ä¹ˆæ ·ï¼Œä½†å¯¹æ¯”ä¸‹å‰åçš„è´¨é‡ï¼Œå‘ç°è¿˜æ˜¯æœ‰é•¿è¿›çš„ã€‚å¾ˆå¤šä¸œè¥¿å†™ç€å†™ç€ï¼Œä¼šå¿½ç„¶å‘ç°ä¸€äº›å¹³æ—¶æ²¡æœ‰æ³¨æ„çš„ç‚¹ã€‚åœ¨è¿™ä¸€å—ï¼Œæ„Ÿè§‰æœ€ä¸»è¦çš„å°±æ˜¯å‹¤äºæ€»ç»“ï¼Œå–„äºæ€è€ƒäº†ã€‚18å¹´ï¼Œè¿™ä¸ªåšæŒè¿˜æ˜¯å¾—ç»§ç»­ä¸‹å»çš„ã€‚å› ä¸ºå†™åšæ–‡ï¼Œå½“ç„¶ä¸ºäº†é¿å…ç©å•æœºï¼Œå¼€é€šäº†å¤´æ¡å·å’Œå…¬ä¼—å·, ä¸‹é¢æ˜¯é“¾æ¥ï¼Œæ¬¢è¿å…³æ³¨ è°ˆåˆ°å…¬ä¼—å·ï¼Œå°±æœ‰å¿…è¦è¯´ä¸€ä¸‹ä¸ä¹‹ç›¸å…³çš„å°ç¨‹åºäº†ï¼Œå°ç¨‹åºå¤§ç«çš„æ—¶å€™ï¼Œä¹Ÿè¿›æ¥ç©äº†ä¸€ä¸‹ï¼Œåšäº†ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯ã€Šå¤è¯—é€‰ã€‹ï¼Œæ¯å¤©ä¼šæ¨é€åæ¡å¤è¯—ï¼Œè€Œä¸”å¯ä»¥æ ¹æ®å…³é”®è¯æœç´¢ç›¸å…³å¤è¯—çš„å°ç¨‹åºï¼Œæ„Ÿè§‰è¿˜è›®æœ‰æ„æ€çš„ï¼Œç»“æœç­‰åšå®Œä¹‹åï¼Œå‘Šè¯‰ç±»ç›®ä¸å¯¹ä¸ªäººå¼€æ”¾ï¼Œç®€ç›´äº†â€¦ï¼›ç„¶åå¼€å§‹åšç¬¬äºŒä¸ªäº†ï¼Œè¿™ä¸ªçº¯ç²¹æ˜¯ä¸ºäº†å®ä¾‹éªŒè¯æˆ‘ä¹‹å‰æ¨çš„ä¸€ä¸ªå¼€æºé¡¹ç›®Quick-Mediaï¼Œä¸»è¦æä¾›å›¾ç‰‡ã€äºŒç»´ç ã€éŸ³è§†é¢‘å¤„ç†æœåŠ¡ï¼Œç›®å‰å¤„äºéå¸¸ç®€é™‹çš„çŠ¶æ€ï¼Œé€šè¿‡å†™ç€ä¸¤ä¸ªå°ç¨‹åºï¼Œæœ€å¤§çš„ä¸€ä¸ªæ„Ÿå—æ˜¯ï¼Œå¯¹äºå¸ƒå±€å’Œæ ·å¼è¿™ä¸€å—ï¼Œå®åœ¨æ˜¯å¤ªä¸æ•æ„Ÿäº†ã€‚ æ—¢ç„¶è¯´åˆ°äº†å¼€æºé¡¹ç›®ï¼Œé‚£ä¹Ÿæœ‰å¿…è¦æä¸€ä¸‹äº†ï¼Œ17å¹´çš„ä¸€ä¸ªæ”¶è·å°±æ˜¯åšäº†å‡ ä¸ªæœ‰æ„æ€çš„å¼€æºé¡¹ç›®ï¼Œè™½ç„¶ä¸æ€ä¹ˆæˆåŠŸï¼Œæ²¡ä»€ä¹ˆäººå…³æ³¨ï¼Œä½†å¯¹ä¸ªäººçš„å­¦ä¹ å’Œæ”¶è·è¿˜æ˜¯å¾ˆä¸é”™çš„ã€‚æ¯”å¦‚ æä¾›SPIæœåŠ¡çš„Quick-Spi:https://github.com/liuyueyi/quick-spiï¼Œé€šè¿‡è¿™ä¸ªé¡¹ç›®çš„å®ç°ï¼Œç®—æ˜¯ç†è§£äº†spiåˆ°åº•æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Œåˆå¯ä»¥æ€ä¹ˆå»ç©ï¼› Quick-Crawleçˆ¬è™«æ¡†æ¶:https://github.com/liuyueyi/quick-crawlerï¼Œå¾ˆä¹…å¾ˆä¹…ä»¥å‰å°±å¯¹çˆ¬è™«æ„Ÿå…´è¶£äº†ï¼Œç„¶åå°±ä»0åˆ°1æ„å»ºäº†ä¸€ä¸ªéå¸¸ç®€å•çš„çˆ¬è™«æ¡†æ¶ï¼Œå‰é¢è¯´çš„ã€Šå¤è¯—é€‰ã€‹çš„å†…å®¹ï¼Œå°±æ˜¯é€šè¿‡è¿™ä¸ªçˆ¬è™«æ¡†æ¶ä»ç½‘ä¸Šçˆ¬ä¸‹æ¥çš„ï¼Œä»ç©ç¥¨çš„æ€§è´¨æ¥çœ‹ï¼Œè¿˜ä¸é”™ï¼› Quick-Mediaå¤šåª’ä½“æœåŠ¡:https://github.com/liuyueyi/quick-mediaï¼Œç›®å‰ç®—æ˜¯ä¸ªäººæœ€å¤šstarçš„é¡¹ç›®äº†ï¼Œé‡Œé¢æ·±åº¦çš„åˆ¨æäº†ä¸€ä¸‹äºŒç»´ç çš„ç”Ÿæˆï¼Œå®Œå…¨å¯ä»¥æ›¿æ¢äºŒç»´ç ä¸Šå„ç§å…ƒç´ ï¼Œå½“ç„¶è¿˜æœ‰ä¸€äº›å…¶ä»–çš„ä¸œè¥¿ï¼Œè¿™ä¸ªé¡¹ç›®ç®—æ˜¯å·¥ä½œçš„é™„å±å“ï¼Œå› ä¸ºå®é™…çš„å·¥ä½œä¸­ï¼Œå¾ˆå¤šæœåŠ¡éƒ½æ˜¯ä¸éœ€è¦çš„ï¼Œä½†æ˜¯å¶å°”æˆ‘ä¸ªäººä¼šå¯¹æŸä¸€å—æ¯”è¾ƒæ„Ÿå…´è¶£ï¼Œæ‰€ä»¥å¹²è„†æ–°æäº†ä¸€ä¸ªï¼ŒæŠŠè‡ªå·±å¹³æ—¶çš„å„ç§æƒ³æ³•éƒ½ä¸¢ä¸Šå»å°è¯•ä¸€ä¸‹ï¼› quick-doraemonï¼Œä¸€ä¸ªåŸºäºrediså®ç°çš„é…ç½®ä¸­å¿ƒæ¡†æ¶:https://github.com/liuyueyi/quick-doraemonï¼Œäº†è§£é˜¿é‡Œçš„Diaemondçš„åŒå­¦å¤§æ¦‚å¯ä»¥çŒœåˆ°è¿™ä¸ªæ˜¯å¹²å˜›çš„ï¼Œåšè¿™ä¸ªï¼Œçº¯ç²¹æ˜¯ä¸ºäº†æ¢ç©¶ä¸€ä¸‹ä¸€ä¸ªé…ç½®ä¸­å¿ƒçš„å®ç°ï¼Œåˆ°åº•éœ€è¦äº›ä»€ä¹ˆä¸œè¥¿ï¼Œæœ€å…³é”®çš„æ˜¯ï¼Œè¿™ä¸ªå®ç°ç®€ä¸ç®€å•ï¼› å¦å¤–è¿˜æœ‰ä¸¤ä¸ªå°å·¥å…·åŒ…ï¼Œä¸€ä¸ªæ˜¯åŸºäºPopClipçš„ https://github.com/liuyueyi/PopClipï¼Œ ä¸€ä¸ªåŸºäºAlfredçš„å°å·¥å…·é›†åˆï¼ˆç›®å‰æ²¡æœ‰å¯¹å¤–å¼€æ”¾ï¼Œä¸»è¦æ‰”åœ¨äº†å…¬å¸å†…ç½‘ï¼Œæœ‰è¾ƒå¤šçš„å†…éƒ¨ä¿¡æ¯ï¼‰ å‡ºå»è·‘äº†ä¸ªæ­¥ï¼Œéƒ½æ¥ä¸ä¸‹æ¥ä¸Šé¢å†™çš„ä¸œè¥¿äº†ï¼Œå¹²è„†ç›´æ¥æ¢ä¸ªè¯é¢˜ï¼Œè°ˆè°ˆç”Ÿæ´»ã€‚ç„¶è€Œä»”ç»†æƒ³äº†æƒ³ï¼Œå¥½åƒæ²¡å•¥å¥½è¯´çš„ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯ä¸Šç­ï¼Œæ™šä¸ŠåŠ ç­ï¼Œå›å®¶ç¡è§‰ï¼Œç¬¬äºŒå¤©ç»§ç»­ä¸Šç­ï¼›è¿™æ—¥å­ï¼Œè¿‡å¾—æœ‰ç‚¹å•è°ƒå•Šã€‚è‡ªå‹‰ï¼Œ18å¹´ä¸èƒ½è¿™ä¹ˆä¸‹å»äº†ï¼Œå¥½æ­¹ä¹Ÿå¾—æœ‰ç‚¹ä¸šåŠ¡ç”Ÿæ´»ï¼Œå‡ºå»é€›é€›åœˆï¼Œåˆ°å¤„èµ°èµ°ä¹Ÿå¥½è¿‡æ¯å¤©æ­»å®… 17å¹´ï¼Œå®¶åº­æ–°å¢äº†ä¸¤ä¸ªæˆå‘˜ï¼Œä¸åˆ°ä¸€å²çš„å°æœ‹å‹ï¼Œè€å¤§å·²ç»ä¼šèµ°è·¯äº†ï¼Œè€Œè€äºŒåˆ™å¤„äºåªæ™“å¾—åƒåƒå–å–çš„çŠ¶æ€ï¼›å°å¤–ç”¥çš„æˆå°±å·²ç»è¿œè¿œè¶…è¿‡ä»–ä»¬è€èˆ…æˆ‘çš„çŠ¶æ€äº†ï¼Œå¬æˆ‘å¦ˆè¯´ä¸¤å²å¤šæˆ‘éƒ½è¿˜ä¸ä¼šèµ°è·¯ï¼Œä¹Ÿæ˜¯å°´å°¬; å¤šäº†å°æœ‹å‹ä¹‹åï¼Œè¿˜æŒºä¸é”™çš„ï¼Œæœ€è¿‘æ²¡ä»€ä¹ˆäº‹æƒ…å°±å–œæ¬¢åœ¨æ·˜å®ï¼Œäº¬ä¸œä¸Šçœ‹ä¸€äº›å°æœ‹å‹çš„ç©å…·ï¼Œå„ç§ç§¯æœ¨ï¼Œç©å…·è½¦ä¹‹ç±»çš„ï¼Œå‘ç°è¿˜è›®æœ‰æ„æ€çš„ï¼Œå°æ—¶å€™æ²¡æœ‰ç©è¿‡çš„ä¸œè¥¿ï¼Œå®Œå…¨å¯ä»¥å€Ÿç€å°æœ‹å‹çš„åå¤´ä¹°æ¥è‡ªå·±è€ï¼Œä¹Ÿæ˜¯ä¸é”™ï¼›ä¸€ç›´éƒ½ä¸å¤ªå–œæ¬¢å°å­©å­ï¼Œæ€»è§‰å¾—éš¾ä»¥æ²Ÿé€šï¼Œè¿˜æŒºéº»çƒ¦ï¼Œä½†çœ‹ç€è€çˆ¸è€å¦ˆï¼Œæ¯å¤©æ•™ä»–ä»¬çš„å¤§å¤–ç”¥ä¸€äº›ä¸œè¥¿çš„æ—¶å€™ï¼Œè¿˜æ˜¯è›®æœ‰è¶£çš„ï¼Œé™ªä¼´ä¸æˆé•¿ï¼Œå¦‚æœå¯ä»¥çš„è¯ï¼Œçˆ¶æ¯è¿˜æ˜¯éœ€è¦å’Œå°å­©å­ä¸€èµ· 17å¹´èŠ±äº†æ‰€æœ‰çš„ç§¯è“„ï¼Œå€Ÿäº†ä¸€äº›ï¼Œæ–¹æ‰å‹‰å¼ºå‡‘å¤Ÿé¦–ä»˜ï¼Œè´·æ¬¾äº†ä¸ªå°ç ´æˆ¿ï¼Œç”Ÿæ´»è‰°è¾›ï¼Œå”‰ï¼Œå•¥æ—¶å€™æˆ¿ä»·æ‰èƒ½å¹³æ°‘ï¼Œåƒå¹´å‰çš„â€œå®‰å¾—å¹¿å¦åƒä¸‡é—´ï¼Œå¤§åº‡å¤©ä¸‹å¯’å£«ä¿±æ¬¢é¢œâ€æ”¾åœ¨ç°åœ¨ï¼Œä¾ç„¶æœ‰æ•ˆï¼›è„‘å­ä¸å¤Ÿçµæ´»ï¼Œåªèƒ½æ‹¿ç‚¹æ­»å·¥èµ„ï¼Œå¾—å¼€æ‹“ä¸‹è‡ªå·±çš„æ€è·¯äº†ã€‚ æ„Ÿè°¢@ç¾äººå§£çš„è¿™ä¸€è·¯çš„ç›¸ä¼´ï¼Œè™½ç„¶ç”Ÿæ´»è¿‡å¾—æ¯”è¾ƒå¹³æ·¡ï¼Œæ²¡æœ‰é‚£ä¹ˆå¤šçš„æƒŠå–œï¼Œæ²¡æœ‰é‚£ä¹ˆå¤šçš„æµªæ¼«ï¼Œè¿™äº›ä¸»è¦éƒ½æ˜¯æˆ‘çš„åŸå› äº†ï¼Œå¾—æ”¹æ­£ï¼Œè¯¥æœ‰çš„å°æƒŠå–œè¿˜æ˜¯å¾—æœ‰çš„ï¼Œæ‹“å®½ä¸€ä¸‹æ€è·¯ï¼Œæ”¹å˜ä¸€ä¸‹ä¹ æ€§ï¼Œè®©ç”Ÿæ´»å˜å¾—æœ‰æ„æ€èµ·æ¥ï¼Œè¿™ä¸ªéœ€è¦åœ¨18å¹´å¥½å¥½åŸ¹å…»ã€‚ æœ€åï¼Œå†æ†§æ†¬ä¸‹18å¹´ï¼Œå®šä¸ªå°ç›®æ ‡ï¼Œè¯¥ç»“å©šè¿‡å°æ—¥å­äº†!!! @ç¾äººå§£","categories":[{"name":"éšç¬”","slug":"éšç¬”","permalink":"https://zbang.online/hexblog/categories/éšç¬”/"}],"tags":[{"name":"æ—¥è®°","slug":"æ—¥è®°","permalink":"https://zbang.online/hexblog/tags/æ—¥è®°/"}],"keywords":[{"name":"éšç¬”","slug":"éšç¬”","permalink":"https://zbang.online/hexblog/categories/éšç¬”/"}]},{"title":"åŸºäºOkHttpå°è£…ä¸€ä¸ªç®€å•æ˜“ç”¨çš„httpå·¥å…·","slug":"åŸºäºOkHttpå°è£…ä¸€ä¸ªç®€å•æ˜“ç”¨çš„httpå·¥å…·","date":"2018-01-15T05:15:03.000Z","updated":"2018-02-13T03:21:17.020Z","comments":true,"path":"2018/01/15/åŸºäºOkHttpå°è£…ä¸€ä¸ªç®€å•æ˜“ç”¨çš„httpå·¥å…·/","link":"","permalink":"https://zbang.online/hexblog/2018/01/15/åŸºäºOkHttpå°è£…ä¸€ä¸ªç®€å•æ˜“ç”¨çš„httpå·¥å…·/","excerpt":"åŸºäºOkHttpå°è£…ä¸€ä¸ªç®€å•æ˜“ç”¨çš„httpå·¥å…· okHttæ›´å¸¸è§çš„æ˜¯ç”¨åœ¨androidé¡¹ç›®ä¸Šå®ç°httpäº¤äº’ï¼Œè€Œjavaåç«¯ï¼Œå¯èƒ½æ›´å¤šçš„ä½¿ç”¨httpclientï¼›ä¸€èˆ¬æ¥è®²ï¼Œandroidçš„åŒ…ï¼Œå¤§éƒ¨åˆ†ä¹Ÿæ˜¯å¯ä»¥ç”¨åˆ°javaåç«¯çš„ï¼Œæœ¬ç‰‡åšæ–‡åˆ™ä¸»è¦æ˜¯ä»‹ç»å¦‚ä½•ä½¿ç”¨okhttpå®ç°httpäº¤äº’ï¼Œå¹¶ä¼šåšä¸€ä¸ªç®€å•çš„å°è£…ï¼Œä»¥è¾¾åˆ°æ›´å¥½çš„ä½¿ç”¨ä½“éªŒ æœ¬ç¯‡ä¸ºçº¯å·¥å…·å°è£…ï¼Œæ— åŸç†åˆ†æ","text":"åŸºäºOkHttpå°è£…ä¸€ä¸ªç®€å•æ˜“ç”¨çš„httpå·¥å…· okHttæ›´å¸¸è§çš„æ˜¯ç”¨åœ¨androidé¡¹ç›®ä¸Šå®ç°httpäº¤äº’ï¼Œè€Œjavaåç«¯ï¼Œå¯èƒ½æ›´å¤šçš„ä½¿ç”¨httpclientï¼›ä¸€èˆ¬æ¥è®²ï¼Œandroidçš„åŒ…ï¼Œå¤§éƒ¨åˆ†ä¹Ÿæ˜¯å¯ä»¥ç”¨åˆ°javaåç«¯çš„ï¼Œæœ¬ç‰‡åšæ–‡åˆ™ä¸»è¦æ˜¯ä»‹ç»å¦‚ä½•ä½¿ç”¨okhttpå®ç°httpäº¤äº’ï¼Œå¹¶ä¼šåšä¸€ä¸ªç®€å•çš„å°è£…ï¼Œä»¥è¾¾åˆ°æ›´å¥½çš„ä½¿ç”¨ä½“éªŒ æœ¬ç¯‡ä¸ºçº¯å·¥å…·å°è£…ï¼Œæ— åŸç†åˆ†æ I. å°è£…åæµ‹è¯•æ•ˆæœä¸€è§ˆåŸºæœ¬ä¸Šï¼Œæœ€å¸¸è§çš„httpäº¤äº’æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªgetè¯·æ±‚ï¼Œä¸€ä¸ªpostè¯·æ±‚ï¼Œå› æ­¤è¿™é‡Œä¹Ÿå°±å°è£…äº†è¿™ä¸¤ç§è¯·æ±‚æ–¹å¼ï¼Œå¹¶é¢å¤–å¢åŠ ä¸€ä¸ªä¸Šä¼ æ–‡ä»¶çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨caseï¼Œæ¥çœ‹ä¸€ä¸‹æˆ‘ä»¬æœ€ç»ˆå°è£…åçš„ä½¿ç”¨å§¿åŠ¿ 123456789101112131415161718192021222324252627282930313233343536// ç®€å•çš„getè¯·æ±‚@Testpublic void testGet() &#123; String url = \"https://zbang.online/wx/list\"; try &#123; okhttp3.Response res = HttpWrapper.of(url).get(); if (res.isSuccessful()) &#123; String ans = res.body().string(); System.out.println(\"ans : \" + ans); &#125; &#125; catch (IOException e) &#123; e.printStackTrace(); &#125;&#125; @Testpublic void testUpload() &#123; String url = \"https://zbang.online/wx/qrcode/encode\"; String path = \"/Users/yihui/Desktop/img/test.jpg\"; File file = new File(path); try &#123; Response res = HttpWrapper.of(url) .file(\"image\", file.getName(), \"image/jpeg\", file) .addParam(\"content\", \"http://www.baidu.com\") .addParam(\"size\", \"400\") .upload(); if (res.isSuccessful()) &#123; String str = res.body().string(); System.out.println(\"ans: \" + str); &#125; &#125; catch (IOException e) &#123; e.printStackTrace(); &#125;&#125; ä¸Šé¢ç»™å‡ºçš„æ˜¯ä¸€ä¸ªä¸Šä¼ æ–‡ä»¶çš„caseï¼Œå®ç°ä¸»è¦æ˜¯å€ŸåŠ©äº†builderæ¨¡å¼ï¼Œå¯ä»¥å¾ˆç®€å•çš„ä¼ é€’ä¸ªä¸­å‚æ•°å’Œé…ç½®ï¼Œæœ€åè·å–è¿”å›çš„ç»“æœï¼Œè¿™æ ·è®¾è®¡çš„å¥½å¤„å¾ˆæ˜æ˜¾ï¼š ä½¿ç”¨ç®€å• é˜…è¯»æ–¹ä¾¿ II. å°è£…å®ç°æ¥ä¸‹æ¥è¿›å…¥æ­£é¢˜ï¼Œå¦‚ä½•å°è£…è¿™ä¸ªå·¥å…·ç±»å‘¢ï¼Œä¸€èˆ¬è€Œè¨€ï¼Œå‘èµ·httpè¯·æ±‚ï¼Œéœ€è¦è®¾ç½®è¯·æ±‚å‚æ•°ï¼Œè®¾ç½®è¯·æ±‚å¤´ï¼Œæ‰€ä»¥builderå†…éƒ¨çš„å…ƒç´ å¯ä»¥å¾ˆæ¸…æ™°çš„å®šä¹‰äº† é¦–å…ˆæ˜¯å¼•å…¥ä¾èµ– 12345&lt;dependency&gt; &lt;groupId&gt;com.squareup.okhttp3&lt;/groupId&gt; &lt;artifactId&gt;okhttp&lt;/artifactId&gt; &lt;version&gt;3.9.0&lt;/version&gt;&lt;/dependency&gt; å½“ç„¶ç”±äºæ•´ä¸ªä½¿ç”¨éƒ½æ¯”è¾ƒç®€å•ï¼Œä¸‹é¢å°±ç›´æ¥è´´å‡ºå°è£…åçš„ä»£ç äº† 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129public class HttpWrapper &#123; private static OkHttpClient client = new OkHttpClient(); private static final String DEFAULT_USER_AGENT = \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36\"; public static Builder of(String url) &#123; return new Builder(url); &#125; public static class Builder &#123; private String url; private Map&lt;String, String&gt; params; private List&lt;MultipartBody.Part&gt; uploadParts; Request.Builder reqBuilder; Builder(String url) &#123; this.url = url; params = new HashMap&lt;&gt;(); uploadParts = new ArrayList&lt;&gt;(); reqBuilder = new Request.Builder(); // é»˜è®¤æ·»åŠ ä¸Šuser-agent addHeader(\"User-Agent\", DEFAULT_USER_AGENT); &#125; // æ·»åŠ å‚æ•° public Builder addParam(String key, String value) &#123; params.put(key, value); return this; &#125; // æ·»åŠ å¤´ public Builder addHeader(String key, String value) &#123; reqBuilder.addHeader(key, value); return this; &#125; public Builder file(String key, String fileName, String fileMime, byte[] bytes) &#123; MultipartBody.Part part = MultipartBody.Part.createFormData( key, fileName, RequestBody.create(MediaType.parse(fileMime), bytes)); uploadParts.add(part); return this; &#125; public Builder file(String key, String fileName, String fileMime, File file) &#123; MultipartBody.Part part = MultipartBody.Part.createFormData( key, fileName, RequestBody.create(MediaType.parse(fileMime), file)); uploadParts.add(part); return this; &#125; public Builder file(String key, String fileName, String fileMime, InputStream stream) throws IOException &#123; int size = stream.available(); byte[] bytes = new byte[size]; stream.read(bytes); return file(key, fileName, fileMime, bytes); &#125; /** * å‘é€getè¯·æ±‚ * * @return * @throws IOException */ public Response get() throws IOException &#123; StringBuilder urlBuilder = new StringBuilder(url); if (!params.isEmpty()) &#123; urlBuilder.append(\"?\").append(Joiner.on('&amp;').withKeyValueSeparator('=').join(params)); &#125; return client.newCall(reqBuilder.url(urlBuilder.toString()).build()).execute(); &#125; /** * postè¡¨å•æ•°æ® * * @return */ public Response post() throws IOException &#123; // åˆ›å»ºè¡¨å• FormBody.Builder formBodyBuilder = new FormBody.Builder(); if (!params.isEmpty()) &#123; params.forEach(formBodyBuilder::add); &#125; return client.newCall(reqBuilder.url(url) .post(formBodyBuilder.build()) .build()) .execute(); &#125; /** * æ–‡ä»¶ä¸Šä¼  * * @return * @throws IOException */ public Response upload() throws IOException &#123; MultipartBody.Builder bodyBuilder = new MultipartBody.Builder() .setType(MultipartBody.FORM); uploadParts.forEach(bodyBuilder::addPart); // æ·»åŠ å‚æ•° params.forEach(bodyBuilder::addFormDataPart); return client.newCall(reqBuilder.url(url) .post(bodyBuilder.build()) .build()) .execute(); &#125; &#125;&#125; é’ˆå¯¹ä¸Šé¢çš„å®ç°ï¼Œæœ‰å‡ ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹ getè¯·æ±‚æ—¶ï¼Œå°†å‚æ•°æ‹¼è£…åˆ°urlä¸Šï¼ˆéœ€è¦è€ƒè™‘æ˜¯å¦è¦ç¼–ç ï¼Ÿï¼‰ postè¯·æ±‚æ—¶ï¼Œä¸»è¦å€ŸåŠ© FormBody æ¥å­˜å‚¨è¯·æ±‚å‚æ•° æ–‡ä»¶ä¸Šä¼ æ—¶ï¼Œ ä¸»è¦åˆ©ç”¨Partæ¥å°è£…ä¸Šä¼ çš„æ–‡ä»¶ï¼Œå€ŸåŠ© MultipartBodyæ¥åŒ…è£…Partå’Œè¯·æ±‚å‚æ•° ä¸Šä¼ æ–‡ä»¶ï¼Œéœ€è¦æŒ‡å®šå…¶ MIMEï¼ˆå³ Content-Type, å¦‚ image/jpeg, audio/mp3, file/txtç­‰ï¼‰ ä¼ æ–‡ä»¶çš„åŒæ—¶ï¼Œä¹Ÿå¯ä»¥ä¼ é€’postå‚æ•°ï¼Œå½“ç„¶urlå‚æ•°ä¹Ÿæ˜¯å¯ä»¥çš„ III. æµ‹è¯•éªŒè¯å‰é¢ç»™å‡ºçš„æ˜¯ä¸€ä¸ªä¼ æ–‡ä»¶çš„caseï¼Œä¸‹é¢åˆ™ç»™å‡ºä¸€ä¸ªæäº¤postè¡¨å•çš„æµ‹è¯•ç”¨ä¾‹ è¿™ä¸ªhttpæ¥å£ä¸»è¦åŠŸèƒ½æ˜¯å®ç°markdownè¾“å‡ºå›¾ç‰‡ 12345678910111213141516171819202122232425262728293031323334@Testpublic void testPost() &#123; String url = \"https://zbang.online/wx/md2img\"; String content = \"h1 header\\n\" + \"============\\n\" + \"\\n\" + \"Paragraphs are separated by a blank line.\\n\" + \"\\n\" + \"2nd paragraph. *Italic*, **bold**, and `monospace`. Itemized lists\\n\" + \"look like:\\n\" + \"\\n\" + \" * this one\\n\" + \" * that one\\n\" + \" * the other one\"; String token = \"0xdahdljk3u8eqhrjqwer90e\"; String noborder = \"true\"; try &#123; Response res = HttpWrapper.of(url) .addParam(\"content\", content) .addParam(\"token\", token) .addParam(\"noborder\", noborder) .addParam(\"type\", \"stream\") .post(); if (res.isSuccessful()) &#123; BufferedImage bf = ImageIO.read(res.body().byteStream()); System.out.println(\"over\"); &#125; &#125; catch (IOException e) &#123; e.printStackTrace(); &#125;&#125; æµ‹è¯•æ¼”ç¤º V. å…¶ä»–æºç ç›¸å…³æºç å¯ä»¥å‚è§ï¼š HttpWrapper.java å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è§£ä¸å…¨ï¼Œå¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ æ‰«æå…³æ³¨ï¼Œjavaåˆ†äº«","categories":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"Tool","slug":"Java/Tool","permalink":"https://zbang.online/hexblog/categories/Java/Tool/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"Okhttp","slug":"Okhttp","permalink":"https://zbang.online/hexblog/tags/Okhttp/"},{"name":"å·¥å…·","slug":"å·¥å…·","permalink":"https://zbang.online/hexblog/tags/å·¥å…·/"}],"keywords":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"Tool","slug":"Java/Tool","permalink":"https://zbang.online/hexblog/categories/Java/Tool/"}]},{"title":"Rediså®ç°åˆ†å¸ƒå¼é”ç›¸å…³æ³¨æ„äº‹é¡¹","slug":"Rediså®ç°åˆ†å¸ƒå¼é”ç›¸å…³æ³¨æ„äº‹é¡¹","date":"2018-01-14T08:12:29.000Z","updated":"2018-02-13T03:21:17.018Z","comments":true,"path":"2018/01/14/Rediså®ç°åˆ†å¸ƒå¼é”ç›¸å…³æ³¨æ„äº‹é¡¹/","link":"","permalink":"https://zbang.online/hexblog/2018/01/14/Rediså®ç°åˆ†å¸ƒå¼é”ç›¸å…³æ³¨æ„äº‹é¡¹/","excerpt":"Rediså®ç°åˆ†å¸ƒå¼é”ç›¸å…³æ³¨æ„äº‹é¡¹ æŸ¥çœ‹äº†ä¸å°‘å…³äºrediså®ç°åˆ†å¸ƒå¼é”çš„æ–‡ç« ï¼Œæ— ç–‘è¦è®¾è®¡ä¸€ä¸ªé è°±çš„åˆ†å¸ƒå¼å¹¶ä¸å¤ªå®¹æ˜“ï¼Œæ€»ä¼šå‡ºç°å„ç§é¬¼ç•œçš„é—®é¢˜ï¼›ç°åœ¨å°±æ¥å°è¿°ä¸€ä¸‹ï¼Œåœ¨è®¾è®¡ä¸€ä¸ªåˆ†å¸ƒå¼é”çš„è¿‡ç¨‹ä¸­ï¼Œä¼šé‡åˆ°ä¸€äº›ä»€ä¹ˆé—®é¢˜","text":"Rediså®ç°åˆ†å¸ƒå¼é”ç›¸å…³æ³¨æ„äº‹é¡¹ æŸ¥çœ‹äº†ä¸å°‘å…³äºrediså®ç°åˆ†å¸ƒå¼é”çš„æ–‡ç« ï¼Œæ— ç–‘è¦è®¾è®¡ä¸€ä¸ªé è°±çš„åˆ†å¸ƒå¼å¹¶ä¸å¤ªå®¹æ˜“ï¼Œæ€»ä¼šå‡ºç°å„ç§é¬¼ç•œçš„é—®é¢˜ï¼›ç°åœ¨å°±æ¥å°è¿°ä¸€ä¸‹ï¼Œåœ¨è®¾è®¡ä¸€ä¸ªåˆ†å¸ƒå¼é”çš„è¿‡ç¨‹ä¸­ï¼Œä¼šé‡åˆ°ä¸€äº›ä»€ä¹ˆé—®é¢˜ I. èƒŒæ™¯çŸ¥è¯†å€ŸåŠ©redisæ¥å®ç°åˆ†å¸ƒå¼é”ï¼ˆæˆ‘ä»¬å…ˆè€ƒè™‘å•æœºredisçš„æ¨¡å¼ï¼‰ï¼Œé¦–å…ˆæœ‰å¿…è¦äº†è§£ä¸‹ä»¥ä¸‹å‡ ç‚¹ï¼š å•çº¿ç¨‹æ¨¡å¼ setnx : å½“ä¸å­˜åœ¨æ—¶ï¼Œè®¾ç½®valueï¼Œå¹¶è¿”å›1ï¼› å¦åˆ™è¿”å›0 getset : è®¾ç½®å¹¶è·å–åŸæ¥çš„å€¼ expire : è®¾ç½®å¤±æ•ˆæ—¶é—´ get : è·å–å¯¹åº”çš„å€¼ del : åˆ é™¤ ttl : è·å–keyå¯¹åº”çš„å‰©ä½™æ—¶é—´ï¼Œè‹¥keyæ²¡æœ‰è®¾ç½®è¿‡è¶…æ—¶æ—¶é—´ï¼Œæˆ–è€…å‹æ ¹æ²¡æœ‰è¿™ä¸ªkeyåˆ™è¿”å›è´Ÿæ•°ï¼ˆå¯èƒ½æ˜¯-1ï¼Œ-2ï¼‰ watch/unwatch : äº‹åŠ¡ç›¸å…³ II. æ–¹æ¡ˆè®¾è®¡1. è®¾è®¡æ€è·¯è·å–é”ï¼š è°ƒç”¨ setnx å°è¯•è·å–é”ï¼Œå¦‚æœè®¾ç½®æˆåŠŸï¼Œè¡¨ç¤ºè·å–åˆ°äº†é” è®¾ç½®å¤±è´¥ï¼Œæ­¤æ—¶éœ€è¦åˆ¤æ–­é”æ˜¯å¦è¿‡æœŸ æœªè¿‡æœŸï¼Œåˆ™è¡¨ç¤ºè·å–å¤±è´¥ï¼›å¾ªç¯ç­‰å¾…ï¼Œå¹¶å†æ¬¡å°è¯•è·å–é” å·²è¿‡æœŸï¼Œgetsetå†æ¬¡è®¾ç½®é”ï¼Œåˆ¤æ–­æ˜¯å¦è·å–äº†é”ï¼ˆæ ¹æ®è¿”å›çš„å€¼è¿›è¡Œåˆ¤æ–­ï¼Œåé¢ç»™å‡ºå…·ä½“çš„æ–¹æ¡ˆï¼‰ è‹¥å¤±è´¥ï¼Œåˆ™é‡æ–°è¿›å…¥è·å–é”çš„é€»è¾‘ é‡Šæ”¾é”ï¼š ä¸€ä¸ªåŸåˆ™å°±æ˜¯ç¡®ä¿æ¯ä¸ªä¸šåŠ¡æ–¹é‡Šæ”¾çš„æ˜¯è‡ªå·±çš„é” 2. getsetçš„å®ç°æ–¹æ¡ˆç½‘ä¸Šä¸€ç§å¸¸è§çš„caseï¼Œä¸»è¦æ€è·¯å¦‚ä¸‹ setnx å°è¯•è·å–é” å¤±è´¥ï¼Œåˆ™ get è·å–é”çš„value ï¼ˆä¸€èˆ¬æ˜¯ uuid_timstampï¼‰ åˆ¤æ–­æ˜¯å¦è¿‡æœŸï¼Œè‹¥æ²¡æœ‰è¿‡æœŸï¼Œåˆ™è¡¨ç¤ºçœŸçš„è·å–å¤±è´¥ è‹¥è¿‡æœŸï¼Œåˆ™é‡‡ç”¨ getsetè®¾ç½®ï¼Œå°è¯•è·å–é” å®ç°ä»£ç å¦‚ä¸‹ 12345678910111213141516171819202122232425262728293031323334353637383940public class DistributeLock &#123; private static final Long OUT_TIME = 30L; public String tryLock(Jedis jedis, String key) &#123; while (true) &#123; String value = UUID.randomUUID().toString() + \"_\" + System.currentTimeMillis(); Long ans = jedis.setnx(key, value); if (ans != null &amp;&amp; ans == 1) &#123; // è·å–é”æˆåŠŸ return value; &#125; // é”è·å–å¤±è´¥, åˆ¤æ–­æ˜¯å¦è¶…æ—¶ String oldLock = jedis.get(key); if (oldLock == null) &#123; continue; &#125; long oldTime = Long.parseLong(oldLock.substring(oldLock.lastIndexOf(\"_\") + 1)); long now = System.currentTimeMillis(); if (now - oldTime &lt; OUT_TIME) &#123; // æ²¡æœ‰è¶…æ—¶ continue; &#125; String getsetOldVal = jedis.getSet(key, value); if (Objects.equals(oldLock, getsetOldVal)) &#123; // è¿”å›çš„æ­£å¥½æ˜¯ä¸Šæ¬¡çš„å€¼ï¼Œè¡¨ç¤ºé”è·å–æˆåŠŸ return value; &#125; else &#123; // è¡¨ç¤ºè¿”å›çš„æ˜¯å…¶ä»–ä¸šåŠ¡è®¾ç½®çš„é”ï¼Œèµ¶ç´§çš„è®¾ç½®å›å» jedis.set(key, getsetOldVal); &#125; &#125; &#125; public void tryUnLock(Jedis jedis, String key, String uuid) &#123; String ov = jedis.get(key); if (uuid.equals(ov)) &#123; // åªé‡Šæ”¾è‡ªå·±çš„é” jedis.del(key); &#125; &#125;&#125; è§‚å¯Ÿè·å–é”çš„é€»è¾‘ï¼Œç‰¹åˆ«æ˜¯è·å–è¶…æ—¶é”çš„é€»è¾‘ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°æœ‰ä¸€ä¸ªé—®é¢˜ getSet æ–¹æ³•ä¼šä¸ä¼šå¯¼è‡´å†™æ•°æ®æ··ä¹±çš„é—®é¢˜ï¼Œç®€å•æ¥è¯´å°±æ˜¯å¤šä¸ªçº¿ç¨‹åŒæ—¶åˆ¤æ–­é”è¶…æ—¶æ—¶ï¼Œæ‰§è¡Œ getSetè®¾ç½®é”æ—¶ï¼Œæœ€ç»ˆè·å–é”çš„çº¿ç¨‹ï¼Œèƒ½å¦ä¿è¯å’Œredisä¸­çš„é”çš„valueç›¸åŒ ä¸Šé¢çš„å®ç°æ–¹å¼ï¼Œä¸€ä¸ªæ··ä¹±çš„caseå¦‚ä¸‹: ä¸‰ä¸ªçº¿ç¨‹a,b,c éƒ½è¿›å…¥åˆ°äº†é”è¶…æ—¶çš„é˜¶æ®µ çº¿ç¨‹a, è·å–åŸå§‹å€¼ oldVal, å¹¶è®¾ç½® t1 çº¿ç¨‹b, è·å–çº¿ç¨‹aè®¾ç½®çš„ t1, å¹¶é‡è®¾ä¸º t2 çº¿ç¨‹c, è·å–çº¿ç¨‹bè®¾ç½®çš„ t2, å¹¶é‡è®¾ä¸º t3 çº¿ç¨‹aï¼Œåˆ¤æ–­ï¼Œå¹¶æ­£å¼è·å–åˆ°é” çº¿ç¨‹bï¼Œåˆ¤æ–­å¤±è´¥ï¼Œæ¢å¤åŸæ¥é”çš„å†…å®¹ä¸ºt1 çº¿ç¨‹c, åˆ¤æ–­å¤±è´¥ï¼Œæ¢å¤åŸæ¥é”çš„å†…å®¹ä¸ºt2 é—®é¢˜å‡ºç°äº†ï¼Œè·å–é”çš„çº¿ç¨‹aï¼ŒæœŸæœ›æ‰€å¾—å†…å®¹ä¸ºt1, ä½†æ˜¯å®é™…ä¸ºt2; å¯¼è‡´æ— æ³•é‡Šæ”¾é” å®é™…éªŒè¯ åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œé…åˆæµ‹è¯•caseï¼ŒåŠ ä¸Šä¸€äº›æ—¥å¿—è¾“å‡º 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556public static String tryLock(Jedis jedis, String key) throws InterruptedException &#123; String threadName = Thread.currentThread().getName(); while (true) &#123; String value = threadName + \"_\" + UUID.randomUUID().toString() + \"_\" + System.currentTimeMillis(); Long ans = jedis.setnx(key, value); if (ans != null &amp;&amp; ans == 1) &#123; // è·å–é”æˆåŠŸ return value; &#125; // é”è·å–å¤±è´¥, åˆ¤æ–­æ˜¯å¦è¶…æ—¶ String oldLock = jedis.get(key); if (oldLock == null) &#123; continue; &#125; long oldTime = Long.parseLong(oldLock.substring(oldLock.lastIndexOf(\"_\") + 1)); long now = System.currentTimeMillis(); if (now - oldTime &lt; OUT_TIME) &#123; // æ²¡æœ‰è¶…æ—¶ continue; &#125; // å¼ºåˆ¶ä½¿æ‰€æœ‰çš„çº¿ç¨‹éƒ½å¯ä»¥åˆ°è¿™ä¸€æ­¥ Thread.sleep(50); System.out.println(threadName + \" in getSet!\"); // äººå·¥æ¥å…¥ï¼Œç¡®ä¿t1 è·å–åˆ°é”ï¼Œ t2 è·å–çš„æ˜¯t1è®¾ç½®çš„å†…å®¹ï¼Œ t3è·å–çš„æ˜¯t2è®¾ç½®çš„å†…å®¹ if (\"t2\".equalsIgnoreCase(threadName)) &#123; Thread.sleep(20); &#125; else if (\"t3\".equalsIgnoreCase(threadName)) &#123; Thread.sleep(40); &#125; String getsetOldVal = jedis.getSet(key, value); System.out.println(threadName + \" set redis value: \" + value); if (Objects.equals(oldLock, getsetOldVal)) &#123; // è¿”å›çš„æ­£å¥½æ˜¯ä¸Šæ¬¡çš„å€¼ï¼Œè¡¨ç¤ºé”è·å–æˆåŠŸ System.out.println(threadName + \" get lock!\"); if (\"t1\".equalsIgnoreCase(threadName)) &#123; // t1è·å–åˆ°é”ï¼Œå¼ºåˆ¶sleep40msï¼Œ ç¡®ä¿çº¿t2,t3ä¹Ÿè¿›å…¥äº† getSeté€»è¾‘ Thread.sleep(40); &#125; return value; &#125; else &#123; // è¡¨ç¤ºè¿”å›çš„æ˜¯å…¶ä»–ä¸šåŠ¡è®¾ç½®çš„é”ï¼Œèµ¶ç´§çš„è®¾ç½®å›å» // äººè‚‰ä»‹å…¥ï¼Œç¡®ä¿t2ä¼˜å…ˆæ‰§è¡Œï¼Œå¹¶è®¾ç½®å›t1è®¾ç½®çš„å€¼, t3åæ‰§è¡Œè®¾ç½®çš„æ˜¯t2è®¾ç½®çš„å€¼ if (\"t3\".equalsIgnoreCase(threadName)) &#123; Thread.sleep(40); &#125; else if (\"t2\".equalsIgnoreCase(threadName))&#123; Thread.sleep(20); &#125; jedis.set(key, getsetOldVal); System.out.println(threadName + \" recover redis value: \" + getsetOldVal); &#125; &#125;&#125; æµ‹è¯•case 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950@Testpublic void testLock() throws InterruptedException &#123; // å…ˆæ— è§†è·å–jedisçš„æ–¹å¼ JedisPool jedisPool = cacheWrapper.getJedisPool(0); Jedis jedis = jedisPool.getResource(); String lockKey = \"lock_test\"; String old = DistributeLock.tryLock(jedis, lockKey); System.out.println(\"old lock: \" + old); // ç¡®ä¿é”è¶…æ—¶ Thread.sleep(40); // åˆ›å»ºä¸‰ä¸ªçº¿ç¨‹ Thread t1 = new Thread(() -&gt; &#123; try &#123; Jedis j =jedisPool.getResource(); DistributeLock.tryLock(j, lockKey); System.out.println(\"t1 &gt;&gt;&gt;&gt; \" + j.get(lockKey)); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125;, \"t1\"); Thread t2 = new Thread(() -&gt; &#123; try &#123; Jedis j =jedisPool.getResource(); DistributeLock.tryLock(j, lockKey); System.out.println(\"t2 &gt;&gt;&gt;&gt;&gt; \" + j.get(lockKey)); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125;, \"t2\"); Thread t3 = new Thread(() -&gt; &#123; try &#123; Jedis j =jedisPool.getResource(); DistributeLock.tryLock(j, lockKey); System.out.println(\"t3 &gt;&gt;&gt;&gt;&gt; \" + j.get(lockKey)); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125;, \"t3\"); t1.start(); t2.start(); t3.start(); Thread.sleep(10000);&#125;; éƒ¨åˆ†è¾“å‡ºç»“æœ: 1234567891011121314main in getSet!main set redis value: main_d4cc5d69-5027-4550-abe1-10126f057779_1515643763130main get lock!old lock: main_d4cc5d69-5027-4550-abe1-10126f057779_1515643763130t1 in getSet!t2 in getSet!t1 set redis value: t1_105974db-7d89-48bf-9669-6f122a3f9fb6_1515643763341t1 get lock!t3 in getSet!t2 set redis value: t2_be06f80a-9b70-4a0e-a86d-44337abe8642_1515643763341t1 &gt;&gt;&gt;&gt; t2_be06f80a-9b70-4a0e-a86d-44337abe8642_1515643763341t3 set redis value: t3_9aa5d755-43b2-43bd-9a0b-2bad13fa31f6_1515643763345t2 recover redis value: t1_105974db-7d89-48bf-9669-6f122a3f9fb6_1515643763341t3 recover redis value: t2_be06f80a-9b70-4a0e-a86d-44337abe8642_1515643763341 é‡ç‚¹å…³æ³¨ t1 &gt;&gt;&gt;&gt; t2_be06f80a-9b70-4a0e-a86d-44337abe8642_1515643763341ï¼Œè¡¨ç¤ºt1çº¿ç¨‹è¿‡å»äº†é”ï¼Œä½†æ˜¯é”çš„å†…å®¹ä¸æ˜¯å…¶valueï¼Œå³ä¾¿t2å»æ¢å¤ï¼Œä¹Ÿä¼šè¢«t3ç»™è¦†ç›– å¦‚ä½•è§£å†³ä¸Šé¢è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ ä¸Šé¢æ˜¯å…¸å‹çš„å¹¶å‘å¯¼è‡´çš„é—®é¢˜ï¼Œå½“ç„¶å¯ä»¥è€ƒè™‘ä»è§£å†³å¹¶å‘é—®é¢˜çš„è§’åº¦å‡ºå‘æ¥è€ƒè™‘ï¼Œä¸€ä¸ªå¸¸è§çš„æ–¹å¼å°±æ˜¯åŠ é”äº†ï¼Œæ€è·¯å¦‚ä¸‹ï¼šï¼ˆä¸è¯¦ç»†å±•å¼€äº†ï¼‰ åœ¨åˆ¤æ–­è¶…æ—¶ä¹‹åï¼ŒåŠ é” å†æ¬¡è·å–å¯¹åº”çš„å€¼ï¼Œåˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œæ˜¯åˆ™æ‰§è¡Œä¸Šé¢çš„æ“ä½œ å¦åˆ™é€€å‡ºé€»è¾‘ï¼Œç»§ç»­å¾ªç¯ è¿™ç§å®ç°æ–¹å¼ï¼Œä¼šæœ‰ä»¥ä¸‹çš„é—®é¢˜ï¼š getset è¿™ä¸ªæ–¹æ³•æ‰§è¡Œï¼Œå¯èƒ½å¯¼è‡´å†™å…¥è„æ•°æ® åŸºäºæœåŠ¡å™¨æ—¶é’Ÿè¿›è¡Œè¶…æ—¶åˆ¤æ–­ï¼Œè¦æ±‚æ‰€æœ‰æœåŠ¡å™¨å§‹ç»ˆä¸€è‡´ï¼Œå¦åˆ™æœ‰å‘ 3. expireå®ç°æ–¹å¼ç›¸æ¯”äºå‰é¢ä¸€ç§ç›´æ¥å°†valueè®¾ç½®ä¸ºæ—¶é—´æˆ³ï¼Œç„¶åæ¥æ¯”å¯¹çš„æ–¹æ³•ï¼Œè¿™é‡Œåˆ™ç›´æ¥å€ŸåŠ©redisæœ¬èº«çš„expireæ–¹å¼æ¥å®ç°è¶…æ—¶è®¾ç½®ï¼Œä¸»è¦å®ç°é€»è¾‘ç›¸å·®æ— å‡  123456789101112131415161718192021222324252627282930313233public class DistributeExpireLock &#123; private static final Integer OUT_TIME = 3; public static String tryLock(Jedis jedis, String key) &#123; String value = UUID.randomUUID().toString(); while(true) &#123; Long ans = jedis.setnx(key, value); if (ans != null &amp;&amp; ans == 1) &#123; // è·å–é”æˆåŠŸ jedis.expire(key, OUT_TIME); // ä¸»åŠ¨è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º3s return value; &#125; // è·å–å¤±è´¥ï¼Œå…ˆç¡®è®¤ä¸‹æ˜¯å¦æœ‰è®¾ç½®å›½è¶…æ˜¯æ—¶é—´ // é˜²æ­¢é”çš„è¶…æ—¶æ—¶é—´è®¾ç½®å¤±æ•ˆï¼Œå¯¼è‡´ä¸€ç›´ç«äº‰ä¸åˆ° if(jedis.ttl(key) &lt; 0) &#123; jedis.expire(key, OUT_TIME); &#125; &#125; &#125; public static void tryUnLock(Jedis jedis, String key, String uuid) &#123; String ov = jedis.get(key); if (uuid.equals(ov)) &#123; // åªé‡Šæ”¾è‡ªå·±çš„é” jedis.del(key); System.out.println(Thread.currentThread() +\" del lock success!\"); &#125; else &#123; System.out.println(Thread.currentThread() +\" del lock fail!\"); &#125; &#125;&#125; è·å–é”çš„é€»è¾‘ç›¸æ¯”ä¹‹å‰çš„ï¼Œå°±ç®€å•å¾ˆå¤šäº†ï¼Œæ¥ä¸‹æ¥åˆ™éœ€è¦ç®€å•çš„åˆ†æä¸‹ï¼Œä¸Šé¢è¿™ç§å®ç°æ–¹å¼ï¼Œä¼šä¸ä¼šæœ‰å‘å‘¢ï¼Ÿæˆ‘ä»¬ä¸»è¦çœ‹ä¸€ä¸‹è·å–é”å¤±è´¥çš„åœºæ™¯ å¦‚æœè·å–é”å¤±è´¥ è¡¨ç¤ºæœ‰å…¶ä»–çš„ä¸šåŠ¡æ–¹å·²ç»è·å–åˆ°äº†é” æ­¤æ—¶ï¼Œåªèƒ½ç­‰æŒæœ‰é”çš„ä¸šåŠ¡æ–¹ä¸»åŠ¨é‡Šæ”¾é” åˆ¤æ–­é”æ˜¯å¦è®¾ç½®äº†è¶…æ—¶æ—¶é—´ï¼Œè‹¥æ²¡æœ‰åˆ™åŠ ä¸€ä¸ªï¼ˆé˜²æ­¢è®¾ç½®è¶…æ—¶æ—¶é—´å¤±è´¥å¯¼è‡´é—®é¢˜ï¼‰ ä»ä¸Šé¢è¿™ä¸ªé€»è¾‘æ¥çœ‹é—®é¢˜ä¸å¤§ï¼Œä½†æ˜¯æœ‰ä¸ªé—®é¢˜ï¼Œcase ï¼š å¦‚æŸä¸ªä¸šåŠ¡æ–¹setnxè·å–åˆ°äº†é”ï¼Œä½†æ˜¯å› ä¸ºç½‘ç»œé—®é¢˜ï¼Œè¿‡äº†å¾ˆä¹…æ‰è·å–åˆ°è¿”å›ï¼Œæ­¤æ—¶é”å·²ç»å¤±æ•ˆå¹¶è¢«å…¶ä»–ä¸šåŠ¡æ–¹è·å–åˆ°äº†ï¼Œå°±ä¼šå‡ºç°å¤šä¸ªä¸šåŠ¡æ–¹åŒæ—¶æŒæœ‰é”çš„åœºæ™¯ III. å°ç»“è¯´æ˜æƒ³åŸºäºrediså®ç°ä¸€ä¸ªç›¸å¯¹é è°±çš„åˆ†å¸ƒå¼é”ï¼Œéœ€è¦è€ƒè™‘çš„ä¸œè¥¿è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œè€Œä¸”è¿™ç§é”å¹¶ä¸å¤ªé€‚ç”¨äºä¸šåŠ¡è¦æ±‚ç‰¹åˆ«ä¸¥æ ¼çš„åœ°æ–¹ï¼Œå¦‚ ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”æ—¶ï¼Œå¦‚æœå‘ç”Ÿgcï¼Œå¯¼è‡´é”è¶…æ—¶å¤±æ•ˆï¼Œä½†æ˜¯è‡ªå·±åˆä¸çŸ¥é“ï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°å¤šä¸ªä¸šåŠ¡æ–¹åŒæ—¶æŒæœ‰é”çš„åœºæ™¯ å¯¹äºé”è¶…æ—¶çš„åœºæ™¯ï¼Œéœ€è¦ä»”ç»†è€ƒè™‘ï¼Œæ˜¯å¦ä¼šå‡ºç°å¹¶å‘é—®é¢˜ ç¡®ä¿åªèƒ½é‡Šæ”¾è‡ªå·±çš„é”ï¼ˆä»¥é˜²æ­¢é‡Šæ”¾äº†åˆ«äººçš„é”ï¼Œå‡ºç°é—®é¢˜ï¼‰ å‚è€ƒé“¾æ¥ åŸºäºRedisçš„åˆ†å¸ƒå¼é”åˆ°åº•å®‰å…¨å—? åˆ©ç”¨rediså®ç°çš„åˆ†å¸ƒå¼é” V. å…¶ä»–å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è§£ä¸å…¨ï¼Œå¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ æ‰«æå…³æ³¨ï¼Œjavaåˆ†äº«","categories":[{"name":"Redis","slug":"Redis","permalink":"https://zbang.online/hexblog/categories/Redis/"}],"tags":[{"name":"distributeLock","slug":"distributeLock","permalink":"https://zbang.online/hexblog/tags/distributeLock/"},{"name":"Redis","slug":"Redis","permalink":"https://zbang.online/hexblog/tags/Redis/"}],"keywords":[{"name":"Redis","slug":"Redis","permalink":"https://zbang.online/hexblog/categories/Redis/"}]},{"title":"SpringMVCä¹‹è¯·æ±‚å‚æ•°çš„è·å–æ–¹å¼","slug":"SpringMVCä¹‹è¯·æ±‚å‚æ•°çš„è·å–æ–¹å¼","date":"2018-01-04T08:48:39.000Z","updated":"2018-01-04T09:06:22.615Z","comments":true,"path":"2018/01/04/SpringMVCä¹‹è¯·æ±‚å‚æ•°çš„è·å–æ–¹å¼/","link":"","permalink":"https://zbang.online/hexblog/2018/01/04/SpringMVCä¹‹è¯·æ±‚å‚æ•°çš„è·å–æ–¹å¼/","excerpt":"SpringMVCä¹‹è¯·æ±‚å‚æ•°çš„è·å–æ–¹å¼ å¸¸è§çš„ä¸€ä¸ªwebæœåŠ¡ï¼Œå¦‚ä½•è·å–è¯·æ±‚å‚æ•°ï¼Ÿ ä¸€èˆ¬æœ€å¸¸è§çš„è¯·æ±‚ä¸ºGETå’ŒPOSTï¼Œgetè¯·æ±‚çš„å‚æ•°åœ¨urlä¸Šå¯ä»¥è·å–ï¼Œpostè¯·æ±‚å‚æ•°é™¤äº†urlä¸Šè¿˜æœ‰å¯èƒ½åœ¨è¡¨å•ä¸­ï¼Œæ–‡ä»¶ä¸Šä¼ æ—¶ï¼Œè·å–æ–¹å¼åˆå’Œä¸€èˆ¬çš„å‚æ•°è·å–ä¸ä¸€æ · æœ¬ç¯‡åˆ™ä¸»è¦é›†ä¸­åœ¨ä¸åŒè¯·æ±‚æ–¹å¼ä¸‹ï¼Œè·å–å‚æ•°çš„ä½¿ç”¨å§¿åŠ¿ é¦–å…ˆéœ€è¦æ­å»ºä¸€ä¸ªåç«¯çš„è¯·æ±‚ï¼Œä¸ºäº†å¿«é€Ÿæ¼”ç¤º åˆ©ç”¨spring-bootåˆ›å»ºäº†ä¸€ä¸ªæœºå™¨ç®€å•çš„å·¥ç¨‹ï¼Œä¾èµ–ç‰ˆæœ¬ 1.5.4.RELEASE","text":"SpringMVCä¹‹è¯·æ±‚å‚æ•°çš„è·å–æ–¹å¼ å¸¸è§çš„ä¸€ä¸ªwebæœåŠ¡ï¼Œå¦‚ä½•è·å–è¯·æ±‚å‚æ•°ï¼Ÿ ä¸€èˆ¬æœ€å¸¸è§çš„è¯·æ±‚ä¸ºGETå’ŒPOSTï¼Œgetè¯·æ±‚çš„å‚æ•°åœ¨urlä¸Šå¯ä»¥è·å–ï¼Œpostè¯·æ±‚å‚æ•°é™¤äº†urlä¸Šè¿˜æœ‰å¯èƒ½åœ¨è¡¨å•ä¸­ï¼Œæ–‡ä»¶ä¸Šä¼ æ—¶ï¼Œè·å–æ–¹å¼åˆå’Œä¸€èˆ¬çš„å‚æ•°è·å–ä¸ä¸€æ · æœ¬ç¯‡åˆ™ä¸»è¦é›†ä¸­åœ¨ä¸åŒè¯·æ±‚æ–¹å¼ä¸‹ï¼Œè·å–å‚æ•°çš„ä½¿ç”¨å§¿åŠ¿ é¦–å…ˆéœ€è¦æ­å»ºä¸€ä¸ªåç«¯çš„è¯·æ±‚ï¼Œä¸ºäº†å¿«é€Ÿæ¼”ç¤º åˆ©ç”¨spring-bootåˆ›å»ºäº†ä¸€ä¸ªæœºå™¨ç®€å•çš„å·¥ç¨‹ï¼Œä¾èµ–ç‰ˆæœ¬ 1.5.4.RELEASE I. GETè¯·æ±‚å‚æ•°è·å–getè¯·æ±‚å‚æ•°ï¼Œä¸€èˆ¬éƒ½æ˜¯ç›´æ¥æŒ‚åœ¨è¯·æ±‚çš„urlä¸Šï¼Œæ‰€ä»¥è·å–è¿™äº›å‚æ•°è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ 1. é€šè¿‡ HttpServletRequestè·å–å‚æ•°è¿™ä¸ªå¯ä»¥è¯´æ˜¯æœ€åŸºæœ¬æœ€å¸¸è§çš„çš„æ–¹å¼äº†ï¼Œjavax.servlet.ServletRequest#getParameter æ¥è·å–å¯¹åº”çš„å‚æ•°ï¼Œä¸‹é¢å„å¤„ä¸€ä¸ªå®ä¾‹ 1234567891011@RestController@RequestMapping(path = \"webs/demo\")public class DemoController &#123; @RequestMapping(path = \"req1\") public String req1(HttpServletRequest request) &#123; String user = request.getParameter(\"user\"); String password = request.getParameter(\"password\"); return \"req1 user: \" + user + \" pwd: \" + password; &#125;&#125; æ ¹æ®ä¸Šé¢æš´éœ²çš„æ¥å£ï¼Œæˆ‘ä»¬æµ‹è¯•çš„caseå°±å¾ˆç®€å•äº† 12345http://127.0.0.1:8080/webs/demo/req1?user=å°ç°ç°Blog&amp;password=123456## è¾“å‡º req1 user: å°ç°ç°Blog pwd: 123456http://127.0.0.1:8080/webs/demo/req1?user=å°ç°ç°Blog## è¾“å‡º req1 user: å°ç°ç°Blog pwd: null è¯´æ˜ è¿™æ˜¯ä¸€ä¸ªæœ€åŸºæœ¬çš„è·å–å‚æ•°çš„æ–¹å¼ï¼Œgetï¼Œpostè¯·æ±‚éƒ½é€‚ç”¨çš„ï¼Œé€šå¸¸åœ¨filter,intercepterä¸­ä¹Ÿæ˜¯å¯ä»¥é€šè¿‡HttpServletRequestå¯¹è±¡æ¥è·å–è¯·æ±‚å‚æ•° é™¤äº†è·å–å¸¸è§çš„è¯·æ±‚å‚æ•°ä¹‹å¤–ï¼ŒHttpServletRequestå¯ä»¥è·å–è¯·æ±‚å¤´çš„å®Œæ•´ä¿¡æ¯ åœ¨ä¸€æ¬¡è¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼è·å–Requestå¯¹è±¡(å½“ç„¶ä¹Ÿå¯ä»¥è·å–responseå¯¹è±¡) 12HttpServletRequest httpServletRequest = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest(); 2. ç›´æ¥æ–¹æ³•å‚æ•°è·å–ç›´æ¥ç»™å‡ºcase, è¿™ä¸ªæ–¹æ³•ä¾ç„¶æ˜¯æ”¾åœ¨ä¸Šé¢çš„DemoControllerä¸‹é¢çš„ 1234@RequestMapping(path = \"req2\")public String req2(String user, String password) &#123; return \"req2 user: \" + user + \" pwd: \" + password;&#125; è¯·æ±‚éªŒè¯ 12345678910http://127.0.0.1:8080/webs/demo/req2?user=%E5%B0%8F%E7%81%B0%E7%81%B0Blog&amp;password=123456## è¾“å‡ºï¼š req2 user: å°ç°ç°Blog pwd: 123456http://127.0.0.1:8080/webs/demo/req2?password=123456## è¾“å‡ºï¼š req2 user: null pwd: 123456http://127.0.0.1:8080/webs/demo/req2?password=123456&amp;User=blog## è¾“å‡ºï¼š req2 user: null pwd: 123456 æ³¨æ„ï¼š ä¸Šé¢è¿™ç§ä½¿ç”¨æ–¹å¼ï¼Œç›¸å½“äºç›´æ¥å°†urlå‚æ•°æ˜ å°„åˆ°äº†Controlleræ–¹æ³•çš„å‚æ•°ä¸Šäº† æ–¹æ³•å‚æ•°åå¿…é¡»å’Œurlå‚æ•°åå®Œå…¨ä¸€è‡´ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰ é¡ºåºæ— å…³ è‹¥å‚æ•°æ²¡ä¼ ï¼Œåˆ™é»˜è®¤ä¸ºnull ä¸€ä¸ªç–‘é—® ä¸Šé¢çš„demoä¸­Controllerçš„æ–¹æ³•å‚æ•°éƒ½æ˜¯Stringè¿˜å¥½ï¼Œå¦‚æœå°†passwordæ”¹æˆintï¼Œä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µ ä»£ç ç¨ä½œä¿®æ”¹ 1234@RequestMapping(path = \"req2\")public String req2(String user, int password) &#123; return \"req2 user: \" + user + \" pwd: \" + password;&#125; å®é™…æµ‹è¯• 12345678910111213# case1 http://127.0.0.1:8080/webs/demo/req2?password=123456&amp;user=blog## è¾“å‡ºï¼š req2 user: blog pwd: 123456# case 2http://127.0.0.1:8080/webs/demo/req2?password2=123456&amp;user=blog## è¾“å‡º: æŠ¥é”™, Optional int parameter 'password' is present but cannot be translated into a null value due to being declared as a primitive type. Consider declaring it as object wrapper for the corresponding primitive type# case 3http://127.0.0.1:8080/webs/demo/req2?password=abc&amp;user=blog## è¾“å‡ºï¼šæŠ¥é”™, \"Failed to convert value of type 'java.lang.String' to required type 'int'; nested exception is java.lang.NumberFormatException: For input string: \"abc\"\" ç»“æœè¯´æ˜ å¦‚æœè¯·æ±‚å‚æ•°ä¸æ–¹æ³•å‚æ•°ç±»å‹ä¸ä¸€è‡´ï¼Œä¼šæŠ›å‡ºè½¬æ¢å¼‚å¸¸ å¦‚æœæ–¹æ³•å‚æ•°ä¸ºéå°è£…åŸºæœ¬ç±»å‹ï¼Œåˆ™urlå‚æ•°å¿…é¡»å­˜åœ¨ï¼Œå¦åˆ™æŠ¥é”™ 3. RequestParamæ³¨è§£æ–¹å¼è·å–è¯·æ±‚å‚æ•°é€šè¿‡@RequestParamæ³¨è§£è·å–å‚æ•°çš„æ–¹å¼å’Œä¸Šé¢çš„ä¸€ç§æ¯”è¾ƒç±»ä¼¼ï¼Œcaseå¦‚ä¸‹ 12345@RequestMapping(path = \"req3\", method = RequestMethod.GET)public String req3(@RequestParam(\"user\") String username, @RequestParam(\"password\") String pwd) &#123; return \"req3 user: \" + username + \" pwd: \" + pwd;&#125; æµ‹è¯•case 12345678# case1 http://127.0.0.1:8080/webs/demo/req3?password=123456&amp;user=blog## è¾“å‡º: req3 user: blog pwd: 123456# case2http://127.0.0.1:8080/webs/demo/req3?password=123456## è¾“å‡ºï¼šæŠ¥é”™ï¼Œ Required String parameter 'user' is not presen è¯´æ˜ ä¸æŒ‡å®šæ³¨è§£çš„nameæˆ–valueå±æ€§æ—¶ï¼Œç­‰åŒäºç¬¬äºŒç§ä½¿ç”¨å§¿åŠ¿ æ³¨è§£çš„nameå±æ€§æˆ–valueå±æ€§ï¼Œç”¨å®é™…çš„å‚æ•°åæ¥æŒ‡å®š controllerçš„å‚æ•°åä¸urlå‚æ•°åæ²¡æœ‰å¼ºå…³è”ï¼ˆåŒºåˆ«ç¬¬äºŒç§æ–¹å¼ï¼‰ å‚æ•°ç±»å‹éœ€è¦ä¿è¯ä¸€è‡´ï¼ˆé€šç¬¬äºŒç§æ–¹å¼ï¼‰ å¦‚æœurlå‚æ•°å¯é€‰ï¼Œè¯·è®¾ç½®requireå±æ€§ä¸ºfalseï¼Œå¦‚ä¸‹1@RequestParam(name = \"user\", required = false) String username 4. Beanæ–¹å¼è·å–å‚æ•°å¯¹äºè¯·æ±‚å‚æ•°æ¯”è¾ƒå¤æ‚çš„æƒ…å†µä¸‹ï¼Œæˆ‘æ¯”è¾ƒå–œæ¬¢è¿™ç§ä½¿ç”¨å§¿åŠ¿ï¼Œç®¡ç†èµ·æ¥æ–¹ä¾¿ç®€å• 12345678910@Datapublic static class UserDO &#123; String user; String password;&#125;@RequestMapping(path = \"req4\", method = RequestMethod.GET)public String req4(UserDO userDO) &#123; return \"req4 userDO: \" + userDO;&#125; æµ‹è¯•case 12345678# case1http://127.0.0.1:8080/webs/demo/req4?password=123456&amp;user=%E5%B0%8F%E7%81%B0%E7%81%B0Blog## è¾“å‡º: req4 userDO: DemoController.UserDO(user=å°ç°ç°Blog, password=123456)# case2http://127.0.0.1:8080/webs/demo/req4?password=123456## è¾“å‡º: req4 userDO: DemoController.UserDO(user=null, password=123456) è¯´æ˜ å®šä¹‰ä¸€ä¸ªbeanï¼Œå†…éƒ¨å±æ€§å’Œè¯·æ±‚å‚æ•°å¯¹åº” å…è®¸å‚æ•°ä¸å­˜åœ¨çš„æƒ…å†µï¼Œä¼šä½¿ç”¨nullä»£æ›¿ï¼ˆæ‰€ä»¥ï¼Œå°½é‡ä¸è¦ä½¿ç”¨éå°è£…åŸºæœ¬ç±»å‹ï¼Œå¦åˆ™å‚æ•°ä¸ä¼ æ—¶ï¼Œä¼šæŠ›å¼‚å¸¸ï¼‰ beançš„å±æ€§ï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µæŒ‡å®šç±»å‹ 5. ModelAttributeæ³¨è§£æ–¹å¼@ModelAttributeæ³¨è§£çš„æ–¹æ³•ï¼Œä¼šä¼˜äºControllerä¹‹å‰æ‰§è¡Œï¼Œä¸€èˆ¬æ›´å¸¸è§äºå‘è§†å›¾ä¼ è¾“æ•°æ®ä½¿ç”¨ï¼Œæ­¤å¤„ä¸è¯¦ç»†å±•å¼€ï¼Œæ­£å¸¸æ¥è®²ï¼Œä¸“é—¨çš„è·å–å‚æ•°ä¸å¤ªä¼šç”¨è¿™è¿™ç§æ–¹å¼æ¥ç© 6. Pathå‚æ•°Pathå‚æ•°ï¼Œä¸“æŒ‡çš„æ˜¯è¯·æ±‚è·¯å¾„çš„å‚æ•°ï¼Œå¦‚ 1http://127.0.0.1:8080/webs/demo/req4?password=123456 ä¸Šé¢è¿™ä¸ªurlä¸­ï¼Œpasswordæ˜¯æˆ‘ä»¬ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„è¯·æ±‚å‚æ•°ï¼Œå…¶ä¸­pathå‚æ•°åˆ™æ˜¯æŒ‡å…¶ä¸­ req4, demoè¿™ç§pathè·¯å¾„ä¸­çš„ä¸€ç¯ï¼›å¯¹æ­¤ï¼Œæœ€å¸¸è§çš„ä¸€ä¸ªcaseå°±æ˜¯å¸¸è§çš„åšå®¢ä¸­,å¦‚å¼€æºä¸­å›½çš„ä¸€ä¸ªåšå®¢é“¾æ¥ 1https://my.oschina.net/u/566591/blog/1601400 566591 : è¿™ä¸ªå‚æ•°ä¸»è¦ç”¨æ¥åŒºåˆ†ç”¨æˆ· 1601400 : è¿™ä¸ªå‚æ•°åˆ™ä¸»è¦æ˜¯è¡¨ç¤ºå¯¹åº”çš„åšæ–‡ ä¸€èˆ¬pathå‚æ•°çš„è·å–æ–¹å¼å¦‚ä¸‹ 1234@RequestMapping(path = \"req6/&#123;user&#125;/info\")public String req6(@PathVariable(name = \"user\") String user) &#123; return \"req6 user: \" + user;&#125; æµ‹è¯•case 1234567891011# case1 http://127.0.0.1:8080/webs/demo/req6/blog/info?user=haha## è¾“å‡ºï¼šreq6 user: blog# case2http://127.0.0.1:8080/webs/demo/req6/blog?user=haha## è¾“å‡º: 404# case3http://127.0.0.1:8080/webs/demo/req6/info?user=haha## è¾“å‡º: 404 æ³¨æ„: pathå‚æ•°çš„ä½¿ç”¨ï¼Œéœ€è¦ç¡®ä¿å‚æ•°å­˜åœ¨ä¸”ç±»å‹åŒ¹é… pathå‚æ•°å’Œurlå‚æ•°ä¸ä¼šç›¸äº’å½±å“ II. POSTè¯·æ±‚å‚æ•°è·å–POSTè¯·æ±‚å‚æ•°ï¼Œæ›´å¤šçš„æ˜¯çœ‹æäº¤è¡¨å•å‚æ•°æ˜¯å¦å¯ä»¥è·å–åˆ°ï¼Œä»¥åŠå¦‚ä½•è·å–ï¼Œä¸»è¦çš„æ‰‹æ®µä¾ç„¶æ˜¯ä¸Šé¢å‡ ç§æ–¹å¼ï¼Œä¸‹é¢éªŒè¯ä¸‹æ˜¯å¦ok 1. HttpServletRequestæ–¹å¼è·å–å‚æ•°æµ‹è¯•caseï¼Œå¯ä»¥å€ŸåŠ©curlæ¥å®ç°postè¯·æ±‚ 123456789101112# case1 curl -d \"user=å°ç°ç°Blog&amp;password=123456\" \"http://127.0.0.1:8080/webs/demo/req1\"## è¾“å‡ºï¼š req1 user: å°ç°ç°Blog pwd: 123456# case2curl -d \"user=å°ç°ç°Blog\" \"http://127.0.0.1:8080/webs/demo/req1?password=123456\"## è¾“å‡ºï¼šreq1 user: å°ç°ç°Blog pwd: 12345# case3curl -d \"user=å°ç°ç°Blog\" \"http://127.0.0.1:8080/webs/demo/req1?user=greyBlog\"## è¾“å‡ºï¼šreq1 user: greyBlog pwd: null curlä¹Ÿå¯ä»¥æ¢æˆjsè¯·æ±‚æµ‹è¯•æ–¹å¼ 1234567891011var formData = new FormData();formData.append(\"user\", \"å°ç°ç°Blog\");$.ajax(&#123; url: 'http://127.0.0.1:8080/webs/demo/req1?password=123456', type: 'post', cache: false, data: formData, processData: false, contentType: false&#125;); è¯´æ˜ å¯¹äºHttpServletReuqestæ–¹å¼è·å–å‚æ•°æ—¶ï¼Œgetå’Œpostæ²¡ä»€ä¹ˆåŒºåˆ« è‹¥urlå‚æ•°å’Œè¡¨å•å‚æ•°åŒåäº†ï¼Œæµ‹è¯•ç»“æœæ˜¾ç¤ºä½¿ç”¨çš„æ˜¯urlå‚æ•°ï¼ˆå¾…ç¡®è®¤ï¼Œå½“ç„¶æœ€å¥½ä¸è¦è¿™ä¹ˆå¹²ï¼‰ 2. æ–¹æ³•å‚æ•°è·å–å‡ ä¸ªæµ‹è¯•demoå¦‚ä¸‹ 12345678910111213# case 1curl -d \"user=å°ç°ç°Blog&amp;password=123456\" \"http://127.0.0.1:8080/webs/demo/req2\"## è¾“å‡ºï¼š req2 user: å°ç°ç°Blog pwd: 123456# case 2curl -d \"password=123456\" \"http://127.0.0.1:8080/webs/demo/req2\"## è¾“å‡ºï¼šreq2 user: null pwd: 123456# case 3curl -d \"password=123456\" \"http://127.0.0.1:8080/webs/demo/req2?user=blog\"## è¾“å‡ºï¼š req2 user: blog pwd: 123456 åŸºæœ¬ä¸Šä½¿ç”¨å§¿åŠ¿å’Œgetæ²¡ä»€ä¹ˆåŒºåˆ« 3. RequestParamæ³¨è§£æ–¹å¼12345678910111213# case 1curl -d \"password=123456&amp;user=blog\" \"http://127.0.0.1:8080/webs/demo/req3\"## è¾“å‡ºï¼š req3 user: blog pwd: 123456# case 2curl -d \"password=123456\" \"http://127.0.0.1:8080/webs/demo/req3?user=blog\"## è¾“å‡ºï¼š req3 user: blog pwd: 123456# case 3curl -d \"password=123456&amp;user=blog\" \"http://127.0.0.1:8080/webs/demo/req3?password=900\"## è¾“å‡ºï¼šreq3 user: blog pwd: 900,123456 æ³¨æ„ å’Œå‰é¢çš„ä¸¤ç§æ–¹å¼ä¸åŒçš„æ˜¯ï¼Œå½“postè¡¨å•çš„å‚æ•°å’Œurlå‚æ•°åŒåæ—¶ï¼Œä¼šåˆå¹¶æˆä¸€ä¸ªå­—ç¬¦ä¸² 4. Beanæ–¹å¼12345678910111213## case1 curl -d \"password=123456&amp;user=blog\" \"http://127.0.0.1:8080/webs/demo/req4?password=900\"## è¾“å‡º req4 userDO: DemoController.UserDO(user=blog, password=900,123456)## case2curl -d \"password=123456&amp;user=blog\" \"http://127.0.0.1:8080/webs/demo/req4\"## è¾“å‡º req4 userDO: DemoController.UserDO(user=blog, password=123456)## case3curl -d \"password=123456\" \"http://127.0.0.1:8080/webs/demo/req4\"## è¾“å‡º req4 userDO: DemoController.UserDO(user=null, password=123456) è¿™ç§æ–¹å¼ä¸åŒºåˆ†get,postï¼Œæ‰€ä»¥å®Œå…¨å¤æ‚çš„äº¤äº’æ¥å£ï¼Œå®Œå…¨å¯ä»¥è€ƒè™‘ç”¨beançš„æ–¹å¼æ¥å®šä¹‰è¯·æ±‚å‚æ•° 5. PathVariableè¿™ä¸ªæ²¡æ³•ç©â€¦ III. å¤šåª’ä½“ä¸Šä¼ å‚æ•°è·å– ä¸Šä¼ æ–‡ä»¶çš„æ”¯æŒï¼Œå¯¹äºä¼ ç»Ÿçš„spring-mvcæ¥è¯´ï¼Œå¯èƒ½éœ€è¦ä¸€äº›æ·»åŠ ä¸€äº›ç›¸å…³é…ç½®ï¼Œä¸åœ¨æœ¬æ–‡çš„èŒƒç•´å†…ï¼Œä¸‹é¢é»˜è®¤å·²ç»é…ç½®å¥½ 1. å®ä¾‹æ”¯æŒ1234567891011121314@RequestMapping(path = &#123;\"wx/upload\", \"wx/wx/upload\"&#125;, method = &#123;RequestMethod.GET, RequestMethod.POST, RequestMethod.OPTIONS&#125;)@ResponseBodypublic String upload(HttpServletRequest request) &#123; MultipartFile file = null; if (request instanceof MultipartHttpServletRequest) &#123; file = ((MultipartHttpServletRequest) request).getFile(\"image\"); &#125; if (file == null) &#123; throw new IllegalArgumentException(\"å›¾ç‰‡ä¸èƒ½ä¸ºç©º!\"); &#125; return \"success\";&#125; ç®€å•æ¥è¯´ï¼Œä¸»è¦æ˜¯åˆ©ç”¨HttpServletRequestæ¥è·å–ä¸Šä¼ çš„æ–‡ä»¶ æ³¨æ„ï¼š å¦‚æœæ¥å£å¿…é¡»è¦æ±‚ä¸Šä¼ æ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥æŠŠå‚æ•°å£°æ˜ä¸º MultipartHttpServletRequestï¼Œ æ­¤æ—¶è°ƒç”¨æ–¹å¦‚æœä¸ä¼ å‚æ•°ï¼Œä¼šè¢«å¼‚å¸¸æ‹¦æˆªï¼ˆå¯ä»¥é€šè¿‡@ControllerAdviceæ¥æ‹¦æˆªå…¨å±€å¼‚å¸¸ï¼‰ å¦‚æœå¯ä»¥ä¸ä¸Šä¼ æ–‡ä»¶ï¼Œåˆ™å¯ä»¥ç”¨ä¸Šé¢çš„è¿™ç§çŒ¥çå§¿åŠ¿ï¼Œå†…éƒ¨è¿›è¡Œåˆ¤æ–­ ((MultipartHttpServletRequest) request).getFile(xxx)æ¥è·å–æŒ‡å®šåçš„ä¸Šä¼ æ–‡ä»¶ IV. å°ç»“1. äº”ç§è·å–å‚æ•°çš„å§¿åŠ¿ æ–¹å¼ æ³¨æ„äº‹é¡¹ HttpServletRequestè·å–å‚æ•° æœ€å¸¸è§é€šç”¨ æ–¹æ³•å‚æ•°ä¸è¯·æ±‚å‚æ•°åŒå æ³¨æ„å‚æ•°åç»Ÿä¸€ï¼Œæ³¨æ„ç±»å‹ä¸€è‡´ï¼Œå°½é‡ä¸ç”¨éåŒ…è£…åŸºæœ¬ç±»å‹ @RequestParamæ³¨è§£ åŒä¸Šï¼Œå¯æ³¨è§£å†…æŒ‡å®šhttpå‚æ•°å Beanæ–¹å¼ å®šä¹‰ä¸€ä¸ªbeanï¼Œä¼šå°†åŒåçš„httpå‚æ•°èµ‹å€¼è¿›å»ï¼Œæ¨è @PathVariable æ³¨è§£ è¯·æ±‚urlå‚æ•° 2. ä¼ æ–‡ä»¶ä½¿ç”¨å§¿åŠ¿ä½¿ç”¨MultipartHttpServletRequestæ¥è·å–ä¸Šä¼ çš„æ–‡ä»¶ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è·å–åŸºæœ¬çš„è¯·æ±‚å‚æ•° V. å…¶ä»–å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è§£ä¸å…¨ï¼Œå¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ æ‰«æå…³æ³¨ï¼Œjavaåˆ†äº«","categories":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"Spring","slug":"Java/Spring","permalink":"https://zbang.online/hexblog/categories/Java/Spring/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"Spring","slug":"Spring","permalink":"https://zbang.online/hexblog/tags/Spring/"},{"name":"RequestParam","slug":"RequestParam","permalink":"https://zbang.online/hexblog/tags/RequestParam/"}],"keywords":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"Spring","slug":"Java/Spring","permalink":"https://zbang.online/hexblog/categories/Java/Spring/"}]},{"title":"jvmè°ƒä¼˜çš„å·¥å…·ä»‹ç»","slug":"jvmè°ƒä¼˜çš„å·¥å…·ä»‹ç»","date":"2018-01-03T06:18:35.000Z","updated":"2018-02-13T03:21:17.019Z","comments":true,"path":"2018/01/03/jvmè°ƒä¼˜çš„å·¥å…·ä»‹ç»/","link":"","permalink":"https://zbang.online/hexblog/2018/01/03/jvmè°ƒä¼˜çš„å·¥å…·ä»‹ç»/","excerpt":"jvmè°ƒä¼˜å®æˆ˜ç¬”è®°ä¹‹åŸºç¡€çŸ¥è¯†ç®€ä»‹I. èƒŒæ™¯ javaåç«¯ï¼Œæä¾›äº†ä¸€ä¸ªsvgæ¸²æŸ“çš„æœåŠ¡ï¼Œåœ¨qpsè¾ƒå¤§æ—¶ï¼Œä¼šå‡ºç°é¢‘ç¹çš„gcï¼Œè€Œæ­¤æ—¶çš„æœåŠ¡å™¨æ€§èƒ½æœ¬èº«å¹¶æ²¡æœ‰è¾¾åˆ°ç“¶é¢ˆï¼ˆcpu,load,ioéƒ½ä¸å¤ªé«˜ï¼‰å› æ­¤è€ƒè™‘è°ƒæ•´ä¸€ä¸‹jvmçš„ç›¸å…³å‚æ•°ï¼Œçœ‹æ˜¯å¦å¯ä»¥æå‡æœåŠ¡æ€§èƒ½","text":"jvmè°ƒä¼˜å®æˆ˜ç¬”è®°ä¹‹åŸºç¡€çŸ¥è¯†ç®€ä»‹I. èƒŒæ™¯ javaåç«¯ï¼Œæä¾›äº†ä¸€ä¸ªsvgæ¸²æŸ“çš„æœåŠ¡ï¼Œåœ¨qpsè¾ƒå¤§æ—¶ï¼Œä¼šå‡ºç°é¢‘ç¹çš„gcï¼Œè€Œæ­¤æ—¶çš„æœåŠ¡å™¨æ€§èƒ½æœ¬èº«å¹¶æ²¡æœ‰è¾¾åˆ°ç“¶é¢ˆï¼ˆcpu,load,ioéƒ½ä¸å¤ªé«˜ï¼‰å› æ­¤è€ƒè™‘è°ƒæ•´ä¸€ä¸‹jvmçš„ç›¸å…³å‚æ•°ï¼Œçœ‹æ˜¯å¦å¯ä»¥æå‡æœåŠ¡æ€§èƒ½ jvmç›¸å…³å‚æ•°è®°å½• 12-XX:+CMSClassUnloadingEnabled -XX:CMSInitiatingOccupancyFraction=80 -XX:CMSMaxAbortablePrecleanTime=5000 -XX:+CMSParallelRemarkEnabled -XX:+CMSScavengeBeforeRemark -XX:+ExplicitGCInvokesConcurrent -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/xxx/java.hprof -XX:InitialCodeCacheSize=134217728 -XX:InitialHeapSize=4294967296 -XX:MaxDirectMemorySize=1073741824 -XX:MaxHeapSize=4294967296 -XX:MaxMetaspaceSize=268435456 -XX:MaxNewSize=2147483648 -XX:MetaspaceSize=268435456 -XX:NewSize=2147483648 -XX:OldPLABSize=16 -XX:+PrintGC -XX:+PrintGCDateStamps -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:ReservedCodeCacheSize=268435456 -XX:SurvivorRatio=10 -XX:+UseCMSCompactAtFullCollection -XX:+UseCMSInitiatingOccupancyOnly -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseConcMarkSweepGC -XX:+UseParNewGC 2. ç›‘æ§å·¥å…·ä½¿ç”¨tsarä½œä¸ºæœåŠ¡å™¨æ€§èƒ½ç›‘æ§å·¥å…·ï¼Œæ‰€ä»¥å‰ææ˜¯å…ˆå®‰è£…tsar 12345wget -O tsar.zip https://github.com/alibaba/tsar/archive/master.zip --no-check-certificateunzip tsar.zipcd tsarmakemake install ç›‘æ§å‘½ä»¤ 1tsar --cpu --swap -i1 -l è¯´æ˜ tsarç›¸å…³å¯ä»¥å‚è€ƒï¼š Linuxç³»ç»Ÿæ€§èƒ½ç›‘æ§å·¥å…·ä»‹ç»ä¹‹-tsar II. ç›¸å…³çŸ¥è¯†ç‚¹ç®€ä»‹æˆªå–å‡ æ¡gcæ—¥å¿— 1234562018-01-02T10:49:20.390+0800: 9.015: [GC (Allocation Failure) 2018-01-02T10:49:20.390+0800: 9.015: [ParNew: 1922431K-&gt;134118K(1922432K), 0.1486593 secs] 1934749K-&gt;201350K(4019584K), 0.1487460 secs] [Times: user=0.33 sys=0.05, real=0.14 secs]2018-01-02T10:49:25.374+0800: 13.999: [GC (Allocation Failure) 2018-01-02T10:49:25.374+0800: 13.999: [ParNew: 1881830K-&gt;93708K(1922432K), 0.0910714 secs] 1949062K-&gt;197949K(4019584K), 0.0911833 secs] [Times: user=0.26 sys=0.01, real=0.09 secs]2018-01-02T10:55:53.013+0800: 401.639: [GC (GCLocker Initiated GC) 2018-01-02T10:55:53.013+0800: 401.639: [ParNew: 1841429K-&gt;142552K(1922432K), 0.0629031 secs] 1945670K-&gt;246793K(4019584K), 0.0630512 secs] [Times: user=0.14 sys=0.01, real=0.06 secs]2018-01-02T10:55:55.076+0800: 403.701: [GC (GCLocker Initiated GC) 2018-01-02T10:55:55.076+0800: 403.701: [ParNew: 1890281K-&gt;59983K(1922432K), 0.0661778 secs] 1994522K-&gt;201875K(4019584K), 0.0663176 secs] [Times: user=0.15 sys=0.01, real=0.07 secs]2018-01-02T11:47:25.271+0800: 3493.897: [GC (Allocation Failure) 2018-01-02T11:47:25.271+0800: 3493.897: [ParNew: 1807695K-&gt;20975K(1922432K), 0.0193077 secs] 1949587K-&gt;162867K(4019584K), 0.0195351 secs] [Times: user=0.04 sys=0.00, real=0.02 secs]2018-01-02T11:56:50.621+0800: 4059.247: [GC (GCLocker Initiated GC) 2018-01-02T11:56:50.622+0800: 4059.247: [ParNew: 1774543K-&gt;108899K(1922432K), 0.0401606 secs] 1916434K-&gt;250791K(4019584K), 0.0403586 secs] [Times: user=0.10 sys=0.00, real=0.04 secs] 1. CMS GCæ—¥å¿—æ ¼å¼åˆ†ææˆªå–ä¸Šé¢æ—¥å¿—ä¸­çš„ç¬¬ä¸€æ¡ï¼Œåˆ†åˆ«è¯´æ˜æ¯ä¸€é¡¹æ˜¯ä»€ä¹ˆæ„æ€ 2018-01-02T10:49:20.390+0800: 9.015: [GC (Allocation Failure) 2018-01-02T10:49:20.390+0800: 9.015: [ParNew: 1922431K-&gt;134118K(1922432K), 0.1486593 secs] 1934749K-&gt;201350K(4019584K), 0.1487460 secs] [Times: user=0.33 sys=0.05, real=0.14 secs] 2018-01-02T10:49:20.390+0800 ï¼šå‘ç”Ÿgcçš„æ—¶é—´ 9.015 - GCå¼€å§‹ï¼Œç›¸å¯¹JVMå¯åŠ¨çš„ç›¸å¯¹æ—¶é—´ï¼Œå•ä½æ˜¯ç§’ GC - åŒºåˆ«FullGCå’ŒMinorGCçš„æ ‡è¯†ï¼Œæ­¤å¤„è¡¨ç¤ºä¸ºMinorGC (Allocation Failure) - å‘ç”Ÿgcçš„åŸå› ï¼Œæ­¤å¤„è¡¨ç¤ºç©ºé—´ä¸è¶³ï¼Œå¯¼è‡´åˆ†é…å¤±è´¥ ParNew â€“ æ”¶é›†å™¨çš„åç§°ï¼Œå®ƒé¢„ç¤ºäº†å¹´è½»ä»£ä½¿ç”¨ä¸€ä¸ªå¹¶è¡Œçš„ mark-copy stop-the-world åƒåœ¾æ”¶é›†å™¨ 1922431K-&gt;134118K â€“ æ”¶é›†å‰åå¹´è½»ä»£çš„ä½¿ç”¨æƒ…å†µï¼Œæœªå›æ”¶ä¹‹å‰ï¼Œå¤§å°ä¸º1922431K, å›æ”¶å®Œæ¯•ä¹‹åï¼Œå¤§å°ä¸º134118K, æ‰€ä»¥å›æ”¶å¤§å°ä¸º: 1922431K - 134118K (1922432K) - æ•´ä¸ªå¹´è½»ä»£çš„å®¹é‡ 0.1486593 secs - è¿™ä¸ªè§£é‡Šç”¨åŸæ»‹åŸå‘³çš„è§£é‡Šï¼šDuration for the collection w/o final cleanup. 1934749K-&gt;201350K - æ”¶é›†å‰åæ•´ä¸ªå †çš„ä½¿ç”¨æƒ…å†µ (4019584K) - æ•´ä¸ªå †çš„å®¹é‡ 0.1487460 secs â€“ ParNewæ”¶é›†å™¨æ ‡è®°å’Œå¤åˆ¶å¹´è½»ä»£æ´»ç€çš„å¯¹è±¡æ‰€èŠ±è´¹çš„æ—¶é—´ï¼ˆåŒ…æ‹¬å’Œè€å¹´ä»£é€šä¿¡çš„å¼€é”€ã€å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£æ—¶é—´ã€åƒåœ¾æ”¶é›†å‘¨æœŸç»“æŸä¸€äº›æœ€åçš„æ¸…ç†å¯¹è±¡ç­‰çš„èŠ±é”€ï¼‰ï¼› [Times: user=0.78 sys=0.01, real=0.11 secs] â€“ GCäº‹ä»¶åœ¨ä¸åŒç»´åº¦çš„è€—æ—¶ï¼Œå…·ä½“çš„ç”¨è‹±æ–‡è§£é‡Šèµ·æ¥æ›´åŠ åˆç†: user â€“ Total CPU time that was consumed by Garbage Collector threads during this collection sys â€“ Time spent in OS calls or waiting for system event real â€“ Clock time for which your application was stopped. With Parallel GC this number should be close to (user time + system time) divided by the number of threads used by the Garbage Collector. In this particular case 8 threads were used. Note that due to some activities not being parallelizable, it always exceeds the ratio by a certain amount. 2. CMSç®€ä»‹ åç«¯æœåŠ¡é€‰ç”¨çš„å°±æ˜¯CMSï¼Œé‚£ä¹ˆå°±æœ‰å¿…è¦çœ‹ä¸€ä¸‹è¿™ä¸ªCMSåˆ°åº•æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ CMSConcurrent Mark Sweep æ”¶é›†å™¨ï¼Œæ˜¯ä¸€ç§ä»¥è·å–æœ€çŸ­å›æ”¶åœé¡¿æ—¶é—´ä¸ºç›®æ ‡çš„æ”¶é›†å™¨ï¼Œæ ¸å¿ƒå°±æ˜¯æ ‡ç­¾-æ¸…é™¤ç®—æ³• æ­¥éª¤åˆ’åˆ† åˆå§‹æ ‡è®° (CMS initial mark) : æ ‡è®°GC Rootsèƒ½ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡ï¼Œé€Ÿåº¦å¾ˆå¿«ï¼Œä¼šæš‚åœ å¹¶å‘æ ‡è®° (CMS concurrent mark) : è¿›è¡Œ GC Roots Tracingçš„è¿‡ç¨‹ é‡æ–°æ ‡è®° (CMS remark) : ä¸ºäº†ä¿®æ­£å¹¶å‘æ ‡è®°æœŸé—´ï¼Œå› ä¸ºç¨‹åºç»§ç»­è¿ä½œå¯¼è‡´æ ‡è®°å˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†å¯¹è±¡çš„æ ‡è®°è®°å½•ï¼Œä¸€èˆ¬ä¼šé•¿äºåˆå§‹æ ‡è®°æ—¶é—´ï¼Œè¿œå°äºå¹¶å‘æ ‡è®°çš„æ—¶é—´ å¹¶å‘æ¸…é™¤ (CMS concurrent sweep) : è¯´æ˜ï¼Œåˆå§‹æ ‡è®°å’Œé‡æ–°æ ‡è®°çš„æ—¶å€™ï¼Œä¼šæš‚åœæœåŠ¡ï¼›åé¢ä¸¤ä¸ªåˆ™æ˜¯å¹¶å‘ä¿®æ”¹ æ ‡è®°æ¸…é™¤ç®—æ³•ä¸€å¥è¯æè¿°ï¼š æ ‡è®°æ‰€æœ‰éœ€è¦å›æ”¶çš„å¯¹è±¡ï¼Œåœ¨æ ‡è®°å®Œæˆåï¼Œç»Ÿä¸€å›æ”¶æ‰€æœ‰è¢«æ ‡è®°çš„å¯¹è±¡ å¸¸è§çš„ä¸¤ä¸ªé—®é¢˜ï¼š æ•ˆç‡ä¸é«˜ï¼›å›æ”¶åå¤§é‡çš„ç¢ç‰‡ 3. å†…å­˜åˆ†é…å’Œå›æ”¶ç­–ç•¥a. å¯¹è±¡ä¼˜å…ˆåœ¨Edenåˆ†é…å¤§å¤šæ•°åœºæ™¯ä¸‹ï¼Œå¯¹è±¡åœ¨æ–°ç”Ÿä»£EdenåŒºåˆ†é…ï¼Œå½“Edenå»æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´è¿›è¡Œåˆ†é…æ—¶ï¼Œè™šæ‹Ÿæœºå‘èµ·ä¸€æ¬¡ Minor GC æ–°ç”Ÿä»£MinorGC ï¼š å‘ç”Ÿåœ¨æ–°ç”Ÿä»£çš„åƒåœ¾æ”¶é›†åŠ¨ä½œï¼Œå› ä¸ºjavaå¯¹è±¡å¤§å¤šéƒ½å…·å¤‡æœç”Ÿå¤•ç­çš„ç‰¹æ€§æ˜¯ï¼Œæ‰€ä»¥ä¸€èˆ¬MinorGCéå¸¸é¢‘ç¹ï¼Œä¸€èˆ¬å›æ”¶é€Ÿåº¦ä¹Ÿå¾ˆå¿« è€å¹´ä»£MajorGC(FullGC) : å‘ç”Ÿåœ¨è€å¹´ä»£çš„GCï¼Œé€šå¸¸å°±ä¼´éšè‡³å°‘ä¸€æ¬¡çš„MinorGCï¼ˆéç»å¯¹ï¼‰ï¼Œä¸€èˆ¬è¾ƒæ…¢ï¼Œæ˜¯MinorGCçš„åå€ä»¥ä¸Š b. å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£éœ€è¦å¤§é‡è¿ç»­å†…å­˜ç©ºé—´çš„Javaå¯¹è±¡ï¼Œé€šå¸¸æ˜¯æ•°ç»„ï¼ŒåŒæ„ -XX:PretenuresizeThreshold å‚æ•°ï¼Œæ¥è®¾ç½®å¤§å¯¹è±¡çš„é˜€å€¼ï¼Œè¶…è¿‡è¿™ä¸ªé˜€å€¼çš„ç›´æ¥åˆ†é…åœ¨å¹´è€ä»£ï¼Œé¿å…åœ¨EdenåŒºåŠä¸¤ä¸ªSurvivoråŒºæŒ‡å°–å‘ç”Ÿå¤§é‡çš„å†…å­˜å¤åˆ¶ c. é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£æ—¢ç„¶è™šæ‹Ÿæœºé‡‡ç”¨åˆ†ä»£æ”¶é›†çš„æ€æƒ³æ¥ç®¡ç†å†…å­˜ï¼Œåœ¨å›æ”¶æ—¶ï¼Œå°±å¿…é¡»èƒ½è¯†åˆ«å“ªäº›å¯¹è±¡åº”æ”¾åœ¨æ–°ç”Ÿä»£ï¼Œé‚£äº›å¯¹è±¡åº”æ”¾åœ¨è€å¹´ä»£ä¸­ æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸ªAgeçš„è®¡æ•°å™¨ï¼Œå¯¹è±¡åœ¨Edenå‡ºç”Ÿå¹¶ç»è¿‡ç¬¬ä¸€æ¬¡MinorGCåä»å­˜åœ¨ï¼Œä¸”å¯ä»¥è¢«Survivorå®¹çº³çš„è¯ï¼Œä¼šè¢«ç§»åŠ¨åˆ°Survivorç©ºé—´ä¸­ï¼Œå¹¶è®¾ç½®Ageä¸º1 å¯¹è±¡åœ¨SurvivoråŒºæ²¡å¤šç»è¿‡ä¸€æ¬¡MinorGCï¼Œåˆ™age+1 å½“ageè¶…è¿‡é˜€å€¼ï¼ˆé»˜è®¤15ï¼‰ï¼Œå°±ä¼šæ™‹å‡åˆ°è€å¹´ä»£ é˜€å€¼å¯ä»¥é€šè¿‡ -XX:MaxTenuringThresholdæ¥è®¾ç½® d. åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®šå¦‚æœåœ¨Survivorç©ºé—´ä¸­ç›¸åŒå¹´é¾„æ‰€æœ‰å¯¹è±¡çš„å¤§å°çš„æ€»å’Œï¼Œå¤§äºSurvivorç©ºé—´çš„ä¸€åŠï¼Œåˆ™å¹´é¾„å¤§äºæˆ–ç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡å°±å¯ä»¥è¿›å…¥è€å¹´ä»£ï¼Œæ— åºç­‰Ageè¾¾åˆ°é˜€å€¼ e. ç©ºé—´åˆ†é…æ‹…ä¿åœ¨å‘ç”ŸMinorGCä¹‹å‰ï¼Œè™šæ‹Ÿæœºä¼šå…ˆæ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨çš„è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºæ–°ç”Ÿä»£æ‰€æœ‰å¯¹è±¡æ€»ç©ºé—´ï¼Œå¦‚æœæˆç«‹ï¼Œåˆ™Minor GCå¯ä»¥ç¡®ä¿æ€»æ˜¯å®‰å…¨çš„ï¼› å¦åˆ™ï¼ŒæŸ¥çœ‹ HandlePromotionFailureå‚æ•°ï¼Œæ˜¯å¦å…è®¸æ‹…ä¿å¤±è´¥ è‹¥å…è®¸ï¼Œåˆ™ç»§ç»­æ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨çš„è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºå†æ¬¡æ™‹å‡åˆ°è€å¹´ä»£å¯¹è±¡çš„å¹³å‡å¤§å°ï¼Œè‹¥å¤§äºï¼Œåˆ™å°è¯•MinorGC å¦åˆ™è¿›è¡ŒFullGC 3. jstat å‘½ä»¤ç®€ä»‹ æ—¢ç„¶é—®é¢˜æ˜¯é¢‘ç¹çš„gcå¼•èµ·çš„ï¼Œé‚£ä¹ˆè§‚å¯Ÿæ–°ç”Ÿä»£ï¼Œè€å¹´ä»£å¯¹è±¡å ç”¨ç©ºé—´çš„æƒ…å†µå°±ä¸å¯é¿å…äº†ï¼Œæ‰€ä»¥jstatå‘½ä»¤ä¸å¾—ä¸å‡ºç°äº† æˆªä¸€ä¸ªçº¿ç¨‹å›¾ 1234567$ jstat -gcutil 11573 1000 5 S0 S1 E O M CCS YGC YGCT FGC FGCT GCT 0.00 34.39 24.68 68.01 98.12 96.30 3051 170.096 242 18.429 188.525 0.00 34.39 26.29 68.01 98.12 96.30 3051 170.096 242 18.429 188.525 0.00 34.39 27.45 68.01 98.12 96.30 3051 170.096 242 18.429 188.525 0.00 34.39 28.32 68.01 98.12 96.30 3051 170.096 242 18.429 188.525 0.00 34.39 29.93 68.01 98.12 96.30 3051 170.096 242 18.429 188.525 a. å‚æ•°è¯´æ˜ -gcutil ï¼š ç›‘è§†Javaå¯¹çŠ¶å†µï¼ŒåŒ…æ‹¬EdenåŒºã€ä¸¤ä¸ªsurvivoråŒºï¼Œè€å¹´ä»£ï¼Œæ°¸ä¹…ä»£ç­‰ï¼Œå·²ç”¨ç©ºé—´ï¼Œgcæ—¶é—´ç­‰ 11573ï¼š javaè¿›ç¨‹å· 1000ï¼š æ¯1såˆ·æ–°ä¸€æ¬¡ 5ï¼š ä¸€å…±æŸ¥è¯¢5æ¬¡ b. è¾“å‡ºè¯´æ˜ S0, S1: è¡¨ç¤ºä¸¤ä¸ª survivoråŒº E(Eden) : æ–°ç”Ÿä»£Eden O(Old) : è€å¹´ä»£Old M(metaspace) : å…ƒç©ºé—´,æœ¬åœ°å†…å­˜ï¼Œ åœ¨1.8ç§»é™¤äº†æ°¸ä¹…ä»£æ”¹æˆè¿™ä¸ª YGC : ç¨‹åºè¿è¡Œä»¥æ¥ï¼Œå‘ç”ŸMinor GC(Young GC)æ¬¡æ•° YGCT : Minor GC æ€»è€—æ—¶ï¼ˆå•ä½s) FGC : Full GCçš„æ€»æ¬¡æ•° FGCT : Full GCçš„æ€»è€—æ—¶ ï¼ˆå•ä½s) GCT : æ‰€æœ‰GCçš„æ€»è€—æ—¶ ï¼ˆå•ä½s) III. ç›‘æ§æµ‹è¯•0. å‡†å¤‡a. é¦–å…ˆæ˜¯è·å–å¯¹åº”çš„è¿›ç¨‹å·12jps -ljinfo xxx æŠ“å›¾ 123$ jps -l30916 sun.tools.jps.Jps2909 org.apache.catalina.startup.Bootstrap b. æœåŠ¡å™¨æ€§èƒ½ç›‘æ§å‘½ä»¤12## ä¸»è¦æŸ¥çœ‹cpuå’Œnginxè®¿é—®çš„ç›‘æ§tsar --cpu --nginx -i1 -l æŠ“å›¾: 12345678Time -----------------------cpu---------------------- ----------------------------------nginx---------------------------------Time user sys wait hirq sirq util accept handle reqs active read write wait qps rt03/01/18-11:29:37 16.54 1.50 0.00 0.00 0.00 18.05 2.00 2.00 6.00 15.00 0.00 1.00 14.00 6.00 89.5003/01/18-11:29:38 26.07 1.75 0.00 0.00 0.00 27.82 3.00 3.00 10.00 15.00 0.00 1.00 14.00 10.00 47.1003/01/18-11:29:39 19.60 1.01 0.00 0.00 0.00 20.60 4.00 4.00 11.00 15.00 0.00 1.00 14.00 11.00 37.8203/01/18-11:29:40 28.75 2.50 0.00 0.00 0.25 31.50 2.00 2.00 10.00 15.00 0.00 1.00 14.00 10.00 79.3003/01/18-11:29:41 14.07 1.51 0.00 0.00 0.00 15.58 1.00 1.00 10.00 15.00 0.00 3.00 12.00 10.00 51.3003/01/18-11:29:42 20.60 1.01 0.00 0.00 0.00 21.61 6.00 6.00 13.00 15.00 0.00 1.00 14.00 13.00 44.69 c. jvmå†…å­˜çš„ç›‘æ§1jstat -gcutil 4354 1000 æŠ“å›¾: 123456$ jstat -gcutil 2909 1000 S0 S1 E O M CCS YGC YGCT FGC FGCT GCT 29.03 0.00 66.34 16.34 98.57 96.32 200 6.393 0 0.000 6.393 29.03 0.00 66.37 16.34 98.57 96.32 200 6.393 0 0.000 6.393 29.03 0.00 66.50 16.34 98.57 96.32 200 6.393 0 0.000 6.393 29.03 0.00 66.54 16.34 98.57 96.32 200 6.393 0 0.000 6.393 d. æŸ¥çœ‹å†…å­˜ä¸­å¯¹è±¡çš„ä¸ªæ•°å’Œå¤§å°1jmap -histo 4354 æŠ“å›¾ 123456789101112num #instances #bytes class name---------------------------------------------- 1: 78179 181546608 [I 2: 1259 175880312 [S 3: 35915 65527520 [B 4: 242125 40558408 [C 5: 571604 13718496 java.util.concurrent.atomic.AtomicLong 6: 233282 5598768 java.lang.String 7: 55177 5296992 java.util.jar.JarFile$JarFileEntry 8: 119906 3836992 java.util.HashMap$Node 9: 33327 2932776 java.lang.reflect.Method 10: 1147 2303216 [Ljava.util.concurrent.atomic.AtomicLong; e. å‹æµ‹æ¨¡æ‹Ÿå·¥å…·Jmetter æ·»åŠ çº¿ç¨‹ç»„ æ–°å¢httpè¯·æ±‚ æ·»åŠ ç›‘å¬å™¨ä¸­ï¼Œç»“æœçš„ç›‘æ§ï¼šå›¾å½¢ç»“æœï¼ŒèšåˆæŠ¥å‘Šï¼ŒæŸ¥çœ‹ç»“æœæ ‘ï¼Œç”¨è¡¨æ ¼æŸ¥çœ‹ç»“æœ httpè¯·æ±‚ä¸­é…ç½®å‚æ•° åè®® åŸŸåor IP + ç«¯å£å· ç¼–ç : utf-8 è¯·æ±‚æ–¹æ³• + è¯·æ±‚è·¯å¾„ è¯·æ±‚å‚æ•°ï¼Œæ”¯æŒæ–‡ä»¶ä¸Šä¼ ï¼Œæ³¨æ„ç¼–ç æ–¹å¼ IV. å‚è€ƒ Linuxç³»ç»Ÿæ€§èƒ½ç›‘æ§å·¥å…·ä»‹ç»ä¹‹-tsar tsarä½¿ç”¨è¯´æ˜ JVMè°ƒä¼˜â€”â€”ä¹‹CMS GCæ—¥å¿—åˆ†æ jvmçš„GCæ—¥å¿—åˆ†æ JVM è¿è¡Œæ—¶å†…å­˜ä½¿ç”¨æƒ…å†µç›‘æ§ ã€Šæ·±å…¥ç†è§£JVMè™šæ‹Ÿæœºã€‹ V. å…¶ä»–å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è§£ä¸å…¨ï¼Œå¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ æ‰«æå…³æ³¨ï¼Œjavaåˆ†äº«","categories":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"JVM","slug":"Java/JVM","permalink":"https://zbang.online/hexblog/categories/Java/JVM/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"JVM","slug":"JVM","permalink":"https://zbang.online/hexblog/tags/JVM/"}],"keywords":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"JVM","slug":"Java/JVM","permalink":"https://zbang.online/hexblog/categories/Java/JVM/"}]},{"title":"JDKå­¦ä¹ ä¹‹åå°„çš„ä½¿ç”¨å§¿åŠ¿ä¸€è§ˆ","slug":"JDKå­¦ä¹ ä¹‹åå°„çš„ä½¿ç”¨å§¿åŠ¿ä¸€è§ˆ","date":"2017-12-29T12:26:51.000Z","updated":"2018-02-08T04:06:14.096Z","comments":true,"path":"2017/12/29/JDKå­¦ä¹ ä¹‹åå°„çš„ä½¿ç”¨å§¿åŠ¿ä¸€è§ˆ/","link":"","permalink":"https://zbang.online/hexblog/2017/12/29/JDKå­¦ä¹ ä¹‹åå°„çš„ä½¿ç”¨å§¿åŠ¿ä¸€è§ˆ/","excerpt":"åå°„çš„å­¦ä¹ ä½¿ç”¨ æ—¥å¸¸çš„å­¦ä¹ å·¥ä½œä¸­ï¼Œå¯èƒ½ç”¨åˆ°åå°„çš„åœ°æ–¹ä¸å¤ªå¤šï¼Œä½†çœ‹çœ‹ä¸€äº›ä¼˜ç§€æ¡†æ¶çš„æºç ï¼Œä¼šå‘ç°åŸºæœ¬ä¸Šéƒ½ç¦»ä¸å¼€åå°„çš„ä½¿ç”¨ï¼›å› æ­¤æœ¬ç¯‡åšæ–‡å°†ä¸“æ³¨ä¸‹å¦‚ä½•ä½¿ç”¨åå°„ æœ¬ç‰‡åšæ–‡å¸ƒå±€å¦‚ä¸‹: åå°„æ˜¯ä»€ä¹ˆï¼Œæœ‰ä»€ä¹ˆç”¨ï¼Œå¯ä»¥åšä»€ä¹ˆ å¦‚ä½•ä½¿ç”¨åå°„ å®ä¾‹ï¼š åˆ©ç”¨åå°„æ–¹å¼ï¼Œè·å–ä¸€ä¸ªç±»çš„æ‰€æœ‰æˆå‘˜å˜é‡çš„nameåŠå€¼ é€šè¿‡åå°„æ–¹å¼ï¼Œä¿®æ”¹å¯¹è±¡çš„ç§æœ‰æˆå‘˜å˜é‡ ä¼šé€šè¿‡å†™ä¸€ä¸ªBeanUtilså®ç°å¯¹è±¡çš„æˆå‘˜å˜é‡å€¼æ‹·è´æ¥è¦†ç›–ä¸Šé¢ä¸¤ä¸ªåœºæ™¯","text":"åå°„çš„å­¦ä¹ ä½¿ç”¨ æ—¥å¸¸çš„å­¦ä¹ å·¥ä½œä¸­ï¼Œå¯èƒ½ç”¨åˆ°åå°„çš„åœ°æ–¹ä¸å¤ªå¤šï¼Œä½†çœ‹çœ‹ä¸€äº›ä¼˜ç§€æ¡†æ¶çš„æºç ï¼Œä¼šå‘ç°åŸºæœ¬ä¸Šéƒ½ç¦»ä¸å¼€åå°„çš„ä½¿ç”¨ï¼›å› æ­¤æœ¬ç¯‡åšæ–‡å°†ä¸“æ³¨ä¸‹å¦‚ä½•ä½¿ç”¨åå°„ æœ¬ç‰‡åšæ–‡å¸ƒå±€å¦‚ä¸‹: åå°„æ˜¯ä»€ä¹ˆï¼Œæœ‰ä»€ä¹ˆç”¨ï¼Œå¯ä»¥åšä»€ä¹ˆ å¦‚ä½•ä½¿ç”¨åå°„ å®ä¾‹ï¼š åˆ©ç”¨åå°„æ–¹å¼ï¼Œè·å–ä¸€ä¸ªç±»çš„æ‰€æœ‰æˆå‘˜å˜é‡çš„nameåŠå€¼ é€šè¿‡åå°„æ–¹å¼ï¼Œä¿®æ”¹å¯¹è±¡çš„ç§æœ‰æˆå‘˜å˜é‡ ä¼šé€šè¿‡å†™ä¸€ä¸ªBeanUtilså®ç°å¯¹è±¡çš„æˆå‘˜å˜é‡å€¼æ‹·è´æ¥è¦†ç›–ä¸Šé¢ä¸¤ä¸ªåœºæ™¯ I. åå°„å®šä¹‰ æŒ‡ç¨‹åºå¯ä»¥è®¿é—®ã€æ£€æµ‹å’Œä¿®æ”¹å®ƒæœ¬èº«çŠ¶æ€æˆ–è¡Œä¸ºçš„ä¸€ç§èƒ½åŠ› ç›´æ¥è¯´å®šä¹‰çš„è¯ï¼Œå¯èƒ½å¹¶ä¸èƒ½éå¸¸æ¸…æ™°çš„è§£é‡Šè¯´æ˜ï¼Œç»“åˆä½œç”¨è¿›è¡Œæè¿° åå°„å¯ä»¥å¹²ä»€ä¹ˆï¼Ÿ 1234åœ¨è¿è¡Œæ—¶æ„é€ ä»»æ„ä¸€ä¸ªç±»çš„å¯¹è±¡ã€‚åœ¨è¿è¡Œæ—¶åˆ¤æ–­ä»»æ„ä¸€ä¸ªå¯¹è±¡æ‰€å±çš„ç±»ã€‚åœ¨è¿è¡Œæ—¶åˆ¤æ–­ä»»æ„ä¸€ä¸ªç±»æ‰€å…·æœ‰çš„æˆå‘˜å˜é‡å’Œæ–¹æ³•ã€‚åœ¨è¿è¡Œæ—¶è°ƒç”¨ä»»æ„ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³• æœ‰äº†ä¸Šé¢å››ç‚¹ï¼ŒåŸºæœ¬ä¸Šä½ æƒ³å¹²å˜›å°±å¯ä»¥å¹²å˜›ï¼Œæ¯”å¦‚æˆ‘ç°åœ¨å°±æœ‰ä¸‹é¢è¿™ä¸ªç±» 1234567891011121314151617181920212223242526272829public class RefectTest extends MyRefect implements IRefect &#123; private static String s1 = \"hello\"; private static int s2 = 100; private int s3 = 200; private boolean ans; protected RefectTest next; public RefectTest() &#123; &#125; public RefectTest(int s3, boolean ans, RefectTest next) &#123; this.s3 = s3; this.ans = ans; this.next = next; &#125; public RefectTest next() &#123; return next; &#125; private int count(int a, int b) &#123; return a + b; &#125;&#125; ç°åœ¨æˆ‘æœ‰äº†clz,å…¶èµ‹å€¼è¯­å¥ä¸º Class clz = RefectTest.classï¼Œ é‚£ä¹ˆæˆ‘å¯ä»¥å¹²å•¥ï¼Ÿ åˆ›å»ºä¸€ä¸ª RefectTest å¯¹è±¡ 123456// è‹¥æœ‰é»˜è®¤æ„é€ æ–¹æ³•RefectTest instance = clz.newIntance();// è‹¥éœ€è¦ä¼ å‚æ•°Constructor con = clz.getConstructor(int.class, boolean.class, RefectTest.class);RefectTest instance2 = con.newInstance(10, true, new RefectTest()); åˆ¤æ–­çˆ¶ç±»æ˜¯å¦æ˜¯ MyRefect 12// åˆ¤æ–­MyRefectæ˜¯å¦ä¸ºclzçš„çˆ¶ç±»boolean ans = MyRefect.class.isAssignableFrom(clz); è·å–æ‰€æœ‰çš„æˆå‘˜å˜é‡ 12// è·å–æ‰€æœ‰çš„æˆå‘˜å˜é‡ï¼ˆåŒ…æ‹¬ç§æœ‰çš„ï¼‰Field[] fields = clz.getDeclaredFields(); è·å–æ‰€æœ‰çš„æ–¹æ³• 12// è·å–æ‰€æœ‰çš„æˆå‘˜æ–¹æ³•ï¼ˆåŒ…æ‹¬ç§æœ‰æ–¹æ³•ï¼‰Method[] methods = clz.getDeclaredMethods(); ä¸Šé¢ç»™å‡ºäº†å¯ä»¥å¹²äº›ä»€ä¹ˆï¼Œå¹¶ç»™äº†å¯¹åº”çš„ç®€å•ç¤ºä¾‹ï¼Œå¼•å…¥äº†å‡ ä¸ªæ–°çš„ç±»Constructor, Field, Methodï¼Œ ä¸‹é¢å°†è¯¦ç»†è§£é‡Šè¿™ä¸‰ä¸ªç±»æ˜¯ä»€ä¹ˆï¼Œæ€ä¹ˆç”¨ II. åå°„çš„ä½¿ç”¨åŠªåŠ›ç»“åˆå®é™…çš„åº”ç”¨åœºæ™¯ï¼Œç»™å‡ºæ¯ç§åˆ©ç”¨åå°„çš„å®ç°å¯¹åº”éœ€æ±‚çš„ä½¿ç”¨å§¿åŠ¿ï¼Œæœ‰äº›åœºæ™¯å¯èƒ½å¹¶ä¸æ˜¯ç‰¹åˆ«è´´åˆ‡ï¼Œæ¬¢è¿æå‡ºç»™åˆé€‚çš„åœºæ™¯ä»¥æ­¤è¿›è¡Œæ›¿æ¢ 1. é€šè¿‡åå°„åˆ›å»ºå¯¹è±¡ è¿™æ˜¯ä¸ªæ¯”è¾ƒå¸¸è§çš„åœºæ™¯ï¼Œæˆ‘åœ¨ä½¿ç”¨äº†è‡ªå®šä¹‰æ³¨è§£æ—¶ï¼Œé€šå¸¸ä¼šè¿™ä¹ˆæ™š åº”ç”¨åœºæ™¯ï¼š æˆ‘å®šä¹‰äº†ä¸€ä¸ªæ ¡éªŒå™¨çš„æ³¨è§£ValDotï¼Œæ³¨è§£ä¸­æœ‰ä¸ªæ ¡éªŒè§„åˆ™classå¯¹è±¡ï¼Œå¦‚ä¸‹ 1234567891011121314151617public interface ICheckRule &#123; boolean check(Object ... obj);&#125;public class DefaultCheckRule implements ICheckRule &#123; @Override public boolean check(Object... obj) &#123; return false; &#125;&#125;@Retention(RetentionPolicy.RUNTIME)@Target(ElementType.METHOD)public @interface CheckDot &#123; // æ ¡éªŒè§„åˆ™ Class&lt;? extends ICheckRule&gt; check() default DefaultCheckRule.class;&#125; ä¸Šé¢å®šä¹‰äº†æ³¨è§£å’Œæ ¡éªŒæ¡ä»¶ï¼Œæ¥ç€è¿›å…¥æ•´ä½“ï¼Œåœ¨åˆ‡é¢ä¸­ï¼Œéœ€è¦è·å– 1234567891011121314@Aspect@Componentpublic class CheckAspect &#123; @Before(\"@annotation(checkDot)\") public void process(JoinPoint joinPoint, CheckDot checkDot) throws IllegalAccessException, InstantiationException &#123; // æ³¨æ„ï¼Œè¿™é‡Œè·å–æ³¨è§£ä¸Šçš„æ ¡éªŒè§„åˆ™ç±»ï¼Œå¹¶è·å–å®ä¾‹ ICheckRule rule = checkDot.check().newInstance(); if(rule.check(joinPoint.getArgs())) &#123; throw new IllegalStateException(\"check argument error!\"); &#125; &#125;&#125; ä¸Šé¢æ˜¯ä¸€ä¸ªè¾ƒå¥½çš„åˆ©ç”¨åå°„è·å–å®ä¾‹çš„åº”ç”¨åœºæ™¯ï¼Œæƒ³ä¸€æƒ³ï¼Œå¦‚æœä¸ç”¨åå°„ï¼Œè¿™ä¸ªæ ¡éªŒè§„åˆ™æ€ä¹ˆä¼ è¿›æ¥å‘¢ï¼Œè¿™ä¸ªæ—¶å€™å°±æ²¡é‚£ä¹ˆæ–¹ä¾¿äº†ï¼ˆå½“ç„¶ä¹Ÿä¸æ˜¯ä¸å¯ä»¥ï¼Œæœ€ç®€å•çš„å°±æ˜¯æ‹¿ä¸€ä¸ªHolderæŒæœ‰ç±»ååˆ°ç±»å¯¹è±¡çš„æ˜ å°„å…³ç³»ï¼Œç„¶ååœ¨æ³¨è§£ä¸­ä¼ ç±»åï¼Œä¹Ÿå¯ä»¥è¾¾åˆ°ä¸Šé¢çš„æ•ˆæœï¼‰ è¿˜æœ‰ä¸€ç§åœºæ™¯å¯èƒ½å°±æ¯”è¾ƒè›‹ç–¼äº†ï¼Œå¦‚æœä¸€ä¸ªç±»æ²¡æœ‰é»˜è®¤æ„é€ æ–¹æ³•ï¼Œé€šè¿‡åå°„å°±æ²¡æ³•ç›´æ¥ç”¨class.newInstanace()äº† Constructoræ„é€ å™¨ç±» æ ¹æ®Classä¼˜å…ˆè·å–åˆ° Constructor å¯¹è±¡ï¼Œç„¶åä¼ å…¥éœ€è¦çš„æ„é€ å‚æ•°, æµ‹è¯•å¦‚ä¸‹ 1234567891011121314151617181920212223public class ConTest &#123; private int a,b; public ConTest(int a, int b) &#123; this.a = a; this.b = b; &#125; @Override public String toString() &#123; return \"ConTest&#123;\" + \"a=\" + a + \", b=\" + b + '&#125;'; &#125; public static void main(String[] args) throws Exception &#123; Class clz = ConTest.class; // è·å–å¯¹åº”çš„æ„é€ å™¨ï¼ˆæ³¨æ„å‚æ•°ç±»å‹ï¼‰ Constructor constructor = clz.getConstructor(int.class, int.class); // åˆ›å»ºå®ä¾‹ï¼ˆæ³¨æ„å‚æ•°è¦åŒ¹é…ï¼‰ ConTest test = (ConTest) constructor.newInstance(10, 20); System.out.println(test.toString()); &#125;&#125; è¾“å‡º 1ConTest&#123;a=10, b=20&#125; ä¸€èˆ¬å¸¸ç”¨ä¸‹é¢å››ç§æ–¹å¼è·å– 1234567891011// æ ¹æ®å‚æ•°ç±»å‹è·å–åŒ¹é…çš„æ„é€ å™¨Constructor getConstructor(Class[] params)// è·å–æ‰€æœ‰çš„Constructor[] getConstructors()// ç›¸æ¯”è¾ƒå‰é¢çš„ï¼Œè¿™é‡Œå¯ä»¥è·å–ç§æœ‰æ–¹æ³•Constructor getDeclaredConstructor(Class[] params)// å¯ä»¥è·å–ç§æœ‰æ–¹æ³•Constructor[] getDeclaredConstructors() 2. åˆ¤æ–­classçš„ç»§æ‰¿å…³ç³»åˆ¤æ–­æ˜¯å¦ä¸ºåŸºç¡€æ•°æ®ç±»å‹åŸºæœ¬ç±»å‹è¾ƒä¸ºç‰¹æ®Šï¼Œæ‰€ä»¥JDKå¾ˆäººæ€§åŒ–çš„ç»™å°è£…äº†ä¸€ä¸ªæ–¹æ³•ï¼ŒClass#isPrimitive å› æ­¤è¿”å›trueçš„ç±»å‹æœ‰: int long short byte char boolean å°è£…åçš„ç±»å‹ï¼Œè¿”å›çš„ä¾ç„¶æ˜¯false é™„å¸¦ä¸€å¥ï¼Œæ˜¯æ²¡æœ‰null.classè¿™ç§ç”¨æ³•çš„ åˆ¤æ–­æ˜¯å¦ä¸ºå¦ä¸€ä¸ªç±»çš„å­ç±»ï¼Œå¦ä¸€ä¸ªæ¥å£çš„å®ç°ç±»é€šå¸¸æˆ‘ä»¬åˆ©ç”¨ instanceof å…³é”®å­—æ¥åˆ¤æ–­ç»§æ‰¿å…³ç³»ï¼Œä½†æ˜¯è¿™ä¸ªæ˜¯é’ˆå¯¹å¯¹è±¡æ¥çš„ï¼Œç°åœ¨ç»™ä¸€ä¸ªclassï¼Œè¦æ€ä¹ˆç©ï¼Ÿ çœ‹ä¸‹é¢ï¼Œä¸»è¦å°±æ˜¯ Class#isAssignableFrom() çš„åŠŸåŠ³äº† 1234567891011121314151617181920212223public class ExtendTest &#123; interface ITest &#123;&#125; abstract class ATest &#123; abstract public void print(); &#125; class TestClz extends ATest implements ITest &#123; @Override public void print() &#123; System.out.println(\"TestClz\"); &#125; &#125; public static void main(String[] args) &#123; Class clz = TestClz.class; System.out.println(ATest.class.isAssignableFrom(clz)); System.out.println(ITest.class.isAssignableFrom(clz)); &#125;&#125; éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œçˆ¶ç±»ä½œä¸ºè°ƒç”¨æ–¹ï¼Œå­ç±»ä½œä¸ºå‚æ•° ç»“åˆæ³›å‹æ—¶ï¼Œè·å–æ³›å‹çš„å®é™…ç±»å‹æ³›å‹ï¼Œåˆæ˜¯ä¸€ä¸ªæœ‰æ„æ€çš„åŠŸèƒ½ï¼Œè¿™é‡Œä¸å¤šè¯´ï¼Œç»§æ‰¿ä¸€ä¸ªæ³›å‹åŸºç±»ï¼Œç„¶åé—®é¢˜æ˜¯å¦‚ä½•é€šè¿‡åå°„è·å¾—æ³›å‹ç­¾åä¸­çš„ç±»å‹ï¼Œä¸€èˆ¬ä¼šåœ¨ç»§æ‰¿æˆ–å®ç°æ³›å‹æ¥å£æ—¶ä¼šç”¨åˆ°å®ƒã€‚ 123456789class A&lt;T, ID&gt; &#123;&#125;class B extends A&lt;String, Integer&gt; &#123;&#125;public static void main(String[] args) &#123; System.out.println(B.class.getGenericSuperclass());&#125; æ¢æˆæ³›å‹æ¥å£å‘¢ ? 12345678910111213interface A&lt;T, ID&gt; &#123; &#125; class B implements A&lt;String, Integer&gt; &#123; &#125;public static void main(String[] args) &#123; ParameterizedType parameterizedType = (ParameterizedType) B.class.getGenericInterfaces()[0]; Type[] actualTypeArguments = parameterizedType.getActualTypeArguments(); for (Type actualTypeArgument : actualTypeArguments) &#123; System.out.println(actualTypeArgument); &#125;&#125; 3. è·å–æˆå‘˜å˜é‡è·å–æˆå‘˜å˜é‡ï¼Œä¸»è¦æ˜¯æ ¹æ® B.class.getDeclaredFields() æ¥è·å–æ‰€æœ‰å£°æ˜çš„å˜é‡ï¼Œè¿™ä¸ªåº”ç”¨åœºæ™¯ä¼šå’Œä¸‹é¢çš„è·å–æ–¹æ³•å¹¶æ‰§è¡Œè”åˆä¸€èµ·è¯´æ˜ 1234567891011// è·å–æŒ‡å®šçš„å…¬å…±æˆå‘˜å˜é‡Field getField(String name)// è·å¾—æ‰€æœ‰å…¬å…±å­—æ®µField[] getFields()// è·å–æŒ‡å®šå£°æ˜çš„æˆå‘˜å˜é‡ï¼ˆåŒ…æ‹¬priveï¼‰Field getDeclaredField(String name)// è·å–æ‰€æœ‰å£°æ˜çš„æˆå‘˜å˜é‡Field[] getDeclaredFields() è¿™ä¸ªä¸»è¦è¿”å› Fieldå¯¹è±¡ï¼Œç°åœ¨æœ‰äº†Fieldï¼Œå¯ä»¥åšäº›å•¥ï¼Ÿ åˆ¤æ–­æˆå‘˜çš„ä¿®é¥° Field#getModifiers() 12345678int modify = field.getModifiers();// æ˜¯å¦æ˜¯é™æ€å˜é‡boolean ans = Modifier.isStatic(modifier);// æ˜¯å¦æ˜¯å…¬å…±å˜é‡boolean ans = Modifier.isPublic(modifier);// æ˜¯å¦ä¸å¯å˜boolean ans = Modifier.isFinal(modifier);// ... è·å–æˆå‘˜çš„å˜é‡å : field#getName() è·å–æˆå‘˜å¯¹åº”çš„value: field#get(instance) å¯¹äºé™æ€æˆå‘˜ï¼Œinstanceå¯ä»¥ä¸ºnull å¯¹äºéé™æ€æˆå‘˜ï¼Œinstanceå¿…é¡»ä¸ºä¸€ä¸ªå®ä¾‹å¯¹è±¡ è·å–æ³¨è§£: field#getAnnotations() è¿™ä¸ªå°±å‰å®³äº†ï¼Œhibernateçš„æ ¡éªŒæ¡†æ¶ï¼Œåœ¨æˆå‘˜å˜é‡ä¸ŠåŠ ä¸€ä¸ªæ³¨è§£Max,å°±å¯ä»¥è®¾ç½®å‚æ•°çš„æœ€å¤§å€¼ï¼Œå…¶å®å°±æ˜¯é€šè¿‡åå°„è·å–åˆ°æ³¨è§£ï¼Œç„¶åè¿›è¡Œç›¸åº”çš„é€»è¾‘ 4. è·å–æ–¹æ³•è·å–æ–¹æ³•ï¼ŒåŒä¸Šé¢çš„å·®ä¸å¤šï¼Œä¹Ÿæœ‰å››ç§æ–¹å¼ 1234567891011// æ ¹æ®æ–¹æ³•åï¼Œå‚æ•°ç±»å‹è·å–å…¬å…±æ–¹æ³•Method getMethod(String name, Class[] params)// è·å–æ‰€æœ‰çš„å…¬å…±æ–¹æ³•Method[] getMethods()// æ ¹æ®æ–¹æ³•åï¼Œå‚æ•°ç±»å‹ï¼Œè·å–å£°æ˜çš„æ–¹æ³•ï¼ˆåŒ…æ‹¬ç§æœ‰ï¼‰Method getDeclaredMethod(String name, Class[] params)// è·å–æ‰€æœ‰å£°æ˜çš„æ–¹æ³•Method[] getDeclaredMethods() è¿”å›äº†ä¸€ä¸ªMethodç±»ï¼Œé‚£ä¹ˆè¿™ä¸ªä¸œè¥¿åˆæœ‰ä¸€äº›ä»€ä¹ˆåŠŸèƒ½ï¼Ÿ è·å–æ–¹æ³•å Method#getName() è·å–æ–¹æ³•æ‰€åœ¨çš„ç±» : Method#getDeclaringClass() è·å–æ–¹æ³•è¿”å›ç±»å‹ : Method#getReturnType() è·å–æ–¹æ³•ä¸Šçš„æ³¨è§£ : Method#getAnnotations() æ‰§è¡Œæ–¹æ³• æœ‰äº†è¿™ä¸ªå°±å¯ä»¥åšå¾ˆå¤šäº‹æƒ…äº†ï¼Œå®ä¾‹ä¸­ç»™å‡ºè¯´æ˜ 1234// è®¾ç½®æ–¹æ³•å¯è®¿é—®ï¼ˆå³ç§æœ‰æ–¹æ³•ä¹Ÿå¯ä»¥è¢«è°ƒç”¨ï¼‰method.setAccessible(true);// instanceä¸ºå®ä¾‹å¯¹è±¡ï¼Œ argsä¸ºä¼ å…¥å‚æ•°method.invoke(instance, args) III. å®ä¾‹DEMOé€šè¿‡åå°„çš„æ–¹å¼ï¼Œå®ç°ä¸€ä¸ª BeanUtilsï¼Œå®ç°Beançš„æ‹·è´ å½“ä¸€ä¸ªBeanæœ‰è¾ƒå¤šçš„æˆå‘˜å˜é‡æ—¶ï¼Œå¦‚æœæˆ‘ä»¬é‡‡ç”¨æœ€åŸå§‹çš„setXXX()æ¥ä¸€æ¬¡èµ‹å€¼çš„æ—¶å€™ï¼Œä¸€æ˜¯å®ç°æ¯”è¾ƒç¹çï¼Œå…¶æ¬¡å°±æ˜¯å½“Beançš„å­—æ®µå‘ç”Ÿå˜åŠ¨ä¹‹åï¼Œä¹Ÿéœ€è¦åŒæ­¥çš„ä¿®æ”¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å€ŸåŠ©åå°„çš„æ–¹å¼ï¼Œå®ç°ä¸€ä¸ªä¼˜é›…çš„ BeanUtils å·¥å…·ç±» 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849public class BeanUtils &#123; public static void copy(Object source, Object dest) throws Exception &#123; Class destClz = dest.getClass(); // è·å–ç›®æ ‡çš„æ‰€æœ‰æˆå‘˜ Field[] destFields = destClz.getDeclaredFields(); Object value; for (Field field : destFields) &#123; // éå†æ‰€æœ‰çš„æˆå‘˜ï¼Œå¹¶èµ‹å€¼ // è·å–valueå€¼ value = getVal(field.getName(), source); field.setAccessible(true); field.set(dest, value); &#125; &#125; private static Object getVal(String name, Object obj) throws Exception &#123; try &#123; // ä¼˜å…ˆè·å–objä¸­åŒåçš„æˆå‘˜å˜é‡ Field field = obj.getClass().getField(name); field.setAccessible(true); return field.get(obj); &#125; catch (NoSuchFieldException e) &#123; // è¡¨ç¤ºæ²¡æœ‰åŒåçš„å˜é‡ &#125; // è·å–å¯¹åº”çš„ getXxx() æˆ–è€… isXxx() æ–¹æ³• name = name.substring(0, 1).toUpperCase() + name.substring(1); String methodName = \"get\" + name; String methodName2 = \"is\" + name; Method[] methods = obj.getClass().getMethods(); for (Method method : methods) &#123; // åªè·å–æ— å‚çš„æ–¹æ³• if (method.getParameterCount() &gt; 0) &#123; continue; &#125; if (method.getName().equals(methodName) || method.getName().equals(methodName2)) &#123; return method.invoke(obj); &#125; &#125; // æ²¡æœ‰åŒ¹é…åˆ°ï¼Œè¿™é‡Œè¿”å›nullå®é™…ä¸Šæ˜¯ä¸åˆé€‚çš„ // å› ä¸ºå¦‚æœåŸå±æ€§ä¸ºåŸºæœ¬æ•°æ®ç±»å‹ï¼Œèµ‹å€¼nullä¸ºæŠ¥é”™ throw new Exception(); &#125;&#125; IV. å°ç»“åå°„çš„å››ç§ç”¨é€” åˆ›å»ºä¸€ä¸ª RefectTest å¯¹è±¡ 123456// è‹¥æœ‰é»˜è®¤æ„é€ æ–¹æ³•RefectTest instance = clz.newIntance();// è‹¥éœ€è¦ä¼ å‚æ•°Constructor con = clz.getConstructor(int.class, boolean.class, RefectTest.class);RefectTest instance2 = con.newInstance(10, true, new RefectTest()); åˆ¤æ–­çˆ¶ç±»æ˜¯å¦æ˜¯ MyRefect 12// åˆ¤æ–­MyRefectæ˜¯å¦ä¸ºclzçš„çˆ¶ç±»boolean ans = MyRefect.class.isAssignableFrom(clz); è·å–æ‰€æœ‰çš„æˆå‘˜å˜é‡ 12// è·å–æ‰€æœ‰çš„æˆå‘˜å˜é‡ï¼ˆåŒ…æ‹¬ç§æœ‰çš„ï¼‰Field[] fields = clz.getDeclaredFields(); è·å–æ‰€æœ‰çš„æ–¹æ³• 12// è·å–æ‰€æœ‰çš„æˆå‘˜æ–¹æ³•ï¼ˆåŒ…æ‹¬ç§æœ‰æ–¹æ³•ï¼‰Method[] methods = clz.getDeclaredMethods(); ä½¿ç”¨æ³¨æ„äº‹é¡¹ æ“ä½œç§æœ‰å˜é‡ï¼Œç§æœ‰æ–¹æ³•æ—¶ï¼Œå…ˆè®¾ç½®field.setAccessible(true);ç¡®ä¿å¯è®¿é—® åå°„ä¼šå¸¦æ¥é¢å¤–çš„æ€§èƒ½å¼€é”€ å¯ä»¥ç”¨ Class#isAssignableFrom() æ¥åˆ¤æ–­ç±»ç»§æ‰¿å…³ç³» å¯ä»¥ç”¨ Class#isPrimitive()åˆ¤æ–­æ˜¯å¦ä¸ºåŸºæœ¬æ•°æ®ç±»å‹ å¯ä»¥ç”¨ Class#getGenericSuperclass() è·å–æ³›å‹ç±»å‹ V. å…¶ä»–å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è§£ä¸å…¨ï¼Œå¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ æ‰«æå…³æ³¨ï¼Œjavaåˆ†äº«","categories":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"JDK","slug":"Java/JDK","permalink":"https://zbang.online/hexblog/categories/Java/JDK/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"Reflect","slug":"Reflect","permalink":"https://zbang.online/hexblog/tags/Reflect/"}],"keywords":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"JDK","slug":"Java/JDK","permalink":"https://zbang.online/hexblog/categories/Java/JDK/"}]},{"title":"Centos å®‰è£…hexoåšå®¢","slug":"Centos-å®‰è£…hexoåšå®¢","date":"2017-12-29T10:10:43.000Z","updated":"2018-02-13T03:21:17.017Z","comments":true,"path":"2017/12/29/Centos-å®‰è£…hexoåšå®¢/","link":"","permalink":"https://zbang.online/hexblog/2017/12/29/Centos-å®‰è£…hexoåšå®¢/","excerpt":"Centoså®‰è£…hexoåšå®¢æ ¹æ®å®˜ç½‘æ¥å®‰è£…: hexo why hexoæ”¯æŒmarkdownï¼Œç®€å•ï¼Œä¸»é¢˜å¯é€‰","text":"Centoså®‰è£…hexoåšå®¢æ ¹æ®å®˜ç½‘æ¥å®‰è£…: hexo why hexoæ”¯æŒmarkdownï¼Œç®€å•ï¼Œä¸»é¢˜å¯é€‰ å®‰è£…æ­¥éª¤12345678910## 1. nodejså®‰è£…sudo yum install nodejs## 2. å®‰è£… hexosudo npm install -g hexo-clisudo npm install## 3. åˆ›å»ºhexohexo init xxxnpm install æµ‹è¯•éªŒè¯ hexo server ä½¿ç”¨è¯´æ˜1. åˆ›å»ºä¸€ä¸ªpageæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ä¹‹åï¼Œå°±å¯ä»¥åˆ›å»ºä¸€ä¸ªmenuèœå• 1hexo new page about 2. æ–°å»ºä¸€ä¸ªåšæ–‡1hexo new 'new blog' 3. æ˜¾ç¤ºç®€ä»‹åœ¨mdæ–‡ä»¶ä¸­ï¼ŒæŸä¸€ä¸ªåœ°æ–¹åœ°æ–¹æ·»åŠ  1&lt;!-- more --&gt; åˆ™åé¢çš„å†…å®¹éƒ½ä¸ä¼šæ˜¾ç¤ºåœ¨é¦–é¡µäº† 4. å¯åŠ¨12345## ç¼–è¯‘hexo g## å¯åŠ¨ä¸€ä¸ªserverhexo s 5. deployæ‰“å¼€ _config.yml æ–‡ä»¶ï¼Œæ·»åŠ é…ç½® 1234deploy: type: git repository: https://github.com/liuyueyi/blogs.git branch: master å¼€å§‹å‘å¸ƒ: 1hexo d -g è¯´æ˜ å¦‚æœgithubä¸Šï¼Œè®¿é—®ç½‘é¡µæ—¶ï¼Œæç¤ºjsæˆ–è€…css 404ï¼Œåˆ™éœ€è¦æ³¨æ„ä¸‹é¢çš„é…ç½® 1234567# URL## If your site is put in a subdirectory, set url as &apos;http://yoursite.com/child&apos; and root as &apos;/child/&apos;url: https://liuyueyi.github.io/hexblogroot: /hexblog/permalink: :year/:month/:day/:title/permalink_defaults: lang: zh-cn å…¶ä¸­URLï¼Œå’Œrootæ˜¯å…³é”®çš„è®¾ç½®å±æ€§ï¼Œrootæœ€åçš„/ä¸èƒ½æ¼æ‰ å¦‚æœæç¤ºgitæ²¡æœ‰ï¼Œåˆ™éœ€è¦å®‰è£… 1npm install hexo-deployer-git --save","categories":[{"name":"Shell","slug":"Shell","permalink":"https://zbang.online/hexblog/categories/Shell/"},{"name":"ç¯å¢ƒæ­å»º","slug":"Shell/ç¯å¢ƒæ­å»º","permalink":"https://zbang.online/hexblog/categories/Shell/ç¯å¢ƒæ­å»º/"}],"tags":[{"name":"Centos","slug":"Centos","permalink":"https://zbang.online/hexblog/tags/Centos/"},{"name":"æ•™ç¨‹","slug":"æ•™ç¨‹","permalink":"https://zbang.online/hexblog/tags/æ•™ç¨‹/"},{"name":"Hexo","slug":"Hexo","permalink":"https://zbang.online/hexblog/tags/Hexo/"}],"keywords":[{"name":"Shell","slug":"Shell","permalink":"https://zbang.online/hexblog/categories/Shell/"},{"name":"ç¯å¢ƒæ­å»º","slug":"Shell/ç¯å¢ƒæ­å»º","permalink":"https://zbang.online/hexblog/categories/Shell/ç¯å¢ƒæ­å»º/"}]},{"title":"Nginx è·¯ç”±è½¬å‘é…ç½®ç¬”è®°","slug":"Nginx-è·¯ç”±è½¬å‘é…ç½®ç¬”è®°","date":"2017-12-27T09:57:18.000Z","updated":"2018-02-13T03:21:17.018Z","comments":true,"path":"2017/12/27/Nginx-è·¯ç”±è½¬å‘é…ç½®ç¬”è®°/","link":"","permalink":"https://zbang.online/hexblog/2017/12/27/Nginx-è·¯ç”±è½¬å‘é…ç½®ç¬”è®°/","excerpt":"Nginx è·¯ç”±è½¬å‘é…ç½®ç¬”è®° ç”±äºé¢„ç®—æœ‰é™ï¼Œåªæœ‰ä¸€å°æœåŠ¡å™¨ï¼Œæƒ³è¦ç©çš„ä¸œè¥¿ä¸å°‘ï¼Œæ‰€ä»¥è¿™ä¸ªå°æœåŠ¡å™¨ä¸Šä¼šæä¾›å¤šé‡æœåŠ¡ï¼Œå› æ­¤æ¶‰åŠåˆ°çš„nginxè½¬å‘å°±å¿…æœ‰é‡è¦äº† ç”±nginxåšè¯·æ±‚ä»£ç†ï¼Œæä¾›å¤šç§æœåŠ¡ phpæ­å»ºçš„ç½‘ç«™ hexoåˆ›å»ºçš„åšå®¢ç³»ç»Ÿ spring-boot &amp; tomcatæ­å»ºçš„åå° é™æ€ç½‘é¡µ æœ¬ç‰‡é…ç½®ç¬”è®°ä¸­ï¼Œä¸»è¦é›†ä¸­ä»¥ä¸‹å‡ ä¸ªå†…å®¹ locationçš„åŒ¹é…è§„åˆ™æ˜¯æ€æ ·çš„ å¦‚ä½•å®ç°è·¯ç”±è½¬å‘ï¼ˆåå‘ä»£ç†ï¼‰ å¦‚ä½•ä¿®æ”¹è¯·æ±‚çš„è·¯å¾„ï¼ˆå¦‚è¯·æ±‚çš„æ˜¯ a/index.html æ”¹ä¸º a/public/index.htmlï¼‰","text":"Nginx è·¯ç”±è½¬å‘é…ç½®ç¬”è®° ç”±äºé¢„ç®—æœ‰é™ï¼Œåªæœ‰ä¸€å°æœåŠ¡å™¨ï¼Œæƒ³è¦ç©çš„ä¸œè¥¿ä¸å°‘ï¼Œæ‰€ä»¥è¿™ä¸ªå°æœåŠ¡å™¨ä¸Šä¼šæä¾›å¤šé‡æœåŠ¡ï¼Œå› æ­¤æ¶‰åŠåˆ°çš„nginxè½¬å‘å°±å¿…æœ‰é‡è¦äº† ç”±nginxåšè¯·æ±‚ä»£ç†ï¼Œæä¾›å¤šç§æœåŠ¡ phpæ­å»ºçš„ç½‘ç«™ hexoåˆ›å»ºçš„åšå®¢ç³»ç»Ÿ spring-boot &amp; tomcatæ­å»ºçš„åå° é™æ€ç½‘é¡µ æœ¬ç‰‡é…ç½®ç¬”è®°ä¸­ï¼Œä¸»è¦é›†ä¸­ä»¥ä¸‹å‡ ä¸ªå†…å®¹ locationçš„åŒ¹é…è§„åˆ™æ˜¯æ€æ ·çš„ å¦‚ä½•å®ç°è·¯ç”±è½¬å‘ï¼ˆåå‘ä»£ç†ï¼‰ å¦‚ä½•ä¿®æ”¹è¯·æ±‚çš„è·¯å¾„ï¼ˆå¦‚è¯·æ±‚çš„æ˜¯ a/index.html æ”¹ä¸º a/public/index.htmlï¼‰ I. locationåŒ¹é…è§„åˆ™1. è¯­æ³•123location [=|~|~*|^~|@] /uri/ &#123; ...&#125; 2. è¯´æ˜ä»ä¸Šé¢çš„è¯­æ³•å‡ºå‘ï¼Œå¯ä»¥äº†è§£åˆ°locationå¯ä»¥åŒºåˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼Œæ¥ä¸‹æ¥ä¸€ä¸ªä¸€ä¸ªçš„ç ”ç©¶ä¸€ä¸‹ a. PartOne: [=|~|~*|^~|@] = : è¡¨ç¤ºç²¾ç¡®åŒ¹é…åé¢çš„url ~ : è¡¨ç¤ºæ­£åˆ™åŒ¹é…ï¼Œä½†æ˜¯åŒºåˆ†å¤§å°å†™ ~* : æ­£åˆ™åŒ¹é…ï¼Œä¸åŒºåˆ†å¤§å°å†™ ^~ : è¡¨ç¤ºæ™®é€šå­—ç¬¦åŒ¹é…ï¼Œå¦‚æœè¯¥é€‰é¡¹åŒ¹é…ï¼ŒåªåŒ¹é…è¯¥é€‰é¡¹ï¼Œä¸åŒ¹é…åˆ«çš„é€‰é¡¹ï¼Œä¸€èˆ¬ç”¨æ¥åŒ¹é…ç›®å½• @ : â€œ@â€ å®šä¹‰ä¸€ä¸ªå‘½åçš„ locationï¼Œä½¿ç”¨åœ¨å†…éƒ¨å®šå‘æ—¶ï¼Œä¾‹å¦‚ error_page ä¸Šé¢å®šä¹‰äº†å‡ ä¸ªä¸åŒçš„ç¬¦å·ï¼Œè¡¨ç¤ºä¸åŒçš„åŒ¹é…è§„åˆ™ï¼Œé‚£ä¹ˆå…ˆåé¡ºåºå‘¢ï¼Ÿ =å‰ç¼€çš„æŒ‡ä»¤ä¸¥æ ¼åŒ¹é…è¿™ä¸ªæŸ¥è¯¢ã€‚å¦‚æœæ‰¾åˆ°ï¼Œåœæ­¢æœç´¢ã€‚ æ‰€æœ‰å‰©ä¸‹çš„å¸¸è§„å­—ç¬¦ä¸²ï¼Œæœ€é•¿çš„åŒ¹é…ã€‚å¦‚æœè¿™ä¸ªåŒ¹é…ä½¿ç”¨^ã€œå‰ç¼€ï¼Œæœç´¢åœæ­¢ã€‚ æ­£åˆ™è¡¨è¾¾å¼ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„é¡ºåºã€‚ å¦‚æœç¬¬3æ¡è§„åˆ™äº§ç”ŸåŒ¹é…çš„è¯ï¼Œç»“æœè¢«ä½¿ç”¨ã€‚å¦åˆ™ï¼Œä½¿ç”¨ç¬¬2æ¡è§„åˆ™çš„ç»“æœã€‚ ç›´æ¥çœ‹è¿™ä¸ªå¯èƒ½ä¸å¤ªå¥½ç†è§£ï¼Œå†™å‡ ä¸ªcaseå®é™…æµ‹è¯•ä¸€ä¸‹ æµ‹è¯•case1: 123456789101112131415location = /world &#123; return 600;&#125;location = /hello &#123; return 600;&#125;location ~ /hellowo &#123; return 602;&#125;location ^~ /hello &#123; return 601;&#125; 12345678- è¯·æ±‚ localhost/world è¿”å›600- è¯·æ±‚ localhost/world2 localhost/test/world è¿”å›å…¶ä»–- è¯·æ±‚ localhost/hello è¿”å›600- è¯·æ±‚ localhost/hello/123 è¿”å›601- è¯·æ±‚ localhost/hellow è¿”å›601- è¯·æ±‚ localhost/hellowo è¿”å›601- è¯·æ±‚ localhost/test/hellowo è¿”å›602- è¯·æ±‚ localhost/test/hello è¿”å›å…¶ä»– å› æ­¤å¯ä»¥çŸ¥é“ = æ˜¯ç²¾ç¡®å®Œæ•´åŒ¹é…, ä¸”ä¼˜ç§€æœ€é«˜ æ­£åˆ™åŒ¹é…æ—¶ï¼Œå¦‚æœ ~ å’Œ ^~ åŒæ—¶åŒ¹é…è§„åˆ™ï¼Œåˆ™ ^~ ä¼˜å…ˆ ^~ è¿™ä¸ªä¸ä¼šåŒ¹é…è¯·æ±‚urlä¸­åé¢çš„è·¯å¾„, å¦‚ä¸Šé¢çš„ /test/hello æ²¡æœ‰åŒ¹é…ä¸Š ^~ ä¸æ”¯æŒæ­£åˆ™ï¼Œå’Œ=ç›¸æ¯”ï¼ŒèŒƒå›´æ›´å¹¿ï¼Œ hellowo æ˜¯å¯ä»¥è¢«^~åŒ¹é…ï¼Œä½†æ˜¯ = ä¸ä¼šåŒ¹é… ~ è·¯å¾„ä¸­åªè¦åŒ…å«å°±å¯ä»¥åŒ¹é…ï¼Œå¦‚ä¸Šé¢çš„ /test/hellowo è¿”å›äº†602 æµ‹è¯•case2: 1234567location ~ /hello &#123; return 602;&#125;location ~ /helloworld &#123; return 601;&#125; 12- è¯·æ±‚ localhost/world/helloworld è¿”å› 602- è¯·æ±‚ localhost/helloworld è¿”å› 602 è°ƒæ•´ä¸€ä¸‹ä¸Šé¢çš„é¡ºåºä¹‹å 1234567location ~ /helloworld &#123; return 601;&#125;location ~ /hello &#123; return 602;&#125; 123- è¯·æ±‚ localhost/helloworld è¿”å›601- è¯·æ±‚ localhost/world/helloworld è¿”å›601- è¯·æ±‚ localhost/helloWorld è¿”å›602 æ‰€ä»¥åŒæ—¶æ­£åˆ™åŒ¹é…æ—¶ æ”¾åœ¨å‰é¢çš„ä¼˜å…ˆåŒ¹é… æ³¨æ„å¦‚æœä¸åŒºåˆ†å¤§å°å†™æ—¶ï¼Œä½¿ç”¨~* å°½é‡å°†ç²¾ç¡®åŒ¹é…çš„æ”¾åœ¨å‰é¢ æµ‹è¯•case3: 1234567location ^~ /hello/ &#123; return 601;&#125;location /hello/world &#123; return 602;&#125; è¿™ç§åœºæ™¯ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªæ²¡æœ‰ç¬¦å·çš„è·¯ç”±è§„åˆ™ï¼Œé‚£ä¹ˆå®é™…çš„æµ‹è¯•æ˜¯æ€æ ·å‘¢ï¼Ÿ 1234- http://localhost/hello/wor è¿”å›601- http://localhost/hello/world è¿”å›602- http://localhost/hello/world23 è¿”å›602- http://localhost/hello/world/123 è¿”å›602 ä»ä¸Šé¢caseå¯ä»¥çœ‹å‡º æ²¡æœ‰ç¬¦å·æ—¶ï¼Œå…¨åŒ¹é…æ˜¯ä¼˜å…ˆäº^~çš„ b. PartTwo: [uri]è¿™é‡Œä¸»è¦å¡«çš„å°±æ˜¯éœ€è¦åŒ¹é…çš„pathè·¯å¾„ï¼Œæ ¹æ®å‰é¢çš„ç¬¦å·ï¼Œè¿™é‡Œå¯ä»¥å¡«å†™ç²¾ç¡®çš„pathè·¯å¾„ï¼Œä¹Ÿå¯ä»¥å¡«æ­£åˆ™è¡¨è¾¾å¼ï¼Œä¸‹é¢åˆ™ä¸»è¦é’ˆå¯¹æ­£åˆ™è¿›è¡Œè¯´æ˜ 123456789101112. ï¼š åŒ¹é…é™¤æ¢è¡Œç¬¦ä»¥å¤–çš„ä»»æ„å­—ç¬¦? ï¼š é‡å¤0æ¬¡æˆ–1æ¬¡+ ï¼š é‡å¤1æ¬¡æˆ–æ›´å¤šæ¬¡* ï¼š é‡å¤0æ¬¡æˆ–æ›´å¤šæ¬¡\\d ï¼šåŒ¹é…æ•°å­—^ ï¼š åŒ¹é…å­—ç¬¦ä¸²çš„å¼€å§‹$ ï¼š åŒ¹é…å­—ç¬¦ä¸²çš„ä»‹ç»&#123;n&#125; ï¼š é‡å¤næ¬¡&#123;n,&#125; ï¼š é‡å¤næ¬¡æˆ–æ›´å¤šæ¬¡[c] ï¼š åŒ¹é…å•ä¸ªå­—ç¬¦c[a-z] ï¼š åŒ¹é…a-zå°å†™å­—æ¯çš„ä»»æ„ä¸€ä¸ªå°æ‹¬å·()ä¹‹é—´åŒ¹é…çš„å†…å®¹ï¼Œå¯ä»¥åœ¨åé¢é€šè¿‡$1æ¥å¼•ç”¨ï¼Œ$2è¡¨ç¤ºçš„æ˜¯å‰é¢ç¬¬äºŒä¸ª()é‡Œçš„å†…å®¹ã€‚æ­£åˆ™é‡Œé¢å®¹æ˜“è®©äººå›°æƒ‘çš„æ˜¯\\è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ã€‚ c. PartThree: {}åŒ¹é…å®Œæ¯•ä¹‹åå†…éƒ¨å®šä¹‰ä¸€äº›åˆ—çš„å¤„ç†åŠ¨ä½œï¼Œè¿™ä¸ªæ¶‰åŠåˆ°çš„ç‚¹æ¯”è¾ƒå¤šï¼Œè¿™é‡Œä¸è¯¦ç»†å±•å¼€ï¼Œåé¢æœ‰ç©ºå•ç‹¬æå‡º II. è·¯ç”±è½¬å‘ è¯·æ±‚pathåŒ¹é…åªæ˜¯ç¬¬ä¸€æ­¥ï¼ŒåŒ¹é…å®Œäº†ä¹‹åï¼Œå¦‚ä½•å°†è¯·æ±‚è½¬å‘ç»™å…¶ä»–çš„webæœåŠ¡å‘¢ï¼Ÿ 0. åå‘ä»£ç†é€šå¸¸å¯è§çš„ä¸€ç§ä½¿ç”¨å§¿åŠ¿å°±æ˜¯ä½¿ç”¨nginxï¼Œä»£ç†è¯·æ±‚ï¼Œè½¬å‘åˆ°å†…éƒ¨çš„tomactæœåŠ¡ä¸Š ä¸»è¦æ˜¯é€šè¿‡ proxy_pass è¿™ä¸ªæ¥å®ç° 123location ^~ /webs &#123; proxy_pass http://127.0.0.1:8080/webs;&#125; å°†æ‰€æœ‰ä»¥ webså¼€å¤´çš„è¯·æ±‚ï¼Œè½¬å‘ç»™8080ç«¯å£çš„tomcatæœåŠ¡ä¸Š ä¸Šé¢æ˜¯ç›´æ¥å†™æ­»è½¬å‘åˆ°ä¸€ä¸ªipä¸Šï¼Œå¦‚æœæ˜¯å¤šä¸ªæœºå™¨æä¾›æœåŠ¡å‘¢ï¼Ÿå¯ä»¥è¿™ä¹ˆç© 12345678910## ä¸‹é¢æ”¾åœ¨httpçš„æ‹¬å·å†…ï¼Œä½œä¸ºç¬¬ä¸€å±‚upstream test.online &#123; server 120.11.11.11:8080 weight=1; server 120.11.11.12:8080 weight=1;&#125;location ^~ /webs &#123; proxy_pass http://test.online; proxy_redirect default;&#125; 1. Rewriteå‘½ä»¤rewriteåŠŸèƒ½å°±æ˜¯ï¼Œä½¿ç”¨nginxæä¾›çš„å…¨å±€å˜é‡æˆ–è‡ªå·±è®¾ç½®çš„å˜é‡ï¼Œç»“åˆæ­£åˆ™è¡¨è¾¾å¼å’Œæ ‡å¿—ä½å®ç°urlé‡å†™ä»¥åŠé‡å®šå‘ã€‚ rewriteåªèƒ½æ”¾åœ¨server{},location{},if{}ä¸­ï¼Œ å¹¶ä¸”åªèƒ½å¯¹åŸŸååè¾¹çš„é™¤å»ä¼ é€’çš„å‚æ•°å¤–çš„å­—ç¬¦ä¸²èµ·ä½œç”¨, å¦‚ http://zbang.online/a/we/index.php?id=1&amp;u=str åªå¯¹/a/we/index.phpé‡å†™ã€‚ è¯­æ³•rewrite regex replacement [flag]; ä¸€ä¸ªcaseï¼Œé€šè¿‡rewriteå®ç°å¯¹urlçš„é‡å†™ï¼Œå°†ä¸‹é¢çš„ 12345678location ^~ /hexo &#123; root &apos;/Users/yihui/GitHub/&apos;;&#125;location ~ /hello &#123; rewrite ^(/hello).*$ /hexo/public/index.html last; return 603;&#125; å°†helloå¼€å¤´çš„ï¼Œå…¨éƒ¨è½¬å‘åˆ°/hexo/public/index.html III. å°ç»“1. demoå°†æ‰€æœ‰ä»¥blogå¼€å¤´çš„è¯·æ±‚ï¼Œå…¨éƒ¨è½¬å‘åˆ°æŸä¸ªåœ°æ–¹ 123location ^~ /blog &#123; root &apos;/var/www/html/blog&apos;;&#125; 2. è·¯å¾„åŒ¹é…è§„åˆ™ = : è¡¨ç¤ºç²¾ç¡®åŒ¹é…åé¢çš„url ~ : è¡¨ç¤ºæ­£åˆ™åŒ¹é…ï¼Œä½†æ˜¯åŒºåˆ†å¤§å°å†™ ~* : æ­£åˆ™åŒ¹é…ï¼Œä¸åŒºåˆ†å¤§å°å†™ ^~ : è¡¨ç¤ºæ™®é€šå­—ç¬¦åŒ¹é…ï¼Œå¦‚æœè¯¥é€‰é¡¹åŒ¹é…ï¼ŒåªåŒ¹é…è¯¥é€‰é¡¹ï¼Œä¸åŒ¹é…åˆ«çš„é€‰é¡¹ï¼Œä¸€èˆ¬ç”¨æ¥åŒ¹é…ç›®å½• @ : â€œ@â€ å®šä¹‰ä¸€ä¸ªå‘½åçš„ locationï¼Œä½¿ç”¨åœ¨å†…éƒ¨å®šå‘æ—¶ï¼Œä¾‹å¦‚ error_page åŒ¹é…é¡ºåºå¦‚ä¸‹ï¼š =å‰ç¼€çš„æŒ‡ä»¤ä¸¥æ ¼åŒ¹é…è¿™ä¸ªæŸ¥è¯¢ã€‚å¦‚æœæ‰¾åˆ°ï¼Œåœæ­¢æœç´¢ã€‚ æ‰€æœ‰å‰©ä¸‹çš„å¸¸è§„å­—ç¬¦ä¸²ï¼Œæœ€é•¿çš„åŒ¹é…ã€‚å¦‚æœè¿™ä¸ªåŒ¹é…ä½¿ç”¨^ã€œå‰ç¼€ï¼Œæœç´¢åœæ­¢ã€‚ æ­£åˆ™è¡¨è¾¾å¼ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„é¡ºåºã€‚ å¦‚æœç¬¬3æ¡è§„åˆ™äº§ç”ŸåŒ¹é…çš„è¯ï¼Œç»“æœè¢«ä½¿ç”¨ã€‚å¦åˆ™ï¼Œä½¿ç”¨ç¬¬2æ¡è§„åˆ™çš„ç»“æœã€‚ 3. è·¯ç”±è½¬å‘ é€šè¿‡ proxy_pass å¯ä»¥å®ç°åå‘ä»£ç† é€šè¿‡ rewrite å¯ä»¥å®ç°è·¯ç”±è½¬å‘ IV. å‚è€ƒ locationåŒ¹é…é¡ºåº nginx å¸¸è§æ­£åˆ™åŒ¹é…ç¬¦å·è¡¨ç¤º V. å…¶ä»–å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è¯†æœ‰é™ï¼Œå¦‚æœ‰é—®é¢˜ï¼Œè¯·ä¸åæŒ‡æ­£ï¼Œæ„Ÿæ¿€ æ‰«æå…³æ³¨ï¼Œä¸å®šæ—¶åˆ†äº«å„ç§javaå­¦ä¹ ç¬”è®°","categories":[{"name":"Shell","slug":"Shell","permalink":"https://zbang.online/hexblog/categories/Shell/"},{"name":"Nginx","slug":"Shell/Nginx","permalink":"https://zbang.online/hexblog/categories/Shell/Nginx/"}],"tags":[{"name":"Nginx","slug":"Nginx","permalink":"https://zbang.online/hexblog/tags/Nginx/"},{"name":"é…ç½®","slug":"é…ç½®","permalink":"https://zbang.online/hexblog/tags/é…ç½®/"}],"keywords":[{"name":"Shell","slug":"Shell","permalink":"https://zbang.online/hexblog/categories/Shell/"},{"name":"Nginx","slug":"Shell/Nginx","permalink":"https://zbang.online/hexblog/categories/Shell/Nginx/"}]},{"title":"Centos å®‰è£…gitbook","slug":"Centos-å®‰è£…gitbook","date":"2017-12-25T03:26:00.000Z","updated":"2017-12-29T04:16:00.000Z","comments":true,"path":"2017/12/25/Centos-å®‰è£…gitbook/","link":"","permalink":"https://zbang.online/hexblog/2017/12/25/Centos-å®‰è£…gitbook/","excerpt":"å®‰è£…è¯´æ˜ ä¸»è¦è®°å½•åœ¨centosç¯å¢ƒä¸‹å¦‚ä½•æ­å»ºä¸€ä¸ªgitbookçš„æœåŠ¡","text":"å®‰è£…è¯´æ˜ ä¸»è¦è®°å½•åœ¨centosç¯å¢ƒä¸‹å¦‚ä½•æ­å»ºä¸€ä¸ªgitbookçš„æœåŠ¡ 1. nodejså®‰è£…1sudo yum install nodejs 2. gitbookå®‰è£…12npm install gitbook -gnpm install gitbook-cli -g ä¸Šé¢æ‰§è¡Œå®Œæ¯•ï¼Œå¯èƒ½å‡ºç°ä¸€ä¸ªé—®é¢˜ 1npm: symbol SSL_set_cert_cb, version libssl.so.10 not defined in file libssl è§£å†³æ–¹æ³• 1yum update openssl 3. calibreå®‰è£…ç›´æ¥åˆ°å®˜ç½‘ä¸Šä¸‹è½½ ï¼› Â·https://calibre-ebook.com/downloadÂ· 1sudo -v &amp;&amp; wget -nv -O- https://download.calibre-ebook.com/linux-installer.py | sudo python -c &quot;import sys; main=lambda:sys.stderr.write(&apos;Download failed\\n&apos;); exec(sys.stdin.read()); main()&quot; 4. æµ‹è¯•1gitbook build . æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œä¼šå‡ºç°ä¸€ä¸ª _book ç›®å½•ï¼Œ é‡Œé¢å°±æ˜¯ç”Ÿæˆçš„é™æ€ç½‘é¡µï¼Œç›´æ¥åŠ ä¸Šå»å³å¯ 5. è¾“å‡ºpdfå¦‚æœæŠ¥é”™ 1ImportError: libGL.so.1: cannot open shared object file: No such file or directory åˆ™å®‰è£… 1yum install mesa-libGL.x86_64 å¦‚æœæŠ¥é”™ 1ImportError: libXrender.so.1: cannot open shared object file: No such file or directory 1yum install libXrender.so.1 -y å‚è€ƒæ–‡æ¡£ åŸºäºcentos6æ„å»ºç§æœ‰gitbookå¹³å°","categories":[{"name":"Shell","slug":"Shell","permalink":"https://zbang.online/hexblog/categories/Shell/"},{"name":"ç¯å¢ƒæ­å»º","slug":"Shell/ç¯å¢ƒæ­å»º","permalink":"https://zbang.online/hexblog/categories/Shell/ç¯å¢ƒæ­å»º/"}],"tags":[{"name":"Gitbook","slug":"Gitbook","permalink":"https://zbang.online/hexblog/tags/Gitbook/"},{"name":"Centos","slug":"Centos","permalink":"https://zbang.online/hexblog/tags/Centos/"},{"name":"æ•™ç¨‹","slug":"æ•™ç¨‹","permalink":"https://zbang.online/hexblog/tags/æ•™ç¨‹/"}],"keywords":[{"name":"Shell","slug":"Shell","permalink":"https://zbang.online/hexblog/categories/Shell/"},{"name":"ç¯å¢ƒæ­å»º","slug":"Shell/ç¯å¢ƒæ­å»º","permalink":"https://zbang.online/hexblog/categories/Shell/ç¯å¢ƒæ­å»º/"}]},{"title":"Javaå­¦ä¹ ä¹‹æ·±æ‹·è´æµ…æ‹·è´åŠå¯¹è±¡æ‹·è´çš„ä¸¤ç§æ–¹å¼","slug":"Javaå­¦ä¹ ä¹‹æ·±æ‹·è´æµ…æ‹·è´åŠå¯¹è±¡æ‹·è´çš„ä¸¤ç§æ–¹å¼","date":"2017-12-17T11:53:51.000Z","updated":"2018-02-08T04:06:14.096Z","comments":true,"path":"2017/12/17/Javaå­¦ä¹ ä¹‹æ·±æ‹·è´æµ…æ‹·è´åŠå¯¹è±¡æ‹·è´çš„ä¸¤ç§æ–¹å¼/","link":"","permalink":"https://zbang.online/hexblog/2017/12/17/Javaå­¦ä¹ ä¹‹æ·±æ‹·è´æµ…æ‹·è´åŠå¯¹è±¡æ‹·è´çš„ä¸¤ç§æ–¹å¼/","excerpt":"I. Javaä¹‹Clone0. èƒŒæ™¯å¯¹è±¡æ‹·è´ï¼Œæ˜¯ä¸€ä¸ªéå¸¸åŸºç¡€çš„å†…å®¹äº†ï¼Œä¸ºä»€ä¹ˆä¼šå•ç‹¬çš„æŠŠè¿™ä¸ªé¢†å‡ºæ¥è®²è§£ï¼Œä¸»è¦æ˜¯å…ˆå‰é‡åˆ°äº†ä¸€ä¸ªéå¸¸æœ‰æ„æ€çš„åœºæ™¯ æœ‰ä¸€ä¸ªä»»åŠ¡ï¼Œéœ€è¦è§£æç±»xmlæ ‡è®°è¯­è¨€ï¼Œç„¶åç”Ÿæˆdocumentå¯¹è±¡ï¼Œä¹‹åå°†ä¼šæœ‰ä¸€ç³»åˆ—é’ˆå¯¹documentå¯¹è±¡çš„æ“ä½œ é€šè¿‡å®é™…çš„æµ‹è¯•ï¼Œå‘ç°ç”ŸæˆDocumentå¯¹è±¡æ˜¯æ¯”è¾ƒè€—æ—¶çš„ä¸€ä¸ªæ“ä½œï¼Œå†åŠ ä¸Šè¿™ä¸ªä»»åŠ¡åœºæ™¯ä¸­ï¼Œéœ€è¦è§£æçš„xmlæ–‡æ¡£æ˜¯å›ºå®šçš„å‡ ä¸ªï¼Œé‚£ä¹ˆä¸€ä¸ªå¯ä»¥ä¼˜åŒ–çš„æ€è·¯å°±æ˜¯èƒ½ä¸èƒ½ç¼“å­˜ä½åˆ›å»ºåçš„Documentå¯¹è±¡ï¼Œåœ¨å®é™…ä½¿ç”¨çš„æ—¶å€™cloneä¸€ä»½å‡ºæ¥","text":"I. Javaä¹‹Clone0. èƒŒæ™¯å¯¹è±¡æ‹·è´ï¼Œæ˜¯ä¸€ä¸ªéå¸¸åŸºç¡€çš„å†…å®¹äº†ï¼Œä¸ºä»€ä¹ˆä¼šå•ç‹¬çš„æŠŠè¿™ä¸ªé¢†å‡ºæ¥è®²è§£ï¼Œä¸»è¦æ˜¯å…ˆå‰é‡åˆ°äº†ä¸€ä¸ªéå¸¸æœ‰æ„æ€çš„åœºæ™¯ æœ‰ä¸€ä¸ªä»»åŠ¡ï¼Œéœ€è¦è§£æç±»xmlæ ‡è®°è¯­è¨€ï¼Œç„¶åç”Ÿæˆdocumentå¯¹è±¡ï¼Œä¹‹åå°†ä¼šæœ‰ä¸€ç³»åˆ—é’ˆå¯¹documentå¯¹è±¡çš„æ“ä½œ é€šè¿‡å®é™…çš„æµ‹è¯•ï¼Œå‘ç°ç”ŸæˆDocumentå¯¹è±¡æ˜¯æ¯”è¾ƒè€—æ—¶çš„ä¸€ä¸ªæ“ä½œï¼Œå†åŠ ä¸Šè¿™ä¸ªä»»åŠ¡åœºæ™¯ä¸­ï¼Œéœ€è¦è§£æçš„xmlæ–‡æ¡£æ˜¯å›ºå®šçš„å‡ ä¸ªï¼Œé‚£ä¹ˆä¸€ä¸ªå¯ä»¥ä¼˜åŒ–çš„æ€è·¯å°±æ˜¯èƒ½ä¸èƒ½ç¼“å­˜ä½åˆ›å»ºåçš„Documentå¯¹è±¡ï¼Œåœ¨å®é™…ä½¿ç”¨çš„æ—¶å€™cloneä¸€ä»½å‡ºæ¥ 1. å†…å®¹è¯´æ˜çœ‹åˆ°äº†ä¸Šé¢çš„åº”ç”¨èƒŒæ™¯ï¼Œè‡ªç„¶è€Œè¨€çš„å°±ä¼šæƒ³åˆ°æ·±æ‹·è´äº†ï¼Œæœ¬ç¯‡åšæ–‡åˆ™ä¸»è¦å†…å®¹å¦‚ä¸‹ ä»‹ç»ä¸‹ä¸¤ç§æ‹·è´æ–¹å¼çš„åŒºåˆ« æ·±æ‹·è´çš„è¾…åŠ©å·¥å…·ç±» å¦‚ä½•è‡ªå®šä¹‰å®ç°å¯¹è±¡æ‹·è´ II. æ·±æ‹·è´å’Œæµ…æ‹·è´0. å®šä¹‰è¯´æ˜æ·±æ‹·è´ ç›¸å½“äºåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œåªæ˜¯è¿™ä¸ªå¯¹è±¡çš„æ‰€æœ‰å†…å®¹ï¼Œéƒ½å’Œè¢«æ‹·è´çš„å¯¹è±¡ä¸€æ¨¡ä¸€æ ·è€Œå·²ï¼Œå³ä¸¤è€…çš„ä¿®æ”¹æ˜¯éš”ç¦»çš„ï¼Œç›¸äº’ä¹‹é—´æ²¡æœ‰å½±å“ æµ…æ‹·è´ ä¹Ÿæ˜¯åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ï¼Œä½†æ˜¯è¿™ä¸ªå¯¹è±¡çš„æŸäº›å†…å®¹ï¼ˆæ¯”å¦‚Aï¼‰ä¾ç„¶æ˜¯è¢«æ‹·è´å¯¹è±¡çš„ï¼Œå³é€šè¿‡è¿™ä¸¤ä¸ªå¯¹è±¡ä¸­ä»»æ„ä¸€ä¸ªä¿®æ”¹Aï¼Œä¸¤ä¸ªå¯¹è±¡çš„Aéƒ½ä¼šå—åˆ°å½±å“ çœ‹åˆ°ä¸Šé¢ä¸¤ä¸ªç®€å•çš„è¯´æ˜ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº† æµ…æ‹·è´ä¸­ï¼Œæ˜¯æ‰€æœ‰çš„å†…å®¹å…¬ç”¨å‘¢ï¼Ÿè¿˜æ˜¯æŸäº›å†…å®¹å…¬ç”¨ï¼Ÿ ä»éš”ç¦»æ¥å°†ï¼Œéƒ½ä¸å¸Œæœ›å‡ºç°æµ…æ‹·è´è¿™ç§æ–¹å¼äº†ï¼Œå¤ªå®¹æ˜“å‡ºé”™äº†ï¼Œé‚£ä¹ˆä¸¤ç§æ‹·è´æ–¹å¼çš„åº”ç”¨åœºæ™¯æ˜¯æ€æ ·çš„ï¼Ÿ 1. æµ…æ‹·è´ä¸€èˆ¬æ¥è¯´ï¼Œæµ…æ‹·è´æ–¹å¼éœ€è¦å®ç°Cloneableæ¥å£ï¼Œä¸‹é¢ç»“åˆä¸€ä¸ªå®ä¾‹ï¼Œæ¥çœ‹ä¸‹æµ…æ‹·è´ä¸­å“ªäº›æ˜¯ç‹¬ç«‹çš„ï¼Œå“ªäº›æ˜¯å…¬ç”¨çš„ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647@Datapublic class ShallowClone implements Cloneable &#123; private String name; private int age; private List&lt;String&gt; books; public ShallowClone clone() &#123; ShallowClone clone = null; try &#123; clone = (ShallowClone) super.clone(); &#125; catch (CloneNotSupportedException e) &#123; e.printStackTrace(); &#125; return clone; &#125; public static void main(String[] args) &#123; ShallowClone shallowClone = new ShallowClone(); shallowClone.setName(\"SourceName\"); shallowClone.setAge(28); List&lt;String&gt; list = new ArrayList&lt;&gt;(); list.add(\"java\"); list.add(\"c++\"); shallowClone.setBooks(list); ShallowClone cloneObj = shallowClone.clone(); // åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ä¸ºåŒä¸€ä¸ªå¯¹è±¡ï¼ˆå³æ˜¯å¦æ˜¯æ–°åˆ›å»ºäº†ä¸€ä¸ªå®ä¾‹ï¼‰ System.out.println(shallowClone == cloneObj); // ä¿®æ”¹ä¸€ä¸ªå¯¹è±¡çš„å†…å®¹æ˜¯å¦ä¼šå½±å“å¦ä¸€ä¸ªå¯¹è±¡ shallowClone.setName(\"newName\"); shallowClone.setAge(20); shallowClone.getBooks().add(\"javascript\"); System.out.println(\"source: \" + shallowClone.toString() + \"\\nclone:\" + cloneObj.toString()); shallowClone.setBooks(Arrays.asList(\"hello\")); System.out.println(\"source: \" + shallowClone.toString() + \"\\nclone:\" + cloneObj.toString()); &#125;&#125; è¾“å‡ºç»“æœ: 12345falsesource: ShallowClone(name=newName, age=20, books=[java, c++, javascript])clone:ShallowClone(name=SourceName, age=28, books=[java, c++, javascript])source: ShallowClone(name=newName, age=20, books=[hello])clone:ShallowClone(name=SourceName, age=28, books=[java, c++, javascript]) ç»“æœåˆ†æï¼š æ‹·è´åè·å–çš„æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¯¹è±¡ï¼Œå’ŒåŸå¯¹è±¡æ‹¥æœ‰ä¸åŒçš„å†…å­˜åœ°å€ åŸºæœ¬å…ƒç´ ç±»å‹ï¼Œä¸¤è€…æ˜¯éš”ç¦»çš„ï¼ˆè™½ç„¶ä¸Šé¢åªç»™å‡ºäº†intï¼ŒStringï¼‰ åŸºæœ¬å…ƒç´ ç±»å‹åŒ…æ‹¬: int, Integer, long, Long, char, Charset, byte,Byte, boolean, Boolean, float,Float, double, Double, String éåŸºæœ¬æ•°æ®ç±»å‹ï¼ˆå¦‚åŸºæœ¬å®¹å™¨ï¼Œå…¶ä»–å¯¹è±¡ç­‰ï¼‰ï¼Œåªæ˜¯æ‹·è´äº†ä¸€ä»½å¼•ç”¨å‡ºå»äº†ï¼Œå®é™…æŒ‡å‘çš„ä¾ç„¶æ˜¯åŒä¸€ä»½ å…¶å®ï¼Œæµ…æ‹·è´æœ‰ä¸ªéå¸¸ç®€å•çš„ç†è§£æ–¹å¼ï¼š æµ…æ‹·è´çš„æ•´ä¸ªè¿‡ç¨‹å°±æ˜¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œç„¶åæ–°å¯¹è±¡çš„æ¯ä¸ªå€¼éƒ½æ˜¯ç”±åŸå¯¹è±¡çš„å€¼ï¼Œé€šè¿‡ = è¿›è¡Œèµ‹å€¼ è¿™ä¸ªæ€ä¹ˆç†è§£å‘¢ï¼Ÿ ä¸Šé¢çš„æµç¨‹æ‹†è§£å°±æ˜¯ï¼š 1234- Object clone = new Object();- clone.a = source.a- clone.b = source.b- ... é‚£ä¹ˆ=èµ‹å€¼æœ‰ä»€ä¹ˆç‰¹ç‚¹å‘¢ï¼Ÿ åŸºæœ¬æ•°æ®ç±»å‹æ˜¯å€¼èµ‹å€¼ï¼›éåŸºæœ¬çš„å°±æ˜¯å¼•ç”¨èµ‹å€¼ 2. æ·±æ‹·è´æ·±æ‹·è´ï¼Œå°±æ˜¯è¦åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡ï¼Œæ–°çš„å¯¹è±¡å†…éƒ¨æ‰€æœ‰çš„æˆå‘˜ä¹Ÿéƒ½æ˜¯å…¨æ–°çš„ï¼Œåªæ˜¯åˆå§‹åŒ–çš„å€¼å·²ç»ç”±è¢«æ‹·è´çš„å¯¹è±¡ç¡®å®šäº†è€Œå·² é‚£ä¹ˆä¸Šé¢çš„å®ä¾‹æ”¹æˆæ·±æ‹·è´åº”è¯¥æ˜¯æ€æ ·çš„å‘¢ï¼Ÿ å¯ä»¥åŠ ä¸Šè¿™ä¹ˆä¸€ä¸ªæ–¹æ³• 1234567891011121314151617181920212223242526272829303132333435363738public ShallowClone deepClone() &#123; ShallowClone clone = new ShallowClone(); clone.name = this.name; clone.age = this.age; if (this.books != null) &#123; clone.books = new ArrayList&lt;&gt;(this.books); &#125; return clone;&#125;// ç®€å•æ”¹ä¸€ä¸‹æµ‹è¯•casepublic static void main(String[] args) &#123; ShallowClone shallowClone = new ShallowClone(); shallowClone.setName(\"SourceName\"); shallowClone.setAge(new Integer(1280)); List&lt;String&gt; list = new ArrayList&lt;&gt;(); list.add(\"java\"); list.add(\"c++\"); shallowClone.setBooks(list); ShallowClone cloneObj = shallowClone.deepClone(); // åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ä¸ºåŒä¸€ä¸ªå¯¹è±¡ï¼ˆå³æ˜¯å¦æ˜¯æ–°åˆ›å»ºäº†ä¸€ä¸ªå®ä¾‹ï¼‰ System.out.println(shallowClone == cloneObj); // ä¿®æ”¹ä¸€ä¸ªå¯¹è±¡çš„å†…å®¹æ˜¯å¦ä¼šå½±å“å¦ä¸€ä¸ªå¯¹è±¡ shallowClone.setName(\"newName\"); shallowClone.setAge(2000); shallowClone.getBooks().add(\"javascript\"); System.out.println(\"source: \" + shallowClone.toString() + \"\\nclone:\" + cloneObj.toString()); shallowClone.setBooks(Arrays.asList(\"hello\")); System.out.println(\"source: \" + shallowClone.toString() + \"\\nclone:\" + cloneObj.toString());&#125; è¾“å‡ºç»“æœä¸ºï¼š 12345falsesource: ShallowClone(name=newName, age=2000, books=[java, c++, javascript])clone:ShallowClone(name=SourceName, age=1280, books=[java, c++])source: ShallowClone(name=newName, age=2000, books=[hello])clone:ShallowClone(name=SourceName, age=1280, books=[java, c++]) ç»“æœåˆ†æï¼š æ·±æ‹·è´ç‹¬ç«‹çš„å¯¹è±¡ æ‹·è´åå¯¹è±¡çš„å†…å®¹ï¼Œä¸åŸå¯¹è±¡çš„å†…å®¹å®Œå…¨æ²¡å…³ç³»ï¼Œéƒ½æ˜¯ç‹¬ç«‹çš„ ç®€å•æ¥è¯´ï¼Œæ·±æ‹·è´æ˜¯éœ€è¦è‡ªå·±æ¥å®ç°çš„ï¼Œå¯¹äºåŸºæœ¬ç±»å‹å¯ä»¥ç›´æ¥èµ‹å€¼ï¼Œè€Œå¯¹äºå¯¹è±¡ã€å®¹å™¨ã€æ•°ç»„æ¥è®²ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„å‡ºæ¥ï¼Œç„¶åé‡æ–°èµ‹å€¼ 3. åº”ç”¨åœºæ™¯åŒºåˆ†æ·±æ‹·è´çš„ç”¨é€”æˆ‘ä»¬å¾ˆå®¹æ˜“å¯ä»¥æƒ³è§ï¼ŒæŸä¸ªå¤æ‚å¯¹è±¡åˆ›å»ºæ¯”è¾ƒæ¶ˆè€—èµ„æºçš„æ—¶å€™ï¼Œå°±å¯ä»¥ç¼“å­˜ä¸€ä¸ªè“æœ¬ï¼Œåç»­çš„æ“ä½œéƒ½æ˜¯é’ˆå¯¹æ·±cloneåçš„å¯¹è±¡ï¼Œè¿™æ ·å°±ä¸ä¼šå‡ºç°æ··ä¹±çš„æƒ…å†µäº† é‚£ä¹ˆæµ…æ‹·è´å‘¢ï¼Ÿæ„Ÿè§‰ç•™ç€æ˜¯ä¸€ä¸ªå‘ï¼Œä¸€ä¸ªäººä¿®æ”¹äº†è¿™ä¸ªå¯¹è±¡çš„å€¼ï¼Œç»“æœå‘ç°å¯¹å¦ä¸€ä¸ªäººé€ æˆäº†å½±å“ï¼ŒçœŸä¸æ˜¯å‘çˆ¹ä¹ˆï¼Ÿ å‡è®¾åˆè¿™ä¹ˆä¸€ä¸ªé€šçŸ¥å¯¹è±¡é•¿ä¸‹é¢è¿™æ · 12345private String notifyUser;// xxxprivate List&lt;String&gt; notifyRules; æˆ‘ä»¬ç°åœ¨éšæœºæŒ‘é€‰äº†ä¸€åƒä¸ªäººï¼ŒåŒæ—¶å‘é€é€šçŸ¥æ¶ˆæ¯ï¼Œæ‰€ä»¥éœ€è¦åˆ›å»ºä¸€åƒä¸ªä¸Šé¢çš„å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡ä¸­å‘¢ï¼Œé™¤äº†notifyUserä¸åŒï¼Œå…¶ä»–çš„éƒ½ä¸€æ · åœ¨å‘é€ä¹‹å‰ï¼Œçªç„¶å‘ç°è¦ä¸´æ—¶æ–°å¢ä¸€æ¡é€šçŸ¥ä¿¡æ¯ï¼Œå¦‚æœæ˜¯æµ…æ‹·è´çš„è¯ï¼Œåªç”¨åœ¨ä»»æ„ä¸€ä¸ªé€šçŸ¥å¯¹è±¡çš„notifyRulesä¸­æ·»åŠ ä¸€è°ƒæ¶ˆæ¯ï¼Œé‚£ä¹ˆè¿™ä¸€åƒä¸ªå¯¹è±¡çš„é€šçŸ¥æ¶ˆæ¯éƒ½ä¼šå˜æˆæœ€æ–°çš„äº†ï¼›è€Œå¦‚æœä½ æ˜¯ç”¨æ·±æ‹·è´ï¼Œé‚£ä¹ˆè‹¦é€¼çš„å¾—éå†è¿™ä¸€åƒä¸ªå¯¹è±¡ï¼Œæ¯ä¸ªéƒ½åŠ ä¸€æ¡æ¶ˆæ¯äº† III. å¯¹è±¡æ‹·è´å·¥å…·ä¸Šé¢è¯´åˆ°ï¼Œæµ…æ‹·è´ï¼Œéœ€è¦å®ç°Clonebaleæ¥å£ï¼Œæ·±æ‹·è´ä¸€èˆ¬éœ€è¦è‡ªå·±æ¥å®ç°ï¼Œé‚£ä¹ˆæˆ‘ç°åœ¨æ‹¿åˆ°ä¸€ä¸ªå¯¹è±¡Aï¼Œå®ƒè‡ªå·±æ²¡æœ‰æä¾›æ·±æ‹·è´æ¥å£ï¼Œæˆ‘ä»¬é™¤äº†ä¸»åŠ¨ä¸€æ¡ä¸€æ¡çš„å¸®å®ƒå®ç°ä¹‹å¤–ï¼Œæœ‰ä»€ä¹ˆè¾…åŠ©å·¥å…·å¯ç”¨ä¹ˆï¼Ÿ å¯¹è±¡æ‹·è´åŒºåˆ«ä¸cloneï¼Œå®ƒå¯ä»¥æ”¯æŒä¸¤ä¸ªä¸åŒå¯¹è±¡ä¹‹é—´å®ç°å†…å®¹æ‹·è´ Apacheçš„ä¸¤ä¸ªç‰ˆæœ¬ï¼šï¼ˆåå°„æœºåˆ¶ï¼‰ 1234org.apache.commons.beanutils.PropertyUtils.copyProperties(Object dest, Object orig)org.apache.commons.beanutils.BeanUtils#cloneBean Springç‰ˆæœ¬ï¼šï¼ˆåå°„æœºåˆ¶ï¼‰ 1org.springframework.beans.BeanUtils.copyProperties(Object source, Object target, Class editable, String[] ignoreProperties) cglibç‰ˆæœ¬ï¼šï¼ˆä½¿ç”¨åŠ¨æ€ä»£ç†ï¼Œæ•ˆç‡é«˜ï¼‰ 1net.sf.cglib.beans.BeanCopier.copy(Object paramObject1, Object paramObject2, Converter paramConverter) ä»ä¸Šé¢çš„å‡ ä¸ªæœ‰åçš„å·¥å…·ç±»æ¥çœ‹ï¼Œæä¾›äº†ä¸¤ç§ä½¿ç”¨è€…å§¿åŠ¿ï¼Œä¸€ä¸ªæ˜¯åå°„ï¼Œä¸€ä¸ªæ˜¯åŠ¨æ€ä»£ç†ï¼Œä¸‹é¢åˆ†åˆ«æ¥çœ‹ä¸¤ç§æ€è·¯ 1. å€ŸåŠ©åå°„å®ç°å¯¹è±¡æ‹·è´é€šè¿‡åå°„çš„æ–¹å¼å®ç°å¯¹è±¡æ‹·è´çš„æ€è·¯è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼Œå…ˆé€šè¿‡åå°„è·å–å¯¹è±¡çš„æ‰€æœ‰å±æ€§ï¼Œç„¶åä¿®æ”¹å¯è®¿é—®çº§åˆ«ï¼Œç„¶åèµ‹å€¼ï¼›å†è·å–ç»§æ‰¿çš„çˆ¶ç±»çš„å±æ€§ï¼ŒåŒæ ·åˆ©ç”¨åå°„è¿›è¡Œèµ‹å€¼ ä¸Šé¢çš„å‡ ä¸ªå¼€æºå·¥å…·ï¼Œå†…éƒ¨å®ç°å°è£…å¾—æ¯”è¾ƒå¥½ï¼Œæ‰€ä»¥ç›´æ¥è´´æºç å¯èƒ½ä¸å¤ªå®¹æ˜“ä¸€çœ¼å°±èƒ½çœ‹å‡ºåå°„æ–¹å¼çš„åŸç†ï¼Œæ‰€ä»¥ç®€å•çš„å®ç°äº†ä¸€ä¸ª, ä»…æä¾›æ€è·¯ 123456789101112131415161718192021222324252627282930313233343536373839404142434445public static void copy(Object source, Object dest) throws Exception &#123; Class destClz = dest.getClass(); // è·å–ç›®æ ‡çš„æ‰€æœ‰æˆå‘˜ Field[] destFields = destClz.getDeclaredFields(); Object value; for (Field field : destFields) &#123; // éå†æ‰€æœ‰çš„æˆå‘˜ï¼Œå¹¶èµ‹å€¼ // è·å–valueå€¼ value = getVal(field.getName(), source); field.setAccessible(true); field.set(dest, value); &#125;&#125;private static Object getVal(String name, Object obj) throws Exception &#123; try &#123; // ä¼˜å…ˆè·å–objä¸­åŒåçš„æˆå‘˜å˜é‡ Field field = obj.getClass().getDeclaredField(name); field.setAccessible(true); return field.get(obj); &#125; catch (NoSuchFieldException e) &#123; // è¡¨ç¤ºæ²¡æœ‰åŒåçš„å˜é‡ &#125; // è·å–å¯¹åº”çš„ getXxx() æˆ–è€… isXxx() æ–¹æ³• name = name.substring(0, 1).toUpperCase() + name.substring(1); String methodName = \"get\" + name; String methodName2 = \"is\" + name; Method[] methods = obj.getClass().getMethods(); for (Method method : methods) &#123; // åªè·å–æ— å‚çš„æ–¹æ³• if (method.getParameterCount() &gt; 0) &#123; continue; &#125; if (method.getName().equals(methodName) || method.getName().equals(methodName2)) &#123; return method.invoke(obj); &#125; &#125; return null;&#125; ä¸Šé¢çš„å®ç°æ­¥éª¤è¿˜æ˜¯éå¸¸æ¸…æ™°çš„ï¼Œé¦–å…ˆæ˜¯æ‰¾åŒåçš„å±æ€§ï¼Œç„¶ååˆ©ç”¨åå°„è·å–å¯¹åº”çš„å€¼ 123Field field = obj.getClass().getDeclaredField(name);field.setAccessible(true);return field.get(obj); å¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™æ‰¾getXXX, isXXXæ¥è·å– 2. ä»£ç†çš„æ–¹å¼å®ç°å¯¹è±¡æ‹·è´Cglibçš„BeanCopierå°±æ˜¯é€šè¿‡ä»£ç†çš„æ–¹å¼å®ç°æ‹·è´ï¼Œæ€§èƒ½ä¼˜äºåå°„çš„æ–¹å¼ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤§é‡çš„æ•°æ®æ‹·è´æ—¶ï¼Œæ¯”è¾ƒæ˜æ˜¾ ä»£ç†ï¼Œæˆ‘ä»¬çŸ¥é“å¯ä»¥åŒºåˆ†ä¸ºé™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†ï¼Œç®€å•æ¥è®²å°±æ˜¯ä½ è¦æ“ä½œå¯¹è±¡Aï¼Œä½†æ˜¯ä½ ä¸ç›´æ¥å»æ“ä½œAï¼Œè€Œæ˜¯æ‰¾ä¸€ä¸ªä¸­è½¬porxyA, è®©å®ƒæ¥å¸®ä½ æ“ä½œå¯¹è±¡A é‚£ä¹ˆè¿™ç§æŠ€æœ¯æ˜¯å¦‚ä½•ä½¿ç”¨åœ¨å¯¹è±¡æ‹·è´çš„å‘¢ï¼Ÿ æˆ‘ä»¬çŸ¥é“ï¼Œæ•ˆç‡æœ€é«˜çš„å¯¹è±¡æ‹·è´æ–¹å¼å°±æ˜¯Getter/Setteræ–¹æ³•äº†ï¼Œå‰é¢è¯´çš„ä»£ç†çš„å«ä¹‰æŒ‡æˆ‘ä»¬ä¸ç›´æ¥æ“ä½œï¼Œè€Œæ˜¯æ‰¾ä¸ªä¸­é—´å•†æ¥èµšå·®ä»·ï¼Œé‚£ä¹ˆæ–¹æ¡ˆå°±å‡ºæ¥äº† å°†åŸSourceAæ‹·è´åˆ°ç›®æ ‡DestB åˆ›å»ºä¸€ä¸ªä»£ç† copyProxy åœ¨ä»£ç†ä¸­ï¼Œä¾æ¬¡è°ƒç”¨ SourceAçš„getæ–¹æ³•è·å–å±æ€§å€¼ï¼Œç„¶åè°ƒç”¨DestBçš„setæ–¹æ³•è¿›è¡Œèµ‹å€¼ å®é™…ä¸ŠBeanCopierçš„æ€è·¯å¤§è‡´å¦‚ä¸Šï¼Œå…·ä½“çš„æ–¹æ¡ˆå½“ç„¶å°±ä¸å¤ªä¸€æ ·äº†, ç®€å•çœ‹äº†ä¸€ä¸‹å®ç°é€»è¾‘ï¼ŒæŒºæœ‰æ„æ€çš„ä¸€å—ï¼Œå…ˆç•™ä¸ªå‘ï¼Œåé¢å•ç‹¬å¼€ä¸ªåšæ–‡è¡¥ä¸Š è¯´æ˜ ä»å®ç°åŸç†å’Œé€šè¿‡ç®€å•çš„æµ‹è¯•ï¼Œå‘ç°BeanCopieræ˜¯æ‰«æåŸå¯¹è±¡çš„getXXXæ–¹æ³•ï¼Œç„¶åèµ‹å€¼ç»™åŒåçš„ setXXX æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœè¿™ä¸ªå¯¹è±¡ä¸­æŸä¸ªå±æ€§æ²¡æœ‰get/setæ–¹æ³•ï¼Œé‚£ä¹ˆå°±æ— æ³•èµ‹å€¼æˆåŠŸäº† IV. å°ç»“1. æ·±æ‹·è´å’Œæµ…æ‹·è´æ·±æ‹·è´ ç›¸å½“äºåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œåªæ˜¯è¿™ä¸ªå¯¹è±¡çš„æ‰€æœ‰å†…å®¹ï¼Œéƒ½å’Œè¢«æ‹·è´çš„å¯¹è±¡ä¸€æ¨¡ä¸€æ ·è€Œå·²ï¼Œå³ä¸¤è€…çš„ä¿®æ”¹æ˜¯éš”ç¦»çš„ï¼Œç›¸äº’ä¹‹é—´æ²¡æœ‰å½±å“ å®Œå…¨ç‹¬ç«‹ æµ…æ‹·è´ ä¹Ÿæ˜¯åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ï¼Œä½†æ˜¯è¿™ä¸ªå¯¹è±¡çš„æŸäº›å†…å®¹ï¼ˆæ¯”å¦‚Aï¼‰ä¾ç„¶æ˜¯è¢«æ‹·è´å¯¹è±¡çš„ï¼Œå³é€šè¿‡è¿™ä¸¤ä¸ªå¯¹è±¡ä¸­ä»»æ„ä¸€ä¸ªä¿®æ”¹Aï¼Œä¸¤ä¸ªå¯¹è±¡çš„Aéƒ½ä¼šå—åˆ°å½±å“ ç­‰åŒä¸æ–°åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åä½¿ç”¨=ï¼Œå°†åŸå¯¹è±¡çš„å±æ€§èµ‹å€¼ç»™æ–°å¯¹è±¡çš„å±æ€§ éœ€è¦å®ç°Cloneableæ¥å£ 2. å¯¹è±¡æ‹·è´çš„ä¸¤ç§æ–¹æ³•é€šè¿‡åå°„æ–¹å¼å®ç°å¯¹è±¡æ‹·è´ ä¸»è¦åŸç†å°±æ˜¯é€šè¿‡åå°„è·å–æ‰€æœ‰çš„å±æ€§ï¼Œç„¶ååå°„æ›´æ”¹å±æ€§çš„å†…å®¹ é€šè¿‡ä»£ç†å®ç°å¯¹è±¡æ‹·è´ å°†åŸSourceAæ‹·è´åˆ°ç›®æ ‡DestB åˆ›å»ºä¸€ä¸ªä»£ç† copyProxyåœ¨ä»£ç†ä¸­ï¼Œä¾æ¬¡è°ƒç”¨ SourceAçš„getæ–¹æ³•è·å–å±æ€§å€¼ï¼Œç„¶åè°ƒç”¨DestBçš„setæ–¹æ³•è¿›è¡Œèµ‹å€¼ V. å…¶ä»–å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è§£ä¸å…¨ï¼Œå¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ æ‰«æå…³æ³¨ï¼Œjavaåˆ†äº«","categories":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"JDK","slug":"Java/JDK","permalink":"https://zbang.online/hexblog/categories/Java/JDK/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"clone","slug":"clone","permalink":"https://zbang.online/hexblog/tags/clone/"},{"name":"beancopy","slug":"beancopy","permalink":"https://zbang.online/hexblog/tags/beancopy/"}],"keywords":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/categories/Java/"},{"name":"JDK","slug":"Java/JDK","permalink":"https://zbang.online/hexblog/categories/Java/JDK/"}]},{"title":"4. SPIæ¡†æ¶å®ç°ä¹‹æ—…å››ï¼šä½¿ç”¨æµ‹è¯•","slug":"SPIæ¡†æ¶å®ç°ä¹‹æ—…å››ï¼šä½¿ç”¨æµ‹è¯•","date":"2017-05-30T12:50:37.000Z","updated":"2018-02-13T03:21:17.019Z","comments":true,"path":"2017/05/30/SPIæ¡†æ¶å®ç°ä¹‹æ—…å››ï¼šä½¿ç”¨æµ‹è¯•/","link":"","permalink":"https://zbang.online/hexblog/2017/05/30/SPIæ¡†æ¶å®ç°ä¹‹æ—…å››ï¼šä½¿ç”¨æµ‹è¯•/","excerpt":"ä½¿ç”¨æµ‹è¯• å‰é¢ä¸‰ç¯‡ä¸»è¦æ˜¯ä»‹ç»å¦‚ä½•è®¾è®¡çš„ï¼Œå¦‚ä½•å®ç°çš„ï¼Œè¿™ä¸€ç¯‡ï¼Œåˆ™ä¸»è¦é›†ä¸­åœ¨å¦‚ä½•ä½¿ç”¨ã€‚å®ç°å¾—å†å¥½ï¼Œå¦‚æœä¸å¥½ç”¨ï¼Œä¹Ÿç™½æ­ æœ¬ç¯‡ä»‹ç»å‡ ä¸ªç®€å•çš„ä½¿ç”¨caseï¼ŒåŒ…æ‹¬é™æ€ä½¿ç”¨ï¼ŒåŠ¨æ€é€‚é…ï¼Œè‡ªå®šä¹‰é€‰æ‹©å™¨ç­‰","text":"ä½¿ç”¨æµ‹è¯• å‰é¢ä¸‰ç¯‡ä¸»è¦æ˜¯ä»‹ç»å¦‚ä½•è®¾è®¡çš„ï¼Œå¦‚ä½•å®ç°çš„ï¼Œè¿™ä¸€ç¯‡ï¼Œåˆ™ä¸»è¦é›†ä¸­åœ¨å¦‚ä½•ä½¿ç”¨ã€‚å®ç°å¾—å†å¥½ï¼Œå¦‚æœä¸å¥½ç”¨ï¼Œä¹Ÿç™½æ­ æœ¬ç¯‡ä»‹ç»å‡ ä¸ªç®€å•çš„ä½¿ç”¨caseï¼ŒåŒ…æ‹¬é™æ€ä½¿ç”¨ï¼ŒåŠ¨æ€é€‚é…ï¼Œè‡ªå®šä¹‰é€‰æ‹©å™¨ç­‰ 1. ç®€å•çš„é™æ€ä½¿ç”¨å®šä¹‰ä¸€ä¸ªSPIæ¥å£ IPrint, ä¸¤ä¸ªå®ç° FilePrint, ConsolePrint 123456789101112131415161718@Spipublic interface IPrint &#123; void print(String str);&#125;public class FilePrint implements IPrint &#123; @Override public void print(String str) &#123; System.out.println(\"file print: \" + str); &#125;&#125;public class ConsolePrint implements IPrint &#123; @Override public void print(String str) &#123; System.out.println(\"console print: \" + str); &#125;&#125; æ·»åŠ é…ç½®æ–‡ä»¶ com.hust.hui.quicksilver.spi.test.print.IPrint, å†…å®¹å¦‚ä¸‹ com.hust.hui.quicksilver.spi.test.print.ConsolePrint com.hust.hui.quicksilver.spi.test.print.FilePrint æµ‹è¯•ä»£ç å¦‚ä¸‹ 1234567891011121314151617181920212223242526272829@Testpublic void testPrint() throws NoSpiMatchException &#123; SpiLoader&lt;IPrint&gt; spiLoader = SpiLoader.load(IPrint.class); IPrint print = spiLoader.getService(&quot;ConsolePrint&quot;); print.print(&quot;console----&gt;&quot;); print = spiLoader.getService(&quot;FilePrint&quot;); print.print(&quot;file----&gt;&quot;); try &#123; print = spiLoader.getService(&quot;undefine&quot;); print.print(&quot;undefine----&quot;); Assert.assertTrue(false); &#125; catch (Exception e) &#123; System.out.println(&quot;type error--&gt;&quot; + e); &#125; try &#123; print = spiLoader.getService(123); print.print(&quot;type error----&quot;); Assert.assertTrue(false); &#125; catch (Exception e)&#123; System.out.println(&quot;type error--&gt;&quot; + e); &#125;&#125; è¾“å‡ºå¦‚ä¸‹ 1234console print: console----&gt;file print: file----&gt;type error--&gt;com.hust.hui.quicksilver.spi.exception.NoSpiMatchException: no spiImpl match the name you choose! your choose is: undefinetype error--&gt;java.lang.IllegalArgumentException: conf spiInterfaceType should be sub class of [class java.lang.String] but yours:class java.lang.Integer æ¼”ç¤ºå¦‚ä¸‹ 2. åŠ¨æ€é€‚é…ä¸é™æ€çš„ä½¿ç”¨æœ‰ç‚¹åŒºåˆ«ï¼Œä¸»è¦çš„åŒºåˆ«ç‚¹åœ¨äºæ¥å£çš„å®šä¹‰ï¼ˆéœ€è¦æ³¨æ„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä½œä¸ºé€‰æ‹©å™¨é€‰æ‹©SPIå®ç°çš„å‚æ•°ï¼‰ï¼ŒåŒæ ·æ˜¯ä¸Šé¢è¿™ä¸ªspiæ¥å£ 123456789101112131415161718192021222324252627282930313233@Spipublic interface IPrint &#123; void print(String str); void adaptivePrint(String conf, String str);&#125; @Override public void print(String str) &#123; System.out.println(\"file print: \" + str); &#125; @Override public void adaptivePrint(String conf, String str) &#123; System.out.println(\"file adaptivePrint: \" + str); &#125;&#125;public class ConsolePrint implements IPrint &#123; @Override public void print(String str) &#123; System.out.println(\"console print: \" + str); &#125; @Override public void adaptivePrint(String conf, String str) &#123; System.out.println(\"console adaptivePrint: \" + str); &#125;&#125; ä¸»è¦æ˜¯æ–°å¢äº†ä¸€ä¸ªæ¥å£ adaptivePrint, å…¶ä»–çš„æ²¡æœ‰å•¥åŒºåˆ«ï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹ 12345678@Testpublic void testAdaptivePrint() throws SpiProxyCompileException &#123; IPrint print = SpiLoader.load(IPrint.class).getAdaptive(); print.adaptivePrint(\"FilePrint\", \"[file print]\"); print.adaptivePrint(\"ConsolePrint\", \"[console print]\");&#125; è¾“å‡ºç»“æœ 1234567891011121314151617181920212223242526file adaptivePrint: [file print]console adaptivePrint: [console print]``` æ¼”ç¤ºå›¾ ![http://s2.mogucdn.com/mlcdn/c45406/170531_54f638fkcl58c6lihl92adei31c78_1222x718.gif](http://s2.mogucdn.com/mlcdn/c45406/170531_54f638fkcl58c6lihl92adei31c78_1222x718.gif)## 3. è‡ªå®šä¹‰é€‰æ‹©å™¨&gt; ä¸Šé¢ä¸¤ä¸ªå¾ˆç®€å•çš„æ¼”ç¤ºäº†ä¸‹ä½¿ç”¨æ–¹å¼ï¼Œæœ€åŸºæœ¬çš„æ–¹æ³•ï¼Œ æ²¡æœ‰åŠ ä¸Š @SpiConf æ³¨è§£ï¼Œ æ²¡æœ‰æ˜¾ç¤ºæŒ‡å®šé€‰æ‹©å™¨ç±»å‹ï¼Œä¸‹é¢åˆ™æ¼”ç¤ºä¸‹ï¼Œå¦‚ä½•è‡ªå®šä¹‰é€‰æ‹©å™¨**SPIæ¥å£**æœ‰ä¸€ä¸ªæ¬¢è¿æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€æ±‚æ ¹æ®ç”¨æˆ·çš„æ¥æºæ˜¾ç¤ºä¸åŒçš„æ¬¢è¿è‡³æ­¤ï¼Œ ä¸‹é¢å®šä¹‰äº†ä¸€ä¸ª `UserSelector`é€‰æ‹©å™¨ï¼Œè¿™ä¸ªå°±æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„é€‰æ‹©å™¨```java@Spipublic interface IUser &#123; @SpiAdaptive(selector = UserSelector.class) void welcome(UserDO userDO);&#125; spiå®ç°ç±» 123456789101112131415public class QQUser implements IUser &#123; @Override public void welcome(UserDO userDO) &#123; System.out.println(\"qq æ¬¢è¿ä½ ! \" + userDO); &#125;&#125;public class WeixinUser implements IUser &#123; @Override public void welcome(UserDO userDO) &#123; System.out.println(\"weixin æ¬¢è¿ä½ ! \" + userDO); &#125;&#125; META-INF/services/ ç›®å½•ä¸‹çš„é…ç½®å¦‚ä¸‹ com.hust.hui.quicksilver.spi.def.spi.IUser com.hust.hui.quicksilver.spi.def.spi.QQUser com.hust.hui.quicksilver.spi.def.spi.WeixinUser é€‰æ‹©å™¨å®ç°å¦‚ä¸‹ 12345678910111213141516171819public class UserSelector implements ISelector&lt;UserDO&gt; &#123; @Override public &lt;K&gt; K selector(Map&lt;String, SpiImplWrapper&lt;K&gt;&gt; map, UserDO conf) throws NoSpiMatchException &#123; if (conf == null || conf.getMarket() == null) &#123; throw new IllegalArgumentException(\"userDo or userDO#market should not be null!\"); &#125; String name = conf.getMarket().getName(); if (map.containsKey(name)) &#123; return map.get(name).getSpiImpl(); &#125; throw new NoSpiMatchException(\"no spiImp matched marked: \" + conf.getMarket()); &#125;&#125; ä»ä¸Šé¢çš„é€‰æ‹©å™¨é€»è¾‘å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬æ˜¯æ ¹æ® UserDOçš„marketå‚æ•°æ¥è¿›è¡Œé€‰æ‹©çš„ï¼Œ UserDOçš„å®šä¹‰å¦‚ä¸‹ 12345678910111213141516171819202122232425262728@Getter@Setter@ToStringpublic class UserDO &#123; private String uname; private String avatar; private MarketEnum market;&#125;public enum MarketEnum &#123; WEIXIN(\"WeixinUser\"), QQ(\"QQUser\"); private String name; MarketEnum(String name) &#123; this.name = name; &#125; public String getName() &#123; return name; &#125;&#125; æµ‹è¯•ä»£ç å¦‚ä¸‹ 123456789101112131415161718192021@Testpublic void testUserSPI() throws SpiProxyCompileException &#123; SpiLoader&lt;IUser&gt; loader = SpiLoader.load(IUser.class); IUser user = loader.getAdaptive(); UserDO weixinUser = new UserDO(); weixinUser.setAvatar(\"weixin.avatar.jpg\"); weixinUser.setUname(\"å¾®ä¿¡ç”¨æˆ·\"); weixinUser.setMarket(MarketEnum.WEIXIN); user.welcome(weixinUser); UserDO qqUser = new UserDO(); qqUser.setAvatar(\"qq.avatar.jpg\"); qqUser.setUname(\"qqç”¨æˆ·\"); qqUser.setMarket(MarketEnum.QQ); user.welcome(qqUser); System.out.println(\"-----over------\");&#125; è¾“å‡ºç»“æœ: weixin æ¬¢è¿ä½ ! UserDO(uname=å¾®ä¿¡ç”¨æˆ·, avatar=weixin.avatar.jpg, market=WEIXIN) qq æ¬¢è¿ä½ ! UserDO(uname=qqç”¨æˆ·, avatar=qq.avatar.jpg, market=QQ) æ¼”ç¤ºå¦‚ä¸‹: 3. å…¶ä»–åšå®¢ç³»åˆ—é“¾æ¥ï¼š SPIæ¡†æ¶å®ç°ä¹‹æ—…å››ï¼šä½¿ç”¨æµ‹è¯• SPIæ¡†æ¶å®ç°ä¹‹æ—…ä¸‰ï¼šå®ç°è¯´æ˜ SPIæ¡†æ¶å®ç°ä¹‹æ—…äºŒï¼šæ•´ä½“è®¾è®¡ SPIæ¡†æ¶å®ç°ä¹‹æ—…ä¸€ï¼šèƒŒæ™¯ä»‹ç» é¡¹ç›®: QuickAlarm é¡¹ç›®åœ°å€ï¼š Quick-SPI åšå®¢åœ°å€ï¼š å°ç°ç°Blog ä¸ªäººåšå®¢ï¼š Z+|blogåŸºäºhexo + github pagesæ­å»ºçš„ä¸ªäººåšå®¢ï¼Œè®°å½•æ‰€æœ‰å­¦ä¹ å’Œå·¥ä½œä¸­çš„åšæ–‡ï¼Œæ¬¢è¿å¤§å®¶å‰å»é€›é€› å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è¯†æœ‰é™ï¼Œå¦‚å‘ç°bugæˆ–è€…æœ‰æ›´å¥½çš„å»ºè®®ï¼Œéšæ—¶æ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼Œæˆ‘çš„å¾®åšåœ°å€: å°ç°ç°Blog æ‰«æå…³æ³¨","categories":[{"name":"Quickç³»åˆ—é¡¹ç›®","slug":"Quickç³»åˆ—é¡¹ç›®","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/"},{"name":"QuickSpi","slug":"Quickç³»åˆ—é¡¹ç›®/QuickSpi","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/QuickSpi/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"SPI","slug":"SPI","permalink":"https://zbang.online/hexblog/tags/SPI/"},{"name":"ä½¿ç”¨æ‰‹å†Œ","slug":"ä½¿ç”¨æ‰‹å†Œ","permalink":"https://zbang.online/hexblog/tags/ä½¿ç”¨æ‰‹å†Œ/"}],"keywords":[{"name":"Quickç³»åˆ—é¡¹ç›®","slug":"Quickç³»åˆ—é¡¹ç›®","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/"},{"name":"QuickSpi","slug":"Quickç³»åˆ—é¡¹ç›®/QuickSpi","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/QuickSpi/"}]},{"title":"3. SPIæ¡†æ¶å®ç°ä¹‹æ—…ä¸‰ï¼šå®ç°è¯´æ˜","slug":"SPIæ¡†æ¶å®ç°ä¹‹æ—…ä¸‰ï¼šå®ç°è¯´æ˜","date":"2017-05-29T02:50:37.000Z","updated":"2018-02-13T03:21:17.019Z","comments":true,"path":"2017/05/29/SPIæ¡†æ¶å®ç°ä¹‹æ—…ä¸‰ï¼šå®ç°è¯´æ˜/","link":"","permalink":"https://zbang.online/hexblog/2017/05/29/SPIæ¡†æ¶å®ç°ä¹‹æ—…ä¸‰ï¼šå®ç°è¯´æ˜/","excerpt":"å®ç°è¯´æ˜ å‰ä¸€ç¯‡ ã€ŠSPIæ¡†æ¶å®ç°ä¹‹æ—…äºŒï¼šæ•´ä½“è®¾è®¡ã€‹ä¸­ï¼Œä»‹ç»äº†å‡ ä¸ªå®šä¹‰çš„æ¥å£ï¼Œæ³¨è§£ï¼›å™è¿°äº†å®ç°æµç¨‹ï¼›å¹¶ç®€å•çš„ä»‹ç»äº† SpiLoaderä¸­çš„éƒ¨åˆ†å®ç°ï¼› æœ¬ç¯‡åˆ™ä¸»è¦ä»‹ç»SpiLoaderç±»çš„å®ç° ç±»å›¾ç»“æ„å¦‚ä¸‹ï¼š","text":"å®ç°è¯´æ˜ å‰ä¸€ç¯‡ ã€ŠSPIæ¡†æ¶å®ç°ä¹‹æ—…äºŒï¼šæ•´ä½“è®¾è®¡ã€‹ä¸­ï¼Œä»‹ç»äº†å‡ ä¸ªå®šä¹‰çš„æ¥å£ï¼Œæ³¨è§£ï¼›å™è¿°äº†å®ç°æµç¨‹ï¼›å¹¶ç®€å•çš„ä»‹ç»äº† SpiLoaderä¸­çš„éƒ¨åˆ†å®ç°ï¼› æœ¬ç¯‡åˆ™ä¸»è¦ä»‹ç»SpiLoaderç±»çš„å®ç° ç±»å›¾ç»“æ„å¦‚ä¸‹ï¼š SpiLoader å…¨è§£æ spiImplé€‰æ‹©çš„æ ¸å¿ƒç±»ï¼ŒåŒ…æ‹¬åˆå§‹åŒ–é€‰æ‹©å™¨ï¼Œåˆå§‹åŒ–spiImplå®ç°åˆ—è¡¨ï¼Œè§£æspiImplçš„é€‰æ‹©æ¡ä»¶ï¼Œè¿”å›å…·ä½“çš„å®ç°ç±»ç­‰ 1. è·å–spiLoaderå¯¹è±¡ SpiLoader æ˜¯ä¸€ä¸ªæ³›å‹å¯¹è±¡ï¼Œæ¯ä¸ªSPIæ¥å£ï¼Œå¯¹åº”ä¸€ä¸ªSpiLoader&lt;T&gt; å¯¹è±¡ï¼Œæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªé™æ€æ–¹æ³•æ¥è·å–è¿™ä¸ªå¯¹è±¡ å®ç°ä¼˜å…ˆä»ç¼“å­˜ä¸­è·å–ï¼Œ å¦‚æœç¼“å­˜æ²¡æœ‰ï¼Œåˆ™æ–°å»ºä¸€ä¸ªï¼›ç¼“å­˜ä¸­æœ‰ï¼Œ åˆ™ç›´æ¥è¿”å› 123456789101112131415161718192021222324252627282930/*** spiLoaderç¼“å­˜, å…¶ä¸­keyä¸º spiæ¥å£, valueä¸ºå¯¹åº”çš„Loaderå¯¹è±¡*/private static final ConcurrentMap&lt;Class&lt;?&gt;, SpiLoader&lt;?&gt;&gt; loaderCache = new ConcurrentHashMap&lt;&gt;();@SuppressWarnings(\"unchecked\")public static &lt;T&gt; SpiLoader&lt;T&gt; load(Class&lt;T&gt; type) &#123; if (null == type) &#123; throw new IllegalArgumentException(\"common cannot be null...\"); &#125; if (!type.isInterface()) &#123; throw new IllegalArgumentException(\"common class:\" + type + \" must be interface!\"); &#125; if (!withSpiAnnotation(type)) &#123; throw new IllegalArgumentException(\"common class:\" + type + \" must have the annotation of @Spi\"); &#125; SpiLoader&lt;T&gt; spiLoader = (SpiLoader&lt;T&gt;) loaderCache.get(type); if (spiLoader == null) &#123; loaderCache.putIfAbsent(type, new SpiLoader&lt;&gt;(type)); spiLoader = (SpiLoader&lt;T&gt;) loaderCache.get(type); &#125; return spiLoader;&#125; è¯´æ˜ ä¸Šé¢æœ‰å‡ ä¸ªæ ¡éªŒï¼Œå‰ä¸€ç¯‡å·²ç»è¯´æ˜ï¼Œä¸å†èµ˜è¿° ä¸Šé¢æ–°å»ºå¯¹è±¡ï¼Œä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ 2. æ–°å»º SpiLoaderå¯¹è±¡ åˆ›å»ºå¯¹è±¡ï¼Œä¸»è¦ä¼šåˆå§‹åŒ–é€‰æ‹©å™¨ å®ç°123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263private SpiLoader(Class&lt;T&gt; type) &#123; // åˆå§‹åŒ–é»˜è®¤çš„é€‰æ‹©å™¨, ä¸ºä¿ç•™é¡¹ç›®, å¿…ç„¶ä¼šæä¾›çš„æœåŠ¡ selectorInstanceCacheMap.putIfAbsent(DefaultSelector.class, DEFAULT_SELECTOR); this.spiInterfaceType = type; initSelector();&#125;private void initSelector() &#123; Spi ano = spiInterfaceType.getAnnotation(Spi.class); if (ano == null) &#123; currentSelector = initSelector(DefaultSelector.class); &#125; else &#123; currentSelector = initSelector(ano.selector()); &#125; Method[] methods = this.spiInterfaceType.getMethods(); currentMethodSelector = new ConcurrentHashMap&lt;&gt;(); SelectorWrapper temp; for (Method method : methods) &#123; if (!method.isAnnotationPresent(SpiAdaptive.class)) &#123; continue; &#125; temp = initSelector(method.getAnnotation(SpiAdaptive.class).selector()); if (temp == null) &#123; continue; &#125; currentMethodSelector.put(method.getName(), temp); &#125;&#125;private SelectorWrapper initSelector(Class&lt;? extends ISelector&gt; clz) &#123; // ä¼˜å…ˆä»é€‰æ‹©å™¨ç¼“å­˜ä¸­è·å–ç±»å‹å¯¹åº”çš„é€‰æ‹©å™¨ if (selectorInstanceCacheMap.containsKey(clz)) &#123; return selectorInstanceCacheMap.get(clz); &#125; try &#123; ISelector selector = clz.newInstance(); Class paramClz = null; Type[] types = clz.getGenericInterfaces(); for (Type t : types) &#123; if (t instanceof ParameterizedType) &#123; paramClz = (Class) ((ParameterizedType) t).getActualTypeArguments()[0]; break; &#125; &#125; Assert.check(paramClz != null); SelectorWrapper wrapper = new SelectorWrapper(selector, paramClz); selectorInstanceCacheMap.putIfAbsent(clz, wrapper); return wrapper; &#125; catch (Exception e) &#123; throw new IllegalArgumentException(\"illegal selector defined! yous:\" + clz); &#125;&#125; è¯´æ˜ æŒæœ‰ä¸€ä¸ªé€‰æ‹©å™¨ç¼“å­˜åˆ—è¡¨ï¼ŒselectorInstanceCacheMap ä¿è¯æ¯ç§ç±»å‹çš„é€‰æ‹©å™¨ï¼Œåœ¨è¿™ä¸ªSpiLoaderä¸­ï¼Œåªä¼šæœ‰ä¸€ä¸ªå®ä¾‹å­˜åœ¨ ä¸åšæˆå…¨å±€å”¯ä¸€çš„åŸå› æ˜¯å°½é‡éš”ç¦», æ¯”å¦‚ ParamsSelector å†…éƒ¨ç¼“å­˜äº†spiå®ç°çš„åˆ—è¡¨ï¼Œå¦‚æœå…¨å±€å…¬ç”¨çš„è¯ï¼Œå°±ä¼šæ··æ‰ï¼Œå¯¼è‡´è¿™ä¸ªåˆ—è¡¨ä¸­å°±å‡ºç°éè¿™ä¸ªspiæ¥å£çš„å®ç°ç±» ç±»é€‰æ‹©å™¨ + æ–¹æ³•é€‰æ‹©å™¨ currentSelector ï¼š ç±»é€‰æ‹©å™¨, è§£æ @Spi æ³¨è§£è·å–ï¼Œé€‚ç”¨äºé™æ€é€‰æ‹© + åŠ¨æ€é€‰æ‹©ä¸¤ç§ä½¿ç”¨æ–¹å¼ currentMethodSelector : æ–¹æ³•é€‰æ‹©å™¨ï¼Œè§£æ @SpiAdaptive æ³¨è§£è·å–ï¼Œ ä»…é€‚ç”¨äºåŠ¨æ€é€‰æ‹©SPIå®ç°çš„æ–¹å¼ ä¼˜å…ˆçº§ï¼š æ–¹æ³•ä¸Šå®šä¹‰çš„é€‰æ‹©å™¨ ç”±äº ç±»ä¸Šå®šä¹‰çš„é€‰æ‹©å™¨ï¼› æ–¹æ³•ä¸Šæœªå®šä¹‰æ—¶ï¼Œé»˜è®¤ä½¿ç”¨ç±»å®šä¹‰çš„é€‰æ‹©å™¨ 3. é™æ€ä½¿ç”¨ é™æ€ä½¿ç”¨æ–¹å¼ï¼Œè¡¨ç¤ºæ ¹æ®ä¼ å…¥çš„æ¡ä»¶ï¼Œé€‰æ‹©ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„å®ç°è¿”å› å®ç°1234567891011121314151617181920212223242526272829303132333435/*** æ ¹æ®ä¼ å…¥æ¡ä»¶, é€‰æ‹©å…·ä½“çš„spiå®ç°ç±»* &lt;p/&gt;* è¿™é‡Œè¦æ±‚confçš„ç±»å‹å’Œé€‰æ‹©å™¨çš„å‚æ•°ç±»å‹åŒ¹é…, å¦åˆ™ä¼šå°è¯•ä½¿ç”¨é»˜è®¤çš„é€‰æ‹©å™¨è¡¥æ•‘, è‹¥è¡¥æ•‘å¤±è´¥, åˆ™æŠ›å¼‚å¸¸** @param conf* @return* @throws NoSpiMatchException* @throws IllegalArgumentException*/@SuppressWarnings(\"unchecked\")public T getService(Object conf) throws NoSpiMatchException &#123; if (spiImplClassCacheMap == null || spiImplClassCacheMap.size() == 0) &#123; loadSpiService(); &#125; if (!currentSelector.getConditionType().isAssignableFrom(conf.getClass())) &#123; /** * å‚æ•°ç±»å‹ä¸åŒ¹é…æ—¶, åˆ¤æ–­æ˜¯å¦å¯ä»¥æ ¹æ®é»˜è®¤çš„é€‰æ‹©å™¨æ¥è·å– */ if (conf instanceof String) &#123; return (T) DEFAULT_SELECTOR.getSelector().selector(spiImplClassCacheMap, conf); &#125; /** * å‚æ•°ç±»å‹å®Œå…¨ä¸åŒ¹é…, åˆ™æŠ›å‚æ•°å¼‚å¸¸ */ throw new IllegalArgumentException(\"conf spiInterfaceType should be sub class of [\" + currentSelector.getConditionType() + \"] but yours:\" + conf.getClass()); &#125; return (T) currentSelector.getSelector().selector(spiImplClassCacheMap, conf);&#125; è¯´æ˜ spiImplClassCacheMap spiå®ç°çš„ç¼“å­˜æ˜ å°„è¡¨ï¼Œä¼˜å…ˆåˆ¤æ–­ç¼“å­˜æ˜ å°„è¡¨æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨æ—¶éœ€è¦åˆå§‹åŒ–ï¼›å­˜åœ¨æ—¶ï¼Œåˆ™è¿›å…¥æ ¡éªŒé€»è¾‘ æ ¡éªŒ æ ¡éªŒä¼ å…¥çš„å‚æ•°ï¼Œæ˜¯å¦åŒ¹é…å½“å‰çš„é€‰æ‹©å™¨å‚æ•°ç±»å‹ï¼Œä¸ºäº†ä¿è¯é€‰æ‹©å™¨å¯ä»¥æ­£å¸¸è¿è¡Œ å½“ä¸åŒ¹é…æ—¶ï¼Œä¼šæœ‰ä¸€ä¸ªå…¼å®¹é€»è¾‘ï¼Œåˆ¤æ–­ä¼ å‚ç±»å‹æ˜¯å¦ä¸ºStringï¼Œ æ˜¯åˆ™é‡‡ç”¨é»˜è®¤çš„é€‰æ‹©å™¨ï¼Œæ ¹æ®nameæ¥é€‰æ‹©spiå®ç° ï¼ˆè¿™ç§å®ç°å¯èƒ½é€ æˆé€‰æ‹©çš„å®ç°ä¸æ˜¯é¢„æœŸçš„ï¼‰ é™æ€ä½¿ç”¨æ–¹å¼ï¼Œä½¿ç”¨ç±»å®šä¹‰é€‰æ‹©å™¨ : currentSelector é™æ€ä½¿ç”¨çš„æ–¹å¼ï¼Œç›®æ ‡å°±æ˜¯äº‹å‰å°±ç¡®è®¤ä½¿ç”¨è¿™ä¸ªå®ç°äº†ï¼Œä¸ä¼šå‡ºç°å˜åŠ¨äº†ï¼› ç›¸å½“äºä¸€æ¬¡ç¡®è®¤ï¼Œæ‰€æœ‰çš„è°ƒç”¨éƒ½æ˜¯ç¡®è®¤çš„ é™æ€ä½¿ç”¨ï¼Œæ–¹æ³•æ³¨è§£çš„é€‰æ‹©å™¨æ— æ•ˆã€‚è¿™ä¸ªæˆ‘ä»¬ä»é€†å‘çš„æ€è·¯è¿›è¡Œè§£é‡Š IPrint æ˜¯ä¸€ä¸ªSpiæ¥å£ï¼Œ æœ‰ä¸¤ä¸ªå®ç° FilePrint, ConsolePrint å‡è®¾ `currentSelector=DefaultSelector`ï¼Œ æ–¹æ³• methodA ä¸Šå®šä¹‰çš„æ˜¯ ParamsSelector æ—¶ é™æ€ä½¿ç”¨æ–¹å¼ï¼Œè·å–ä¸€ä¸ªspiå®ç°ï¼Œå¸Œæœ›åœ¨æ‰€æœ‰çš„spiæ¥å£ä½¿ç”¨å¤„ï¼Œéƒ½è¾“å‡ºåˆ°æ–‡ä»¶ï¼Œç”¨æˆ·æ ¹æ® `FilePrint` é€‰æ‹© FilePrint è¿™ä¸ªç±»æ¥æ‰§è¡Œå…·ä½“çš„è¾“å‡ºé€»è¾‘ï¼Œ å¦‚æœåœ¨è°ƒç”¨ methodA æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œ å‡è®¾æ ¹æ® ParamsSelector åˆ¤æ–­ï¼Œ ConsolePrint æ‰æ»¡è¶³è¿™å„¿æ¡ä»¶ï¼Œè¿™æ˜¯ç›¸å½“äºåœ¨å…·ä½“å®ç°æ—¶ï¼Œæ¢æˆäº†å¦ä¸€ä¸ª ConsolePrint, è¿™ä¸‹å­å°±ä¸æˆ‘ä»¬çš„åˆè¡·èƒŒç¦»äº†ï¼ˆå¦‚æœç›®æ ‡æ˜¯æƒ³å®ç°è¿™ä¸ªåœºæ™¯ï¼Œæ˜¾ç„¶åŠ¨æ€é€‚é…çš„æ–¹å¼æ‰æ˜¯æ­£ç¡®çš„ä½¿ç”¨å§¿åŠ¿ï¼‰ loadService çš„é€»è¾‘åé¢è¯¦ç»†è¯´æ˜ 4. åŠ¨æ€ä½¿ç”¨ åŠ¨æ€ä½¿ç”¨åŒºåˆ«äºé™æ€çš„ç›´æ¥ç¡®å®šå®ç°ç±»ï¼Œ é€šè¿‡getService è·å–çš„å¹¶ä¸æ˜¯æŸä¸ªç‰¹å®šå¯¹çš„å®ç°ç±»ï¼Œè€Œæ˜¯ä¸€ä¸ªåŠ¨æ€ç”Ÿæˆçš„ä»£ç†ï¼Œæ¯æ¬¡å…·ä½“æ‰§è¡Œä¹‹å‰ï¼Œä¼šå»åˆ¤æ–­ä¸€ä¸‹ï¼Œåº”è¯¥é€‰æ‹©å“ªä¸€ä¸ªå®ç°æ¥æ‰§è¡Œ è®¾è®¡çš„å‡ºå‘ç‚¹å¯ä»¥è€ƒè™‘ä¸‹ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯åœ¨æ‰§è¡Œæ–¹æ³•ä¹‹å‰ï¼Œéœ€è¦åˆ¤æ–­ä¸€ä¸‹å“ªä¸ªå®ç°ç±»æ»¡è¶³è¦æ±‚ï¼Œé€‰æ‹©è¿™ä¸ªå®ç°ç±»æ¥æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ€ä¹ˆå»åšï¼Ÿ è€ƒè™‘åˆ°åˆ‡é¢çš„æ–¹å¼ï¼Œå¦‚æœæœ‰ä¸€ç§æ‰‹æ®µï¼Œåœ¨æ–¹æ³•æ‰§è¡Œä¹‹å‰ï¼Œç»‡å…¥ä¸€æ®µä¸šåŠ¡é€»è¾‘ï¼Œå°±å¯ä»¥è¾¾åˆ°ä¸Šé¢çš„ç›®çš„ æœ€å¼€å§‹è™½ç„¶æ˜¯æ€ä¹ˆæƒ³çš„ï¼Œä½†æ˜¯æœ‰ç‚¹å°´å°¬çš„æ˜¯ï¼Œä¸çŸ¥é“æ€ä¹ˆå»å®ç°ï¼›å› æ­¤æ¢äº†ä¸€ä¸ªæ€è·¯ï¼Œæˆ‘è‡ªå·±æ–°ç”Ÿæˆä¸€ä¸ªæ¥å£çš„å®ç°ç±»ï¼Œåœ¨è¿™ä¸ªå®ç°ç±»é‡Œé¢åšé€‰æ‹©é€»è¾‘ï¼Œç„¶åæŠŠè¿™ä¸ªå®ç°ç±»å¯¹è±¡è¿”å› å®ç°å¦‚ä¸‹å’Œé™æ€å®ç°çš„é€»è¾‘å·®ä¸å¤šï¼Œä¸€èˆ¬æµç¨‹å¦‚ä¸‹: åˆ¤æ–­spiå®ç°ç±»çš„æ˜ å°„å…³ç³»è¡¨æ˜¯å¦åˆå§‹åŒ–ï¼Œè‹¥æ²¡æœ‰åˆ™åˆå§‹åŒ– è·å–é€‰æ‹©å™¨ ä¼˜å…ˆä»æ–¹æ³•é€‰æ‹©å™¨ä¸­æŸ¥æ‰¾ï¼Œ è‹¥å­˜åœ¨ï¼Œåˆ™ç›´æ¥é€‰ä¸­ï¼› ä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨ç±»é€‰æ‹©å™¨ æ ¡éªŒï¼šåˆ¤æ–­ä¼ å…¥æ¡ä»¶å‚æ•°ç±»å‹æ˜¯å¦æ»¡è¶³é€‰æ‹©å™¨çš„å‚æ•°ç±»å‹åŒ¹é…ï¼ˆå°†æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä½œä¸ºé€‰æ‹©å™¨çš„é€‰æ‹©æ¡ä»¶ï¼‰ è¿”å›å®ç°ç±» 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950@SuppressWarnings(\"unchecked\")public T getService(Object conf, String methodName) throws NoSpiMatchException &#123; if (spiImplClassCacheMap == null || spiImplClassCacheMap.size() == 0) &#123; loadSpiService(); &#125; // é¦–å…ˆè·å–å¯¹åº”çš„selector SelectorWrapper selector = currentMethodSelector.get(methodName); if (selector == null) &#123; // è‡ªé€‚åº”æ–¹æ³•ä¸Šæœªå®šä¹‰é€‰æ‹©å™¨, åˆ™é»˜è®¤ç»§æ‰¿ç±»çš„ selector = currentSelector; currentMethodSelector.putIfAbsent(methodName, selector); &#125; if (!selector.getConditionType().isAssignableFrom(conf.getClass())) &#123; // é€‰æ‹©å™¨ç±»å‹æ ¡éªŒ if (!(conf instanceof String)) &#123; throw new IllegalArgumentException(\"conf spiInterfaceType should be sub class of [\" + currentSelector.getConditionType() + \"] but yours:\" + conf.getClass()); &#125; selector = DEFAULT_SELECTOR; &#125; if (spiImplMethodCacheMap.size() == 0) &#123; return (T) selector.getSelector().selector(spiImplClassCacheMap, conf); &#125; try &#123; // é‡‡ç”¨é»˜è®¤çš„é€‰æ‹©å™¨,æ ¹æ®æŒ‡å®šname è¿›è¡ŒæŸ¥è¯¢æ—¶, éœ€è¦å…¼å®¹ä¸€ä¸‹, å› ä¸ºmethodå¯¹åº”çš„ç¼“å­˜keyä¸º SpiImpName_methodName if (DEFAULT_SELECTOR.equals(selector)) &#123; if (spiImplMethodCacheMap.containsKey(conf)) &#123; return (T) selector.getSelector().selector(spiImplMethodCacheMap, conf); &#125; if (spiImplClassCacheMap.containsKey(conf)) &#123; return (T) selector.getSelector().selector(spiImplClassCacheMap, conf); &#125; return (T) selector.getSelector().selector(spiImplMethodCacheMap, conf + \"_\" + methodName); &#125; else &#123; return (T) selector.getSelector().selector(spiImplMethodCacheMap, conf); &#125; &#125; catch (Exception e) &#123; return (T) selector.getSelector().selector(spiImplClassCacheMap, conf); &#125;&#125; è¯´æ˜ è¿™ä¸ªæ–¹æ³•é€šå¸¸æ˜¯ç”±æ¡†æ¶ç”Ÿæˆçš„ä»£ç†å®ç°ç±»æ¥è°ƒç”¨ï¼ˆåé¢ä¼šè¯´æ˜åŠ¨æ€ç”Ÿæˆä»£ç†ç±»çš„é€»è¾‘ï¼‰ åŒºåˆ«ä¸é™æ€ä½¿ç”¨æ–¹å¼ï¼Œ ä¼˜å…ˆæ ¹æ®æ–¹æ³•åï¼ŒæŸ¥æ‰¾å¯¹åº”çš„é€‰æ‹©å™¨ï¼›å½“æœªå®šä¹‰æ—¶ï¼Œä½¿ç”¨ç±»é€‰æ‹©å™¨ é»˜è®¤é€‰æ‹©å™¨ï¼Œæ ¹æ®nameæ¥æŸ¥è¯¢å®ç°æ—¶ï¼Œä¼ å…¥çš„å‚æ•°ç‰¹æ®Šå¤„ç†ä¸‹ï¼Œä¸»è¦æ˜¯å› ä¸º spiImplMethodCacheMap ä¸­keyçš„ç”Ÿæˆï¼Œæœ‰ä¸€ä¸ªå°è½¬æ¢ è‹¥å®ç°ç±»ä¸Šæ²¡æœ‰ @SpiConfæ³¨è§£ï¼Œæˆ–è€… @SpiConfçš„æ³¨è§£æ²¡æœ‰å®šä¹‰ name å±æ€§ï¼Œåˆ™ç±»çš„å”¯ä¸€æ ‡è¯†nameä¸ºï¼šç®€å•ç±»åï¼› å¦åˆ™ä¸ºæŒ‡å®šçš„nameå±æ€§ è‹¥æ–¹æ³•ä¸Šæ˜¾ç¤ºä½¿ç”¨ @SpiConf æŒ‡å®šäº†nameå±æ€§ï¼Œåˆ™keyçš„ç”Ÿæˆè§„åˆ™ä¸ºï¼š æ–¹æ³•æ³¨è§£ä¸ŠæŒ‡å®šçš„nameï¼› å¦‚æœæ²¡æœ‰ @SpiConfæ³¨è§£ï¼Œæˆ–å…¶ä¸­æ²¡æœ‰æŒ‡å®šnameå±æ€§ï¼Œåˆ™keyç”Ÿæˆè§„åˆ™: ç±»nameå±æ€§ + ä¸‹åˆ’çº¿ + æ–¹æ³•å è¿™ä¸€ç‚¹å•ç‹¬çœ‹å¯èƒ½ä¸å¤ªå¥½ç†è§£ï¼Œå› æ­¤å¯ä»¥å’Œä¸‹é¢çš„spiå®ç°ç±»æ˜ å°„å…³ç³»çš„åˆå§‹åŒ–ç»“åˆèµ·æ¥ åŠ¨æ€ç”Ÿæˆä»£ç†ç±»çš„é€»è¾‘ï¼Œæ”¾åœ¨æœ€åè¿›è¡Œè¯´æ˜ 5. spiå®ç°ç±»æ˜ å°„å…³ç³»è¡¨åˆå§‹åŒ– ä¸ºäº†é¿å…æ¯æ¬¡é€‰æ‹©å…·ä½“çš„å®ç°ç±»æ—¶ï¼Œéƒ½å»åŠ è½½ä¸€éï¼Œè€—æ—¶è€—åŠ›å¥½æ€§èƒ½ï¼Œå› æ­¤åŠ ä¸€ä¸ªç¼“å­˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œè¿™é‡Œä¸»è¦è¯´ä¸‹è¿™ä¸ªå®ç°é€»è¾‘ï¼Œä»¥åŠä¸ºå•¥è¿™ä¹ˆå¹² ç¼“å­˜ç»“æ„ä½¿ç”¨äº†ä¸¤ä¸ªMapï¼š ä¸€ä¸ªæ˜¯ç±»çº§åˆ«çš„æ˜ å°„å…³ç³» spiImplClassCacheMap é™æ€ä½¿ç”¨æ—¶ï¼Œåªä¼šç”¨æè¿™ä¸ª åŠ¨æ€é€‚é…æ—¶ï¼Œå½“ä¸‹é¢çš„æ˜ å°„å…³ç³»ä¸­æ— æ³•è·å–æ»¡è¶³æ¡ä»¶çš„å®ç°æ—¶ï¼Œä¼šå†æ¬¡ä»è¿™é‡Œè¿›è¡Œåˆ¤æ–­ keyï¼š @SpiConf æ³¨è§£ä¸­å®šä¹‰çš„nameï¼› æˆ–è€…spiå®ç°ç±»çš„ç®€å•ç±»å ä¸€ä¸ªæ˜¯æ–¹æ³•çš„æ˜ å°„å…³ç³» spiImplMethodCacheMap åŠ¨æ€é€‚é…æ—¶ï¼Œ é€‰æ‹©å™¨ä¼˜å…ˆä»è¿™é‡Œè¿›è¡Œåˆ¤æ–­ key: @SpiConf æ³¨è§£ä¸­å®šä¹‰çš„nameï¼› æˆ–è€…æ˜¯ å®ç°ç±»çš„ name + â€œ_â€ + æ–¹æ³•å 12345678910/*** name : spiImpl çš„æ˜ å°„è¡¨*/private Map&lt;String, SpiImplWrapper&lt;T&gt;&gt; spiImplClassCacheMap;/*** è‡ªé€‚åº”æ—¶, æ ¹æ®æ–¹æ³•é€‰æ‹©å®ç°; name : spiImpl çš„æ˜ å°„è¡¨*/private Map&lt;String, SpiImplWrapper&lt;T&gt;&gt; spiImplMethodCacheMap; å®ç°123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101private void loadSpiService() &#123; List&lt;SpiImplWrapper&lt;T&gt;&gt; spiServiceList = new ArrayList&lt;&gt;(); List&lt;SpiImplWrapper&lt;T&gt;&gt; spiServiceMethodList = new ArrayList&lt;&gt;(); ServiceLoader&lt;T&gt; serviceLoader = ServiceLoader.load(spiInterfaceType); SpiConf spiConf; String implName; int implOrder; for (T t : serviceLoader) &#123; spiConf = t.getClass().getAnnotation(SpiConf.class); Map&lt;String, String&gt; map; if (spiConf == null) &#123; implName = t.getClass().getSimpleName(); implOrder = SpiImplWrapper.DEFAULT_ORDER; // å‚æ•°é€‰æ‹©å™¨æ—¶, è¦æ±‚spiå®ç°ç±»å¿…é¡»æœ‰ @SpiConf æ³¨è§£, å¦åˆ™é€‰æ‹©å™¨æ— æ³•è·å–æ ¡éªŒæ¡ä»¶å‚æ•° if (currentSelector.getSelector() instanceof ParamsSelector) &#123; throw new IllegalStateException(\"spiImpl must contain annotation @SpiConf!\"); &#125; map = Collections.emptyMap(); &#125; else &#123; implName = spiConf.name(); if (StringUtils.isBlank(implName)) &#123; implName = t.getClass().getSimpleName(); &#125; implOrder = spiConf.order() &lt; 0 ? SpiImplWrapper.DEFAULT_ORDER : spiConf.order(); map = parseParms(spiConf.params()); &#125; // æ·»åŠ ä¸€ä¸ªç±»çº§åˆ«çš„å°è£…ç±» spiServiceList.add(new SpiImplWrapper&lt;&gt;(t, implOrder, implName, map)); // todo æ”¹æˆ getMethods(), ä½†æ˜¯è¿‡æ»¤æ‰ Objectç±»ä¸­çš„åŸºç¡€æ–¹æ³• Method[] methods = t.getClass().getDeclaredMethods(); String methodImplName; int methodImplOrder; Map&lt;String, String&gt; methodParams; for (Method method : methods) &#123; spiConf = method.getAnnotation(SpiConf.class); if (spiConf == null) &#123; continue; &#125; // æ–¹æ³•ä¸Šæœ‰è‡ªå®šä¹‰æ³¨è§£, ä¸”å®šä¹‰çš„nameä¸ç±»å®ç°åä¸åŒ, åˆ™ç›´æ¥é‡‡ç”¨ // å¦åˆ™é‡‡ç”¨ ServiceName_MethodName æ–¹å¼å®šä¹‰ if (StringUtils.isBlank(spiConf.name()) || implName.equals(spiConf.name())) &#123; methodImplName = implName + \"_\" + method.getName(); &#125; else &#123; methodImplName = spiConf.name(); &#125; // ä¼˜å…ˆçº§, ä»¥æœ€å°çš„ä¸ºå‡† ï¼ˆå³ä¸€ä¸ªç±»ä¸Šçš„ä¼˜å…ˆçº§å¾ˆä½, ä¹Ÿå¯ä»¥å®šä¹‰ä¼˜å…ˆçº§é«˜çš„æ–¹æ³•ï¼‰ // æ–¹æ³•æ³¨è§£æœªå®šä¹‰é¡ºåºæ—¶, ç»§æ‰¿ç±»ä¸Šçš„é¡ºåº methodImplOrder = Math.min(implOrder, spiConf.order() &lt; 0 ? implOrder : spiConf.order()); // è‡ªé€‚åº”æ–¹æ³•çš„å‚æ•°é™åˆ¶, è¦æ±‚ç»§æ‰¿ç±»ä¸Šçš„å‚æ•° methodParams = parseParms(spiConf.params()); if (map.size() &gt; 0) &#123; // æ–¹æ³•çš„å‚æ•°é™å®šä¼šç»§æ‰¿ç±»ä¸Šçš„å‚æ•°é™å®š if (methodParams.size() == 0) &#123; methodParams = map; &#125; else &#123; methodParams.putAll(map); &#125; &#125; spiServiceMethodList.add(new SpiImplWrapper&lt;&gt;(t, methodImplOrder, methodImplName, methodParams)); &#125; &#125; if (spiServiceList.size() == 0) &#123; throw new IllegalStateException(\"no spiImpl implements spi: \" + spiInterfaceType); &#125; this.spiImplClassCacheMap = initSpiImplMap(spiServiceList); this.spiImplMethodCacheMap = initSpiImplMap(spiServiceMethodList);&#125;private Map&lt;String, SpiImplWrapper&lt;T&gt;&gt; initSpiImplMap(List&lt;SpiImplWrapper&lt;T&gt;&gt; list) &#123; // æ˜ å°„ä¸ºmap, é™å®šä¸èƒ½é‡å Map&lt;String, SpiImplWrapper&lt;T&gt;&gt; tempMap = new ConcurrentHashMap&lt;&gt;(); for (SpiImplWrapper&lt;T&gt; wrapper : list) &#123; if (tempMap.containsKey(wrapper.getName())) &#123; throw new IllegalArgumentException(\"duplicate spiImpl name \" + wrapper.getName()); &#125; tempMap.put(wrapper.getName(), wrapper); &#125; return tempMap;&#125; ä¸Šé¢çš„é€»è¾‘å¯ä»¥åˆ†ä¸ºä¸¤å—ï¼Œä¸€å—æ˜¯ä¸ŠåŠè¾¹çš„åˆå§‹åŒ–ï¼Œè·å–spiImplClassCacheMap;ä¸‹ä¸€å—åˆ™æ˜¯æ‰«æå®ç°ç±»çš„æ‰€æœ‰æ–¹æ³•ï¼Œå°†æ–¹æ³•ä¸Šæ ‡æœ‰@SpiConfæ³¨è§£çš„æå‡ºæ¥ï¼Œç”¨äºåˆå§‹åŒ– spiImplMethodCacheMap è¯´æ˜ ç¼“å­˜ç»“æ„ä¸­valueä¸º SpiImplWrapper ç¼“å­˜valueå¹¶ä¸æ˜¯ç®€å•çš„å®ç°ç±»ï¼Œå°è£…ç±»çš„å®šä¹‰å¦‚ä¸‹ï¼Œå°†æ¡ä»¶å’Œæ’åºä¹ŸåŒæ—¶å°è£…è¿›å»äº† 1234567891011121314151617181920private T spiImpl;private int order;/*** spiImpl çš„æ ‡è¯†name, è¦æ±‚å”¯ä¸€* &lt;p/&gt;* &#123;@link com.hust.hui.quicksilver.spi.selector.DefaultSelector é€‰æ‹©å…·ä½“çš„SpiImpl æ—¶ä½¿ç”¨&#125;*/private String name;/*** å‚æ•°æ ¡éªŒè§„åˆ™* &lt;p/&gt;* &#123;@link com.hust.hui.quicksilver.spi.selector.ParamsSelector&#125; é€‰æ‹©å…·ä½“çš„SpiImpl æ—¶ä½¿ç”¨* è¦æ±‚æ¯ä¸ªå®ç°ç±»éƒ½æœ‰æ³¨è§£ &#123;@link SpiConf&#125;*/private Map&lt;String, String&gt; paramCondition; name çš„å®šä¹‰ï¼Œç±»ä¸æ–¹æ³•ä¸¤ä¸ªçº¬åº¦çš„ç¼“å­˜ä¸­ï¼Œå®šä¹‰è§„åˆ™ä¸åŒï¼Œå…·ä½“å¯ä»¥çœ‹ã€Šç¼“å­˜ç»“æ„ã€‹è¿™é‡Œçš„è¯´æ˜ é‡‡ç”¨ ParamsSelector æ—¶ï¼Œ è¦æ±‚ @SpiConf æ³¨è§£å¿…é¡»å­˜åœ¨ æ³¨æ„æ‰«ææ‰€æœ‰æ–¹æ³•å¯¹åº”çš„æ³¨è§£, spiå®ç°ç±»ï¼Œå¦‚æœå­˜åœ¨ç»§æ‰¿åˆ™ä¼šå‡ºç°é—®é¢˜ // todo æ”¹æˆ getMethods(), ä½†æ˜¯è¿‡æ»¤æ‰ Objectç±»ä¸­çš„åŸºç¡€æ–¹æ³• Method[] methods = t.getClass().getDeclaredMethods(); åŠ¨æ€ä»£ç ç”Ÿæˆ ä¸Šé¢åœ¨è°ˆè®ºåŠ¨æ€ä½¿ç”¨çš„æ—¶å€™ï¼Œé‡‡ç”¨çš„æ–¹æ¡ˆæ˜¯ï¼Œç”Ÿæˆä¸€ä¸ªä»£ç†ç±»ï¼Œå®ç°spiæ¥å£ï¼Œ åœ¨å…·ä½“çš„å®ç°é€»è¾‘ä¸­ï¼Œä½¿ç”¨é€‰æ‹©å™¨æ¥è·å–æ»¡è¶³æ¡ä»¶çš„å®ç°ç±»ï¼Œç„¶åæ‰§è¡Œç›¸åº”çš„æ–¹æ³• 1. ä»£ç†ç±»æ ¼å¼é‡‡ç”¨å€’æ¨æ–¹å¼ï¼Œå…ˆç»™å‡ºä¸€ä¸ªå®é™…çš„ä»£ç†ç±»å¦‚ä¸‹ï¼Œå…·ä½“çš„å®ç°ä¸­å…¶å®åªæœ‰ä¸¤è¡Œä»£ç  è·å–å…·ä½“çš„å®ç°ç±» ï¼ˆè°ƒç”¨ä¸Šé¢çš„ SpiLoader.getService(conf, methodNameï¼‰ æ‰§è¡Œå®ç°ç±»çš„æ¥å£ 123456789101112131415161718192021222324package com.hust.hui.quicksilver.spi.test.print;import com.hust.hui.quicksilver.spi.SpiLoader;public class IPrint$Proxy implements com.hust.hui.quicksilver.spi.test.print.IPrint &#123; public void print(java.lang.String arg0) &#123; try &#123; com.hust.hui.quicksilver.spi.test.print.IPrint spiImpl = SpiLoader.load(com.hust.hui.quicksilver.spi.test.print.IPrint.class).getService(arg0, \"print\"); spiImpl.print(arg0); &#125; catch (com.hust.hui.quicksilver.spi.exception.NoSpiMatchException e) &#123; throw new java.lang.RuntimeException(e); &#125; &#125; public void adaptivePrint(java.lang.String arg0, java.lang.String arg1) &#123; try &#123; com.hust.hui.quicksilver.spi.test.print.IPrint spiImpl = SpiLoader.load(com.hust.hui.quicksilver.spi.test.print.IPrint.class).getService(arg0, \"adaptivePrint\"); spiImpl.adaptivePrint(arg0, arg1); &#125; catch (com.hust.hui.quicksilver.spi.exception.NoSpiMatchException e) &#123; throw new java.lang.RuntimeException(e); &#125; &#125;&#125; ä¸Šé¢ç»™å‡ºäº†ä¸€ä¸ªä»£ç†ç±»çš„æ¼”ç¤ºï¼Œé‚£ä¹ˆå‰©ä¸‹ä¸¤ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªæ˜¯å¦‚ä½•ç”Ÿæˆä»£ç†ç±»ï¼› ä¸€ä¸ªæ˜¯å¦‚ä½•è¿è¡Œä»£ç†ç±»ï¼ˆä¸Šé¢æ˜¯javaä»£ç ï¼Œæˆ‘ä»¬çŸ¥é“è¿è¡Œå¾—æ˜¯å­—èŠ‚ç æ‰è¡Œï¼‰ ä»£ç†ç±»ç”Ÿæˆå¯¹ç€ä¸Šé¢çš„å®ç°ï¼Œåæ¨ä»£ç ç”Ÿæˆï¼Œå…¶å®æ¯”è¾ƒç®€å•äº†ï¼Œæ— éå°±æ˜¯ç”Ÿæˆä¸€å¤§ä¸²çš„Stringç½¢äº†ï¼Œè¿™é‡ŒçœŸæ²¡ä»€ä¹ˆç‰¹æ®Šçš„ï¼Œè´´ä¸‹å®ç°ï¼Œé€»è¾‘çœç•¥ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566/** * æ„å»ºSPIæ¥å£çš„å®ç°ä»£ç†ç±», åœ¨æ‰§è¡ŒåŠ¨æ€é€‚é…çš„æ–¹æ³•æ—¶, è°ƒç”¨SpiLoaderçš„ spiImplé€‰æ‹©å™¨, é€‰æ‹©å…·ä½“çš„å®ç°ç±»æ‰§è¡Œ * * @return */public static String buildTempImpl(Class type) &#123; StringBuilder codeBuilder = new StringBuilder(); codeBuilder.append(\"package \").append(type.getPackage().getName()).append(\";\"); codeBuilder.append(\"\\nimport \").append(SpiLoader.class.getName()).append(\";\"); codeBuilder.append(\"\\npublic class \").append(type.getSimpleName()).append(\"$Proxy implements \").append(type.getCanonicalName()).append(\" &#123;\\n\"); Method[] methods = type.getMethods(); for (Method method : methods) &#123; Class&lt;?&gt; returnType = method.getReturnType(); //å‡½æ•°è¿”å›å€¼ Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();//å‡½æ•°å‚æ•°åˆ—è¡¨ Class&lt;?&gt;[] exceptionTypes = method.getExceptionTypes();//å‡½æ•°å¼‚å¸¸åˆ—è¡¨ // build method code StringBuilder code = new StringBuilder(512); if (parameterTypes.length &lt; 0) &#123; //æ£€æŸ¥è¯¥å‡½æ•°å‚æ•°åˆ—è¡¨ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸ºé€‰æ‹©å™¨å‚æ•° code.append(\"throw new IllegalArgumentException(\\\"there should be one argument for selector to choose spiImpl\\\")\"); &#125; else &#123; // æ²¡æœ‰ SpiAdaptiveæ³¨è§£çš„, é‡‡ç”¨é»˜è®¤çš„æ³¨è§£æ–¹å¼ code.append(\"try&#123;\\n\"); code.append(type.getName()).append(\" spiImpl=\") .append(\"SpiLoader.load(\") .append(type.getName()).append(\".class\") .append(\").getService(arg0,\\\"\") .append(method.getName()) .append(\"\\\");\"); if (!\"void\".equals(returnType.getName())) &#123; code.append(\"return \"); &#125; code.append(\"spiImpl.\").append(method.getName()).append(\"(arg0\"); for (int i = 1; i &lt; parameterTypes.length; i++) &#123; code.append(\",\").append(\"arg\").append(i); &#125; code.append(\");\"); code.append(\"\\n&#125; catch(com.hust.hui.quicksilver.spi.exception.NoSpiMatchException e)&#123;\\nthrow new java.lang.RuntimeException(e);\\n&#125;\"); &#125; // build method signature codeBuilder.append(\"\\npublic \").append(returnType.getName()).append(\" \").append(method.getName()) .append(\"(\").append(parameterTypes[0].getName()).append(\" arg0\"); for (int i = 1; i &lt; parameterTypes.length; i++) &#123; codeBuilder.append(\", \").append(parameterTypes[i].getName()).append(\" arg\").append(i); &#125; codeBuilder.append(\") \"); if (exceptionTypes.length &gt; 0) &#123; codeBuilder.append(\"throw \").append(exceptionTypes[0].getName()); for (int i = 1; i &lt; exceptionTypes.length; i++) &#123; codeBuilder.append(\", \").append(exceptionTypes[i].getName()); &#125; &#125; codeBuilder.append(\"&#123;\\n\"); codeBuilder.append(code.toString()).append(\"\\n&#125;\"); &#125; codeBuilder.append(\"\\n&#125;\"); return codeBuilder.toString();&#125; åŠ¨æ€ç¼–è¯‘è¿è¡ŒåŠ¨æ€ç¼–è¯‘ï¼Œæœ€å¼€å§‹æƒ³çš„æ˜¯åˆ©ç”¨jdkçš„åŠ¨æ€ç¼–è¯‘æ–¹å¼ï¼Œè¯•æ¥è¯•å»æ²¡ææˆåŠŸï¼Œç„¶åé€‰æ‹©äº†ä¸€ä¸ªæŠ˜ä¸­çš„æ–¹æ¡ˆï¼ŒæŠŠä»£ç†ç±»çœ‹æˆæ˜¯groovyä»£ç ï¼Œåˆ©ç”¨ GroovyEngine æ¥å®ç°åŠ¨æ€è¿è¡Œ, è¿™ä¸€å—çš„é€»è¾‘ä¹Ÿè¶…çº§ç®€å•ï¼Œä¸‹é¢çš„çŸ­çŸ­å‡ è¡Œä»£ç å³å¯ï¼› åé¢æœ‰ç©ºå•ç‹¬ç ”ç©¶ä¸‹javaçš„åŠ¨æ€ç¼–è¯‘ 12345678910111213141516@SuppressWarnings(\"unchecked\")public static &lt;T&gt; T compile(String code, Class&lt;T&gt; interfaceType, ClassLoader classLoader) throws SpiProxyCompileException &#123; GroovyClassLoader loader = new GroovyClassLoader(classLoader); Class clz = loader.parseClass(code); if (!interfaceType.isAssignableFrom(clz)) &#123; throw new IllegalStateException(\"illegal proxy type!\"); &#125; try &#123; return (T) clz.newInstance(); &#125; catch (Exception e) &#123; throw new SpiProxyCompileException(\"init spiProxy error! msg: \" + e.getMessage()); &#125;&#125; å°ç»“è‡³æ­¤ï¼Œæ ¸å¿ƒçš„ä¸œè¥¿åŸºæœ¬ä¸Šéƒ½è¿‡äº†ä¸€éï¼Œä¸»è¦çš„è®¾è®¡æ€è·¯ï¼Œå®ç°é€»è¾‘ï¼Œæ‰§è¡Œæµç¨‹éƒ½è¯´å®Œäº† åšå®¢ç³»åˆ—é“¾æ¥ï¼š SPIæ¡†æ¶å®ç°ä¹‹æ—…å››ï¼šä½¿ç”¨æµ‹è¯• SPIæ¡†æ¶å®ç°ä¹‹æ—…ä¸‰ï¼šå®ç°è¯´æ˜ SPIæ¡†æ¶å®ç°ä¹‹æ—…äºŒï¼šæ•´ä½“è®¾è®¡ SPIæ¡†æ¶å®ç°ä¹‹æ—…ä¸€ï¼šèƒŒæ™¯ä»‹ç» é¡¹ç›®: QuickAlarm é¡¹ç›®åœ°å€ï¼š Quick-SPI åšå®¢åœ°å€ï¼š å°ç°ç°Blog ä¸ªäººåšå®¢ï¼š Z+|blogåŸºäºhexo + github pagesæ­å»ºçš„ä¸ªäººåšå®¢ï¼Œè®°å½•æ‰€æœ‰å­¦ä¹ å’Œå·¥ä½œä¸­çš„åšæ–‡ï¼Œæ¬¢è¿å¤§å®¶å‰å»é€›é€› å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è¯†æœ‰é™ï¼Œå¦‚å‘ç°bugæˆ–è€…æœ‰æ›´å¥½çš„å»ºè®®ï¼Œéšæ—¶æ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼Œæˆ‘çš„å¾®åšåœ°å€: å°ç°ç°Blog æ‰«æå…³æ³¨","categories":[{"name":"Quickç³»åˆ—é¡¹ç›®","slug":"Quickç³»åˆ—é¡¹ç›®","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/"},{"name":"QuickSpi","slug":"Quickç³»åˆ—é¡¹ç›®/QuickSpi","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/QuickSpi/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"SPI","slug":"SPI","permalink":"https://zbang.online/hexblog/tags/SPI/"}],"keywords":[{"name":"Quickç³»åˆ—é¡¹ç›®","slug":"Quickç³»åˆ—é¡¹ç›®","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/"},{"name":"QuickSpi","slug":"Quickç³»åˆ—é¡¹ç›®/QuickSpi","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/QuickSpi/"}]},{"title":"2. SPIæ¡†æ¶å®ç°ä¹‹æ—…äºŒï¼šæ•´ä½“è®¾è®¡","slug":"SPIæ¡†æ¶å®ç°ä¹‹æ—…äºŒï¼šæ•´ä½“è®¾è®¡","date":"2017-05-28T02:50:37.000Z","updated":"2018-02-13T03:21:17.019Z","comments":true,"path":"2017/05/28/SPIæ¡†æ¶å®ç°ä¹‹æ—…äºŒï¼šæ•´ä½“è®¾è®¡/","link":"","permalink":"https://zbang.online/hexblog/2017/05/28/SPIæ¡†æ¶å®ç°ä¹‹æ—…äºŒï¼šæ•´ä½“è®¾è®¡/","excerpt":"æ•´ä½“è®¾è®¡ ä¸Šä¸€ç¯‡ç®€å•çš„è¯´äº†ä¸€ä¸‹spiç›¸å…³çš„ä¸œè¥¿ï¼Œ æ¥ä¸‹æ¥æˆ‘ä»¬å‡†å¤‡å¼€åŠ¨ï¼Œæœ¬ç¯‡åšæ–‡ä¸»è¦é›†ä¸­åœ¨ä¸€äº›æœ¯è¯­ï¼Œä½¿ç”¨è§„èŒƒçš„çº¦å®šå’Œä½¿ç”¨æ–¹å¼","text":"æ•´ä½“è®¾è®¡ ä¸Šä¸€ç¯‡ç®€å•çš„è¯´äº†ä¸€ä¸‹spiç›¸å…³çš„ä¸œè¥¿ï¼Œ æ¥ä¸‹æ¥æˆ‘ä»¬å‡†å¤‡å¼€åŠ¨ï¼Œæœ¬ç¯‡åšæ–‡ä¸»è¦é›†ä¸­åœ¨ä¸€äº›æœ¯è¯­ï¼Œä½¿ç”¨è§„èŒƒçš„çº¦å®šå’Œä½¿ç”¨æ–¹å¼ è®¾è®¡æ€è·¯ä¸‹å›¾å›´ç»• SpiLoader ä¸ºä¸­å¿ƒï¼Œæè¿°äº†ä¸‰ä¸ªä¸»è¦çš„æµç¨‹ï¼š loadæ‰€æœ‰çš„spiå®ç° åˆå§‹åŒ–é€‰æ‹©å™¨ selector è·å–spiå®ç°ç±» ï¼ˆorä¸€ä¸ªå®ç°ç±»ä»£ç†ï¼‰ åŸºç¡€ç±»è¯´æ˜ ä¸»è¦ä»‹ç»ä¸€ä¸‹æ¡†æ¶ä¸­æ¶‰åŠåˆ°çš„æ¥å£å’Œæ³¨è§£ï¼Œå¹¶æŒ‡å‡ºéœ€è¦æ³¨æ„çš„ç‚¹ 1. Selector é€‰æ‹©å™¨ ä¸ºäº†æœ€å¤§ç¨‹åº¦çš„æ”¯æŒä¸šåŠ¡æ–¹å¯¹spiå®ç°ç±»çš„é€‰æ‹©ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªé€‰æ‹©å™¨çš„æ¦‚å¿µï¼Œç”¨äºè·å–spiå®ç°ç±» æ¥å£å®šä¹‰å¦‚ä¸‹:123public interface ISelector&lt;T&gt; &#123; &lt;K&gt; K selector(Map&lt;String, SpiImplWrapper&lt;K&gt;&gt; map, T conf) throws NoSpiMatchException;&#125; ç»“åˆä¸Šé¢çš„æ¥å£å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä¸‹ï¼Œé€‰æ‹©å™¨åº”è¯¥å¦‚ä½•å·¥ä½œï¼Ÿ æ ¹æ®ä¼ å…¥çš„æ¡ä»¶ï¼Œä»æ‰€æœ‰çš„å®ç°ç±»ä¸­ï¼Œæ‰¾åˆ°ä¸€ä¸ªæœ€åŒ¹é…çš„å®ç°ç±»è¿”å› å¦‚æœæŸ¥ä¸åˆ°ï¼Œåˆ™æŠ›ä¸€ä¸ªå¼‚å¸¸NoSpiMatchExceptionå‡ºå» æ‰€ä»¥ä¼ å…¥çš„å‚æ•°ä¼šæ˜¯ä¸¤ä¸ªï¼Œ ä¸€ä¸ªæ˜¯æ‰€æœ‰çš„å®ç°ç±»åˆ—è¡¨mapï¼ˆè‡³äºä¸Šé¢ä¸ºä»€ä¹ˆç”¨mapï¼Œåç»­åˆ†æï¼‰ï¼Œä¸€ä¸ªæ˜¯ç”¨äºåˆ¤æ–­çš„è¾“å…¥æ¡ä»¶conf æ¡†æ¶ä¸­ä¼šæä¾›ä¸¤ç§åŸºæœ¬çš„é€‰æ‹©å™¨å®ç°ï¼Œ DefaultSelector ï¼Œ å¯¹æ¯ä¸ªå®ç°ç±»èµ‹äºˆå”¯ä¸€çš„nameï¼Œé»˜è®¤é€‰æ‹©å™¨åˆ™è¡¨ç¤ºæ ¹æ®nameæ¥æŸ¥æ‰¾å®ç°ç±» ParamsSelectorï¼Œ åœ¨å®ç°ç±»ä¸ŠåŠ ä¸Š @SpiConf æ³¨è§£ï¼Œå®šä¹‰å…¶ä¸­çš„ paramsï¼Œå½“ä¼ å…¥çš„å‚æ•°(conf)ï¼Œ èƒ½å®Œå…¨åŒ¹é…å®šä¹‰çš„paramsï¼Œè¡¨ç¤ºè¿™ä¸ªå®ç°ç±»å°±æ˜¯ä½ æ‰€éœ€è¦çš„ è‡ªå®šä¹‰å®ç°è‡ªå®šä¹‰å®ç°æ¯”è¾ƒç®€å•ï¼Œå®ç°ä¸Šé¢çš„æ¥å£å³å¯ 2. Spi æ³¨è§£ è¦æ±‚æ‰€æœ‰çš„spiæ¥å£ï¼Œéƒ½å¿…é¡»æœ‰è¿™ä¸ªæ³¨è§£ï¼› å®šä¹‰å¦‚ä¸‹ä¸»è¦æ˜¯æœ‰ä¸€ä¸ªå‚æ•°ï¼Œç”¨äºæŒ‡å®šæ˜¯é€‰æ‹©å™¨ç±»å‹ï¼Œå®šä¹‰spiæ¥å£çš„é»˜è®¤é€‰æ‹©å™¨ï¼Œ 123456@Target(ElementType.TYPE)@Retention(RetentionPolicy.RUNTIME)@Documentedpublic @interface Spi &#123; Class&lt;? extends ISelector&gt; selector() default DefaultSelector.class;&#125; è¯´æ˜åœ¨ä¸Šä¸€ç¯‡ã€ŠSPIæ¡†æ¶å®ç°ä¹‹æ—…ä¸€ã€‹ä¸­ï¼Œä½¿ç”¨jdkçš„spiæ–¹å¼ä¸­ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨æ³¨è§£ä¾ç„¶å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œæˆ‘ä»¬è¿™é‡Œå®šä¹‰è¿™ä¸ªæ³¨è§£ä¸”è¦æ±‚å¿…éœ€æœ‰ï¼Œå‡ºäºä¸‹é¢å‡ ä¸ªè€ƒè™‘ é†’ç›®ï¼Œå‘Šè¯‰å¼€å‘è€…ï¼Œè¿™ä¸ªæ¥å£æ˜¯å£°æ˜çš„spiæ¥å£ï¼Œ ä½¿ç”¨çš„æ—¶å€™æ³¨æ„ä¸‹ åŠ å…¥é€‰æ‹©å™¨å‚æ•°ï¼Œæ–¹ä¾¿ç”¨æˆ·æ‰©å±•è‡ªå·±çš„é€‰æ‹©æ–¹å¼ 3. SpiAdaptive æ³¨è§£ å¯¹éœ€è¦è‡ªé€‚åº”çš„åœºæ™¯ï¼Œä¸ºäº†æ»¡è¶³ä¸€ä¸ªspiæ¥å£ï¼Œåº”ç”¨å¤šé‡ä¸åŒçš„é€‰æ‹©å™¨åœºæ™¯ï¼Œå¯ä»¥åŠ ä¸Šè¿™ä¸ªæ³¨è§£ï¼›å¦‚æœä¸åŠ è¿™ä¸ªæ³¨è§£ï¼Œåˆ™è¡¨ç¤ºé‡‡ç”¨é»˜è®¤çš„é€‰æ‹©å™¨æ¥è‡ªé€‚åº” æ¥å£è¯´æ˜1234567891011/** * SPI è‡ªé€‚åº”æ³¨è§£, è¡¨ç¤ºè¯¥æ–¹æ³•ä¼šç”¨åˆ°spiå®ç° * &lt;p/&gt; * Created by yihui on 2017/5/24. */@Documented@Retention(RetentionPolicy.RUNTIME)@Target(&#123;ElementType.METHOD&#125;)public @interface SpiAdaptive &#123; Class&lt;? extends ISelector&gt; selector() default DefaultSelector.class;&#125; è¯´æ˜è¿™ä¸ªæ³¨è§£å†…å®¹å’Œ @Spi åŸºæœ¬ä¸Šä¸€æ¨¡ä¸€æ ·ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯ä¸€ä¸ªæ”¾åœ¨ç±»ä¸Šï¼Œä¸€ä¸ªæ”¾åœ¨æ–¹æ³•ä¸Šï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¿™ä¹ˆè€ƒè™‘ï¼Ÿ @Spi æ³¨è§£æ”¾åœ¨ç±»ä¸Šï¼Œæ›´å¤šçš„è¡¨åè¿™ä¸ªæ¥å£æ˜¯æˆ‘ä»¬å®šä¹‰çš„ä¸€ä¸ªSPIæ¥å£ï¼Œä½†æ˜¯ä½¿ç”¨æ–¹å¼å¯ä»¥æœ‰ä¸¤ç§ï¼ˆé™æ€ + åŠ¨æ€ç¡®è®¤ï¼‰ @SpiAdaptive åªèƒ½åœ¨è‡ªé€‚åº”çš„åœºæ™¯ä¸‹ä½¿ç”¨ï¼Œç”¨äºé¢å¤–æŒ‡å®šspiæ¥å£ä¸­æŸä¸ªæ–¹æ³•çš„é€‰æ‹©å™¨ ï¼ˆå¦‚æœä¸€ä¸ªspiæ¥å£å…¨éƒ¨åªéœ€è¦ä¸€ä¸ªé€‰æ‹©å™¨å³å¯ï¼Œé‚£ä¹ˆå¯ä»¥ä¸ä½¿ç”¨è¿™ä¸ªæ³¨è§£ï¼‰ å¦‚ä¸‹é¢çš„è¿™ä¸ªä¾‹å­ï¼Œprintæ–¹æ³•å’Œ echoæ–¹æ³•å…¶å®æ˜¯ç­‰ä»·çš„ï¼Œéƒ½æ˜¯é‡‡ç”¨ DefaultSelector æ¥ç¡®è®¤å…·ä½“çš„å®ç°ç±»ï¼›è€Œ write å’Œ pp æ–¹æ³•åˆ™æ˜¯é‡‡ç”¨ ParamsSelector é€‰æ‹©å™¨; 1234567891011121314151617181920/** * Created by yihui on 2017/5/25. */@Spipublic interface ICode &#123; void print(String name, String contet); @SpiAdaptive void echo(String name, String content); @SpiAdaptive(selector = ParamsSelector.class) void write(Context context, String content); @SpiAdaptive(selector = ParamsSelector.class) void pp(Context context, String content);&#125; 4. SpiConf æ³¨è§£ è¿™ä¸ªä¸»é”®ä¸»è¦æ˜¯ç”¨åœ¨å®ç°ç±»ä¸Šï¼ˆæˆ–å®ç°ç±»çš„æ–¹æ³•ä¸Šï¼‰ï¼Œé‡Œé¢å­˜å‚¨ä¸€äº›é€‰æ‹©æ¡ä»¶ï¼Œé€šå¸¸æ˜¯å’ŒSelectoræ­é…ä½¿ç”¨ å®šä¹‰å¦‚ä¸‹å®šä¹‰äº†ä¸‰ä¸ªå­—æ®µ: name å”¯ä¸€æ ‡è¯†ï¼Œç”¨äº DefaultSelectorï¼› params å‚æ•°æ¡ä»¶ï¼Œ ç”¨äº ParamsSelectorï¼› order : ä¼˜å…ˆçº§ï¼Œ ä¸»è¦æ˜¯ä¸ºäº†è§£å†³å¤šä¸ªå®ç°ç±»éƒ½æ»¡è¶³é€‰æ‹©æ¡ä»¶æ—¶ï¼Œ åº”è¯¥é€‰æ‹©å“ªä¸€ä¸ª ï¼ˆè°ˆåˆ°è¿™é‡Œå°±æœ‰ä¸ªæƒ³æ³•ï¼Œ é€šè¿‡ä¸€ä¸ªå‚æ•°ï¼Œæ¥é€‰æ‹©æ˜¯å¦è®©æ»¡è¶³æ¡ä»¶çš„å…¨éƒ¨è¿”å›ï¼‰ 123456789101112131415161718192021222324252627282930@Documented@Retention(RetentionPolicy.RUNTIME)@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)public @interface SpiConf &#123; /** * å”¯ä¸€æ ‡è¯† * * @return */ String name() default \"\"; /** * å‚æ•°è¿‡æ»¤, å•ç‹¬ä¸€ä¸ªå…ƒç´ ,è¡¨ç¤ºå‚æ•°å¿…é¡»åŒ…å«; ç”¨è‹±æ–‡åˆ†å·,å·¦è¾¹ä¸ºå‚æ•°å,å³è¾¹ä¸ºå‚æ•°å€¼,è¡¨ç¤ºå‚æ•°çš„å€¼å¿…é¡»æ˜¯å³è¾¹çš„ * &lt;p/&gt; * å½¢å¦‚ &#123;\"a\", \"a:12\", \"b:TAG\"&#125; * * @return */ String[] params() default &#123;&#125;; /** * æ’åº, è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ * * @return */ int order() default -1;&#125; è¯´æ˜SpiConf æ³¨è§£å¯ä»¥ä¿®é¥°ç±»ï¼Œä¹Ÿå¯ä»¥ä¿®é¥°æ–¹æ³•ï¼Œå› æ­¤å½“ä¸€ä¸ªå®ç°ç±»ä¸­ï¼Œç±»å’Œæ–¹æ³•éƒ½æœ‰è¿™ä¸ªæ³¨è§£æ—¶ï¼Œ æ€ä¹ˆå¤„ç† ï¼Ÿ ä»¥ä¸‹é¢çš„è¿™ä¸ªæµ‹è¯•ç±»è¿›è¡Œè¯´æ˜ 1234567891011121314151617181920212223242526272829303132333435/** * Created by yihui on 2017/5/25. */@SpiConf(params = \"code\", order = 1)public class ConsoleCode implements ICode &#123; @Override public void print(String name, String contet) &#123; System.out.println(\"console print:---&gt;\" + contet); &#125; /** * æ˜¾ç¤ºæŒ‡å®šäº†name, å› æ­¤å¯ä»¥ç›´æ¥é€šè¿‡ consoleEcho æ¥ç¡®å®šè°ƒç”¨æœ¬å®ç°æ–¹æ³• * @param name * @param content */ @Override @SpiConf(name = \"consoleEcho\") public void echo(String name, String content) &#123; System.out.println(\"console echo:----&gt;\" + content); &#125; /** * å®é™…çš„ä¼˜å…ˆçº§å– æ–¹æ³• å’Œç±»ä¸Šçš„æœ€é«˜ä¼˜å…ˆçº§, å®é™…ä¸º1ï¼› * `ParamsSelector`é€‰æ‹©å™¨æ—¶ï¼Œ æ‰§è¡Œè¯¥æ–¹æ³•çš„æ¡ä»¶ç­‰åŒäº `&#123;\"code\", \"type:console\"&#125;` * @param context * @param content */ @Override @SpiConf(params = &#123;\"type:console\"&#125;, order = 3) public void write(Context context, String content) &#123; System.out.println(\"console write:----&gt;\" + content); &#125;&#125; åœ¨è®¾è®¡ä¸­ï¼Œéµå¾ªä¸‹é¢å‡ ä¸ªåŸåˆ™ï¼š ç±»ä¸Šçš„SpiConfæ³¨è§£ï¼Œ é»˜è®¤é€‚ç”¨ä¸ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³• æ–¹æ³•ä¸Šæœ‰SpiConfæ³¨è§£ï¼Œé‡‡å–ä¸‹é¢çš„è§„åˆ™ æ–¹æ³•æ³¨è§£å£°æ˜nameæ—¶ï¼Œä¸¤ä¸ªä¼šåŒæ—¶ç”Ÿæ•ˆï¼Œå³æƒ³è°ƒç”¨ä¸Šé¢çš„echoæ–¹æ³•ï¼Œ é€šè¿‡ä¼ å…¥ ConsoleCodeï¼ˆç±»æ³¨è§£ä¸æ˜¾ç¤ºèµ‹å€¼æ—¶ï¼Œé‡‡ç”¨ç±»åä»£æ›¿ï¼‰ å’Œ consoleEcho ç­‰ä»· æ–¹æ³•æ³¨è§£æœªå£°æ˜nameæ—¶ï¼Œåªèƒ½é€šè¿‡ç±»æ³¨è§£ä¸Šå®šä¹‰çš„nameï¼ˆoré»˜è®¤çš„ç±»åï¼‰æ¥é€‰æ‹© orderï¼Œå–æœ€é«˜ä¼˜å…ˆçº§ï¼Œå¦‚ä¸Šé¢çš„ write æ–¹æ³•çš„ä¼˜å…ˆçº§æ˜¯ 1; å½“æœªæ˜¾ç¤ºå®šä¹‰orderæ—¶ï¼Œä»¥å®šä¹‰çš„ä¸ºå‡† params: å–å¹¶é›†ï¼Œå³è¦æ±‚ç±»ä¸Š + æ–¹æ³•ä¸Šçš„æ¡ä»¶éƒ½æ»¡è¶³ SPIåŠ è½½å™¨ spiåŠ è½½å™¨çš„ä¸»è¦ä¸šåŠ¡é€»è¾‘é›†ä¸­åœ¨ SpiLoader ç±»ä¸­ï¼ŒåŒ…å«é€šè¿‡spiæ¥å£ï¼Œè·å–æ‰€æœ‰çš„å®ç°ç±»ï¼› è·å–spiæ¥å£å¯¹åº”çš„é€‰æ‹©å™¨ ï¼ˆåŒ…æ‹¬ç±»å¯¹åº”çš„é€‰æ‹©å™¨ï¼Œ æ–¹æ³•å¯¹åº”çš„é€‰æ‹©å™¨ï¼‰ï¼› è¿”å›Spiæ¥å£å®ç°ç±»ï¼ˆé™æ€ç¡®è®¤çš„å®ç°ç±»ï¼Œè‡ªé€‚åº”çš„ä»£ç†ç±»ï¼‰ ä»ä¸Šé¢çš„ç®€è¿°ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥çœ‹å‡ºè¿™ä¸ªç±»åˆ’åˆ†ä¸ºä¸‰ä¸ªåŠŸèƒ½ç‚¹ï¼Œ ä¸‹é¢å°†é€ä¸€è¯´æ˜ï¼Œæœ¬ç¯‡åšæ–‡ä¸»è¦é›†ä¸­åœ¨é€»è¾‘çš„è®¾è®¡å±‚ï¼Œè‡³äºä¼˜åŒ–ï¼ˆå¦‚æ‡’åŠ è½½ï¼Œç¼“å­˜ä¼˜åŒ–ç­‰ï¼‰ æ”¾ç½®ä¸‹ä¸€ç¯‡åšæ–‡å•ç‹¬å™è¿° 1. åŠ è½½spiå®ç°ç±» è¿™ä¸€å—æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥åˆ©ç”¨äº†jdkçš„ ServiceLoader æ¥æ ¹æ®æ¥å£ï¼Œè·å–æ‰€æœ‰çš„å®ç°ç±»ï¼›å› æ­¤æˆ‘ä»¬çš„spiå®ç°ï¼Œéœ€è¦æ»¡è¶³jdkå®šä¹‰çš„è¿™ä¸€å¥—è§„èŒƒ å…·ä½“çš„ä»£ç ä¸šåŠ¡é€»è¾‘éå¸¸ç®€å•ï¼Œå¤§è‡´æµç¨‹å¦‚ä¸‹ 1234567891011121314151617 if (null == spiInterfaceType) &#123; throw new IllegalArgumentException(\"common cannot be null...\");&#125;if (!spiInterfaceType.isInterface()) &#123; throw new IllegalArgumentException(\"common class:\" + spiInterfaceType + \" must be interface!\");&#125;if (!withSpiAnnotation(spiInterfaceType)) &#123; throw new IllegalArgumentException(\"common class:\" + spiInterfaceType + \" must have the annotation of @Spi\");&#125; ServiceLoader&lt;T&gt; serviceLoader = ServiceLoader.load(spiInterfaceType);for(T spiImpl: serviceLoader) &#123; // xxx&#125; æ³¨æ„ å› ä¸ºä½¿ç”¨äº†jdkçš„æ ‡å‡†ï¼Œå› æ­¤æ¯å®šä¹‰ä¸€ä¸ªspiæ¥å£ï¼Œå¿…é¡»åœ¨ META_INF.services ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œ æ–‡ä»¶åä¸ºåŒ…å«åŒ…è·¯å¾„çš„spiæ¥å£åï¼Œ å†…éƒ¨ä¸ºåŒ…å«åŒ…è·¯å¾„çš„å®ç°ç±»å æ¯ä¸ªspiæ¥å£ï¼Œè¦æ±‚å¿…é¡»æœ‰ @Spi æ³¨è§£ Spiæ¥å£å¿…é¡»æ˜¯ interface ç±»å‹ï¼Œ ä¸æ”¯æŒæŠ½è±¡ç±»å’Œç±»çš„æ–¹å¼ æ‹“å±•è™½ç„¶è¿™é‡Œç›´æ¥ä½¿ç”¨äº†spiçš„è§„èŒƒï¼Œæˆ‘ä»¬å…¶å®å®Œå…¨å¯ä»¥è‡ªå·±å®šä¹‰æ ‡å‡†çš„ï¼Œåªè¦èƒ½å°†è¿™ä¸ªæ¥å£çš„æ‰€æœ‰å®ç°ç±»æ‰¾åˆ°ï¼Œ æ€ä¹ˆå®ç°éƒ½å¯ä»¥ç”±ä½ å®šä¹‰ å¦‚ä½¿ç”¨springæ¡†æ¶åï¼Œå¯ä»¥è€ƒè™‘é€šè¿‡ applicationContext.getBeansOfAnnotaion(xxx ) æ¥è·å–æ‰€æœ‰çš„ç‰¹å®šæ³¨è§£çš„beanï¼Œè¿™æ ·å°±å¯ä»¥ä¸éœ€è¦è‡ªå·±æ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œæ¥å­˜å‚¨spiæ¥å£å’Œå…¶å®ç°ç±»çš„æ˜ å°„å…³ç³»äº† æ„å»ºspiå®ç°çš„å…³ç³»è¡¨ä¸Šé¢è·å–äº†spiå®ç°ç±»ï¼Œæ˜¾ç„¶æˆ‘ä»¬çš„ç›®æ ‡å¹¶ä¸å±€é™äºç®€å•çš„è·å–å®ç°ç±»ï¼Œåœ¨è·å–å®ç°ç±»ä¹‹åï¼Œè¿˜éœ€è¦è§£æå…¶ä¸­çš„ @SpiConf æ³¨è§£ä¿¡æ¯ï¼Œç”¨äºè¡¨ç¤ºè¦é€‰æ‹©è¿™ä¸ªå®ç°ï¼Œå¿…é¡»æ»¡è¶³ä»€ä¹ˆæ ·çš„æ¡ä»¶ SpiImplWrapper : spiå®ç°ç±»ï¼Œä»¥åŠå®šä¹‰çš„å„ç§æ¡ä»¶çš„å°è£…ç±» æ³¨è§£çš„è§£æè¿‡ç¨‹æµç¨‹å¦‚ä¸‹: name: æ³¨è§£å®šä¹‰æ—¶ï¼Œé‡‡ç”¨å®šä¹‰çš„å€¼ï¼› å¦åˆ™é‡‡ç”¨ç®€å•ç±»å ï¼ˆå› æ­¤ä¸€ä¸ªç³»ç»Ÿä¸­ä¸å…è®¸ä¸¤ä¸ªå®ç°ç±»åŒåçš„æƒ…å†µï¼‰ orderï¼š ä¼˜å…ˆçº§ï¼Œ æ³¨è§£å®šä¹‰æ—¶ï¼Œé‡‡ç”¨å®šä¹‰çš„å€¼ï¼›æœªå®šä¹‰æ—¶é‡‡ç”¨é»˜è®¤ï¼› params: å‚æ•°çº¦æŸæ¡ä»¶ï¼Œ ä¼šå–ç±»ä¸Šå’Œæ–¹æ³•ä¸Šçš„å¹¶é›†ï¼ˆåŸåˆ™ä¸Šè¦æ±‚ç±»ä¸Šçš„çº¦æŸå’Œæ–¹æ³•ä¸Šçš„çº¦æŸä¸èƒ½å†²çªï¼‰ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152List&lt;SpiImplWrapper&lt;T&gt;&gt; spiServiceList = new ArrayList&lt;&gt;();// è§£ææ³¨è§£spiConf = t.getClass().getAnnotation(SpiConf.class); Map&lt;String, String&gt; map; if (spiConf == null) &#123; // æ²¡æœ‰æ·»åŠ æ³¨è§£æ—¶ï¼Œ é‡‡ç”¨é»˜è®¤çš„æ–¹æ¡ˆ implName = t.getClass().getSimpleName(); implOrder = SpiImplWrapper.DEFAULT_ORDER; // å‚æ•°é€‰æ‹©å™¨æ—¶, è¦æ±‚spiå®ç°ç±»å¿…é¡»æœ‰ @SpiConf æ³¨è§£, å¦åˆ™é€‰æ‹©å™¨æ— æ³•è·å–æ ¡éªŒæ¡ä»¶å‚æ•° if (currentSelector.getSelector() instanceof ParamsSelector) &#123; throw new IllegalStateException(\"spiImpl must contain annotation @SpiConf!\"); &#125; map = Collections.emptyMap(); &#125; else &#123; implName = spiConf.name(); if (StringUtils.isBlank(implName)) &#123; implName = t.getClass().getSimpleName(); &#125; implOrder = spiConf.order() &lt; 0 ? SpiImplWrapper.DEFAULT_ORDER : spiConf.order(); map = parseParms(spiConf.params()); &#125; // æ·»åŠ ä¸€ä¸ªç±»çº§åˆ«çš„å°è£…ç±» spiServiceList.add(new SpiImplWrapper&lt;&gt;(t, implOrder, implName, map)); // ------------ // è§£æå‚æ•°çš„æ–¹æ³• private Map&lt;String, String&gt; parseParms(String[] params) &#123; if (params.length == 0) &#123; return Collections.emptyMap(); &#125; Map&lt;String, String&gt; map = new HashMap&lt;&gt;(params.length); String[] strs; for (String param : params) &#123; strs = StringUtils.split(param, \":\"); if (strs.length &gt;= 2) &#123; map.put(strs[0].trim(), strs[1].trim()); &#125; else if (strs.length == 1) &#123; map.put(strs[0].trim(), null); &#125; &#125; return map; &#125; 2. åˆå§‹åŒ–é€‰æ‹©å™¨ æˆ‘ä»¬çš„é€‰æ‹©å™¨ä¼šåŒºåˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ä¸ªæ˜¯ç±»ä¸Šå®šä¹‰çš„é€‰æ‹©å™¨ï¼Œ ä¸€ä¸ªæ˜¯æ–¹æ³•ä¸Šå®šä¹‰çš„é€‰æ‹©å™¨ï¼› åœ¨è‡ªé€‚åº”çš„ä½¿ç”¨æ–¹å¼ä¸­ï¼Œæ–¹æ³•ä¸Šå®šä¹‰çš„ä¼˜å…ˆçº§ &gt; ç±»ä¸Šå®šä¹‰ ç®€å•æ¥è®²ï¼Œåˆå§‹åŒ–é€‰æ‹©å™¨ï¼Œå°±æ˜¯æ‰«ä¸€éSPIæ¥å£ä¸­çš„æ³¨è§£ï¼Œå®ä¾‹åŒ–é€‰æ‹©å™¨åï¼Œç¼“å­˜ä½å¯¹åº”çš„ç»“æœ, å®ç°å¦‚ä¸‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071 /*** é€‰æ‹©å™¨, æ ¹æ®æ¡ä»¶, é€‰æ‹©å…·ä½“çš„ SpiImpl;*/private SelectorWrapper currentSelector;/*** è‡ªé€‚åº”æ—¶, æ–¹æ³•å¯¹åº”çš„é€‰æ‹©å™¨*/private Map&lt;String, SelectorWrapper&gt; currentMethodSelector;/*** æ¯ä¸€ä¸ª SpiLoader ä¸­, æ¯ç§ç±»å‹çš„é€‰æ‹©å™¨, åªä¿å­˜ä¸€ä¸ªå®ä¾‹* å› æ­¤å¯ä»¥åœ¨é€‰æ‹©å™¨ä¸­, å¦‚&#123;@link ParamsSelector&#125; å¯¹spiImplMapè¿›è¡Œå¤„ç†å¹¶ç¼“å­˜ç»“æœ*/private ConcurrentHashMap&lt;Class, SelectorWrapper&gt; selectorInstanceCacheMap = new ConcurrentHashMap&lt;&gt;(); private void initSelector() &#123; Spi ano = spiInterfaceType.getAnnotation(Spi.class); if (ano == null) &#123; currentSelector = initSelector(DefaultSelector.class); &#125; else &#123; currentSelector = initSelector(ano.selector()); &#125; Method[] methods = this.spiInterfaceType.getMethods(); currentMethodSelector = new ConcurrentHashMap&lt;&gt;(); SelectorWrapper temp; for (Method method : methods) &#123; if (!method.isAnnotationPresent(SpiAdaptive.class)) &#123; continue; &#125; temp = initSelector(method.getAnnotation(SpiAdaptive.class).selector()); if (temp == null) &#123; continue; &#125; currentMethodSelector.put(method.getName(), temp); &#125;&#125;private SelectorWrapper initSelector(Class&lt;? extends ISelector&gt; clz) &#123; // ä¼˜å…ˆä»é€‰æ‹©å™¨ç¼“å­˜ä¸­è·å–ç±»å‹å¯¹åº”çš„é€‰æ‹©å™¨ if (selectorInstanceCacheMap.containsKey(clz)) &#123; return selectorInstanceCacheMap.get(clz); &#125; try &#123; ISelector selector = clz.newInstance(); Class paramClz = null; Type[] types = clz.getGenericInterfaces(); for (Type t : types) &#123; if (t instanceof ParameterizedType) &#123; paramClz = (Class) ((ParameterizedType) t).getActualTypeArguments()[0]; break; &#125; &#125; Assert.check(paramClz != null); SelectorWrapper wrapper = new SelectorWrapper(selector, paramClz); selectorInstanceCacheMap.putIfAbsent(clz, wrapper); return wrapper; &#125; catch (Exception e) &#123; throw new IllegalArgumentException(\"illegal selector defined! yous:\" + clz); &#125;&#125; è¯´æ˜ SeectorWrapper é€‰æ‹©å™¨å°è£…ç±» è¿™é‡Œæˆ‘ä»¬åœ¨è·å–é€‰æ‹©å™¨æ—¶ï¼Œç‰¹æ„å®šä¹‰äº†ä¸€ä¸ªå°è£…ç±»ï¼Œå…¶ä¸­åŒ…å«å…·ä½“çš„é€‰æ‹©å™¨å¯¹è±¡ï¼Œä»¥åŠæ‰€åŒ¹é…çš„å‚æ•°ç±»å‹ï¼Œå› æ­¤å¯ä»¥åœ¨ä¸‹ä¸€æ­¥é€šè¿‡é€‰æ‹©å™¨è·å–å®ç°ç±»æ—¶ï¼Œä¿è¯ä¼ å…¥çš„å‚æ•°ç±»å‹åˆæ³• private SelectorWrapper initSelector(Class&lt;? extends ISelector&gt; clz) å…·ä½“çš„å®ä¾‹åŒ–é€‰æ‹©å™¨çš„æ–¹æ³• ä»å®ç°æ¥çœ‹ï¼Œä¼˜å…ˆä»é€‰æ‹©å™¨ç¼“å­˜ä¸­è·å–é€‰æ‹©å™¨å¯¹è±¡ï¼Œè¿™æ ·çš„ç›®çš„æ˜¯ä¿è¯ä¸€ä¸ªspiæ¥å£ï¼Œæ¯ç§ç±»å‹çš„é€‰æ‹©å™¨åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼›å› æ­¤åœ¨è‡ªå®šä¹‰é€‰æ‹©å™¨ä¸­ï¼Œä½ å®Œå…¨å¯ä»¥åšä¸€äº›é€‰æ‹©åˆ¤æ–­çš„ç¼“å­˜é€»è¾‘ï¼Œå¦‚ ParamsSelector ä¸­çš„spiå®ç°ç±»çš„æœ‰åºç¼“å­˜åˆ—è¡¨ currentSelector , currentMethodSelector, selectorInstanceCacheMap currentSelector: å¯¹åº”çš„æ˜¯ç±»é€‰æ‹©å™¨ï¼Œæ¯ä¸ªSPIæ¥å£å¿…ç„¶ä¼šæœ‰ä¸€ä¸ªï¼Œä½œä¸ºæ‰“åº•çš„é€‰æ‹©å™¨ currentMethodSelector: æ–¹æ³•é€‰æ‹©å™¨æ˜ å°„å…³ç³»è¡¨ï¼Œkeyä¸ºæ–¹æ³•åï¼Œvalueä¸ºè¯¥æ–¹æ³•å¯¹åº”çš„é€‰æ‹©å™¨ï¼› æ‰€ä»¥spiæ¥å£ä¸­ï¼Œä¸æ”¯æŒé‡è½½ selectorInstanceCacheMap: spiæ¥å£æ‰€æœ‰å®šä¹‰çš„é€‰æ‹©å™¨æ˜ å°„å…³ç³»è¡¨ï¼Œkeyä¸ºé€‰æ‹©å™¨ç±»å‹ï¼Œvalueæ˜¯å®ä¾‹ï¼›ç”¨äºä¿éšœæ¯ä¸ªspiæ¥å£ä¸­é€‰æ‹©å™¨åªä¼šæœ‰ä¸€ä¸ªå®ä¾‹ 3. è·å–å®ç°ç±» å¯¹ä½¿ç”¨è€…è€Œè¨€ï¼Œæœ€å…³æ³¨çš„å°±æ˜¯è¿™ä¸ªæ¥å£ï¼Œè¿™é‡Œä¼šè¿”å›æˆ‘ä»¬éœ€è¦çš„å®ç°ç±»ï¼ˆorä»£ç†ï¼‰ï¼›å†…éƒ¨çš„é€»è¾‘ä¹Ÿæ¯”è¾ƒæ¸…æ¥šï¼Œé¦–å…ˆç¡®å®šé€‰æ‹©å™¨ï¼Œç„¶åé€šè¿‡é€‰æ‹©å™¨ä¾¿åˆ©æ‰€æœ‰çš„å®ç°ç±»ï¼ŒæŠŠæ»¡è¶³æ¡ä»¶çš„è¿”å›å³å¯ ä»ä¸Šé¢çš„æè¿°å¯ä»¥çœ‹åˆ°ï¼Œä¸»è¦åˆ†ä¸ºä¸¤æ­¥ è·å–é€‰æ‹©å™¨ æ ¹æ®é€‰æ‹©å™¨ï¼Œéå†æ‰€æœ‰çš„å®ç°ç±»ï¼Œæ‰¾å‡ºåŒ¹é…çš„è¿”å› è·å–é€‰æ‹©å™¨åˆå§‹åŒ–é€‰æ‹©å™¨ä¹‹åï¼Œæˆ‘ä»¬ä¼šæœ‰ currentSelector , currentMethodSelector ä¸¤ä¸ªç¼“å­˜ é™æ€ç¡®å®šspiå®ç°æ—¶ï¼Œç›´æ¥ç”¨ currentSelector å³å¯ ï¼ˆspiæ¥å£ä¸­æ‰€æœ‰æ–¹æ³•éƒ½å…¬ç”¨ç±»å®šä¹‰é€‰æ‹©å™¨ï¼‰ åŠ¨æ€é€‚é…æ—¶ï¼Œ æ ¹æ®æ–¹æ³•ååœ¨ currentMethodSelector ä¸­è·å–é€‰æ‹©å™¨ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è¡¨ç¤ºè¯¥æ–¹æ³•æ²¡æœ‰@SpiAdaptiveæ³¨è§£ï¼Œç›´æ¥ä½¿ç”¨ç±»çš„é€‰æ‹©å™¨ currentMethodSelector å³å¯ 123456789101112131415// åŠ¨æ€é€‚é…æ—¶ï¼Œè·å–æ–¹æ³•å¯¹åº”å¯¹åº”çš„selectorå®ç°é€»è¾‘SelectorWrapper selector = currentMethodSelector.get(methodName);if (selector == null) &#123; // è‡ªé€‚åº”æ–¹æ³•ä¸Šæœªå®šä¹‰é€‰æ‹©å™¨, åˆ™é»˜è®¤ç»§æ‰¿ç±»çš„ selector = currentSelector; currentMethodSelector.putIfAbsent(methodName, selector);&#125;if (!selector.getConditionType().isAssignableFrom(conf.getClass())) &#123; // é€‰æ‹©å™¨ç±»å‹æ ¡éªŒ if (!(conf instanceof String)) &#123; throw new IllegalArgumentException(\"conf spiInterfaceType should be sub class of [\" + currentSelector.getConditionType() + \"] but yours:\" + conf.getClass()); &#125; // å‚æ•°ä¸åŒ¹é…æ—¶ï¼Œä¸”ä¼ å…¥çš„å‚æ•°ä¸ºStringç±»å‹ï¼Œ åˆ™å°è¯•ä½¿ç”¨é»˜è®¤é€‰æ‹©å™¨è¿›è¡Œå…¼å®¹ï¼ˆä¸å»ºè®®åœ¨å®ç°æ—¶ï¼Œå‡ºç°è¿™ç§åœºæ™¯ï¼‰ selector = DEFAULT_SELECTOR;&#125; é€‰æ‹©å®ç°ç±»è¿™ä¸ªçš„ä¸»è¦é€»è¾‘å°±æ˜¯éå†æ‰€æœ‰çš„å®ç°ç±»ï¼Œåˆ¤æ–­æ˜¯å¦æ»¡è¶³é€‰æ‹©å™¨çš„æ¡ä»¶ï¼Œå°†ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„è¿”å›å³å¯ï¼Œæ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘éƒ½åœ¨ ISelector ä¸­å®ç°ï¼Œå¦‚ä¸‹é¢ç»™å‡ºçš„é»˜è®¤é€‰æ‹©å™¨ï¼Œæ ¹æ®nameæ¥è·å–å®ç°ç±» 1234567891011121314151617181920212223242526/** * é»˜è®¤çš„æ ¹æ®name è·å–å…·ä½“çš„å®ç°ç±» * &lt;p/&gt; * Created by yihui on 2017/5/24. */public class DefaultSelector implements ISelector&lt;String&gt; &#123; @Override public &lt;K&gt; K selector(Map&lt;String, SpiImplWrapper&lt;K&gt;&gt; map, String name) throws NoSpiMatchException &#123; if (StringUtils.isBlank(name)) &#123; throw new IllegalArgumentException(\"spiName should not be empty!\"); &#125; if (map == null || map.size() == 0) &#123; throw new IllegalArgumentException(\"no impl spi!\"); &#125; if (!map.containsKey(name)) &#123; throw new NoSpiMatchException(\"no spiImpl match the name you choose! your choose is: \" + name); &#125; return map.get(name).getSpiImpl(); &#125;&#125; æµç¨‹è¯´æ˜ ä¸Šé¢ä¸»è¦å°±å„ä¸ªç‚¹å•ç‹¬çš„è¿›è¡Œäº†è¯´æ˜ï¼Œçœ‹èµ·æ¥å¯èƒ½æ¯”è¾ƒåˆ†æ•£ï¼Œçœ‹å®Œä¹‹åå¯èƒ½æ²¡æœ‰ä¸€ä¸ªæ¸…æ™°çš„æµç¨‹ï¼Œè¿™é‡Œå°±æ•´ä¸ªå®ç°çš„æµç¨‹é¡ºä¸€éï¼Œä¸»è¦ä»ä½¿ç”¨è€…çš„è§’åº¦å‡ºå‘ï¼Œå½“å®šä¹‰äº†ä¸€ä¸ªSPIæ¥å£åï¼Œåˆ°è·å–spiå®ç°çš„è¿‡ç¨‹ä¸­ï¼Œä¸Šé¢çš„è¿™äº›æ­¥éª¤æ˜¯æ€æ ·ä¸²åœ¨ä¸€èµ·çš„ æµç¨‹å›¾å…ˆæ‹¿ç®€å•çš„é™æ€è·å–SPIå®ç°æµç¨‹è¯´æ˜ï¼ˆåŠ¨æ€çš„å…¶å®å·®ä¸å¤šï¼Œå…·ä½“çš„å·®å¼‚ä¸‹ä¸€ç¯‡è¯´æ˜ï¼‰ï¼Œå…ˆçœ‹ä¸‹è¿™ç§ç”¨æ³•çš„ä½¿ç”¨å§¿åŠ¿ 1234567891011121314151617181920212223242526@Spipublic interface IPrint &#123; void print(String str);&#125;public class FilePrint implements IPrint &#123; @Override public void print(String str) &#123; System.out.println(\"file print: \" + str); &#125;&#125;public class ConsolePrint implements IPrint &#123; @Override public void print(String str) &#123; System.out.println(\"console print: \" + str); &#125;&#125;@Testpublic void testPrint() throws NoSpiMatchException &#123; SpiLoader&lt;IPrint&gt; spiLoader = SpiLoader.load(IPrint.class); IPrint print = spiLoader.getService(\"ConsolePrint\"); print.print(\"console----&gt;\");&#125; SpiLoader&lt;IPrint&gt; spiLoader = SpiLoader.load(IPrint.class);è¿™è¡Œä»£ç è§¦å‘çš„action ä¸»è¦æ˜¯åˆå§‹åŒ–æ‰€æœ‰çš„é€‰æ‹©å™¨, å¦‚ä¸‹å›¾ é¦–å…ˆä»ç¼“å­˜ä¸­æŸ¥ æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡äº†æœ‰åˆ™ç›´æ¥è¿”å›ï¼› ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œåˆ™è¿›å…¥newä¸€ä¸ªæ–°çš„å¯¹è±¡å‡ºæ¥ è§£æç±»ä¸Šæ³¨è§£ @Spiï¼Œåˆå§‹åŒ– currentSelector è§£ææ‰€æœ‰æ–¹æ³•çš„æ³¨è§£ @SpiAdaptive ï¼Œ åˆå§‹åŒ– currentMethodSelector å¡å…¥ç¼“å­˜ï¼Œå¹¶è¿”å› IPrint print = spiLoader.getService(&quot;ConsolePrint&quot;);æ ¹æ®nameè·å–å®ç°ç±»ï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹ åˆ¤æ–­æ˜¯å¦åŠ è½½è¿‡æ‰€æœ‰å®ç°ç±» spiImplClassCacheMap æ²¡æœ‰åŠ è½½ï¼Œåˆ™é‡æ–°åŠ è½½æ‰€æœ‰çš„å®ç°ç±» é€šè¿‡jdkçš„ ServiceLoader.load() æ–¹æ³•è·å–æ‰€æœ‰çš„å®ç°ç±» éå†å®ç°ç±»ï¼Œæ ¹æ® @SpiConf æ³¨è§£åˆå§‹åŒ–å‚æ•°ï¼Œå°è£… SpiImplWrapperå¯¹è±¡ ä¿å­˜å°è£…çš„ SpiImplWrapperå¯¹è±¡åˆ°ç¼“å­˜ æ‰§è¡Œ currentSelector.select() æ–¹æ³•ï¼Œè·å–åŒ¹é…çš„å®ç°ç±» å…¶ä»–åšå®¢ç³»åˆ—é“¾æ¥ï¼š SPIæ¡†æ¶å®ç°ä¹‹æ—…å››ï¼šä½¿ç”¨æµ‹è¯• SPIæ¡†æ¶å®ç°ä¹‹æ—…ä¸‰ï¼šå®ç°è¯´æ˜ SPIæ¡†æ¶å®ç°ä¹‹æ—…äºŒï¼šæ•´ä½“è®¾è®¡ SPIæ¡†æ¶å®ç°ä¹‹æ—…ä¸€ï¼šèƒŒæ™¯ä»‹ç» é¡¹ç›®: QuickAlarm é¡¹ç›®åœ°å€ï¼š Quick-SPI åšå®¢åœ°å€ï¼š å°ç°ç°Blog ä¸ªäººåšå®¢ï¼š Z+|blogåŸºäºhexo + github pagesæ­å»ºçš„ä¸ªäººåšå®¢ï¼Œè®°å½•æ‰€æœ‰å­¦ä¹ å’Œå·¥ä½œä¸­çš„åšæ–‡ï¼Œæ¬¢è¿å¤§å®¶å‰å»é€›é€› å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è¯†æœ‰é™ï¼Œå¦‚å‘ç°bugæˆ–è€…æœ‰æ›´å¥½çš„å»ºè®®ï¼Œéšæ—¶æ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼Œæˆ‘çš„å¾®åšåœ°å€: å°ç°ç°Blog æ‰«æå…³æ³¨","categories":[{"name":"Quickç³»åˆ—é¡¹ç›®","slug":"Quickç³»åˆ—é¡¹ç›®","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/"},{"name":"QuickSpi","slug":"Quickç³»åˆ—é¡¹ç›®/QuickSpi","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/QuickSpi/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"SPI","slug":"SPI","permalink":"https://zbang.online/hexblog/tags/SPI/"}],"keywords":[{"name":"Quickç³»åˆ—é¡¹ç›®","slug":"Quickç³»åˆ—é¡¹ç›®","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/"},{"name":"QuickSpi","slug":"Quickç³»åˆ—é¡¹ç›®/QuickSpi","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/QuickSpi/"}]},{"title":"1. SPIæ¡†æ¶å®ç°ä¹‹æ—…ä¸€ï¼šèƒŒæ™¯ä»‹ç»","slug":"SPIæ¡†æ¶å®ç°ä¹‹æ—…ä¸€ï¼šèƒŒæ™¯ä»‹ç»","date":"2017-05-26T02:46:42.000Z","updated":"2018-02-13T03:21:17.018Z","comments":true,"path":"2017/05/26/SPIæ¡†æ¶å®ç°ä¹‹æ—…ä¸€ï¼šèƒŒæ™¯ä»‹ç»/","link":"","permalink":"https://zbang.online/hexblog/2017/05/26/SPIæ¡†æ¶å®ç°ä¹‹æ—…ä¸€ï¼šèƒŒæ™¯ä»‹ç»/","excerpt":"èƒŒæ™¯ä»‹ç» SPIçš„å…¨åä¸ºService Provider Interfaceï¼Œç®€å•çš„æ€»ç»“ä¸‹java spiæœºåˆ¶çš„æ€æƒ³ã€‚æˆ‘ä»¬ç³»ç»Ÿé‡ŒæŠ½è±¡çš„å„ä¸ªæ¨¡å—ï¼Œå¾€å¾€æœ‰å¾ˆå¤šä¸åŒçš„å®ç°æ–¹æ¡ˆï¼Œæ¯”å¦‚æ—¥å¿—æ¨¡å—çš„æ–¹æ¡ˆï¼Œxmlè§£ææ¨¡å—ã€jdbcæ¨¡å—çš„æ–¹æ¡ˆç­‰ã€‚é¢å‘çš„å¯¹è±¡çš„è®¾è®¡é‡Œï¼Œæˆ‘ä»¬ä¸€èˆ¬æ¨èæ¨¡å—ä¹‹é—´åŸºäºæ¥å£ç¼–ç¨‹ï¼Œæ¨¡å—ä¹‹é—´ä¸å¯¹å®ç°ç±»è¿›è¡Œç¡¬ç¼–ç ã€‚ä¸€æ—¦ä»£ç é‡Œæ¶‰åŠå…·ä½“çš„å®ç°ç±»ï¼Œå°±è¿åäº†å¯æ‹”æ’çš„åŸåˆ™ï¼Œå¦‚æœéœ€è¦æ›¿æ¢ä¸€ç§å®ç°ï¼Œå°±éœ€è¦ä¿®æ”¹ä»£ç ã€‚ä¸ºäº†å®ç°åœ¨æ¨¡å—è£…é…çš„æ—¶å€™èƒ½ä¸åœ¨ç¨‹åºé‡ŒåŠ¨æ€æŒ‡æ˜ï¼Œè¿™å°±éœ€è¦ä¸€ç§æœåŠ¡å‘ç°æœºåˆ¶ã€‚ java spiå°±æ˜¯æä¾›è¿™æ ·çš„ä¸€ä¸ªæœºåˆ¶ï¼šä¸ºæŸä¸ªæ¥å£å¯»æ‰¾æœåŠ¡å®ç°çš„æœºåˆ¶","text":"èƒŒæ™¯ä»‹ç» SPIçš„å…¨åä¸ºService Provider Interfaceï¼Œç®€å•çš„æ€»ç»“ä¸‹java spiæœºåˆ¶çš„æ€æƒ³ã€‚æˆ‘ä»¬ç³»ç»Ÿé‡ŒæŠ½è±¡çš„å„ä¸ªæ¨¡å—ï¼Œå¾€å¾€æœ‰å¾ˆå¤šä¸åŒçš„å®ç°æ–¹æ¡ˆï¼Œæ¯”å¦‚æ—¥å¿—æ¨¡å—çš„æ–¹æ¡ˆï¼Œxmlè§£ææ¨¡å—ã€jdbcæ¨¡å—çš„æ–¹æ¡ˆç­‰ã€‚é¢å‘çš„å¯¹è±¡çš„è®¾è®¡é‡Œï¼Œæˆ‘ä»¬ä¸€èˆ¬æ¨èæ¨¡å—ä¹‹é—´åŸºäºæ¥å£ç¼–ç¨‹ï¼Œæ¨¡å—ä¹‹é—´ä¸å¯¹å®ç°ç±»è¿›è¡Œç¡¬ç¼–ç ã€‚ä¸€æ—¦ä»£ç é‡Œæ¶‰åŠå…·ä½“çš„å®ç°ç±»ï¼Œå°±è¿åäº†å¯æ‹”æ’çš„åŸåˆ™ï¼Œå¦‚æœéœ€è¦æ›¿æ¢ä¸€ç§å®ç°ï¼Œå°±éœ€è¦ä¿®æ”¹ä»£ç ã€‚ä¸ºäº†å®ç°åœ¨æ¨¡å—è£…é…çš„æ—¶å€™èƒ½ä¸åœ¨ç¨‹åºé‡ŒåŠ¨æ€æŒ‡æ˜ï¼Œè¿™å°±éœ€è¦ä¸€ç§æœåŠ¡å‘ç°æœºåˆ¶ã€‚ java spiå°±æ˜¯æä¾›è¿™æ ·çš„ä¸€ä¸ªæœºåˆ¶ï¼šä¸ºæŸä¸ªæ¥å£å¯»æ‰¾æœåŠ¡å®ç°çš„æœºåˆ¶ 1. èƒŒæ™¯ä¸Šé¢æ‘˜æŠ„äº†ä¸€ä¸‹spiçš„æ¦‚å¿µï¼Œæ¥ç€ä»¥ä¸ªäººçš„ç†è§£ï¼Œç®€å•çš„è°ˆä¸€ä¸‹ä¸ºä»€ä¹ˆä¼šç”¨åˆ°SPIï¼Œ ä»€ä¹ˆåœºæ™¯ä¸‹å¯ä»¥ç”¨åˆ°è¿™ä¸ªï¼Œ ä»¥åŠä½¿ç”¨äº†SPIæœºåˆ¶åæœ‰ä»€ä¹ˆä¼˜è¶Šæ€§ ä»€ä¹ˆæ˜¯SPIè™½ç„¶æœ€å¼€å§‹å°±å¼•ç”¨äº†spiçš„è§£é‡Šï¼Œè¿™é‡Œæµ…è°ˆä¸€ä¸‹ä¸ªäººç†è§£ã€‚Service Provider Interface ä»¥æ¥å£æ–¹å¼æä¾›æœåŠ¡ï¼Œ å’ŒAPIä¸åŒï¼Œspiçš„æœºåˆ¶æ˜¯å®šä¹‰ä¸€å¥—æ ‡å‡†è§„èŒƒçš„æ¥å£ï¼Œå®ç°äº¤ç»™å…¶ä»–äººæ¥åšã€‚ æ‰€ä»¥ä¸€ä¸ªæ¥å£ï¼Œå¯ä»¥æœ‰å¾ˆå¤šçš„å®ç°ï¼Œä½ å®Œå…¨å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦å»é€‰æ‹©å…·ä½“çš„å®ç°æ–¹å¼ï¼Œå› ä¸ºæ˜¯é¢å‘æ¥å£çš„å¼€å‘ï¼Œæ‰€ä»¥ä½ çš„ä¸šåŠ¡ä»£ç åŸºæœ¬ä¸Šå°±ä¸ç”¨ä¿®æ”¹ï¼Œå°±å¯ä»¥åˆ‡åˆ°å¦ä¸€ä¸ªå®ç°äº† ä»€ä¹ˆåœºæ™¯å¯ä»¥ç”¨ åˆ†åˆ«ä»æ¡†æ¶å±‚é¢å’Œä¸šåŠ¡å±‚é¢ï¼Œç»™å‡ºä¸€ä¸ªæˆ‘è®¤ä¸ºæ¯”è¾ƒåˆé€‚çš„åœºæ™¯ 1. æ—¥å¿—è¾“å‡º SLF4jSLF4jï¼šå¤§åé¼é¼çš„æ—¥å¿—è¾“å‡ºæ¥å£ï¼Œè¿™ä¸ªjaråŒ…é‡Œé¢æä¾›çš„éƒ½åªæ˜¯æ¥å£æ–¹å¼ï¼Œå…·ä½“çš„å®ç°éœ€è¦è‡ªå·±å»å®ç°ï¼Œå½“ç„¶æ¯”è¾ƒå¸¸ç”¨çš„ logback å°±æ˜¯ä¸€ä¸ªå…·ä½“çš„å®ç°åŒ…äº†ï¼Œ åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ slf4j çš„apiè¿›è¡Œæ—¥å¿—çš„è¾“å‡ºï¼Œ é€šè¿‡ç®€å•çš„é…ç½®ï¼Œå¼•å…¥logbackï¼Œ å°±å¯ä»¥ä½¿ç”¨logbackæ¥å®ç°å…·ä½“çš„æ—¥å¿—è¾“å‡ºï¼› ä¹Ÿå¯ä»¥æ¢ä¸€ä¸ªæ—¥å¿—å®ç° commons-loggingï¼Œä¸šåŠ¡ä¸Šä¸éœ€è¦ä»»ä½•çš„æ”¹åŠ¨ï¼Œå°±å¯ä»¥ç”¨ä¸åŒçš„å®ç°æ¥è¾“å‡ºæ—¥å¿— 2. ä¸šåŠ¡åœºæ™¯å‡è®¾ä½ ç°åœ¨æœ‰ä¸ªç”¨æˆ·æ³¨å†ŒæˆåŠŸåçš„æ¬¢è¿ç”¨æˆ·çš„ä¸šåŠ¡ï¼Œä¸åŒæ¸ é“ï¼ˆå¾®ä¿¡ï¼Œqqï¼Œå¾®åšç­‰ï¼‰æ³¨å†Œçš„ï¼Œæ˜¾ç¤ºçš„æ¬¢è¿ä¸åŒï¼Œå¯¹æ­¤æœ‰ä¸¤ç§ä¸åŒçš„å®ç°æ–¹å¼ å¦‚æœæ¯ä¸ªä¸åŒçš„æ¸ é“è¿›æ¥çš„ï¼Œéƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„åº”ç”¨æ¥å“åº” ï¼ˆå› ä¸ºç»å¤§å¤šæ•°çš„ä¸šåŠ¡éƒ½ä¸€æ ·ï¼Œå¯èƒ½å°±æ¬¢è¿è¯ä¸åŒï¼Œå¦‚æœåšåˆ°ä»£ç æœ€å¤§ç¨‹åº¦çš„å¤ç”¨ï¼‰ åªæœ‰ä¸€ä¸ªåº”ç”¨ï¼Œæ¥å¤„ç†æ‰€æœ‰çš„è¿™äº›åœºæ™¯ å¯ä»¥æ€ä¹ˆç”¨ ç»“åˆä¸Šé¢çš„ä¸šåŠ¡åœºæ™¯ï¼Œæ¥æè¿°ä¸‹å¯ä»¥æ€ä¹ˆç”¨ 1. ä»£ç å¤ç”¨ä¸ºäº†å®ç°ä»£ç æœ€å¤§ç¨‹åº¦çš„å¤ç”¨ï¼Œé‚£ä¹ˆå¯ä»¥å°†ä¸åŒçš„åœ°æ–¹ï¼ŒæŠ½è±¡æˆä¸€ä¸ªSPIæ¥å£ï¼Œåœ¨ä¸šåŠ¡å±‚é€šè¿‡æ¥å£æ¥ä»£æ›¿å…·ä½“çš„å®ç°ç±»å®ç°ä¸šåŠ¡é€»è¾‘ï¼› æ¯ä¸ªæ¸ é“ï¼Œéƒ½æœ‰ä¸ªç‹¬ç«‹çš„åº”ç”¨ï¼Œé‚£ä¹ˆåœ¨å¾®ä¿¡æ¸ é“ï¼Œåˆ›å»ºä¸€ä¸ª WeixinSpiImplæ¥å®ç°æ¥å£ åœ¨qqæ¸ é“ï¼Œå®ç° QQSpiImplï¼›é‚£ä¹ˆåœ¨å…·ä½“çš„æ¥å£è°ƒç”¨å¤„ï¼Œå®é™…ä¸Šå°±æ˜¯æ‰§è¡Œçš„spiå®ç°ç±»æ–¹æ³• 2. ä¸šåŠ¡åœºæ™¯çš„é€‰æ‹©åŒºåˆ†è¿™ä¸ªä¸ä¸Šé¢ä¸åŒï¼ŒåŒä¸€ä¸ªæœåŠ¡æ¥å£ï¼Œæ ¹æ®ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ï¼Œé€‰æ‹©ä¸åŒçš„å®ç°æ¥æ‰§è¡Œï¼›å½“ç„¶ä½ æ˜¯å®Œå…¨å¯ä»¥ä½¿ç”¨ ifï¼Œ elseæ¥å®ç°è¿™ç§åœºæ™¯ï¼Œå”¯ä¸€çš„é—®é¢˜å°±æ˜¯æ‰©å±•æ¯”è¾ƒéº»çƒ¦ï¼› è¿™ç§åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›çš„å°±æ˜¯è¿™ä¸ªæ¥å£ï¼Œèƒ½è‡ªåŠ¨çš„æ ¹æ®ä¸šåŠ¡åœºæ™¯ï¼Œæ¥é€‰æ‹©æœ€åˆé€‚çš„å®ç°ç±»æ¥æ‰§è¡Œ ç®€å•æ¥è®²ï¼Œå°±æ˜¯\u0010spiæ¥å£æ‰§è¡Œä¹‹å‰ï¼Œå…¶å®éœ€è¦æœ‰ä¸€ä¸ªè‡ªåŠ¨é€‰æ‹©åŒ¹é…çš„å®ç°ç±»çš„å‰ç½®è¿‡ç¨‹ï¼› é€šå¸¸è¿™ç§ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œå…·ä½“çš„spiå®ç°ä¼šæœ‰å¤šä¸ªï¼Œä½†æ˜¯éœ€è¦æœ‰ä¸€ä¸ªé€‰æ‹©çš„ç­–ç•¥ 2. å°ç›®æ ‡ åœ¨å…·ä½“çš„å®ç°ä¹‹å‰ï¼Œå…ˆå®šä¹‰ä¸€ä¸ªå°ç›®æ ‡ï¼Œæˆ‘ä»¬æƒ³è¦å®ç°ä¸€ä¸ªä»€ä¹ˆæ ·å­çš„ä¸œè¥¿å‡ºæ¥ é€šè¿‡ä¸Šé¢çš„èƒŒæ™¯æè¿°ï¼Œæˆ‘ä»¬çš„å°ç›®æ ‡ä¹Ÿå°±å¾ˆæ˜ç¡®äº†ï¼Œæˆ‘ä»¬çš„å®ç°è‡³å°‘éœ€è¦æ»¡è¶³ä¸¤ä¸ªåœºæ™¯ é™æ€é€‰æ‹©SPIå®ç°ï¼Œ å³åœ¨é€‰æ‹©å®Œæˆä¹‹åï¼Œæ‰€æœ‰å¯¹è¿™ä¸ªspiæ¥å£çš„å¼•ç”¨éƒ½æ˜¯ç¡®å®šç”±è¿™ä¸ªå®ç°æ¥æ‰¿åŒ… åŠ¨æ€é€‰æ‹©SPIå®ç°ï¼Œ ä¸åˆ°è¿è¡Œä¹‹æ—¶ï¼Œä½ éƒ½ä¸çŸ¥é“ä¼šæ˜¯å“ªä¸ªspiå®ç°æ¥å¹²è¿™ä»¶äº‹ 3. æŠ€æœ¯å‚¨å¤‡ javaæœ¬èº«å°±æä¾›äº†ä¸€å¥—spiçš„æ”¯æŒæ–¹å¼: ServiceLoaderï¼Œæˆ‘ä»¬åç»­çš„å¼€å‘ï¼Œä¹Ÿä¼šåœ¨è¿™ä¸ªåŸºç¡€ä¹‹ä¸Šè¿›è¡Œ åˆ©ç”¨javaçš„ ServiceLoader æ‰¾åˆ°æœåŠ¡æ¥å£çš„å®ç°ç±»ï¼Œæœ‰ä¸€äº›çº¦å®šï¼Œä¸‹é¢ç»™å‡ºè¦æ±‚è¯´æ˜å’Œä¸€ä¸ªæµ‹è¯•case ä¸€èˆ¬å®ç°æµç¨‹ å®šä¹‰spiæ¥å£ ï¼š IXxx å…·ä½“çš„å®ç°ç±»: AXxx, BXxx åœ¨jaråŒ…çš„META-INF/services/ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œå‘½åä¸º spiæ¥å£çš„å®Œæ•´ç±»åï¼Œå†…å®¹ä¸ºspiæ¥å£å®ç°çš„å®Œæ•´ç±»åï¼Œä¸€ä¸ªå®ç°ç±»å ä¸€è¡Œ æµ‹è¯•caseå¦‚ä¸‹ spiæ¥å£ com.hust.hui.quicksilver.commons.spi.HelloInterface 12345678910package com.hust.hui.quicksilver.commons.spi;/** * Created by yihui on 2017/3/17. */public interface HelloInterface &#123; void sayHello();&#125; spiæ¥å£çš„ä¸¤ä¸ªå®ç°ç±» com.hust.hui.quicksilver.commons.spi.impl.ImageHello.java 12345678910111213package com.hust.hui.quicksilver.commons.spi.impl;import com.hust.hui.quicksilver.commons.spi.HelloInterface;/** * Created by yihui on 2017/3/17. */public class ImageHello implements HelloInterface &#123; @Override public void sayHello() &#123; System.out.println(\"image hello!\"); &#125;&#125; com.hust.hui.quicksilver.commons.spi.impl.TextHello.java 12345678910111213package com.hust.hui.quicksilver.commons.spi.impl;import com.hust.hui.quicksilver.commons.spi.HelloInterface;/** * Created by yihui on 2017/3/17. */public class TextHello implements HelloInterface &#123; @Override public void sayHello() &#123; System.out.println(\"text hello\"); &#125;&#125; é…ç½®æ–‡ä»¶ com.hust.hui.quicksilver.commons.spi.HelloInterface 12com.hust.hui.quicksilver.commons.spi.impl.ImageHellocom.hust.hui.quicksilver.commons.spi.impl.TextHello æµ‹è¯•ç±» 1234567891011public class HelloSpiTest &#123; @Test public void testSPI() &#123; ServiceLoader&lt;HelloInterface&gt; serviceLoader = ServiceLoader.load(HelloInterface.class); for (HelloInterface hello: serviceLoader) &#123; hello.sayHello(); &#125; &#125;&#125; è¾“å‡ºå¦‚ä¸‹: 12image hello!text hello æµ‹è¯•ç±»æ¼”ç¤ºå¦‚ä¸‹å›¾: 4. è®¾è®¡æ€è·¯ç”»äº†ä¸€ä¸‹ç»“æ„å›¾ï¼Œæ–¹ä¾¿ç†è§£, ä¸‹é¢çš„æ ¸å¿ƒæ˜¯ SpiLoader ç±»ï¼Œ è´Ÿè´£åŠ è½½spiæ¥å£çš„æ‰€æœ‰å®ç°ç±»ï¼Œ åˆå§‹åŒ–æ‰€æœ‰å®šä¹‰çš„é€‰æ‹©å™¨ï¼Œ è¿”å›ä¸€ä¸ªspiæ¥å£çš„å®ç°ç±»åˆå§‹åŒ–ç”¨æˆ·è‡ªå®šä¹‰çš„spiå¯¹è±¡ï¼Œç„¶åç”¨æˆ·æŒæœ‰æ­¤å¯¹è±¡è°ƒç”¨spiæ¥å£ä¸­æä¾›çš„æ–¹æ³•å³å¯ 5. å…¶ä»–åšå®¢ç³»åˆ—é“¾æ¥ï¼š SPIæ¡†æ¶å®ç°ä¹‹æ—…å››ï¼šä½¿ç”¨æµ‹è¯• SPIæ¡†æ¶å®ç°ä¹‹æ—…ä¸‰ï¼šå®ç°è¯´æ˜ SPIæ¡†æ¶å®ç°ä¹‹æ—…äºŒï¼šæ•´ä½“è®¾è®¡ SPIæ¡†æ¶å®ç°ä¹‹æ—…ä¸€ï¼šèƒŒæ™¯ä»‹ç» é¡¹ç›®: QuickAlarm é¡¹ç›®åœ°å€ï¼š Quick-SPI åšå®¢åœ°å€ï¼š å°ç°ç°Blog ä¸ªäººåšå®¢ï¼š Z+|blogåŸºäºhexo + github pagesæ­å»ºçš„ä¸ªäººåšå®¢ï¼Œè®°å½•æ‰€æœ‰å­¦ä¹ å’Œå·¥ä½œä¸­çš„åšæ–‡ï¼Œæ¬¢è¿å¤§å®¶å‰å»é€›é€› å£°æ˜å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› æœ¬äººèƒ½åŠ›ä¸€èˆ¬ï¼Œè§è¯†æœ‰é™ï¼Œå¦‚å‘ç°bugæˆ–è€…æœ‰æ›´å¥½çš„å»ºè®®ï¼Œéšæ—¶æ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼Œæˆ‘çš„å¾®åšåœ°å€: å°ç°ç°Blog æ‰«æå…³æ³¨","categories":[{"name":"Quickç³»åˆ—é¡¹ç›®","slug":"Quickç³»åˆ—é¡¹ç›®","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/"},{"name":"QuickSpi","slug":"Quickç³»åˆ—é¡¹ç›®/QuickSpi","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/QuickSpi/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://zbang.online/hexblog/tags/Java/"},{"name":"SPI","slug":"SPI","permalink":"https://zbang.online/hexblog/tags/SPI/"},{"name":"æ•´ä½“è®¾è®¡","slug":"æ•´ä½“è®¾è®¡","permalink":"https://zbang.online/hexblog/tags/æ•´ä½“è®¾è®¡/"}],"keywords":[{"name":"Quickç³»åˆ—é¡¹ç›®","slug":"Quickç³»åˆ—é¡¹ç›®","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/"},{"name":"QuickSpi","slug":"Quickç³»åˆ—é¡¹ç›®/QuickSpi","permalink":"https://zbang.online/hexblog/categories/Quickç³»åˆ—é¡¹ç›®/QuickSpi/"}]}]